<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ventas y Administraci칩n</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bibliotecas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- Bibliotecas para QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <!-- Leaflet.js para mapas interactivos -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- SDK de Firebase (versi칩n compat para facilidad de uso) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <!-- Estilos personalizados -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        .tab-button { transition: all 0.3s ease; }
        .tab-button.active { border-color: #3b82f6; color: #3b82f6; background-color: #eff6ff; }
        .dark .tab-button.active { border-color: #60a5fa; color: #60a5fa; background-color: #1e293b; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 50; }
        .sidebar-button { transition: all 0.2s ease-in-out; }
        .sidebar-button.active { background-color: #eff6ff; color: #3b82f6; font-weight: 600; }
        .dark .sidebar-button.active { background-color: #334155; color: #60a5fa; }
        .sidebar-button:not(.active):hover { background-color: #f3f4f6; }
        .dark .sidebar-button:not(.active):hover { background-color: #1e293b; }
        .price-input {
            width: 80px;
            background-color: transparent;
            border: 1px solid transparent;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        .price-input:hover, .price-input:focus {
            border-color: #9ca3af;
        }
        .dark .price-input:hover, .dark .price-input:focus {
            border-color: #4b5563;
        }
        #status-indicator {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            z-index: 100;
            transition: background-color 0.3s ease;
        }
        .online { background-color: #22c55e; } /* green-500 */
        .offline { background-color: #ef4444; } /* red-500 */
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="antialiased text-slate-700 dark:text-slate-300 bg-gray-100 dark:bg-slate-900">
    
    <div id="status-indicator" title="Estado de la conexi칩n"></div>

    <!-- Vista de Autenticaci칩n -->
    <div id="auth-view" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg">
            <div id="login-container">
                <h1 class="text-3xl font-bold text-center text-slate-800 dark:text-white mb-6">Iniciar Sesi칩n</h1>
                <form id="login-form" class="space-y-4 mb-4">
                    <input type="email" id="login-email" placeholder="Correo Electr칩nico" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600" required>
                    <input type="password" id="login-password" placeholder="Contrase침a" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600" required>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Ingresar</button>
                </form>
            </div>
            <p id="auth-error" class="text-red-500 text-center text-sm mt-4 h-4"></p>
        </div>
    </div>

    <!-- M칩dulo de Administrador -->
    <div id="admin-view" class="hidden min-h-screen p-4 sm:p-6 md:p-8">
        <div class="max-w-7xl mx-auto">
            <header class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-extrabold text-slate-900 dark:text-white tracking-tight">M칩dulo de Administrador</h1>
                <div class="flex items-center gap-4">
                    <button id="admin-theme-toggle" class="p-2 rounded-md bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200"><svg class="theme-icon-light w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg><svg class="theme-icon-dark w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg></button>
                    <button class="logout-btn bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition">Salir</button>
                </div>
            </header>
            <div id="admin-tabs" class="mb-6 border-b border-slate-200 dark:border-slate-700">
                <nav class="flex space-x-4 flex-wrap"><button data-target="admin-dashboard" class="tab-button active font-semibold py-3 px-1 border-b-2 border-transparent">Dashboard</button><button data-target="admin-products" class="tab-button font-semibold py-3 px-1 border-b-2 border-transparent">Inventario</button><button data-target="admin-vehicles" class="tab-button font-semibold py-3 px-1 border-b-2 border-transparent">Veh칤culos</button><button data-target="admin-losses" class="tab-button font-semibold py-3 px-1 border-b-2 border-transparent">丘멆잺 P칠rdidas</button><button data-target="admin-transfers" class="tab-button font-semibold py-3 px-1 border-b-2 border-transparent">游댃 Transferencias</button><button data-target="admin-clients" class="tab-button font-semibold py-3 px-1 border-b-2 border-transparent">Clientes</button><button data-target="admin-visits" class="tab-button font-semibold py-3 px-1 border-b-2 border-transparent">Visitas</button><button data-target="admin-whatsapp-templates" class="tab-button font-semibold py-3 px-1 border-b-2 border-transparent">Plantillas WhatsApp</button><button data-target="admin-expense-types" class="tab-button font-semibold py-3 px-1 border-b-2 border-transparent">Tipos de Gasto</button><button data-target="admin-sales-goals" class="tab-button font-semibold py-3 px-1 border-b-2 border-transparent">Metas</button><button data-target="admin-management" class="tab-button font-semibold py-3 px-1 border-b-2 border-transparent">Gesti칩n</button><button data-target="admin-closures" class="tab-button font-semibold py-3 px-1 border-b-2 border-transparent">Cierres de Caja</button><button data-target="admin-reports" class="tab-button font-semibold py-3 px-1 border-b-2 border-transparent">Reportes</button></nav>
            </div>
            <div id="admin-content">
                <div id="admin-dashboard">
                    <!-- Filtros Dashboard -->
                    <div class="bg-gradient-to-r from-purple-500 to-pink-600 p-6 rounded-2xl shadow-lg mb-6">
                        <div class="flex items-center gap-3 mb-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <h2 class="text-2xl font-bold text-white">Dashboard de Ventas</h2>
                        </div>
                        <div class="flex flex-wrap gap-3 items-end">
                            <div>
                                <label class="text-white text-sm font-medium mb-1 block">Fecha Inicio</label>
                                <input type="date" id="dashboard-start-date" class="p-2.5 border-0 rounded-lg bg-white/90 backdrop-blur shadow-sm focus:ring-2 focus:ring-white">
                            </div>
                            <div>
                                <label class="text-white text-sm font-medium mb-1 block">Fecha Fin</label>
                                <input type="date" id="dashboard-end-date" class="p-2.5 border-0 rounded-lg bg-white/90 backdrop-blur shadow-sm focus:ring-2 focus:ring-white">
                            </div>
                            <button id="filter-dashboard-btn" class="bg-white text-purple-600 font-bold py-2.5 px-6 rounded-lg hover:bg-purple-50 transition shadow-md">
                                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                Filtrar
                            </button>
                            <button id="reset-dashboard-btn" class="bg-white/20 text-white font-bold py-2.5 px-6 rounded-lg hover:bg-white/30 transition border border-white/50">Ver Hoy</button>
                        </div>
                    </div>

                    <!-- Estad칤sticas Principales -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl shadow-lg text-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Ventas Totales</span>
                                <svg class="w-10 h-10 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <p id="admin-total-sales" class="text-4xl font-bold">$0.00</p>
                            <p id="admin-sales-count" class="text-xs opacity-75 mt-1">0 ventas</p>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-xl shadow-lg text-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Gastos Totales</span>
                                <svg class="w-10 h-10 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <p id="admin-total-expenses" class="text-4xl font-bold">$0.00</p>
                            <p id="admin-expenses-count" class="text-xs opacity-75 mt-1">0 gastos</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl shadow-lg text-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Balance General</span>
                                <svg class="w-10 h-10 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <p id="admin-balance" class="text-4xl font-bold">$0.00</p>
                            <p class="text-xs opacity-75 mt-1">Ventas - Gastos</p>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 p-6 rounded-xl shadow-lg text-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Cr칠ditos Pendientes</span>
                                <svg class="w-10 h-10 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <p id="admin-credits-pending" class="text-4xl font-bold">$0.00</p>
                            <p id="admin-credits-count" class="text-xs opacity-75 mt-1">0 pendientes</p>
                        </div>
                    </div>

                    <!-- Top Productos y Vendedores -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Producto M치s Vendido -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-indigo-100 dark:bg-indigo-900 p-3 rounded-xl">
                                    <svg class="w-6 h-6 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Producto M치s Vendido</h3>
                            </div>
                            <div id="top-product-container" class="space-y-3">
                                <p class="text-slate-500 text-center py-4">Consultando datos...</p>
                            </div>
                        </div>

                        <!-- Vendedor con M치s Ventas -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-purple-100 dark:bg-purple-900 p-3 rounded-xl">
                                    <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Vendedor con M치s Ventas</h3>
                            </div>
                            <div id="top-seller-container" class="space-y-3">
                                <p class="text-slate-500 text-center py-4">Consultando datos...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Top 5 Productos -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="bg-teal-100 dark:bg-teal-900 p-3 rounded-xl">
                                <svg class="w-6 h-6 text-teal-600 dark:text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white">Top 5 Productos M치s Vendidos</h3>
                        </div>
                        <div id="top5-products-container" class="overflow-x-auto">
                            <p class="text-slate-500 text-center py-4">Consultando datos...</p>
                        </div>
                    </div>
                </div>
                <!-- M칍DULO DE INVENTARIO (antes Productos) -->
                <div id="admin-products" class="hidden">
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-700 p-6 rounded-xl shadow-lg text-white mb-6">
                        <h2 class="text-3xl font-bold mb-2 flex items-center gap-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                            Gesti칩n de Inventario
                        </h2>
                        <p class="text-purple-100">Administra productos, stock y precios del sistema</p>
                    </div>

                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md mb-6">
                        <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Registrar Nuevo Producto</h2>
                        <form id="add-product-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Informaci칩n B치sica -->
                            <div class="lg:col-span-3">
                                <h3 class="text-lg font-semibold mb-3 text-slate-700 dark:text-slate-300 border-b pb-2">Informaci칩n B치sica</h3>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Nombre del Producto *</label>
                                <input type="text" id="product-name" placeholder="Ej: BCL 20L" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Categor칤a *</label>
                                <select id="product-category" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="bidon_lleno">Bid칩n Lleno (BCL/BSL)</option>
                                    <option value="bidon_vacio">Bid칩n Vac칤o</option>
                                    <option value="recarga">Recarga de Agua</option>
                                    <option value="equipo">Equipo/V치lvula</option>
                                    <option value="paca">Paca (Gal칩n/Galones)</option>
                                    <option value="llaves">Llaves</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Peso Unitario (kg) *</label>
                                <input type="number" id="product-weight" placeholder="20" min="0" step="0.01" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                            </div>

                            <div class="flex items-center">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="product-is-returnable" class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                                    <span class="ml-2 text-sm font-semibold text-slate-700 dark:text-slate-300">쮼s retornable?</span>
                                </label>
                            </div>

                            <!-- Precios -->
                            <div class="lg:col-span-3 mt-4">
                                <h3 class="text-lg font-semibold mb-3 text-slate-700 dark:text-slate-300 border-b pb-2">Precios</h3>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Costo *</label>
                                <input type="number" id="product-cost" placeholder="0.00" min="0" step="0.01" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Precio Normal *</label>
                                <input type="number" id="product-price-normal" placeholder="0.00" min="0" step="0.01" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Precio Negocio *</label>
                                <input type="number" id="product-price-business" placeholder="0.00" min="0" step="0.01" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                            </div>

                            <!-- Inventario Inicial -->
                            <div class="lg:col-span-3 mt-4">
                                <h3 class="text-lg font-semibold mb-3 text-slate-700 dark:text-slate-300 border-b pb-2">Inventario Inicial (Bodega)</h3>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Stock Inicial</label>
                                <input type="number" id="product-initial-stock" placeholder="0" min="0" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="0">
                            </div>

                            <div class="lg:col-span-3 flex gap-3 mt-4">
                                <button type="submit" class="flex-1 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                    Agregar Producto
                                </button>
                                <button type="button" onclick="document.getElementById('add-product-form').reset()" class="bg-slate-400 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-500 transition">
                                    Limpiar
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Lista de Productos</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white dark:bg-slate-800">
                                <thead class="bg-slate-50 dark:bg-slate-700">
                                    <tr>
                                        <th class="py-3 px-4 text-left font-semibold text-sm text-slate-700 dark:text-slate-300">Nombre</th>
                                        <th class="py-3 px-4 text-left font-semibold text-sm text-slate-700 dark:text-slate-300">Categor칤a</th>
                                        <th class="py-3 px-4 text-left font-semibold text-sm text-slate-700 dark:text-slate-300">Peso (kg)</th>
                                        <th class="py-3 px-4 text-left font-semibold text-sm text-slate-700 dark:text-slate-300">Stock Bodega</th>
                                        <th class="py-3 px-4 text-left font-semibold text-sm text-slate-700 dark:text-slate-300">Costo</th>
                                        <th class="py-3 px-4 text-left font-semibold text-sm text-slate-700 dark:text-slate-300">P. Normal</th>
                                        <th class="py-3 px-4 text-left font-semibold text-sm text-slate-700 dark:text-slate-300">P. Negocio</th>
                                        <th class="py-3 px-4 text-left font-semibold text-sm text-slate-700 dark:text-slate-300">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="product-list" class="divide-y divide-slate-200 dark:divide-slate-700">
                                    <!-- Se llenar치 din치micamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- M칍DULO DE VEH칈CULOS -->
                <div id="admin-vehicles" class="hidden">
                    <div class="bg-gradient-to-r from-green-600 to-teal-700 p-6 rounded-xl shadow-lg text-white mb-6">
                        <h2 class="text-3xl font-bold mb-2 flex items-center gap-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                            Gesti칩n de Veh칤culos
                        </h2>
                        <p class="text-green-100">Administra la flota de veh칤culos y asigna vendedores</p>
                    </div>

                    <!-- Formulario de Registro de Veh칤culo -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md mb-6">
                        <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Registrar Nuevo Veh칤culo</h2>
                        <form id="add-vehicle-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Placa *</label>
                                <input type="text" id="vehicle-plate" placeholder="ABC-1234" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-green-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Marca/Modelo *</label>
                                <input type="text" id="vehicle-brand" placeholder="Toyota Hilux" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-green-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">A침o</label>
                                <input type="number" id="vehicle-year" placeholder="2023" min="1980" max="2030" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-green-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Color</label>
                                <input type="text" id="vehicle-color" placeholder="Blanco" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-green-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Tipo de Veh칤culo *</label>
                                <select id="vehicle-type" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-green-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                                    <option value="">Seleccionar tipo...</option>
                                    <option value="Cami칩n">Cami칩n</option>
                                    <option value="Camioneta">Camioneta</option>
                                    <option value="Furg칩n">Furg칩n</option>
                                    <option value="Van">Van</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Capacidad M치xima (kg) *</label>
                                <input type="number" id="vehicle-max-weight" placeholder="1000" min="0" step="0.01" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-green-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Capacidad M치xima (unidades) *</label>
                                <input type="number" id="vehicle-max-units" placeholder="100" min="0" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-green-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Vendedor Asignado</label>
                                <select id="vehicle-assigned-seller" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-green-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                    <option value="">Sin asignar</option>
                                </select>
                            </div>
                            <div class="md:col-span-2 flex gap-3">
                                <button type="submit" class="flex-1 bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                    Registrar Veh칤culo
                                </button>
                                <button type="button" onclick="resetVehicleForm()" class="bg-slate-400 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-500 transition">
                                    Limpiar
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Lista de Veh칤culos -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white">
                                Lista de Veh칤culos (<span id="vehicles-count">0</span>)
                            </h3>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white dark:bg-slate-800">
                                <thead class="bg-slate-50 dark:bg-slate-700">
                                    <tr>
                                        <th class="py-3 px-4 text-left font-semibold text-sm text-slate-700 dark:text-slate-300">Placa</th>
                                        <th class="py-3 px-4 text-left font-semibold text-sm text-slate-700 dark:text-slate-300">Marca/Modelo</th>
                                        <th class="py-3 px-4 text-left font-semibold text-sm text-slate-700 dark:text-slate-300">Tipo</th>
                                        <th class="py-3 px-4 text-left font-semibold text-sm text-slate-700 dark:text-slate-300">Capacidad (kg)</th>
                                        <th class="py-3 px-4 text-left font-semibold text-sm text-slate-700 dark:text-slate-300">Capacidad (unidades)</th>
                                        <th class="py-3 px-4 text-left font-semibold text-sm text-slate-700 dark:text-slate-300">Vendedor Asignado</th>
                                        <th class="py-3 px-4 text-left font-semibold text-sm text-slate-700 dark:text-slate-300">Inventario</th>
                                        <th class="py-3 px-4 text-left font-semibold text-sm text-slate-700 dark:text-slate-300">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="vehicles-list" class="divide-y divide-slate-200 dark:divide-slate-700">
                                    <!-- Se llenar치 din치micamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- M칍DULO DE P칄RDIDAS/DA칌OS ADMIN -->
                <div id="admin-losses" class="hidden">
                    <div class="bg-gradient-to-r from-yellow-600 to-orange-700 p-6 rounded-xl shadow-lg text-white mb-6">
                        <h2 class="text-3xl font-bold mb-2 flex items-center gap-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            Aprobaci칩n de P칠rdidas y Da침os
                        </h2>
                        <p class="text-yellow-100">Revisa y aprueba los reportes de p칠rdidas de inventario de los vendedores</p>
                    </div>

                    <!-- Estad칤sticas -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                            <div class="text-sm text-slate-600 dark:text-slate-400">Pendientes</div>
                            <div id="losses-pending-count" class="text-3xl font-bold text-yellow-600 dark:text-yellow-400">0</div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                            <div class="text-sm text-slate-600 dark:text-slate-400">Aprobadas (Mes)</div>
                            <div id="losses-approved-count" class="text-3xl font-bold text-green-600 dark:text-green-400">0</div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                            <div class="text-sm text-slate-600 dark:text-slate-400">Rechazadas (Mes)</div>
                            <div id="losses-rejected-count" class="text-3xl font-bold text-red-600 dark:text-red-400">0</div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                            <div class="text-sm text-slate-600 dark:text-slate-400">Total P칠rdidas (Mes)</div>
                            <div id="losses-total-value" class="text-3xl font-bold text-slate-800 dark:text-slate-200">$0</div>
                        </div>
                    </div>

                    <!-- Lista de Reportes Pendientes -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow mb-6">
                        <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Reportes Pendientes de Aprobaci칩n</h3>
                        <div id="admin-losses-pending" class="space-y-4">
                            <p class="text-center py-8 text-slate-500 dark:text-slate-400">No hay reportes pendientes</p>
                        </div>
                    </div>

                    <!-- Historial -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Historial de Reportes</h3>

                        <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-3">
                            <select id="losses-filter-status" class="p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                <option value="all">Todos los estados</option>
                                <option value="approved">Aprobados</option>
                                <option value="rejected">Rechazados</option>
                                <option value="pending">Pendientes</option>
                            </select>
                            <select id="losses-filter-seller" class="p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                <option value="all">Todos los vendedores</option>
                            </select>
                            <button onclick="loadAdminLossesHistory()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                Aplicar Filtros
                            </button>
                        </div>

                        <div id="admin-losses-history" class="space-y-4">
                            <p class="text-center py-8 text-slate-500 dark:text-slate-400">Seleccione filtros y haga clic en "Aplicar Filtros"</p>
                        </div>
                    </div>
                </div>

                <!-- M칍DULO DE TRANSFERENCIAS ADMIN -->
                <div id="admin-transfers" class="hidden">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-700 p-6 rounded-xl shadow-lg text-white mb-6">
                        <h2 class="text-3xl font-bold mb-2 flex items-center gap-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                            </svg>
                            Aprobaci칩n de Transferencias
                        </h2>
                        <p class="text-blue-100">Revisa y aprueba las solicitudes de transferencia de inventario entre veh칤culos</p>
                    </div>

                    <!-- Estad칤sticas -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                            <div class="text-sm text-slate-600 dark:text-slate-400">Pendientes</div>
                            <div id="transfers-pending-count" class="text-3xl font-bold text-yellow-600 dark:text-yellow-400">0</div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                            <div class="text-sm text-slate-600 dark:text-slate-400">Aprobadas (Mes)</div>
                            <div id="transfers-approved-count" class="text-3xl font-bold text-green-600 dark:text-green-400">0</div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                            <div class="text-sm text-slate-600 dark:text-slate-400">Rechazadas (Mes)</div>
                            <div id="transfers-rejected-count" class="text-3xl font-bold text-red-600 dark:text-red-400">0</div>
                        </div>
                    </div>

                    <!-- Lista de Solicitudes Pendientes -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow mb-6">
                        <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Solicitudes Pendientes de Aprobaci칩n</h3>
                        <div id="admin-transfers-pending" class="space-y-4">
                            <p class="text-center py-8 text-slate-500 dark:text-slate-400">No hay solicitudes pendientes</p>
                        </div>
                    </div>

                    <!-- Historial -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Historial de Transferencias</h3>

                        <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-3">
                            <select id="transfers-filter-status" class="p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                <option value="all">Todos los estados</option>
                                <option value="approved">Aprobadas</option>
                                <option value="rejected">Rechazadas</option>
                                <option value="pending">Pendientes</option>
                            </select>
                            <select id="transfers-filter-requester" class="p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                <option value="all">Todos los solicitantes</option>
                            </select>
                            <button onclick="loadAdminTransfersHistory()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                Aplicar Filtros
                            </button>
                        </div>

                        <div id="admin-transfers-history" class="space-y-4">
                            <p class="text-center py-8 text-slate-500 dark:text-slate-400">Seleccione filtros y haga clic en "Aplicar Filtros"</p>
                        </div>
                    </div>
                </div>

                <!-- M칍DULO DE CLIENTES ADMIN -->
                <div id="admin-clients" class="hidden">
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 p-6 rounded-xl shadow-lg text-white mb-6">
                        <h2 class="text-3xl font-bold mb-2 flex items-center gap-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                            Gesti칩n de Clientes
                        </h2>
                        <p class="text-blue-100">Administra todos los clientes del sistema y as칤gnalos a vendedores</p>
                    </div>

                    <!-- Estad칤sticas R치pidas -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                            <div class="text-sm text-slate-600 dark:text-slate-400">Total Clientes</div>
                            <div class="text-2xl font-bold text-slate-900 dark:text-white" id="admin-total-clients">0</div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                            <div class="text-sm text-slate-600 dark:text-slate-400">Clientes Activos</div>
                            <div class="text-2xl font-bold text-green-600" id="admin-active-clients">0</div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                            <div class="text-sm text-slate-600 dark:text-slate-400">Sin Vendedor Asignado</div>
                            <div class="text-2xl font-bold text-orange-600" id="admin-unassigned-clients">0</div>
                        </div>
                    </div>

                    <!-- B칰squeda y Filtros -->
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" id="admin-search-clients" placeholder="游댌 Buscar cliente..." class="p-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600">
                            <select id="admin-filter-seller" class="p-3 border-2 rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                <option value="">Todos los vendedores</option>
                            </select>
                            <select id="admin-filter-province" class="p-3 border-2 rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                <option value="">Todas las provincias</option>
                            </select>
                        </div>
                    </div>

                    <!-- Lista de Clientes -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white">
                                Lista de Clientes (<span id="admin-clients-count">0</span>)
                            </h3>
                            <div class="flex gap-2">
                                <button onclick="downloadAllClientQRs()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Descargar Todos los QR
                                </button>
                                <button onclick="openAdminClientModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                    Nuevo Cliente
                                </button>
                            </div>
                        </div>

                        <!-- Barra de Reasignaci칩n M칰ltiple -->
                        <div id="bulk-reassign-bar" class="hidden bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-500 dark:border-blue-700 p-4 rounded-lg mb-4 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="select-all-clients" onchange="toggleSelectAllClients()" class="w-5 h-5 text-blue-600">
                                <span class="font-semibold text-slate-900 dark:text-white">
                                    <span id="selected-clients-count">0</span> cliente(s) seleccionado(s)
                                </span>
                            </div>
                            <div class="flex items-center gap-3">
                                <select id="bulk-reassign-seller" class="p-2 border-2 rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                    <option value="">Seleccionar vendedor...</option>
                                </select>
                                <button onclick="bulkReassignClients()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                                    Reasignar Seleccionados
                                </button>
                                <button onclick="cancelBulkReassign()" class="bg-slate-400 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg">
                                    Cancelar
                                </button>
                            </div>
                        </div>

                        <div id="admin-clients-list" class="space-y-3">
                            <!-- Se llenar치 din치micamente -->
                        </div>
                    </div>
                </div>

                <!-- M칩dulo de Visitas (Admin) -->
                <div id="admin-visits" class="hidden">
                    <div class="bg-gradient-to-r from-purple-600 to-pink-700 p-6 rounded-xl shadow-lg text-white mb-6">
                        <h2 class="text-3xl font-bold mb-2 flex items-center gap-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            Gesti칩n de Visitas
                        </h2>
                        <p class="text-purple-100">Supervisa las visitas de todos los vendedores a clientes</p>
                    </div>

                    <!-- Filtros -->
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <select id="admin-visits-seller-filter" class="p-3 border-2 rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                <option value="">Todos los vendedores</option>
                            </select>
                            <input type="date" id="admin-visits-start-date" class="p-3 border-2 rounded-lg dark:bg-slate-700 dark:border-slate-600">
                            <input type="date" id="admin-visits-end-date" class="p-3 border-2 rounded-lg dark:bg-slate-700 dark:border-slate-600">
                            <button onclick="filterAdminVisits()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg">
                                Filtrar
                            </button>
                        </div>
                    </div>

                    <!-- Estad칤sticas -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                            <div class="text-sm text-slate-600 dark:text-slate-400">Total Visitas</div>
                            <div class="text-2xl font-bold text-slate-900 dark:text-white" id="admin-total-visits">0</div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                            <div class="text-sm text-slate-600 dark:text-slate-400">Visitas Hoy</div>
                            <div class="text-2xl font-bold text-blue-600" id="admin-visits-today">0</div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                            <div class="text-sm text-slate-600 dark:text-slate-400">Vendedores Activos</div>
                            <div class="text-2xl font-bold text-green-600" id="admin-active-sellers">0</div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                            <div class="text-sm text-slate-600 dark:text-slate-400">Clientes Visitados</div>
                            <div class="text-2xl font-bold text-purple-600" id="admin-unique-clients">0</div>
                        </div>
                    </div>

                    <!-- Lista de Visitas -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white">
                                Historial de Visitas (<span id="admin-visits-count">0</span>)
                            </h3>
                            <button onclick="exportVisitsToExcel()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Exportar Excel
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-slate-50 dark:bg-slate-700">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-sm font-bold">Fecha</th>
                                        <th class="py-3 px-4 text-left text-sm font-bold">Hora</th>
                                        <th class="py-3 px-4 text-left text-sm font-bold">Vendedor</th>
                                        <th class="py-3 px-4 text-left text-sm font-bold">Cliente</th>
                                        <th class="py-3 px-4 text-left text-sm font-bold">Ubicaci칩n</th>
                                        <th class="py-3 px-4 text-left text-sm font-bold">Notas</th>
                                        <th class="py-3 px-4 text-left text-sm font-bold">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-visits-list" class="divide-y divide-slate-200 dark:divide-slate-700">
                                    <!-- Se llenar치 din치micamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- M칩dulo de Plantillas WhatsApp -->
                <div id="admin-whatsapp-templates" class="hidden">
                    <div class="bg-gradient-to-r from-green-500 to-emerald-600 p-6 rounded-xl shadow-lg text-white mb-6">
                        <h2 class="text-3xl font-bold mb-2 flex items-center gap-3">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                            </svg>
                            Plantillas de Mensajes WhatsApp
                        </h2>
                        <p class="text-green-100">Crea plantillas de mensajes para que los vendedores las usen al contactar clientes</p>
                    </div>

                    <!-- Formulario Nueva Plantilla -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow mb-6">
                        <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Crear Nueva Plantilla</h3>
                        <form id="whatsapp-template-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Nombre de la Plantilla</label>
                                <input type="text" id="template-name" placeholder="Ej: Recordatorio de Entrega Semanal" class="w-full p-3 border-2 rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Mensaje</label>
                                <textarea id="template-message" rows="6" placeholder="Escribe tu mensaje aqu칤..." class="w-full p-3 border-2 rounded-lg dark:bg-slate-700 dark:border-slate-600" required></textarea>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                                    Variables disponibles:
                                    <code class="bg-slate-100 dark:bg-slate-700 px-1 rounded">[cliente]</code>
                                    <code class="bg-slate-100 dark:bg-slate-700 px-1 rounded">[vendedor]</code>
                                    <code class="bg-slate-100 dark:bg-slate-700 px-1 rounded">[empresa]</code>
                                    <code class="bg-slate-100 dark:bg-slate-700 px-1 rounded">[dia]</code>
                                </p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Ejemplo de Uso</label>
                                <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg">
                                    <p class="text-sm text-slate-700 dark:text-slate-300 italic" id="template-preview">El preview aparecer치 aqu칤...</p>
                                </div>
                            </div>

                            <div class="flex gap-3">
                                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">
                                    游 Guardar Plantilla
                                </button>
                                <button type="reset" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 font-bold py-3 px-6 rounded-lg">
                                    Limpiar
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Lista de Plantillas -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">
                            Plantillas Guardadas (<span id="templates-count">0</span>)
                        </h3>
                        <div id="templates-list" class="space-y-3">
                            <!-- Se llenar치 din치micamente -->
                        </div>
                    </div>
                </div>

                <div id="admin-expense-types" class="hidden"><div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md"><h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Definir Tipos de Gasto</h2><form id="add-expense-type-form" class="flex gap-4 mb-6"><input type="text" id="expense-type-name" placeholder="Nombre del Tipo de Gasto" class="flex-grow p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600" required><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Agregar</button></form><h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Lista de Tipos de Gasto</h3><div class="overflow-x-auto"><table class="min-w-full bg-white dark:bg-slate-800"><thead class="bg-slate-50 dark:bg-slate-700"><tr><th class="py-3 px-4 text-left font-semibold text-sm">Nombre</th><th class="py-3 px-4 text-left font-semibold text-sm">Acciones</th></tr></thead><tbody id="expense-type-list" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody></table></div></div></div>

                <!-- M칩dulo de Metas de Ventas -->
                <div id="admin-sales-goals" class="hidden">
                    <div class="bg-gradient-to-r from-orange-500 to-red-600 p-6 rounded-2xl shadow-lg mb-6">
                        <div class="flex items-center gap-3 mb-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                            </svg>
                            <h2 class="text-2xl font-bold text-white">Asignaci칩n de Metas de Ventas</h2>
                        </div>
                        <p class="text-white/90 text-sm">Asigna metas mensuales a tus vendedores para motivar y medir el desempe침o</p>
                    </div>

                    <!-- Formulario de Nueva Meta -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg mb-6 border border-slate-200 dark:border-slate-700">
                        <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Crear Nueva Meta</h3>
                        <form id="add-sales-goal-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="text-sm font-medium text-slate-700 dark:text-slate-300 block mb-1">Vendedor</label>
                                <select id="goal-seller" class="w-full p-2.5 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:ring-2 focus:ring-orange-500" required>
                                    <option value="">Seleccionar vendedor</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-slate-700 dark:text-slate-300 block mb-1">Mes</label>
                                <input type="month" id="goal-month" class="w-full p-2.5 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:ring-2 focus:ring-orange-500" required>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-slate-700 dark:text-slate-300 block mb-1">Meta ($)</label>
                                <input type="number" id="goal-amount" placeholder="5000.00" min="0" step="0.01" class="w-full p-2.5 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:ring-2 focus:ring-orange-500" required>
                            </div>
                            <div class="flex items-end">
                                <button type="submit" class="w-full bg-orange-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-orange-700 transition">
                                    <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Crear Meta
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Lista de Metas Activas -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                        <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Metas Activas</h3>
                        <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
                            <table class="min-w-full bg-white dark:bg-slate-800">
                                <thead class="bg-gradient-to-r from-orange-50 to-red-50 dark:from-slate-700 dark:to-slate-700">
                                    <tr>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-orange-900 dark:text-orange-400">Vendedor</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-orange-900 dark:text-orange-400">Mes</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-orange-900 dark:text-orange-400">Meta</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-orange-900 dark:text-orange-400">Vendido</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-orange-900 dark:text-orange-400">Cumplimiento</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-orange-900 dark:text-orange-400">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="sales-goals-list" class="divide-y divide-slate-200 dark:divide-slate-700">
                                    <tr><td colspan="6" class="text-center py-8 text-slate-500">No hay metas registradas</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="admin-management" class="hidden">
                    <!-- Filtros -->
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-6 rounded-2xl shadow-lg mb-6">
                        <div class="flex items-center gap-3 mb-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                            </svg>
                            <h2 class="text-2xl font-bold text-white">Gesti칩n de Ventas y Gastos</h2>
                        </div>
                        <div class="flex flex-wrap gap-3 items-end">
                            <div>
                                <label class="text-white text-sm font-medium mb-1 block">Fecha Inicio</label>
                                <input type="date" id="management-start-date" class="p-2.5 border-0 rounded-lg bg-white/90 backdrop-blur shadow-sm focus:ring-2 focus:ring-white">
                            </div>
                            <div>
                                <label class="text-white text-sm font-medium mb-1 block">Fecha Fin</label>
                                <input type="date" id="management-end-date" class="p-2.5 border-0 rounded-lg bg-white/90 backdrop-blur shadow-sm focus:ring-2 focus:ring-white">
                            </div>
                            <div>
                                <label class="text-white text-sm font-medium mb-1 block">Vendedor</label>
                                <select id="management-seller-filter" class="p-2.5 border-0 rounded-lg bg-white/90 backdrop-blur shadow-sm focus:ring-2 focus:ring-white">
                                    <option value="">Todos los vendedores</option>
                                </select>
                            </div>
                            <button id="query-management-btn" class="bg-white text-indigo-600 font-bold py-2.5 px-6 rounded-lg hover:bg-indigo-50 transition shadow-md">
                                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                Consultar
                            </button>
                        </div>
                    </div>

                    <!-- Estad칤sticas Resumen -->
                    <div id="management-stats" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-green-500 to-green-600 p-5 rounded-xl shadow-lg text-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Total Ventas</span>
                                <svg class="w-8 h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <p id="management-total-sales" class="text-3xl font-bold">$0.00</p>
                            <p id="management-count-sales" class="text-xs opacity-75 mt-1">0 registros</p>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 p-5 rounded-xl shadow-lg text-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Total Gastos</span>
                                <svg class="w-8 h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
                                </svg>
                            </div>
                            <p id="management-total-expenses" class="text-3xl font-bold">$0.00</p>
                            <p id="management-count-expenses" class="text-xs opacity-75 mt-1">0 registros</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-5 rounded-xl shadow-lg text-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Balance</span>
                                <svg class="w-8 h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <p id="management-balance" class="text-3xl font-bold">$0.00</p>
                            <p class="text-xs opacity-75 mt-1">Ventas - Gastos</p>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 p-5 rounded-xl shadow-lg text-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Cr칠ditos</span>
                                <svg class="w-8 h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <p id="management-total-credits" class="text-3xl font-bold">$0.00</p>
                            <p id="management-count-credits" class="text-xs opacity-75 mt-1">0 pendientes</p>
                        </div>
                    </div>

                    <!-- Ventas -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg mb-6 border border-slate-200 dark:border-slate-700">
                        <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                            <div class="flex items-center gap-3">
                                <div class="bg-green-100 dark:bg-green-900 p-3 rounded-xl">
                                    <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-2xl font-bold text-slate-900 dark:text-white">Ventas Registradas</h3>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <input type="text" id="search-sales" placeholder="Buscar por cliente..." class="px-3 py-2 text-sm border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:ring-2 focus:ring-green-500">
                                <select id="filter-sales-payment" class="px-3 py-2 text-sm border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:ring-2 focus:ring-green-500">
                                    <option value="">Todos los m칠todos</option>
                                    <option value="efectivo">Efectivo</option>
                                    <option value="transferencia">Transferencia</option>
                                    <option value="credito">Cr칠dito</option>
                                </select>
                                <button onclick="exportSalesToExcel()" class="px-3 py-2 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Excel
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
                            <table class="min-w-full bg-white dark:bg-slate-800">
                                <thead class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-slate-700 dark:to-slate-700">
                                    <tr>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-green-900 dark:text-green-400">Fecha</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-green-900 dark:text-green-400">Vendedor</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-green-900 dark:text-green-400">Cliente</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-green-900 dark:text-green-400">Total</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-green-900 dark:text-green-400">M칠todo</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-green-900 dark:text-green-400">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="management-sales-list" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Gastos -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                        <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                            <div class="flex items-center gap-3">
                                <div class="bg-red-100 dark:bg-red-900 p-3 rounded-xl">
                                    <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-2xl font-bold text-slate-900 dark:text-white">Gastos Registrados</h3>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <input type="text" id="search-expenses" placeholder="Buscar por categor칤a..." class="px-3 py-2 text-sm border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:ring-2 focus:ring-red-500">
                                <select id="filter-expenses-payment" class="px-3 py-2 text-sm border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:ring-2 focus:ring-red-500">
                                    <option value="">Todos los m칠todos</option>
                                    <option value="efectivo">Efectivo</option>
                                    <option value="transferencia">Transferencia</option>
                                </select>
                                <button onclick="exportExpensesToExcel()" class="px-3 py-2 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Excel
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
                            <table class="min-w-full bg-white dark:bg-slate-800">
                                <thead class="bg-gradient-to-r from-red-50 to-rose-50 dark:from-slate-700 dark:to-slate-700">
                                    <tr>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-red-900 dark:text-red-400">Fecha</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-red-900 dark:text-red-400">Vendedor</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-red-900 dark:text-red-400">Categor칤a</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-red-900 dark:text-red-400">Monto</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-red-900 dark:text-red-400">M칠todo</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-red-900 dark:text-red-400">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="management-expenses-list" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="admin-closures" class="hidden">
                    <!-- Filtros -->
                    <div class="bg-gradient-to-r from-cyan-500 to-blue-600 p-6 rounded-2xl shadow-lg mb-6">
                        <div class="flex items-center gap-3 mb-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            <h2 class="text-2xl font-bold text-white">Consultar Cierres de Caja</h2>
                        </div>
                        <div class="flex flex-wrap gap-3 items-end">
                            <div>
                                <label class="text-white text-sm font-medium mb-1 block">Fecha Inicio</label>
                                <input type="date" id="closure-start-date" class="p-2.5 border-0 rounded-lg bg-white/90 backdrop-blur shadow-sm focus:ring-2 focus:ring-white">
                            </div>
                            <div>
                                <label class="text-white text-sm font-medium mb-1 block">Fecha Fin</label>
                                <input type="date" id="closure-end-date" class="p-2.5 border-0 rounded-lg bg-white/90 backdrop-blur shadow-sm focus:ring-2 focus:ring-white">
                            </div>
                            <button id="filter-closures-btn" class="bg-white text-cyan-600 font-bold py-2.5 px-6 rounded-lg hover:bg-cyan-50 transition shadow-md">
                                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                Consultar
                            </button>
                        </div>
                    </div>

                    <!-- Tabla de Cierres -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="bg-cyan-100 dark:bg-cyan-900 p-3 rounded-xl">
                                <svg class="w-6 h-6 text-cyan-600 dark:text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-slate-900 dark:text-white">Historial de Cierres</h3>
                        </div>
                        <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
                            <table class="min-w-full bg-white dark:bg-slate-800">
                                <thead class="bg-gradient-to-r from-cyan-50 to-blue-50 dark:from-slate-700 dark:to-slate-700">
                                    <tr>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-cyan-900 dark:text-cyan-400">Fecha</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-cyan-900 dark:text-cyan-400">Vendedor</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-cyan-900 dark:text-cyan-400">Diferencia</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-cyan-900 dark:text-cyan-400">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="closures-list" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="admin-reports" class="hidden"><div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Generador de Reportes</h2>
                    <div class="flex flex-wrap gap-4 items-center mb-6">
                        <input type="date" id="report-start-date" class="p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                        <input type="date" id="report-end-date" class="p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                        <button id="query-admin-reports-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Consultar</button>
                    </div>

                    <div id="admin-reports-display" class="hidden space-y-8">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Detalle de Ventas</h3>
                                <button onclick="generateDetailedReport('sales')" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Descargar PDF</button>
                            </div>
                            <div class="overflow-x-auto max-h-96"><table class="min-w-full"><thead class="bg-slate-50 dark:bg-slate-700 sticky top-0"><tr id="admin-sales-report-head"></tr></thead><tbody id="admin-sales-report-body" class="divide-y divide-slate-700"></tbody></table></div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Cuentas por Cobrar</h3>
                                <button onclick="generateDetailedReport('sales', true)" class="bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-700">Descargar PDF</button>
                            </div>
                            <div class="overflow-x-auto max-h-96"><table class="min-w-full"><thead class="bg-slate-50 dark:bg-slate-700 sticky top-0"><tr id="admin-credit-report-head"></tr></thead><tbody id="admin-credit-report-body" class="divide-y divide-slate-700"></tbody></table></div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Detalle de Gastos</h3>
                                <button onclick="generateDetailedReport('expenses')" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Descargar PDF</button>
                            </div>
                             <div class="overflow-x-auto max-h-96"><table class="min-w-full"><thead class="bg-slate-50 dark:bg-slate-700 sticky top-0"><tr id="admin-expenses-report-head"></tr></thead><tbody id="admin-expenses-report-body" class="divide-y divide-slate-700"></tbody></table></div>
                        </div>
                        <div>
                             <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Ingresos Adicionales</h3>
                                <button onclick="generateDetailedReport('collections')" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700">Descargar PDF</button>
                            </div>
                            <div class="overflow-x-auto max-h-96"><table class="min-w-full"><thead class="bg-slate-50 dark:bg-slate-700 sticky top-0"><tr id="admin-collections-report-head"></tr></thead><tbody id="admin-collections-report-body" class="divide-y divide-slate-700"></tbody></table></div>
                        </div>
                    </div>
                </div></div>
            </div>
        </div>
    </div>

    <!-- M칩dulo de Vendedor -->
    <div id="seller-view" class="hidden">
        <aside id="seller-sidebar" class="bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 w-64 min-h-screen flex flex-col fixed inset-y-0 left-0 z-40 transform -translate-x-full transition-transform duration-300 ease-in-out shadow-lg">
            <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center"><h2 class="text-2xl font-bold text-slate-900 dark:text-white">Vendedor</h2></div>
            <nav id="seller-menu" class="flex-1 p-4 space-y-1"><button data-target="seller-dashboard" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg active">Dashboard</button><button data-target="seller-cash" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">Caja</button><button data-target="seller-sales" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">Ventas</button><button data-target="seller-inventory" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">游닍 Inventario del Cami칩n</button><button data-target="seller-clients" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">Clientes</button><button data-target="seller-visits" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">游늸 Visitas</button><button data-target="seller-loaned-containers" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">游댯 Bidones Prestados</button><button data-target="seller-credit-accounts" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">Cuentas por Cobrar</button><button data-target="seller-collections" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">Ingresos Adicionales</button><button data-target="seller-expenses" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">Gastos</button><button data-target="seller-losses" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">丘멆잺 P칠rdidas/Da침os</button><button data-target="seller-transfers" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">游댃 Transferencias</button><button data-target="seller-cash-closure" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">Cierre de Caja</button><button data-target="seller-goals" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">Metas</button><button data-target="seller-reports" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">Reportes</button></nav>
            <div class="p-4 border-t border-slate-200 dark:border-slate-700 space-y-2"><button class="logout-btn w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg text-red-500 hover:bg-red-500/10 dark:hover:bg-red-500/20 transition">Salir</button></div>
        </aside>

        <main id="seller-main-content" class="flex-1 transition-all duration-300 ease-in-out">
            <div class="p-2 sm:p-4 md:p-6">
                <header class="flex justify-between items-center mb-6">
                     <div class="flex items-center gap-4">
                         <button id="sidebar-toggle" class="p-2 rounded-md bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200"><svg id="menu-open-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg><svg id="menu-close-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                         <h1 class="text-2xl md:text-4xl font-extrabold text-slate-900 dark:text-white tracking-tight">M칩dulo de Vendedor</h1>
                     </div>
                     <button id="theme-toggle" class="p-2 rounded-md bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200"><svg id="theme-icon-light" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg><svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg></button>
                </header>
                <div id="seller-content">
                    <div id="seller-dashboard">
                        <!-- Nombre del Vendedor -->
                        <div class="bg-gradient-to-r from-slate-700 to-slate-900 p-4 rounded-xl shadow-lg text-white mb-4">
                            <div class="flex items-center gap-3">
                                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                <div>
                                    <div class="text-sm opacity-75">Vendedor</div>
                                    <div id="seller-name-display" class="text-xl font-bold">CARGANDO...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Resumen Principal: Total Ventas y Total Gastos -->
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-gradient-to-br from-green-500 to-green-700 p-6 rounded-2xl shadow-xl text-white">
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <div class="text-sm opacity-90 font-medium">TOTAL VENTAS</div>
                                </div>
                                <div id="dashboard-total-sales" class="text-3xl font-bold mb-1">$0.00</div>
                                <div id="dashboard-sales-count" class="text-xs opacity-80">0 ventas</div>
                            </div>

                            <div class="bg-gradient-to-br from-red-500 to-red-700 p-6 rounded-2xl shadow-xl text-white">
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 0a3 3 0 110 6H9l3 3m-3-6h6m6 1a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <div class="text-sm opacity-90 font-medium">TOTAL GASTOS</div>
                                </div>
                                <div id="dashboard-total-expenses" class="text-3xl font-bold mb-1">$0.00</div>
                                <div id="dashboard-expenses-count" class="text-xs opacity-80">0 gastos</div>
                            </div>
                        </div>

                        <!-- Alertas de Stock del Veh칤culo -->
                        <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-lg mb-6">
                            <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                ALERTAS DE STOCK
                            </h3>
                            <div id="dashboard-stock-alerts" class="space-y-2">
                                <p class="text-center py-8 text-slate-500 dark:text-slate-400 text-sm">Abra la caja para ver el inventario del veh칤culo</p>
                            </div>
                        </div>

                        <!-- Productos M치s Vendidos -->
                        <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-lg">
                            <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                PRODUCTOS VENDIDOS
                            </h3>
                            <div id="dashboard-top-products" class="space-y-3">
                                <p class="text-center py-8 text-slate-500 dark:text-slate-400 text-sm">No hay productos vendidos</p>
                            </div>
                        </div>
                    </div>
                    <!-- M칩dulo de Caja del Vendedor -->
                    <div id="seller-cash" class="hidden">
                        <!-- Vista: Abrir Caja -->
                        <div id="open-cash-view" class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md">
                            <h2 class="text-2xl font-bold mb-6 text-slate-900 dark:text-white text-center">Apertura de Caja</h2>

                            <form id="open-cash-form" class="max-w-2xl mx-auto">
                                <!-- Informaci칩n B치sica -->
                                <div class="mb-6">
                                    <h3 class="text-lg font-semibold mb-3 text-slate-700 dark:text-slate-300 border-b pb-2">Informaci칩n de Apertura</h3>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Monto Inicial (Efectivo) *</label>
                                            <input type="number" id="opening-balance" placeholder="0.00" min="0" step="0.01" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-green-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Veh칤culo Asignado *</label>
                                            <select id="opening-vehicle" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-green-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                                                <option value="">Seleccionar veh칤culo...</option>
                                            </select>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Kilometraje Inicial</label>
                                            <input type="number" id="opening-km" placeholder="0" min="0" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-green-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        </div>
                                    </div>
                                </div>

                                <!-- Inventario Inicial del Veh칤culo -->
                                <div id="vehicle-inventory-section" class="hidden mb-6">
                                    <h3 class="text-lg font-semibold mb-3 text-slate-700 dark:text-slate-300 border-b pb-2">Inventario Inicial del Veh칤culo</h3>
                                    <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">Confirme las cantidades que lleva en el veh칤culo:</p>

                                    <div id="vehicle-inventory-list" class="space-y-3 max-h-96 overflow-y-auto">
                                        <!-- Se llenar치 din치micamente -->
                                    </div>

                                    <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                        <div class="flex justify-between text-sm">
                                            <span class="font-semibold text-slate-700 dark:text-slate-300">Capacidad Utilizada:</span>
                                            <span class="font-bold text-blue-600 dark:text-blue-400">
                                                <span id="vehicle-capacity-used">0</span> / <span id="vehicle-capacity-max">0</span> unidades
                                            </span>
                                        </div>
                                        <div class="flex justify-between text-sm mt-1">
                                            <span class="font-semibold text-slate-700 dark:text-slate-300">Peso Total:</span>
                                            <span class="font-bold text-blue-600 dark:text-blue-400">
                                                <span id="vehicle-weight-used">0</span> / <span id="vehicle-weight-max">0</span> kg
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition">
                                    Abrir Caja
                                </button>
                            </form>
                        </div>

                        <!-- Vista: Caja Abierta -->
                        <div id="cash-opened-view" class="hidden bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md">
                            <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Caja Abierta</h2>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                                    <div class="text-sm text-slate-600 dark:text-slate-400">Monto Inicial</div>
                                    <div id="display-opening-balance" class="text-2xl font-bold text-green-600 dark:text-green-400"></div>
                                </div>

                                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                                    <div class="text-sm text-slate-600 dark:text-slate-400">Veh칤culo</div>
                                    <div id="display-vehicle" class="text-xl font-bold text-blue-600 dark:text-blue-400"></div>
                                </div>

                                <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
                                    <div class="text-sm text-slate-600 dark:text-slate-400">KM Inicial</div>
                                    <div id="display-km" class="text-xl font-bold text-purple-600 dark:text-purple-400"></div>
                                </div>
                            </div>

                            <p class="text-slate-600 dark:text-slate-400">Utilice el m칩dulo "Cierre de Caja" para finalizar la sesi칩n.</p>
                        </div>
                    </div>
                    <div id="seller-sales" class="hidden">
                        <div class="space-y-4">
                            <!-- Formulario de Venta Optimizado para M칩vil -->
                            <div class="bg-white dark:bg-slate-800 p-3 sm:p-6 rounded-xl shadow-md">
                                <form id="sale-form">
                                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                        <svg class="w-6 h-6 sm:w-8 sm:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                        Nueva Venta
                                    </h2>

                                    <!-- Informaci칩n del Cliente con B칰squeda Inteligente -->
                                    <div class="bg-slate-50 dark:bg-slate-700/50 p-3 sm:p-4 rounded-lg mb-4">
                                        <h3 class="font-semibold mb-3 text-sm sm:text-base text-slate-700 dark:text-slate-300">Cliente</h3>
                                        <div class="space-y-3">
                                            <div class="relative">
                                                <label class="text-xs sm:text-sm font-medium text-slate-600 dark:text-slate-400">Buscar Cliente</label>
                                                <div class="relative mt-1">
                                                    <input
                                                        type="text"
                                                        id="client-name"
                                                        placeholder="涌쬂찧 Buscar o crear cliente..."
                                                        autocomplete="off"
                                                        class="w-full p-3 sm:p-4 pr-12 text-base border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                                    <button
                                                        type="button"
                                                        id="toggle-clients-btn"
                                                        class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-slate-500 hover:text-blue-600 active:scale-95 transition">
                                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <!-- Dropdown de clientes -->
                                                <div id="clients-dropdown" class="hidden absolute z-10 w-full mt-1 bg-white dark:bg-slate-700 border-2 border-blue-500 rounded-lg shadow-xl max-h-64 overflow-y-auto">
                                                    <div id="clients-list" class="divide-y divide-slate-200 dark:divide-slate-600">
                                                        <!-- Los clientes se cargan din치micamente -->
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Bot칩n Escanear QR -->
                                            <button type="button" id="scan-qr-btn" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                                                </svg>
                                                游닝 Escanear C칩digo QR del Cliente
                                            </button>
                                            <div>
                                                <label class="text-xs sm:text-sm font-medium text-slate-600 dark:text-slate-400 block mb-2">Tipo</label>
                                                <div id="client-type-selector" class="grid grid-cols-2 gap-2">
                                                    <label class="flex items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                                        <input type="radio" name="client-type" value="consumidor-final" checked class="w-5 h-5 text-blue-600">
                                                        <span class="text-sm font-medium">Consumidor</span>
                                                    </label>
                                                    <label class="flex items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                                        <input type="radio" name="client-type" value="negocio" class="w-5 h-5 text-blue-600">
                                                        <span class="text-sm font-medium">Negocio</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- B칰squeda y Selecci칩n de Productos Unificado -->
                                    <div class="bg-slate-50 dark:bg-slate-700/50 p-3 sm:p-4 rounded-lg mb-4">
                                        <h3 class="font-semibold mb-3 text-sm sm:text-base text-slate-700 dark:text-slate-300">Agregar Productos</h3>
                                        <div class="space-y-3">
                                            <div class="relative">
                                                <label class="text-xs sm:text-sm font-medium text-slate-600 dark:text-slate-400">Buscar Producto</label>
                                                <div class="relative mt-1">
                                                    <input
                                                        type="text"
                                                        id="product-search-input"
                                                        placeholder="游댌 Buscar o seleccionar producto..."
                                                        autocomplete="off"
                                                        class="w-full p-3 sm:p-4 pr-12 text-base border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                                    <button
                                                        type="button"
                                                        id="toggle-products-btn"
                                                        class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-slate-500 hover:text-blue-600 active:scale-95 transition">
                                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <!-- Dropdown de productos -->
                                                <div id="products-dropdown" class="hidden absolute z-10 w-full mt-1 bg-white dark:bg-slate-700 border-2 border-blue-500 rounded-lg shadow-xl max-h-64 overflow-y-auto">
                                                    <div id="products-list" class="divide-y divide-slate-200 dark:divide-slate-600">
                                                        <!-- Los productos se cargan din치micamente -->
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex gap-2">
                                                <div class="w-24 sm:w-32">
                                                    <label class="text-xs sm:text-sm font-medium text-slate-600 dark:text-slate-400">Cantidad</label>
                                                    <input type="number" id="sale-quantity" value="1" min="1" class="w-full p-3 sm:p-4 text-base text-center font-bold border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                                </div>
                                                <div class="flex-1">
                                                    <label class="text-xs sm:text-sm font-medium text-slate-600 dark:text-slate-400 opacity-0">.</label>
                                                    <button type="button" id="add-to-cart-btn" class="w-full bg-blue-600 active:bg-blue-700 text-white p-3 sm:p-4 mt-1 rounded-lg font-bold text-base shadow-lg active:shadow-inner transition flex items-center justify-center gap-2">
                                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                                        <span class="hidden sm:inline">A침adir</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Carrito Compacto -->
                                    <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg mb-3 overflow-hidden">
                                        <div class="bg-slate-100 dark:bg-slate-700 px-3 py-2 border-b border-slate-200 dark:border-slate-600 flex items-center justify-between">
                                            <h3 class="font-semibold text-xs sm:text-sm text-slate-700 dark:text-slate-300">游 Carrito</h3>
                                            <span id="cart-count" class="bg-blue-500 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span>
                                        </div>
                                        <div id="current-sale-table" class="divide-y divide-slate-200 dark:divide-slate-700 max-h-48 overflow-y-auto">
                                            <div class="text-center py-6 px-3 text-slate-500 dark:text-slate-400">
                                                <svg class="w-10 h-10 mx-auto mb-1 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                                                <p class="text-xs">Vac칤o</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Total Compacto -->
                                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/30 p-3 sm:p-4 rounded-lg mb-3 border-2 border-green-300 dark:border-green-700">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm sm:text-base font-bold text-slate-700 dark:text-slate-200">TOTAL:</span>
                                            <span id="current-sale-total" class="text-2xl sm:text-3xl font-extrabold text-green-600 dark:text-green-400">$0.00</span>
                                        </div>
                                    </div>

                                    <!-- Forma de Pago (Botones grandes para m칩vil) -->
                                    <div class="bg-slate-50 dark:bg-slate-700/50 p-3 sm:p-4 rounded-lg mb-4">
                                        <h3 class="font-semibold mb-3 text-sm sm:text-base text-slate-700 dark:text-slate-300">Forma de Pago</h3>
                                        <div class="grid grid-cols-3 gap-2 mb-3" id="sale-payment-method">
                                            <label class="flex flex-col items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 sm:p-4 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-green-500 has-[:checked]:bg-green-50 dark:has-[:checked]:bg-green-900/30 transition active:scale-95">
                                                <input type="radio" name="sale-payment" value="efectivo" checked class="sr-only">
                                                <span class="text-2xl sm:text-3xl">游눳</span>
                                                <span class="text-xs sm:text-sm font-bold">Efectivo</span>
                                            </label>
                                            <label class="flex flex-col items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 sm:p-4 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition active:scale-95">
                                                <input type="radio" name="sale-payment" value="transferencia" class="sr-only">
                                                <span class="text-2xl sm:text-3xl">游낁</span>
                                                <span class="text-xs sm:text-sm font-bold">Transfer.</span>
                                            </label>
                                            <label class="flex flex-col items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 sm:p-4 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-orange-500 has-[:checked]:bg-orange-50 dark:has-[:checked]:bg-orange-900/30 transition active:scale-95">
                                                <input type="radio" name="sale-payment" value="credito" class="sr-only">
                                                <span class="text-2xl sm:text-3xl">游늶</span>
                                                <span class="text-xs sm:text-sm font-bold">Cr칠dito</span>
                                            </label>
                                        </div>
                                        <textarea id="sale-transfer-note" placeholder="Nota de transferencia / referencia" class="w-full p-3 text-base border-2 rounded-lg mt-2 hidden focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600" rows="2"></textarea>
                                    </div>

                                    <!-- Gesti칩n de Bidones Retornables -->
                                    <div id="containers-section" class="bg-slate-50 dark:bg-slate-700/50 p-3 sm:p-4 rounded-lg mb-4">
                                        <h3 class="font-semibold mb-3 text-sm sm:text-base text-slate-700 dark:text-slate-300 flex items-center gap-2">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                            Bidones Retornables
                                        </h3>

                                        <!-- Info de bidones prestados del cliente -->
                                        <div id="client-loaned-containers-info" class="hidden mb-3 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-300 dark:border-yellow-700">
                                            <div class="flex justify-between items-center">
                                                <span class="text-sm font-medium text-yellow-800 dark:text-yellow-200">Bidones prestados al cliente:</span>
                                                <span id="client-loaned-count" class="font-bold text-lg text-yellow-900 dark:text-yellow-100">0</span>
                                            </div>
                                        </div>

                                        <!-- Bidones vac칤os que devuelve el cliente -->
                                        <div class="space-y-2 mb-3">
                                            <label class="text-xs sm:text-sm font-medium text-slate-600 dark:text-slate-400">쮺liente devuelve bidones vac칤os?</label>
                                            <div class="flex items-center gap-3">
                                                <button type="button" onclick="changeReturnedContainers(-1)" class="bg-red-500 text-white w-10 h-10 rounded-lg hover:bg-red-600 active:scale-95 transition font-bold text-xl">-</button>
                                                <input type="number" id="returned-containers" value="0" min="0" onchange="checkUnreturnedContainers()" oninput="checkUnreturnedContainers()" class="w-20 p-3 text-center text-lg font-bold border-2 rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                                <button type="button" onclick="changeReturnedContainers(1)" class="bg-green-500 text-white w-10 h-10 rounded-lg hover:bg-green-600 active:scale-95 transition font-bold text-xl">+</button>
                                                <span class="text-xs text-slate-500 dark:text-slate-400">bidones vac칤os</span>
                                            </div>
                                        </div>

                                        <!-- Registro de bidones sin devolver (aparece autom치ticamente) -->
                                        <div id="unreturned-containers-section" class="hidden mb-3 p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg border-2 border-orange-300 dark:border-orange-700">
                                            <div class="flex items-center gap-2 mb-3">
                                                <svg class="w-5 h-5 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                                </svg>
                                                <h4 class="font-bold text-orange-900 dark:text-orange-100">Bidones Sin Devolver</h4>
                                            </div>
                                            <p class="text-xs text-orange-800 dark:text-orange-200 mb-3">
                                                El cliente est치 comprando <span id="unreturned-count" class="font-bold">0</span> bid칩n(es) sin devolver envases vac칤os. Registra cu치ndo debe devolverlos:
                                            </p>

                                            <!-- Fecha de devoluci칩n -->
                                            <div class="space-y-2 mb-3">
                                                <label class="text-sm font-medium text-orange-900 dark:text-orange-100">Fecha de devoluci칩n esperada:</label>
                                                <input type="date" id="unreturned-return-date" class="w-full p-2 border-2 border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 dark:bg-slate-700 dark:border-orange-600">
                                                <p class="text-xs text-orange-700 dark:text-orange-300">游눠 Sugerencia: 7 d칤as desde hoy</p>
                                            </div>

                                            <!-- Checkbox de comodato -->
                                            <div class="flex items-center gap-2">
                                                <input type="checkbox" id="unreturned-is-comodato" onchange="toggleUnreturnedComodato()" class="w-5 h-5 text-orange-600 border-orange-300 rounded focus:ring-orange-500">
                                                <label for="unreturned-is-comodato" class="text-sm font-medium text-orange-900 dark:text-orange-100 cursor-pointer">
                                                    Es comodato (pr칠stamo indefinido)
                                                </label>
                                            </div>
                                            <p class="text-xs text-orange-700 dark:text-orange-300 mt-1 ml-7">
                                                Si es comodato, no se requiere fecha de devoluci칩n
                                            </p>
                                        </div>

                                        <!-- Pr칠stamo de bidones llenos (opcional) -->
                                        <div class="space-y-2">
                                            <label class="text-xs sm:text-sm font-medium text-slate-600 dark:text-slate-400">쯇restar bidones llenos adicionales?</label>
                                            <div class="flex items-center gap-3">
                                                <button type="button" onclick="changeLoanedContainers(-1)" class="bg-red-500 text-white w-10 h-10 rounded-lg hover:bg-red-600 active:scale-95 transition font-bold text-xl">-</button>
                                                <input type="number" id="loan-containers" value="0" min="0" class="w-20 p-3 text-center text-lg font-bold border-2 rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                                <button type="button" onclick="changeLoanedContainers(1)" class="bg-green-500 text-white w-10 h-10 rounded-lg hover:bg-green-600 active:scale-95 transition font-bold text-xl">+</button>
                                                <span class="text-xs text-slate-500 dark:text-slate-400">bidones en pr칠stamo</span>
                                            </div>
                                            <p class="text-xs text-slate-500 dark:text-slate-400">
                                                游눠 Los bidones prestados requieren dep칩sito y se registrar치n a nombre del cliente
                                            </p>
                                            <div id="loan-limit-warning" class="hidden p-2 bg-red-50 dark:bg-red-900/20 border border-red-300 dark:border-red-700 rounded text-xs text-red-700 dark:text-red-300">
                                                丘멆잺 <span id="loan-limit-message"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Botones de Acci칩n (Extra grandes para m칩vil) -->
                                    <div class="grid grid-cols-3 gap-2">
                                        <button type="button" onclick="clearSaleCart()" class="bg-slate-200 active:bg-slate-300 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-bold py-4 px-2 rounded-lg shadow-md active:shadow-inner transition text-sm">
                                            游딈勇
                                            <span class="hidden sm:inline">Limpiar</span>
                                        </button>
                                        <button type="submit" class="col-span-2 bg-gradient-to-r from-green-600 to-green-700 active:from-green-700 active:to-green-800 text-white font-bold py-4 px-4 rounded-lg shadow-lg active:shadow-inner transition text-base sm:text-lg">
                                            游눱 Finalizar Venta
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- M칩dulo de Inventario del Cami칩n -->
                    <div id="seller-inventory" class="hidden">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md">
                            <h2 class="text-2xl font-bold mb-6 text-slate-900 dark:text-white flex items-center gap-2">
                                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                </svg>
                                游닍 Inventario del Cami칩n
                            </h2>

                            <div id="inventory-status-message" class="text-center py-8 text-slate-500 dark:text-slate-400">
                                <svg class="w-16 h-16 mx-auto mb-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                                </svg>
                                <p class="text-lg">Abra la caja para ver el inventario del veh칤culo</p>
                            </div>

                            <div id="inventory-content" class="hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    <div class="bg-gradient-to-br from-blue-500 to-blue-700 p-6 rounded-2xl shadow-xl text-white">
                                        <div class="flex items-center gap-2 mb-2">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <div class="text-sm opacity-90 font-medium">VEH칈CULO</div>
                                        </div>
                                        <div id="inventory-vehicle-name" class="text-2xl font-bold">-</div>
                                    </div>
                                    <div class="bg-gradient-to-br from-green-500 to-green-700 p-6 rounded-2xl shadow-xl text-white">
                                        <div class="flex items-center gap-2 mb-2">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                                            <div class="text-sm opacity-90 font-medium">TOTAL PRODUCTOS</div>
                                        </div>
                                        <div id="inventory-total-products" class="text-2xl font-bold">0</div>
                                    </div>
                                </div>

                                <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg mb-6">
                                    <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Filtrar por Estado</h3>
                                    <div class="flex flex-wrap gap-2">
                                        <button onclick="filterInventory('all')" class="inventory-filter-btn active px-4 py-2 rounded-lg bg-blue-600 text-white font-medium">Todos</button>
                                        <button onclick="filterInventory('low')" class="inventory-filter-btn px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-slate-300 font-medium">游댮 Stock Bajo (곣5)</button>
                                        <button onclick="filterInventory('medium')" class="inventory-filter-btn px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-slate-300 font-medium">游 Stock Medio (6-10)</button>
                                        <button onclick="filterInventory('good')" class="inventory-filter-btn px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-slate-300 font-medium">游릭 Stock Bueno (곤11)</button>
                                    </div>
                                </div>

                                <div id="inventory-products-list" class="space-y-3">
                                    <!-- Los productos se cargan din치micamente -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- M칩dulo de Clientes -->
                    <div id="seller-clients" class="hidden">
                        <!-- Pesta침as -->
                        <div class="bg-white dark:bg-slate-800 p-2 rounded-xl shadow-md mb-4">
                            <div class="flex gap-2" id="clients-tabs">
                                <button data-tab="create-client" class="tab-button flex-1 py-3 px-4 rounded-lg font-semibold text-sm sm:text-base transition bg-blue-600 text-white">
                                    俱 Crear Cliente
                                </button>
                                <button data-tab="list-clients" class="tab-button flex-1 py-3 px-4 rounded-lg font-semibold text-sm sm:text-base transition bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300">
                                    游늶 Listado
                                </button>
                            </div>
                        </div>

                        <!-- Crear Cliente -->
                        <div id="create-client" class="tab-content">
                            <div class="bg-white dark:bg-slate-800 p-3 sm:p-6 rounded-xl shadow-md">
                                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                    Nuevo Cliente
                                </h2>

                                <form id="add-client-form" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                                    <!-- Tipo de Cliente -->
                                    <div class="bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg">
                                        <label class="text-sm font-semibold text-slate-700 dark:text-slate-300 block mb-2">Tipo de Cliente</label>
                                        <div id="client-form-type-selector" class="grid grid-cols-2 gap-2">
                                            <label class="flex items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                                <input type="radio" name="client-form-type" value="consumidor-final" checked class="w-5 h-5 text-blue-600">
                                                <span class="text-sm font-medium">游녻 Consumidor Final</span>
                                            </label>
                                            <label class="flex items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                                <input type="radio" name="client-form-type" value="negocio" class="w-5 h-5 text-blue-600">
                                                <span class="text-sm font-medium">游끽 Negocio</span>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- INFORMACI칍N B츼SICA -->
                                    <div class="space-y-3">
                                        <h3 class="text-sm font-bold text-blue-600 dark:text-blue-400 uppercase tracking-wide">游늶 Informaci칩n B치sica</h3>

                                        <div>
                                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Nombre del Cliente *</label>
                                            <input type="text" id="client-name-input" placeholder="Ej: Juan P칠rez" required class="w-full p-3 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                        </div>

                                        <div id="business-name-field" class="hidden">
                                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Nombre del Negocio</label>
                                            <input type="text" id="client-business-name" placeholder="Ej: Tienda La Esperanza" class="w-full p-3 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                        </div>

                                        <div>
                                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Tel칠fono</label>
                                            <input type="tel" id="client-phone" placeholder="Ej: 0999999999" class="w-full p-3 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                        </div>
                                    </div>

                                    <!-- UBICACI칍N ECUADOR -->
                                    <div class="space-y-3">
                                        <h3 class="text-sm font-bold text-green-600 dark:text-green-400 uppercase tracking-wide">游늸 Ubicaci칩n</h3>

                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Provincia *</label>
                                                <select id="client-province" required class="w-full p-3 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                                    <option value="">Seleccione...</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Cant칩n</label>
                                                <input type="text" id="client-canton" placeholder="Cant칩n" class="w-full p-3 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Parroquia</label>
                                                <input type="text" id="client-parish" placeholder="Parroquia" class="w-full p-3 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                            </div>
                                            <div>
                                                <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Sector/Barrio</label>
                                                <input type="text" id="client-sector" placeholder="Sector o barrio" class="w-full p-3 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                            </div>
                                        </div>

                                        <div>
                                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Direcci칩n Completa</label>
                                            <textarea id="client-address" placeholder="Calle principal, n칰mero, referencias..." rows="2" class="w-full p-3 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600"></textarea>
                                        </div>

                                        <!-- Ubicaci칩n GPS -->
                                        <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-200 dark:border-blue-800">
                                            <label class="text-xs font-semibold text-slate-700 dark:text-slate-300 block mb-2">Coordenadas GPS</label>
                                            <div class="flex gap-2 mb-2">
                                                <input type="text" id="client-latitude" placeholder="Latitud" readonly class="flex-1 p-2 border rounded-lg bg-slate-100 dark:bg-slate-700 dark:border-slate-600 text-sm">
                                                <input type="text" id="client-longitude" placeholder="Longitud" readonly class="flex-1 p-2 border rounded-lg bg-slate-100 dark:bg-slate-700 dark:border-slate-600 text-sm">
                                            </div>
                                            <button type="button" onclick="getClientLocation()" class="w-full bg-blue-600 text-white font-semibold py-2 px-3 rounded-lg text-sm">
                                                游늸 Capturar Ubicaci칩n GPS
                                            </button>
                                        </div>
                                    </div>

                                    <!-- PRODUCTOS PREDETERMINADOS -->
                                    <div class="space-y-3">
                                        <h3 class="text-sm font-bold text-purple-600 dark:text-purple-400 uppercase tracking-wide">游 Productos que Consume</h3>
                                        <div id="client-default-products" class="space-y-2">
                                            <!-- Se llenar치 din치micamente -->
                                        </div>
                                    </div>

                                    <!-- PLANIFICACI칍N DE VISITAS -->
                                    <div class="space-y-3">
                                        <h3 class="text-sm font-bold text-orange-600 dark:text-orange-400 uppercase tracking-wide">游늰 Planificaci칩n de Visitas</h3>

                                        <div>
                                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300 block mb-2">D칤as de Visita</label>
                                            <div class="grid grid-cols-7 gap-1">
                                                <label class="flex flex-col items-center p-2 border-2 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 dark:has-[:checked]:bg-blue-900/30">
                                                    <input type="checkbox" name="visit-days" value="L" class="mb-1">
                                                    <span class="text-xs font-bold">L</span>
                                                </label>
                                                <label class="flex flex-col items-center p-2 border-2 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 dark:has-[:checked]:bg-blue-900/30">
                                                    <input type="checkbox" name="visit-days" value="M" class="mb-1">
                                                    <span class="text-xs font-bold">M</span>
                                                </label>
                                                <label class="flex flex-col items-center p-2 border-2 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 dark:has-[:checked]:bg-blue-900/30">
                                                    <input type="checkbox" name="visit-days" value="X" class="mb-1">
                                                    <span class="text-xs font-bold">X</span>
                                                </label>
                                                <label class="flex flex-col items-center p-2 border-2 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 dark:has-[:checked]:bg-blue-900/30">
                                                    <input type="checkbox" name="visit-days" value="J" class="mb-1">
                                                    <span class="text-xs font-bold">J</span>
                                                </label>
                                                <label class="flex flex-col items-center p-2 border-2 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 dark:has-[:checked]:bg-blue-900/30">
                                                    <input type="checkbox" name="visit-days" value="V" class="mb-1">
                                                    <span class="text-xs font-bold">V</span>
                                                </label>
                                                <label class="flex flex-col items-center p-2 border-2 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 dark:has-[:checked]:bg-blue-900/30">
                                                    <input type="checkbox" name="visit-days" value="S" class="mb-1">
                                                    <span class="text-xs font-bold">S</span>
                                                </label>
                                                <label class="flex flex-col items-center p-2 border-2 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 dark:has-[:checked]:bg-blue-900/30">
                                                    <input type="checkbox" name="visit-days" value="D" class="mb-1">
                                                    <span class="text-xs font-bold">D</span>
                                                </label>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Horario</label>
                                                <select id="client-visit-time" class="w-full p-3 border-2 rounded-lg mt-1 dark:bg-slate-700 dark:border-slate-600">
                                                    <option value="">Sin preferencia</option>
                                                    <option value="ma침ana">游깬 Ma침ana (8:00-12:00)</option>
                                                    <option value="tarde">驕勇 Tarde (12:00-18:00)</option>
                                                    <option value="noche">游깿 Noche (18:00-21:00)</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Frecuencia</label>
                                                <select id="client-visit-frequency" class="w-full p-3 border-2 rounded-lg mt-1 dark:bg-slate-700 dark:border-slate-600">
                                                    <option value="diario">Diario</option>
                                                    <option value="semanal" selected>Semanal</option>
                                                    <option value="quincenal">Quincenal</option>
                                                    <option value="mensual">Mensual</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- INFORMACI칍N ADICIONAL -->
                                    <div class="space-y-3">
                                        <h3 class="text-sm font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wide">游닇 Informaci칩n Adicional</h3>

                                        <div>
                                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Notas y Observaciones</label>
                                            <textarea id="client-notes" placeholder="Preferencias, alertas especiales, etc..." rows="3" class="w-full p-3 border-2 rounded-lg mt-1 dark:bg-slate-700 dark:border-slate-600"></textarea>
                                        </div>
                                    </div>

                                    <!-- Botones -->
                                    <div class="flex gap-2">
                                        <button type="reset" class="flex-1 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-bold py-3 px-4 rounded-lg active:bg-slate-300 dark:active:bg-slate-600 transition">
                                            Limpiar
                                        </button>
                                        <button type="submit" class="flex-[2] bg-gradient-to-r from-green-600 to-green-700 active:from-green-700 active:to-green-800 text-white font-bold py-3 px-4 rounded-lg shadow-lg active:shadow-inner transition">
                                            游 Guardar Cliente
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Listado de Clientes -->
                        <div id="list-clients" class="tab-content hidden">
                            <div class="bg-white dark:bg-slate-800 p-3 sm:p-6 rounded-xl shadow-md">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-xl sm:text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                        <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                        Clientes
                                    </h2>
                                    <span id="clients-count" class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-3 py-1 rounded-full text-sm font-bold">0</span>
                                </div>

                                <!-- B칰squeda -->
                                <div class="mb-4">
                                    <input type="text" id="search-clients" placeholder="游댌 Buscar por nombre, negocio o tel칠fono..." class="w-full p-3 sm:p-4 text-base border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                </div>

                                <!-- Lista de Clientes -->
                                <div id="clients-list-container" class="space-y-2">
                                    <p class="text-center py-8 text-slate-500 dark:text-slate-400">No hay clientes registrados</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- M칍DULO DE BIDONES PRESTADOS -->
                    <div id="seller-loaned-containers" class="hidden">
                        <div class="space-y-6">
                            <!-- Encabezado -->
                            <div class="bg-gradient-to-r from-blue-600 to-indigo-700 p-6 rounded-xl shadow-lg text-white">
                                <h2 class="text-3xl font-bold mb-2 flex items-center gap-3">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                    </svg>
                                    Bidones Prestados
                                </h2>
                                <p class="text-blue-100">Control de bidones retornables prestados a clientes</p>
                            </div>

                            <!-- Resumen de Bidones Prestados -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div class="bg-blue-100 dark:bg-blue-900/30 p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-blue-600 dark:text-blue-400 font-semibold">Total Prestados</p>
                                            <p class="text-2xl font-bold text-blue-900 dark:text-blue-100" id="total-loaned-containers">0</p>
                                        </div>
                                        <svg class="w-12 h-12 text-blue-600 dark:text-blue-400 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                        </svg>
                                    </div>
                                </div>

                                <div class="bg-green-100 dark:bg-green-900/30 p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-green-600 dark:text-green-400 font-semibold">Devueltos Hoy</p>
                                            <p class="text-2xl font-bold text-green-900 dark:text-green-100" id="returned-today-containers">0</p>
                                        </div>
                                        <svg class="w-12 h-12 text-green-600 dark:text-green-400 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>

                                <div class="bg-yellow-100 dark:bg-yellow-900/30 p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-yellow-600 dark:text-yellow-400 font-semibold">Prestados Hoy</p>
                                            <p class="text-2xl font-bold text-yellow-900 dark:text-yellow-100" id="loaned-today-containers">0</p>
                                        </div>
                                        <svg class="w-12 h-12 text-yellow-600 dark:text-yellow-400 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                                        </svg>
                                    </div>
                                </div>

                                <div class="bg-purple-100 dark:bg-purple-900/30 p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-purple-600 dark:text-purple-400 font-semibold">Clientes con Bidones</p>
                                            <p class="text-2xl font-bold text-purple-900 dark:text-purple-100" id="clients-with-containers">0</p>
                                        </div>
                                        <svg class="w-12 h-12 text-purple-600 dark:text-purple-400 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <!-- Filtros -->
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-md">
                                <div class="flex flex-col sm:flex-row gap-3">
                                    <div class="flex-1">
                                        <input type="text" id="loaned-client-search" placeholder="游댌 Buscar por cliente..." class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" onkeyup="filterLoanedContainers()">
                                    </div>
                                    <select id="loaned-status-filter" class="p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" onchange="filterLoanedContainers()">
                                        <option value="all">Todos</option>
                                        <option value="active">Activos</option>
                                        <option value="returned">Devueltos</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Lista de Bidones Prestados Activos -->
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                                <h3 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                    </svg>
                                    Bidones Prestados a Clientes
                                </h3>

                                <div class="overflow-x-auto">
                                    <table class="min-w-full">
                                        <thead class="bg-slate-50 dark:bg-slate-700">
                                            <tr>
                                                <th class="py-3 px-4 text-left text-xs font-semibold">Fecha Pr칠stamo</th>
                                                <th class="py-3 px-4 text-left text-xs font-semibold">Cliente</th>
                                                <th class="py-3 px-4 text-left text-xs font-semibold">Cantidad</th>
                                                <th class="py-3 px-4 text-left text-xs font-semibold">D칤as Prestado</th>
                                                <th class="py-3 px-4 text-left text-xs font-semibold">Estado</th>
                                                <th class="py-3 px-4 text-left text-xs font-semibold">Fecha Devoluci칩n</th>
                                            </tr>
                                        </thead>
                                        <tbody id="loaned-containers-list" class="divide-y divide-slate-200 dark:divide-slate-700">
                                            <!-- Se llenar치 din치micamente -->
                                        </tbody>
                                    </table>
                                </div>

                                <div id="loaned-containers-empty" class="hidden text-center py-8 text-slate-500 dark:text-slate-400">
                                    <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                    </svg>
                                    <p class="text-lg font-semibold">No hay bidones prestados</p>
                                    <p class="text-sm mt-2">Los bidones se prestan autom치ticamente al realizar ventas</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="seller-credit-accounts" class="hidden">
                        <!-- Resumen de Cuentas por Cobrar -->
                        <div class="bg-gradient-to-r from-orange-600 to-red-700 p-4 sm:p-6 rounded-xl shadow-lg text-white mb-6">
                            <h2 class="text-xl sm:text-2xl font-bold mb-4 flex items-center gap-2">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                Cuentas por Cobrar
                            </h2>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Total Por Cobrar</div>
                                    <div id="credit-total-pending" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                    <div id="credit-accounts-count" class="text-xs opacity-75">0 cuentas</div>
                                </div>
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Ventas a Cr칠dito</div>
                                    <div id="credit-total-sales" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                </div>
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Abonos Recibidos</div>
                                    <div id="credit-total-payments" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                </div>
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Cuentas Saldadas</div>
                                    <div id="credit-paid-count" class="text-2xl sm:text-3xl font-bold">0</div>
                                </div>
                            </div>
                        </div>

                        <!-- B칰squeda y Filtros -->
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-md mb-4">
                            <div class="flex flex-col sm:flex-row gap-3">
                                <div class="flex-1">
                                    <input type="text" id="credit-client-search" placeholder="游댌 Buscar por cliente..." class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                </div>
                                <select id="credit-status-filter" class="p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                    <option value="all">Todas las cuentas</option>
                                    <option value="pending">Solo pendientes</option>
                                    <option value="paid">Solo saldadas</option>
                                </select>
                            </div>
                        </div>

                        <!-- Lista de Cuentas -->
                        <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-md">
                            <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Detalle de Cuentas</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead class="bg-slate-50 dark:bg-slate-700">
                                        <tr>
                                            <th class="py-3 px-4 text-left text-xs font-semibold">Fecha</th>
                                            <th class="py-3 px-4 text-left text-xs font-semibold">Cliente</th>
                                            <th class="py-3 px-4 text-left text-xs font-semibold">Total Venta</th>
                                            <th class="py-3 px-4 text-left text-xs font-semibold">Abonado</th>
                                            <th class="py-3 px-4 text-left text-xs font-semibold">Saldo</th>
                                            <th class="py-3 px-4 text-left text-xs font-semibold">Estado</th>
                                            <th class="py-3 px-4 text-left text-xs font-semibold">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="credit-sales-list" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="seller-collections" class="hidden">
                        <!-- Resumen de Ingresos Adicionales -->
                        <div class="bg-gradient-to-r from-cyan-600 to-blue-700 p-4 sm:p-6 rounded-xl shadow-lg text-white mb-6">
                            <h2 class="text-xl sm:text-2xl font-bold mb-4 flex items-center gap-2">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Ingresos Adicionales
                            </h2>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 sm:gap-4">
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Total del D칤a</div>
                                    <div id="collections-today-total" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                    <div id="collections-today-count" class="text-xs opacity-75">0 ingresos</div>
                                </div>
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Total del Mes</div>
                                    <div id="collections-month-total" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                </div>
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Mayor Ingreso</div>
                                    <div id="collections-max" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Formulario de Registro -->
                            <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-md">
                                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                    Registrar Nuevo Ingreso
                                </h3>
                                <form id="add-collection-form" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Origen del Ingreso</label>
                                        <input type="text" id="collection-client-name" placeholder="Ej: Devoluci칩n, Bonificaci칩n, etc." class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Monto</label>
                                        <input type="number" id="collection-amount" placeholder="0.00" min="0" step="0.01" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Descripci칩n / Raz칩n</label>
                                        <textarea id="collection-reason" placeholder="Describe el motivo del ingreso..." class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" rows="3" required></textarea>
                                    </div>
                                    <button type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg transition flex items-center justify-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                        Registrar Ingreso
                                    </button>
                                </form>
                            </div>

                            <!-- Historial de Ingresos del D칤a -->
                            <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-md">
                                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                                    Historial del D칤a
                                </h3>
                                <div id="collections-today-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>
                    <div id="seller-expenses" class="hidden">
                        <!-- Resumen de Gastos -->
                        <div class="bg-gradient-to-r from-red-600 to-pink-700 p-4 sm:p-6 rounded-xl shadow-lg text-white mb-6">
                            <h2 class="text-xl sm:text-2xl font-bold mb-4 flex items-center gap-2">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 0a3 3 0 110 6H9l3 3m-3-6h6m6 1a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Gastos
                            </h2>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Total del D칤a</div>
                                    <div id="expenses-today-total" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                    <div id="expenses-today-count" class="text-xs opacity-75">0 gastos</div>
                                </div>
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Efectivo</div>
                                    <div id="expenses-cash-total" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                </div>
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Transfer./Cr칠d.</div>
                                    <div id="expenses-other-total" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                </div>
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Mayor Gasto</div>
                                    <div id="expenses-max" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Formulario de Registro -->
                            <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-md">
                                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                    Registrar Nuevo Gasto
                                </h3>
                                <form id="add-expense-form" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Tipo de Gasto</label>
                                        <select id="expense-category-selector" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                                            <option value="">Seleccione un tipo de gasto</option>
                                        </select>
                                    </div>

                                    <!-- Formulario Normal de Gastos -->
                                    <div id="normal-expense-fields">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Monto</label>
                                            <input type="number" id="expense-amount" placeholder="0.00" min="0" step="0.01" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Observaciones (opcional)</label>
                                            <textarea id="expense-observations" placeholder="Detalles adicionales..." class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" rows="3"></textarea>
                                        </div>
                                    </div>

                                    <!-- Formulario Especial de Compra de Productos -->
                                    <div id="product-purchase-fields" class="hidden space-y-4">
                                        <!-- Buscador de Productos -->
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Buscar Producto</label>
                                            <div class="relative">
                                                <input type="text" id="purchase-product-search" placeholder="Escriba el nombre del producto..." class="w-full p-2 pr-10 border rounded-lg dark:bg-slate-700 dark:border-slate-600" autocomplete="off">
                                                <svg class="w-5 h-5 absolute right-3 top-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                                </svg>
                                            </div>
                                            <!-- Resultados de b칰squeda -->
                                            <div id="purchase-search-results" class="mt-2 max-h-48 overflow-y-auto hidden"></div>
                                        </div>

                                        <!-- Carrito de Compra -->
                                        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                                            <h4 class="font-bold mb-3 text-blue-900 dark:text-blue-100">Productos a Comprar</h4>
                                            <div id="purchase-cart-items" class="space-y-2 mb-4">
                                                <p class="text-sm text-slate-500 dark:text-slate-400 text-center py-4">No hay productos agregados</p>
                                            </div>
                                            <div id="purchase-total-display" class="hidden border-t border-blue-200 dark:border-blue-700 pt-3 mt-3">
                                                <div class="flex justify-between items-center text-lg font-bold">
                                                    <span>TOTAL A PAGAR:</span>
                                                    <span id="purchase-total-amount" class="text-blue-600 dark:text-blue-400">$0.00</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-medium mb-1">N칰mero de Factura/Recibo</label>
                                            <input type="text" id="invoice-number" placeholder="Ej: FAC-001" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Observaciones (opcional)</label>
                                            <textarea id="purchase-observations" placeholder="Detalles adicionales..." class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" rows="2"></textarea>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Forma de Pago</label>
                                        <div class="flex flex-col sm:flex-row gap-3">
                                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                                                <input type="radio" name="expense-payment" value="efectivo" checked class="text-blue-600">
                                                <span>游눳 Efectivo</span>
                                            </label>
                                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                                                <input type="radio" name="expense-payment" value="transferencia" class="text-blue-600">
                                                <span>游눱 Transferencia</span>
                                            </label>
                                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                                                <input type="radio" name="expense-payment" value="credito" class="text-blue-600">
                                                <span>游낁 Cr칠dito</span>
                                            </label>
                                        </div>
                                    </div>
                                    <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition flex items-center justify-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                        Registrar Gasto
                                    </button>
                                </form>
                            </div>

                            <!-- Historial de Gastos del D칤a -->
                            <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-md">
                                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                                    Gastos del D칤a
                                </h3>
                                <div id="expenses-today-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
                            </div>
                        </div>

                        <!-- Resumen por Categor칤a -->
                        <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-md mt-6">
                            <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Gastos por Categor칤a (Hoy)</h3>
                            <div id="expenses-by-category" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                        </div>
                    </div>

                    <!-- M칩dulo de P칠rdidas/Da침os -->
                    <div id="seller-losses" class="hidden">
                        <div class="bg-gradient-to-r from-yellow-600 to-orange-700 p-4 sm:p-6 rounded-xl shadow-lg text-white mb-6">
                            <h2 class="text-xl sm:text-2xl font-bold mb-2 flex items-center gap-2">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                Reporte de P칠rdidas y Da침os
                            </h2>
                            <p class="text-yellow-100">Reporta productos perdidos, da침ados o extraviados para aprobaci칩n del administrador</p>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Formulario de Reporte -->
                            <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-md">
                                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                    Reportar Nueva P칠rdida/Da침o
                                </h3>

                                <form id="add-loss-form" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Producto Afectado *</label>
                                        <select id="loss-product" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-yellow-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                                            <option value="">Seleccionar producto...</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Cantidad *</label>
                                        <input type="number" id="loss-quantity" placeholder="0" min="1" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-yellow-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Tipo de Incidente *</label>
                                        <select id="loss-type" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-yellow-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                                            <option value="">Seleccionar...</option>
                                            <option value="perdida">P칠rdida/Extrav칤o</option>
                                            <option value="rotura">Rotura/Da침o</option>
                                            <option value="robo">Robo</option>
                                            <option value="vencimiento">Vencimiento</option>
                                            <option value="otro">Otro</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Descripci칩n del Incidente *</label>
                                        <textarea id="loss-description" placeholder="Describa qu칠 sucedi칩..." class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-yellow-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" rows="4" required></textarea>
                                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Sea lo m치s espec칤fico posible. Esta informaci칩n ser치 revisada por el administrador.</p>
                                    </div>

                                    <div class="bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded-lg border border-yellow-300 dark:border-yellow-700">
                                        <p class="text-sm text-yellow-800 dark:text-yellow-200 flex items-start gap-2">
                                            <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span>El reporte ser치 enviado al administrador para su revisi칩n. El inventario se ajustar치 una vez aprobado.</span>
                                        </p>
                                    </div>

                                    <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition">
                                        Enviar Reporte para Aprobaci칩n
                                    </button>
                                </form>
                            </div>

                            <!-- Historial de Reportes -->
                            <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-md">
                                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Mis Reportes</h3>

                                <div class="space-y-3 max-h-96 overflow-y-auto" id="losses-list">
                                    <p class="text-center py-8 text-slate-500 dark:text-slate-400">No hay reportes</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- M칩dulo de Transferencias -->
                    <div id="seller-transfers" class="hidden">
                        <div class="bg-gradient-to-r from-blue-600 to-purple-700 p-4 sm:p-6 rounded-xl shadow-lg text-white mb-6">
                            <h2 class="text-xl sm:text-2xl font-bold mb-2 flex items-center gap-2">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                </svg>
                                Transferencias de Inventario
                            </h2>
                            <p class="text-blue-100">Solicita transferencias de productos entre veh칤culos</p>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Formulario de Solicitud -->
                            <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-md">
                                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                    Solicitar Nueva Transferencia
                                </h3>

                                <form id="add-transfer-form" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Veh칤culo Origen *</label>
                                        <select id="transfer-from-vehicle" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                                            <option value="">Seleccionar veh칤culo origen...</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Veh칤culo Destino *</label>
                                        <select id="transfer-to-vehicle" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                                            <option value="">Seleccionar veh칤culo destino...</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Producto *</label>
                                        <select id="transfer-product" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required>
                                            <option value="">Seleccionar producto...</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Cantidad *</label>
                                        <input type="number" id="transfer-quantity" min="1" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="Ej: 10" required>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Motivo de la Transferencia *</label>
                                        <textarea id="transfer-reason" rows="3" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="Describe el motivo de esta transferencia..." required></textarea>
                                    </div>

                                    <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-md">
                                        Solicitar Transferencia
                                    </button>
                                </form>
                            </div>

                            <!-- Historial de Solicitudes -->
                            <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-md">
                                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Mis Solicitudes
                                </h3>
                                <div class="space-y-3 max-h-96 overflow-y-auto" id="transfers-list">
                                    <p class="text-center py-8 text-slate-500 dark:text-slate-400">No hay transferencias registradas</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="seller-cash-closure" class="hidden">
                        <div class="space-y-4 sm:space-y-6">
                            <!-- Meta Diaria -->
                            <div id="closure-daily-goal-container" class="bg-gradient-to-r from-blue-600 to-indigo-700 p-4 sm:p-6 rounded-xl shadow-lg text-white">
                                <h2 class="text-xl sm:text-2xl font-bold mb-4 flex items-center gap-2">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path></svg>
                                    Meta Diaria
                                </h2>
                                <div id="closure-daily-goal-content" class="space-y-3">
                                    <div class="text-center py-4 opacity-90">
                                        <div class="text-sm">Cargando informaci칩n de meta...</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Top Productos del D칤a -->
                            <div class="bg-white dark:bg-slate-800 p-3 sm:p-6 rounded-xl shadow-md">
                                <h3 class="text-lg sm:text-xl font-bold mb-3 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                    Productos M치s Vendidos
                                </h3>
                                <div id="closure-top-products" class="space-y-2">
                                    <p class="text-center text-slate-500 dark:text-slate-400 py-4 text-sm">No hay datos disponibles</p>
                                </div>
                            </div>

                            <!-- Cierre de Caja -->
                            <div class="bg-white dark:bg-slate-800 p-3 sm:p-6 rounded-xl shadow-md">
                                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Cierre de Caja
                                </h2>

                                <!-- Movimientos de Efectivo -->
                                <div class="space-y-2 mb-4">
                                    <h3 class="font-semibold text-sm text-slate-600 dark:text-slate-400 mb-2">游눯 Movimientos de Efectivo</h3>
                                    <div class="flex justify-between items-center p-2 sm:p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                                        <span class="text-sm sm:text-base font-medium">Apertura:</span>
                                        <span id="closure-opening-balance" class="font-bold text-blue-600 dark:text-blue-400">$0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center p-2 sm:p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                                        <span class="text-sm sm:text-base font-medium">+ Ventas Efectivo:</span>
                                        <span id="closure-cash-sales" class="font-bold text-green-600 dark:text-green-400">$0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center p-2 sm:p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                                        <span class="text-sm sm:text-base font-medium">+ Cobros:</span>
                                        <span id="closure-collections" class="font-bold text-green-600 dark:text-green-400">$0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center p-2 sm:p-3 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800">
                                        <span class="text-sm sm:text-base font-medium">- Gastos Efectivo:</span>
                                        <span id="closure-cash-expenses" class="font-bold text-red-600 dark:text-red-400">$0.00</span>
                                    </div>
                                </div>

                                <!-- Conteo F칤sico -->
                                <div class="mb-4">
                                    <label class="font-semibold text-sm sm:text-base text-slate-700 dark:text-slate-300 mb-2 block">游댝 Efectivo F칤sico Contado:</label>
                                    <input type="number" id="closure-physical-cash" placeholder="0.00" min="0" step="0.01" class="w-full p-3 sm:p-4 text-lg border-2 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-slate-700 dark:border-slate-600 font-bold text-center">
                                </div>

                                <!-- Efectivo Esperado (Oculto hasta el cierre) -->
                                <div id="closure-expected-section" class="hidden bg-gradient-to-r from-purple-50 to-indigo-50 dark:from-purple-900/30 dark:to-indigo-900/30 p-4 rounded-xl border-2 border-purple-300 dark:border-purple-700 mb-4">
                                    <div class="flex justify-between items-center">
                                        <span class="font-bold text-base sm:text-lg text-slate-700 dark:text-slate-200">游눳 Efectivo Esperado:</span>
                                        <span id="closure-expected-cash" class="font-extrabold text-xl sm:text-2xl text-purple-600 dark:text-purple-400">$0.00</span>
                                    </div>
                                </div>

                                <!-- Diferencia (Oculta hasta el cierre) -->
                                <div id="closure-difference-section" class="hidden flex justify-between items-center p-3 sm:p-4 rounded-xl bg-yellow-50 dark:bg-yellow-900/30 border-2 border-yellow-300 dark:border-yellow-700 mb-4">
                                    <span class="font-bold text-base sm:text-lg text-yellow-800 dark:text-yellow-300">丘뒲잺 Diferencia:</span>
                                    <span id="closure-difference" class="font-bold text-xl sm:text-2xl text-yellow-800 dark:text-yellow-300">$0.00</span>
                                </div>

                                <!-- Valores Informativos -->
                                <div class="bg-slate-50 dark:bg-slate-700/50 p-3 sm:p-4 rounded-lg border border-slate-200 dark:border-slate-600">
                                    <p class="font-semibold text-xs sm:text-sm text-slate-600 dark:text-slate-400 mb-2">游늵 Valores Informativos (no afectan efectivo):</p>
                                    <div class="space-y-1.5 text-sm">
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-600 dark:text-slate-400">Ventas a Cr칠dito:</span>
                                            <span id="closure-credit-sales" class="font-semibold text-orange-600 dark:text-orange-400">$0.00</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-600 dark:text-slate-400">Ventas por Transferencia:</span>
                                            <span id="closure-transfer-sales" class="font-semibold text-blue-600 dark:text-blue-400">$0.00</span>
                                        </div>
                                        <div class="flex justify-between items-center pt-2 border-t border-slate-300 dark:border-slate-600">
                                            <span class="text-slate-600 dark:text-slate-400 font-semibold">Total General del D칤a:</span>
                                            <span id="closure-total-day" class="font-bold text-lg text-slate-800 dark:text-slate-200">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Estad칤sticas del D칤a -->
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3">
                                <div class="bg-white dark:bg-slate-800 p-3 rounded-lg shadow-md text-center border border-slate-200 dark:border-slate-700">
                                    <div class="text-2xl mb-1">游닍</div>
                                    <div class="text-xs text-slate-600 dark:text-slate-400">Total Ventas</div>
                                    <div id="stats-total-sales" class="text-lg font-bold text-slate-800 dark:text-slate-200">0</div>
                                </div>
                                <div class="bg-white dark:bg-slate-800 p-3 rounded-lg shadow-md text-center border border-slate-200 dark:border-slate-700">
                                    <div class="text-2xl mb-1">游늶</div>
                                    <div class="text-xs text-slate-600 dark:text-slate-400">Productos</div>
                                    <div id="stats-total-items" class="text-lg font-bold text-slate-800 dark:text-slate-200">0</div>
                                </div>
                                <div class="bg-white dark:bg-slate-800 p-3 rounded-lg shadow-md text-center border border-slate-200 dark:border-slate-700">
                                    <div class="text-2xl mb-1">游눶</div>
                                    <div class="text-xs text-slate-600 dark:text-slate-400">Gastos</div>
                                    <div id="stats-total-expenses" class="text-lg font-bold text-red-600 dark:text-red-400">0</div>
                                </div>
                                <div class="bg-white dark:bg-slate-800 p-3 rounded-lg shadow-md text-center border border-slate-200 dark:border-slate-700">
                                    <div class="text-2xl mb-1">游눯</div>
                                    <div class="text-xs text-slate-600 dark:text-slate-400">Cobros</div>
                                    <div id="stats-total-collections" class="text-lg font-bold text-green-600 dark:text-green-400">0</div>
                                </div>
                            </div>

                            <!-- Inventario Final del Veh칤culo -->
                            <div class="bg-white dark:bg-slate-800 p-4 sm:p-6 rounded-xl shadow-md">
                                <h3 class="text-lg sm:text-xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                                    Inventario Final del Veh칤culo
                                </h3>
                                <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">Ingrese las cantidades f칤sicas actuales en el veh칤culo:</p>

                                <div id="closing-inventory-list" class="space-y-3 max-h-96 overflow-y-auto mb-4">
                                    <!-- Se llenar치 din치micamente -->
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                                    <div>
                                        <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Kilometraje Final</label>
                                        <input type="number" id="closing-km" placeholder="0" min="0" class="w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-purple-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">KM Inicial: <span id="display-opening-km">0</span></p>
                                    </div>
                                    <div class="flex items-end">
                                        <button type="button" onclick="calculateInventoryDifferences()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">
                                            Calcular Diferencias
                                        </button>
                                    </div>
                                </div>

                                <!-- Resumen de Diferencias de Inventario -->
                                <div id="inventory-differences-section" class="hidden mt-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border-2 border-yellow-300 dark:border-yellow-700">
                                    <h4 class="font-bold text-lg mb-3 text-yellow-900 dark:text-yellow-200">丘멆잺 Diferencias de Inventario</h4>
                                    <div id="inventory-differences-list" class="space-y-2 text-sm">
                                        <!-- Se llenar치 din치micamente -->
                                    </div>
                                </div>
                            </div>

                            <!-- Bot칩n de Cierre -->
                            <button onclick="closeCashRegister()" id="btn-close-cash" class="w-full bg-gradient-to-r from-red-600 to-red-700 active:from-red-700 active:to-red-800 text-white font-bold py-4 px-6 rounded-xl shadow-lg active:shadow-inner transition text-base sm:text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                游 Cerrar Caja y Generar Reporte
                            </button>
                        </div>
                    </div>
                    <div id="seller-reports" class="hidden">
                        <div class="space-y-4 sm:space-y-6">
                            <!-- Resumen de Ventas de Hoy -->
                            <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-4 sm:p-6 rounded-xl shadow-lg text-white">
                                <h2 class="text-xl sm:text-2xl font-bold mb-4 flex items-center gap-2">
                                    <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                                    Resumen del D칤a
                                </h2>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
                                    <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                        <div class="text-xs sm:text-sm opacity-90">Total Ventas</div>
                                        <div id="today-total-sales" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                        <div id="today-sales-count" class="text-xs opacity-75">0 ventas</div>
                                    </div>
                                    <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                        <div class="text-xs sm:text-sm opacity-90">游눳 Efectivo</div>
                                        <div id="today-cash-sales" class="text-xl sm:text-2xl font-bold">$0.00</div>
                                    </div>
                                    <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                        <div class="text-xs sm:text-sm opacity-90">游낁 Transfer.</div>
                                        <div id="today-transfer-sales" class="text-xl sm:text-2xl font-bold">$0.00</div>
                                    </div>
                                    <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                        <div class="text-xs sm:text-sm opacity-90">游늶 Cr칠dito</div>
                                        <div id="today-credit-sales" class="text-xl sm:text-2xl font-bold">$0.00</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Ventas de Hoy - Lista Detallada -->
                            <div class="bg-white dark:bg-slate-800 p-3 sm:p-6 rounded-xl shadow-md">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg sm:text-xl font-bold text-slate-900 dark:text-white">Ventas de Hoy</h3>
                                    <select id="today-payment-filter" class="p-2 border-2 rounded-lg text-sm dark:bg-slate-700 dark:border-slate-600">
                                        <option value="">Todos los m칠todos</option>
                                        <option value="efectivo">游눳 Efectivo</option>
                                        <option value="transferencia">游낁 Transferencia</option>
                                        <option value="credito">游늶 Cr칠dito</option>
                                    </select>
                                </div>
                                <div id="today-sales-list" class="space-y-2 max-h-96 overflow-y-auto">
                                    <p class="text-center text-slate-500 dark:text-slate-400 py-6 sm:py-8 text-sm">No hay ventas registradas hoy</p>
                                </div>
                            </div>

                            <!-- Top Productos Vendidos Hoy -->
                            <div class="bg-white dark:bg-slate-800 p-3 sm:p-6 rounded-xl shadow-md">
                                <h3 class="text-lg sm:text-xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                    Productos M치s Vendidos
                                </h3>
                                <div id="top-products-today" class="space-y-2">
                                    <p class="text-center text-slate-500 dark:text-slate-400 py-4 text-sm">No hay datos disponibles</p>
                                </div>
                            </div>

                            <!-- Reportes Hist칩ricos -->
                            <div class="bg-white dark:bg-slate-800 p-3 sm:p-6 rounded-xl shadow-md">
                                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-slate-900 dark:text-white">游늵 Reportes Hist칩ricos</h2>

                                <!-- Filtros -->
                                <div class="bg-slate-50 dark:bg-slate-700/50 p-3 sm:p-4 rounded-lg mb-4">
                                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                                        <div>
                                            <label class="text-xs font-medium text-slate-600 dark:text-slate-400">Fecha Inicio</label>
                                            <input type="date" id="seller-start-date" class="w-full p-2 sm:p-3 text-sm border-2 rounded-lg mt-1 dark:bg-slate-700 dark:border-slate-600">
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-slate-600 dark:text-slate-400">Fecha Fin</label>
                                            <input type="date" id="seller-end-date" class="w-full p-2 sm:p-3 text-sm border-2 rounded-lg mt-1 dark:bg-slate-700 dark:border-slate-600">
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-slate-600 dark:text-slate-400">M칠todo de Pago</label>
                                            <select id="report-payment-filter" class="w-full p-2 sm:p-3 text-sm border-2 rounded-lg mt-1 dark:bg-slate-700 dark:border-slate-600">
                                                <option value="">Todos</option>
                                                <option value="efectivo">Efectivo</option>
                                                <option value="transferencia">Transferencia</option>
                                                <option value="credito">Cr칠dito</option>
                                            </select>
                                        </div>
                                        <div class="flex items-end gap-2">
                                            <button onclick="filterSellerReports()" class="flex-1 bg-green-600 active:bg-green-700 text-white font-bold py-2 sm:py-3 px-3 rounded-lg shadow-md active:shadow-inner transition text-sm">
                                                游늵 Consultar
                                            </button>
                                            <button onclick="generateSellerReportPDF()" class="bg-red-600 active:bg-red-700 text-white font-bold py-2 sm:py-3 px-3 rounded-lg shadow-md active:shadow-inner transition text-sm">
                                                游늯 PDF
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Resumen del Per칤odo -->
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                                    <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg border-2 border-green-200 dark:border-green-800">
                                        <div class="text-xs text-slate-600 dark:text-slate-400">Total Ventas</div>
                                        <div id="report-total-sales" class="text-xl sm:text-2xl font-bold text-green-600 dark:text-green-400">$0.00</div>
                                        <div id="report-sales-count" class="text-xs text-slate-500 dark:text-slate-400">0 ventas</div>
                                    </div>
                                    <div class="bg-red-50 dark:bg-red-900/20 p-3 rounded-lg border-2 border-red-200 dark:border-red-800">
                                        <div class="text-xs text-slate-600 dark:text-slate-400">Total Gastos</div>
                                        <div id="report-total-expenses" class="text-xl sm:text-2xl font-bold text-red-600 dark:text-red-400">$0.00</div>
                                        <div id="report-expenses-count" class="text-xs text-slate-500 dark:text-slate-400">0 gastos</div>
                                    </div>
                                    <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border-2 border-blue-200 dark:border-blue-800">
                                        <div class="text-xs text-slate-600 dark:text-slate-400">Balance</div>
                                        <div id="report-balance" class="text-xl sm:text-2xl font-bold text-blue-600 dark:text-blue-400">$0.00</div>
                                    </div>
                                    <div class="bg-purple-50 dark:bg-purple-900/20 p-3 rounded-lg border-2 border-purple-200 dark:border-purple-800">
                                        <div class="text-xs text-slate-600 dark:text-slate-400">Productos</div>
                                        <div id="report-products-count" class="text-xl sm:text-2xl font-bold text-purple-600 dark:text-purple-400">0</div>
                                        <div class="text-xs text-slate-500 dark:text-slate-400">vendidos</div>
                                    </div>
                                </div>

                                <!-- Tablas de Ventas y Gastos -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                    <div>
                                        <h3 class="text-lg font-bold mb-2 text-slate-900 dark:text-white">Detalle de Ventas</h3>
                                        <div class="overflow-x-auto max-h-96">
                                            <table class="min-w-full bg-white dark:bg-slate-800 text-sm">
                                                <thead class="bg-slate-50 dark:bg-slate-700 sticky top-0">
                                                    <tr>
                                                        <th class="py-2 px-2 text-left text-xs">Fecha</th>
                                                        <th class="py-2 px-2 text-left text-xs">Cliente</th>
                                                        <th class="py-2 px-2 text-left text-xs">M칠todo</th>
                                                        <th class="py-2 px-2 text-right text-xs">Monto</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="seller-sales-report" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold mb-2 text-slate-900 dark:text-white">Detalle de Gastos</h3>
                                        <div class="overflow-x-auto max-h-96">
                                            <table class="min-w-full bg-white dark:bg-slate-800 text-sm">
                                                <thead class="bg-slate-50 dark:bg-slate-700 sticky top-0">
                                                    <tr>
                                                        <th class="py-2 px-2 text-left text-xs">Fecha</th>
                                                        <th class="py-2 px-2 text-left text-xs">Descripci칩n</th>
                                                        <th class="py-2 px-2 text-right text-xs">Monto</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="seller-expenses-report" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Historial de Cierres de Caja -->
                            <div class="bg-white dark:bg-slate-800 p-3 sm:p-6 rounded-xl shadow-md">
                                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    Historial de Cierres de Caja
                                </h2>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full bg-white dark:bg-slate-800">
                                        <thead class="bg-slate-50 dark:bg-slate-700">
                                            <tr>
                                                <th class="py-3 px-4 text-left text-sm">Fecha</th>
                                                <th class="py-3 px-4 text-left text-sm">Monto Inicial</th>
                                                <th class="py-3 px-4 text-left text-sm">Esperado</th>
                                                <th class="py-3 px-4 text-left text-sm">F칤sico</th>
                                                <th class="py-3 px-4 text-left text-sm">Diferencia</th>
                                                <th class="py-3 px-4 text-left text-sm">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="seller-closures-list" class="divide-y divide-slate-200 dark:divide-slate-700">
                                            <tr>
                                                <td colspan="6" class="text-center py-4 text-slate-500">Cargando...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- METAS -->
                    <div id="seller-goals" class="hidden">
                        <div class="space-y-6">
                            <!-- Encabezado -->
                            <div class="bg-gradient-to-r from-purple-600 to-indigo-700 p-6 rounded-xl shadow-lg text-white">
                                <h2 class="text-3xl font-bold mb-2 flex items-center gap-3">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Mis Metas
                                </h2>
                                <p class="text-purple-100">Seguimiento de tus objetivos de ventas</p>
                            </div>

                            <!-- Meta Diaria -->
                            <div id="daily-goal-section" class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                                <h3 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Meta Diaria
                                </h3>
                                <div id="daily-goal-content">
                                    <p class="text-slate-500 dark:text-slate-400">No hay meta diaria asignada</p>
                                </div>
                            </div>

                            <!-- Meta Mensual -->
                            <div id="monthly-goal-section" class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                                <h3 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    Meta Mensual
                                </h3>
                                <div id="monthly-goal-content">
                                    <p class="text-slate-500 dark:text-slate-400">No hay meta mensual asignada</p>
                                </div>
                            </div>

                            <!-- Meta Anual -->
                            <div id="yearly-goal-section" class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                                <h3 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-7 h-7 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                                    Meta Anual
                                </h3>
                                <div id="yearly-goal-content">
                                    <p class="text-slate-500 dark:text-slate-400">No hay meta anual asignada</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- M칩dulo de Visitas -->
                    <div id="seller-visits" class="hidden">
                        <div class="space-y-6">
                            <!-- Encabezado -->
                            <div class="bg-gradient-to-r from-teal-600 to-cyan-700 p-6 rounded-xl shadow-lg text-white">
                                <h2 class="text-3xl font-bold mb-2 flex items-center gap-3">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                                    </svg>
                                    Mis Visitas
                                </h2>
                                <p class="text-teal-100">Planifica y registra tus visitas a clientes</p>
                            </div>

                            <!-- Resumen de Hoy -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div class="bg-blue-100 dark:bg-blue-900/30 p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-blue-600 dark:text-blue-400 font-semibold">Visitas Hoy</p>
                                            <p class="text-2xl font-bold text-blue-900 dark:text-blue-100" id="visits-today-count">0</p>
                                        </div>
                                        <svg class="w-12 h-12 text-blue-600 dark:text-blue-400 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                </div>

                                <div class="bg-green-100 dark:bg-green-900/30 p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-green-600 dark:text-green-400 font-semibold">Completadas</p>
                                            <p class="text-2xl font-bold text-green-900 dark:text-green-100" id="visits-completed-count">0</p>
                                        </div>
                                        <svg class="w-12 h-12 text-green-600 dark:text-green-400 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>

                                <div class="bg-yellow-100 dark:bg-yellow-900/30 p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-yellow-600 dark:text-yellow-400 font-semibold">Pendientes</p>
                                            <p class="text-2xl font-bold text-yellow-900 dark:text-yellow-100" id="visits-pending-count">0</p>
                                        </div>
                                        <svg class="w-12 h-12 text-yellow-600 dark:text-yellow-400 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>

                                <div class="bg-red-100 dark:bg-red-900/30 p-4 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-red-600 dark:text-red-400 font-semibold">Clientes Inactivos</p>
                                            <p class="text-2xl font-bold text-red-900 dark:text-red-100" id="clients-inactive-count">0</p>
                                        </div>
                                        <svg class="w-12 h-12 text-red-600 dark:text-red-400 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <!-- Bot칩n Ver Mapa y Ruta -->
                            <div class="flex gap-3">
                                <button onclick="openVisitsMap()" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-3 px-6 rounded-lg shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                                    </svg>
                                    Ver Mapa y Ruta Optimizada
                                </button>
                            </div>

                            <!-- Clientes a Visitar Hoy -->
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                                <h3 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    Clientes para Visitar Hoy
                                </h3>
                                <div id="visits-today-list" class="space-y-3">
                                    <!-- Se llenar치 din치micamente -->
                                </div>
                            </div>

                            <!-- Clientes Inactivos (sin compras recientes) -->
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                                <h3 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-7 h-7 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                    </svg>
                                    Clientes Inactivos (sin compras en 30+ d칤as)
                                </h3>
                                <div id="inactive-clients-list" class="space-y-3">
                                    <!-- Se llenar치 din치micamente -->
                                </div>
                            </div>

                            <!-- Historial de Visitas Recientes -->
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                                <h3 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-7 h-7 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Historial de Visitas (칔ltimos 7 d칤as)
                                </h3>
                                <div id="visit-history-list" class="space-y-3">
                                    <!-- Se llenar치 din치micamente -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para Editar Producto -->
    <div id="edit-product-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Editar Producto</h2>
            <form id="edit-product-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Nombre del Producto *</label>
                    <input type="text" id="edit-product-name" placeholder="Nombre del Producto" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Categor칤a *</label>
                    <select id="edit-product-category" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                        <option value="">Seleccionar...</option>
                        <option value="bidon_lleno">Bid칩n Lleno (BCL/BSL)</option>
                        <option value="bidon_vacio">Bid칩n Vac칤o</option>
                        <option value="recarga">Recarga de Agua</option>
                        <option value="equipo">Equipo/V치lvula</option>
                        <option value="paca">Paca (Gal칩n/Galones)</option>
                        <option value="llaves">Llaves</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Peso Unitario (kg) *</label>
                    <input type="number" id="edit-product-weight" placeholder="20" min="0" step="0.01" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                </div>
                <div class="flex items-center">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="edit-product-is-returnable" class="w-5 h-5 text-blue-600 rounded">
                        <span class="ml-2 text-sm font-semibold text-slate-700 dark:text-slate-300">쮼s retornable?</span>
                    </label>
                </div>

                <div class="md:col-span-2 border-t pt-4 mt-2">
                    <h3 class="text-lg font-semibold mb-3 text-slate-700 dark:text-slate-300">Inventario</h3>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Stock Actual</label>
                    <input type="number" id="edit-product-stock" placeholder="0" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Inventario en bodega principal</p>
                </div>

                <div class="md:col-span-2 border-t pt-4 mt-2">
                    <h3 class="text-lg font-semibold mb-3 text-slate-700 dark:text-slate-300">Precios</h3>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Costo *</label>
                    <input type="number" id="edit-product-cost" placeholder="0.00" min="0" step="0.01" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Precio Normal *</label>
                    <input type="number" id="edit-product-price-normal" placeholder="0.00" min="0" step="0.01" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-slate-700 dark:text-slate-300">Precio Negocio *</label>
                    <input type="number" id="edit-product-price-business" placeholder="0.00" min="0" step="0.01" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                </div>

                <div class="md:col-span-2 flex justify-end gap-4 mt-6 border-t pt-4">
                    <button type="button" onclick="closeEditModal()" class="bg-slate-200 dark:bg-slate-600 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Confirmar Anulaci칩n -->
    <div id="delete-confirm-modal" class="modal-overlay hidden"><div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg w-full max-w-sm text-center"><h2 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Confirmar Anulaci칩n</h2><p class="mb-6">쮼st치 seguro? Esta acci칩n no se puede deshacer.</p><div class="flex justify-center gap-4"><button type="button" onclick="cancelDelete()" class="bg-slate-200 dark:bg-slate-600 font-semibold py-2 px-6 rounded-lg">Cancelar</button><button type="button" id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Anular</button></div></div></div>

    <!-- Modal para Editar Inventario de Veh칤culo -->
    <div id="vehicle-inventory-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    <span id="vehicle-inventory-modal-title">Inventario del Veh칤culo</span>
                </h2>
                <button onclick="closeVehicleInventoryModal()" class="text-slate-500 hover:text-slate-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="mb-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <span class="font-semibold text-slate-700 dark:text-slate-300">Veh칤culo:</span>
                        <span id="modal-vehicle-plate" class="text-blue-600 dark:text-blue-400 font-bold ml-2"></span>
                    </div>
                    <div>
                        <span class="font-semibold text-slate-700 dark:text-slate-300">Capacidad:</span>
                        <span id="modal-vehicle-capacity" class="text-slate-900 dark:text-white font-bold ml-2"></span>
                    </div>
                </div>
            </div>

            <form id="vehicle-inventory-form">
                <input type="hidden" id="modal-vehicle-id">

                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-3 text-slate-700 dark:text-slate-300">Productos en el Veh칤culo</h3>
                    <div id="modal-vehicle-inventory-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Se llenar치 din치micamente -->
                    </div>
                </div>

                <div class="mb-4 p-3 bg-slate-50 dark:bg-slate-700 rounded-lg">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-semibold text-slate-700 dark:text-slate-300">Capacidad Utilizada:</span>
                        <span class="font-bold text-blue-600 dark:text-blue-400">
                            <span id="modal-vehicle-capacity-used">0</span> / <span id="modal-vehicle-capacity-max">0</span> unidades
                        </span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="font-semibold text-slate-700 dark:text-slate-300">Peso Total:</span>
                        <span class="font-bold text-blue-600 dark:text-blue-400">
                            <span id="modal-vehicle-weight-used">0</span> / <span id="modal-vehicle-weight-max">0</span> kg
                        </span>
                    </div>
                </div>

                <div class="flex gap-3 pt-4 border-t">
                    <button type="button" onclick="closeVehicleInventoryModal()" class="flex-1 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-bold py-3 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-[2] bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">
                        游 Guardar Inventario
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Registrar Abono -->
    <div id="payment-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold mb-2 text-slate-900 dark:text-white">Registrar Abono</h2>
            <p class="mb-4">Saldo pendiente: <span id="payment-modal-balance" class="font-bold"></span></p>
            <form id="add-payment-form" class="space-y-4">
                <input type="number" id="payment-amount" placeholder="Monto del abono" min="0.01" step="0.01" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closePaymentModal()" class="bg-slate-200 dark:bg-slate-600 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Guardar Abono</button>
                </div>
            </form>
        </div>
    </div>

    <div id="cash-close-report-modal" class="modal-overlay hidden"><div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg w-full max-w-lg"><h2 class="text-2xl font-bold mb-4 text-center text-slate-900 dark:text-white">Reporte de Cierre de Caja</h2><div id="report-content" class="space-y-3 text-lg"><p><strong>Fecha de Cierre:</strong> <span id="report-date"></span></p><hr class="border-slate-200 dark:border-slate-600"><p><strong>(+) Monto Inicial:</strong> <span id="report-initial"></span></p><p><strong>(+) Ventas Efectivo:</strong> <span id="report-cash-sales"></span></p><p><strong>(+) Cobros:</strong> <span id="report-collections"></span></p><p><strong>(+) Abonos Cr칠ditos:</strong> <span id="report-credit-payments"></span></p><p><strong>(-) Gastos Efectivo:</strong> <span id="report-cash-expenses"></span></p><hr class="border-slate-200 dark:border-slate-600"><p><strong>(=) Total Esperado:</strong> <span id="report-total"></span></p><p><strong>F칤sico Contado:</strong> <span id="report-physical-cash"></span></p><hr class="border-slate-200 dark:border-slate-600"><p class="font-bold text-xl"><strong>Diferencia:</strong> <span id="report-difference"></span></p><hr class="border-slate-200 dark:border-slate-600"><div id="report-daily-goal-section" class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg"><h3 class="font-bold text-lg mb-2 text-blue-900 dark:text-blue-100">Meta Diaria</h3><div id="report-daily-goal-content" class="space-y-2 text-base"><p class="text-slate-600 dark:text-slate-400">Cargando informaci칩n de meta...</p></div></div></div><div class="mt-6 flex justify-end space-x-4"><button onclick="document.getElementById('cash-close-report-modal').classList.add('hidden')" class="bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500">Cerrar</button><button onclick="generateCloseCashPDF()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Descargar PDF</button></div></div></div>

    <!-- Modal de Esc치ner QR -->
    <div id="qr-scanner-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <svg class="w-7 h-7 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                    </svg>
                    Escanear C칩digo QR
                </h2>
                <button onclick="closeQRScanner()" class="text-slate-500 hover:text-slate-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="space-y-4">
                <div id="qr-reader" class="w-full rounded-lg overflow-hidden bg-black"></div>
                <div id="qr-scanner-status" class="text-center text-sm text-slate-600 dark:text-slate-400">
                    游닝 Apunta la c치mara hacia el c칩digo QR del cliente
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Mapa de Visitas con Ruta Optimizada -->
    <div id="visits-map-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg w-full max-w-6xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                    </svg>
                    Mapa de Visitas con Ruta Optimizada
                </h2>
                <button onclick="closeVisitsMap()" class="text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Informaci칩n de la Ruta -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-blue-100 dark:bg-blue-900/30 p-3 rounded-lg">
                    <p class="text-sm text-blue-600 dark:text-blue-400 font-semibold">Clientes en Ruta</p>
                    <p class="text-2xl font-bold text-blue-900 dark:text-blue-100" id="map-clients-count">0</p>
                </div>
                <div class="bg-green-100 dark:bg-green-900/30 p-3 rounded-lg">
                    <p class="text-sm text-green-600 dark:text-green-400 font-semibold">Distancia Total</p>
                    <p class="text-2xl font-bold text-green-900 dark:text-green-100" id="map-total-distance">0 km</p>
                </div>
                <div class="bg-purple-100 dark:bg-purple-900/30 p-3 rounded-lg">
                    <p class="text-sm text-purple-600 dark:text-purple-400 font-semibold">Tiempo Estimado</p>
                    <p class="text-2xl font-bold text-purple-900 dark:text-purple-100" id="map-estimated-time">0 min</p>
                </div>
            </div>

            <!-- Mapa -->
            <div id="visits-map" class="w-full h-96 rounded-lg border-2 border-slate-300 dark:border-slate-600"></div>

            <!-- Lista de Orden de Visitas -->
            <div class="mt-4">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-3">Orden Sugerido de Visitas</h3>
                <div id="route-order-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Se llenar치 din치micamente -->
                </div>
            </div>

            <div class="mt-6 flex justify-end gap-3">
                <button onclick="closeVisitsMap()" class="bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">
                    Cerrar
                </button>
                <button onclick="startNavigation()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                    </svg>
                    Iniciar Navegaci칩n
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Crear Cliente desde Ventas -->
    <div id="create-client-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                Crear Nuevo Cliente
            </h2>

            <form id="modal-client-form" class="space-y-4">
                <!-- Secci칩n 1: Informaci칩n B치sica -->
                <div class="space-y-3 bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-300 flex items-center gap-2">
                        游늶 Informaci칩n B치sica
                    </h3>

                    <div>
                        <label class="text-sm font-semibold text-slate-700 dark:text-slate-300 block mb-2">Tipo de Cliente</label>
                        <div id="modal-client-type-selector" class="grid grid-cols-2 gap-2">
                            <label class="flex items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                <input type="radio" name="modal-client-type" value="consumidor-final" checked class="w-5 h-5 text-blue-600">
                                <span class="text-sm font-medium">游녻 Consumidor Final</span>
                            </label>
                            <label class="flex items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                <input type="radio" name="modal-client-type" value="negocio" class="w-5 h-5 text-blue-600">
                                <span class="text-sm font-medium">游끽 Negocio</span>
                            </label>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Nombre del Cliente *</label>
                            <input type="text" id="modal-client-name" placeholder="Ej: Juan P칠rez" required class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                        </div>

                        <div id="modal-business-name-field" class="hidden">
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Nombre del Negocio</label>
                            <input type="text" id="modal-client-business-name" placeholder="Ej: Tienda La Esperanza" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                        </div>

                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Tel칠fono</label>
                            <input type="tel" id="modal-client-phone" placeholder="0999999999" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                        </div>
                    </div>
                </div>

                <!-- Secci칩n 2: Ubicaci칩n en Ecuador -->
                <div class="space-y-3 bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-300 flex items-center gap-2">
                        游늸 Ubicaci칩n
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Provincia *</label>
                            <select id="modal-client-province" required class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                <option value="">Seleccione una provincia</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Cant칩n</label>
                            <input type="text" id="modal-client-canton" placeholder="Ej: Quito" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                        </div>

                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Parroquia</label>
                            <input type="text" id="modal-client-parish" placeholder="Ej: Chillogallo" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                        </div>

                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Sector/Barrio</label>
                            <input type="text" id="modal-client-sector" placeholder="Ej: Centro Hist칩rico" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                        </div>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Direcci칩n Completa</label>
                        <textarea id="modal-client-address" rows="2" placeholder="Calle principal, n칰mero, referencias..." class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600"></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Latitud (GPS)</label>
                            <input type="number" id="modal-client-latitude" step="0.000001" placeholder="-0.180653" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Longitud (GPS)</label>
                            <input type="number" id="modal-client-longitude" step="0.000001" placeholder="-78.467834" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                        </div>
                    </div>

                    <button type="button" onclick="captureModalClientLocation()" class="w-full bg-blue-600 active:bg-blue-700 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md active:shadow-inner transition flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        游늸 Capturar Ubicaci칩n GPS
                    </button>
                </div>

                <!-- Secci칩n 3: Productos Predeterminados -->
                <div class="space-y-3 bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-300 flex items-center gap-2">
                        游닍 Productos que Consume
                    </h3>
                    <div id="modal-client-default-products" class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <!-- Se llenar치 din치micamente -->
                    </div>
                </div>

                <!-- Secci칩n 4: Planificaci칩n de Visitas -->
                <div class="space-y-3 bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-300 flex items-center gap-2">
                        游늰 Planificaci칩n de Visitas
                    </h3>

                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300 block mb-2">D칤as de Visita</label>
                        <div class="grid grid-cols-7 gap-1">
                            <label class="flex flex-col items-center cursor-pointer bg-white dark:bg-slate-600 p-2 rounded border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                <input type="checkbox" name="modal-visit-days" value="L" class="mb-1">
                                <span class="text-xs font-medium">L</span>
                            </label>
                            <label class="flex flex-col items-center cursor-pointer bg-white dark:bg-slate-600 p-2 rounded border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                <input type="checkbox" name="modal-visit-days" value="M" class="mb-1">
                                <span class="text-xs font-medium">M</span>
                            </label>
                            <label class="flex flex-col items-center cursor-pointer bg-white dark:bg-slate-600 p-2 rounded border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                <input type="checkbox" name="modal-visit-days" value="X" class="mb-1">
                                <span class="text-xs font-medium">X</span>
                            </label>
                            <label class="flex flex-col items-center cursor-pointer bg-white dark:bg-slate-600 p-2 rounded border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                <input type="checkbox" name="modal-visit-days" value="J" class="mb-1">
                                <span class="text-xs font-medium">J</span>
                            </label>
                            <label class="flex flex-col items-center cursor-pointer bg-white dark:bg-slate-600 p-2 rounded border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                <input type="checkbox" name="modal-visit-days" value="V" class="mb-1">
                                <span class="text-xs font-medium">V</span>
                            </label>
                            <label class="flex flex-col items-center cursor-pointer bg-white dark:bg-slate-600 p-2 rounded border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                <input type="checkbox" name="modal-visit-days" value="S" class="mb-1">
                                <span class="text-xs font-medium">S</span>
                            </label>
                            <label class="flex flex-col items-center cursor-pointer bg-white dark:bg-slate-600 p-2 rounded border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                <input type="checkbox" name="modal-visit-days" value="D" class="mb-1">
                                <span class="text-xs font-medium">D</span>
                            </label>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Horario</label>
                            <select id="modal-client-visit-time" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                <option value="">Sin preferencia</option>
                                <option value="ma침ana">游깬 Ma침ana (8:00-12:00)</option>
                                <option value="tarde">驕勇 Tarde (12:00-18:00)</option>
                                <option value="noche">游깿 Noche (18:00-21:00)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Frecuencia</label>
                            <select id="modal-client-frequency" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                <option value="diario">Diario</option>
                                <option value="semanal" selected>Semanal</option>
                                <option value="quincenal">Quincenal</option>
                                <option value="mensual">Mensual</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Botones -->
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeClientModal()" class="flex-1 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-bold py-3 px-4 rounded-lg active:bg-slate-300 dark:active:bg-slate-600 transition">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-[2] bg-gradient-to-r from-green-600 to-green-700 active:from-green-700 active:to-green-800 text-white font-bold py-3 px-4 rounded-lg shadow-lg active:shadow-inner transition">
                        游 Guardar y Seleccionar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Editar Venta -->
    <div id="edit-sale-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Editar Venta</h2>
            <form id="edit-sale-form" class="space-y-4">
                <input type="hidden" id="edit-sale-id">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Fecha</label>
                        <input type="date" id="edit-sale-date" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Cliente</label>
                        <input type="text" id="edit-sale-client" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                    </div>
                </div>

                <div>
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">M칠todo de Pago</label>
                    <select id="edit-sale-payment" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                        <option value="efectivo">Efectivo</option>
                        <option value="transferencia">Transferencia</option>
                        <option value="credito">Cr칠dito</option>
                    </select>
                </div>

                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Productos</label>
                        <button type="button" onclick="addEditSaleProduct()" class="bg-green-600 text-white text-sm py-1 px-3 rounded-lg hover:bg-green-700">+ Agregar Producto</button>
                    </div>
                    <div id="edit-sale-products-container" class="space-y-2"></div>
                </div>

                <div class="border-t pt-4">
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-bold text-slate-900 dark:text-white">Total:</span>
                        <span id="edit-sale-total-display" class="text-2xl font-bold text-green-600">$0.00</span>
                    </div>
                </div>

                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeEditSaleModal()" class="bg-slate-200 dark:bg-slate-600 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Editar Gasto -->
    <div id="edit-expense-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Editar Gasto</h2>
            <form id="edit-expense-form" class="space-y-4">
                <input type="hidden" id="edit-expense-id">

                <div>
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Fecha</label>
                    <input type="date" id="edit-expense-date" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                </div>

                <div>
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Categor칤a</label>
                    <select id="edit-expense-category" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                    </select>
                </div>

                <div>
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Monto</label>
                    <input type="number" id="edit-expense-amount" step="0.01" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                </div>

                <div>
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">M칠todo de Pago</label>
                    <select id="edit-expense-payment" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                        <option value="efectivo">Efectivo</option>
                        <option value="transferencia">Transferencia</option>
                    </select>
                </div>

                <div>
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Descripci칩n (opcional)</label>
                    <textarea id="edit-expense-description" rows="3" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600"></textarea>
                </div>

                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeEditExpenseModal()" class="bg-slate-200 dark:bg-slate-600 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Editar Tipo de Gasto -->
    <div id="edit-expense-type-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Editar Tipo de Gasto</h2>
            <form id="edit-expense-type-form" class="space-y-4">
                <input type="hidden" id="edit-expense-type-id">

                <div>
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Nombre del Tipo de Gasto</label>
                    <input type="text" id="edit-expense-type-name" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                </div>

                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeEditExpenseTypeModal()" class="bg-slate-200 dark:bg-slate-600 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Editar Cierre de Caja -->
    <div id="edit-closure-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Editar Cierre de Caja</h2>
            <form id="edit-closure-form" class="space-y-4">
                <input type="hidden" id="edit-closure-id">

                <!-- Informaci칩n de Apertura -->
                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg space-y-3">
                    <h3 class="text-sm font-bold text-blue-900 dark:text-blue-300">Informaci칩n de Apertura</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Veh칤culo</label>
                            <select id="edit-closure-vehicle" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                <option value="">Seleccionar veh칤culo...</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">KM Inicial</label>
                            <input type="number" id="edit-closure-opening-km" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">KM Final</label>
                            <input type="number" id="edit-closure-closing-km" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Monto Inicial</label>
                        <input type="number" id="edit-closure-opening" step="0.01" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Ventas Efectivo</label>
                        <input type="number" id="edit-closure-cash-sales" step="0.01" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Gastos Efectivo</label>
                        <input type="number" id="edit-closure-cash-expenses" step="0.01" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Cobros/Ingresos</label>
                        <input type="number" id="edit-closure-collections" step="0.01" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Efectivo F칤sico Contado</label>
                        <input type="number" id="edit-closure-physical" step="0.01" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Ventas a Cr칠dito</label>
                        <input type="number" id="edit-closure-credit-sales" step="0.01" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                    </div>

                    <div class="col-span-2">
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Ventas por Transferencia</label>
                        <input type="number" id="edit-closure-transfer-sales" step="0.01" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                    </div>
                </div>

                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                    <p class="text-sm text-slate-600 dark:text-slate-400"><strong>C치lculo autom치tico:</strong></p>
                    <p class="text-sm text-slate-600 dark:text-slate-400">Efectivo Esperado = Monto Inicial + Ventas Efectivo + Cobros - Gastos Efectivo</p>
                    <p class="text-sm text-slate-600 dark:text-slate-400">Diferencia = Efectivo F칤sico - Efectivo Esperado</p>
                </div>

                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeEditClosureModal()" class="bg-slate-200 dark:bg-slate-600 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Admin - Gesti칩n de Clientes -->
    <div id="admin-client-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <span id="admin-client-modal-title">Registrar Nuevo Cliente</span>
                </h2>
                <button onclick="closeAdminClientModal()" class="text-slate-500 hover:text-slate-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="admin-client-form" class="space-y-4">
                <input type="hidden" id="admin-client-id">

                <!-- Secci칩n 1: Informaci칩n B치sica -->
                <div class="space-y-3 bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-300 flex items-center gap-2">
                        游늶 Informaci칩n B치sica
                    </h3>

                    <div>
                        <label class="text-sm font-semibold text-slate-700 dark:text-slate-300 block mb-2">Tipo de Cliente</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                <input type="radio" name="admin-client-type" value="consumidor-final" checked class="w-5 h-5 text-blue-600">
                                <span class="text-sm font-medium">游녻 Consumidor Final</span>
                            </label>
                            <label class="flex items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                <input type="radio" name="admin-client-type" value="negocio" class="w-5 h-5 text-blue-600">
                                <span class="text-sm font-medium">游끽 Negocio</span>
                            </label>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Nombre del Cliente *</label>
                            <input type="text" id="admin-client-name" placeholder="Ej: Juan P칠rez" required class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                        </div>

                        <div id="admin-business-name-field" class="hidden">
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Nombre del Negocio</label>
                            <input type="text" id="admin-client-business-name" placeholder="Ej: Tienda La Esperanza" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                        </div>

                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Tel칠fono</label>
                            <input type="tel" id="admin-client-phone" placeholder="0999999999" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                        </div>
                    </div>
                </div>

                <!-- Secci칩n 2: Ubicaci칩n en Ecuador -->
                <div class="space-y-3 bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-300 flex items-center gap-2">
                        游늸 Ubicaci칩n
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Provincia *</label>
                            <select id="admin-client-province" required class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                <option value="">Seleccione una provincia</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Cant칩n</label>
                            <input type="text" id="admin-client-canton" placeholder="Ej: Quito" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                        </div>

                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Parroquia</label>
                            <input type="text" id="admin-client-parish" placeholder="Ej: Chillogallo" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                        </div>

                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Sector/Barrio</label>
                            <input type="text" id="admin-client-sector" placeholder="Ej: Centro Hist칩rico" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                        </div>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Direcci칩n Completa</label>
                        <textarea id="admin-client-address" rows="2" placeholder="Calle principal, n칰mero, referencias..." class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600"></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Latitud (GPS)</label>
                            <input type="number" id="admin-client-latitude" step="0.000001" placeholder="-0.180653" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Longitud (GPS)</label>
                            <input type="number" id="admin-client-longitude" step="0.000001" placeholder="-78.467834" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                        </div>
                    </div>
                </div>

                <!-- Secci칩n 3: Asignar Vendedor -->
                <div class="space-y-3 bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-300 flex items-center gap-2">
                        游녿꽳눺 Asignaci칩n de Vendedor
                    </h3>

                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Vendedor Asignado</label>
                        <select id="admin-client-seller" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                            <option value="">Sin asignar</option>
                        </select>
                    </div>
                </div>

                <!-- Secci칩n 4: Productos Predeterminados -->
                <div class="space-y-3 bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-300 flex items-center gap-2">
                        游닍 Productos que Consume
                    </h3>
                    <div id="admin-client-default-products" class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <!-- Se llenar치 din치micamente -->
                    </div>
                </div>

                <!-- Secci칩n 5: Planificaci칩n de Visitas -->
                <div class="space-y-3 bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-300 flex items-center gap-2">
                        游늰 Planificaci칩n de Visitas
                    </h3>

                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300 block mb-2">D칤as de Visita</label>
                        <div class="grid grid-cols-7 gap-1">
                            <label class="flex flex-col items-center cursor-pointer bg-white dark:bg-slate-600 p-2 rounded border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                <input type="checkbox" name="admin-visit-days" value="L" class="mb-1">
                                <span class="text-xs font-medium">L</span>
                            </label>
                            <label class="flex flex-col items-center cursor-pointer bg-white dark:bg-slate-600 p-2 rounded border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                <input type="checkbox" name="admin-visit-days" value="M" class="mb-1">
                                <span class="text-xs font-medium">M</span>
                            </label>
                            <label class="flex flex-col items-center cursor-pointer bg-white dark:bg-slate-600 p-2 rounded border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                <input type="checkbox" name="admin-visit-days" value="X" class="mb-1">
                                <span class="text-xs font-medium">X</span>
                            </label>
                            <label class="flex flex-col items-center cursor-pointer bg-white dark:bg-slate-600 p-2 rounded border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                <input type="checkbox" name="admin-visit-days" value="J" class="mb-1">
                                <span class="text-xs font-medium">J</span>
                            </label>
                            <label class="flex flex-col items-center cursor-pointer bg-white dark:bg-slate-600 p-2 rounded border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                <input type="checkbox" name="admin-visit-days" value="V" class="mb-1">
                                <span class="text-xs font-medium">V</span>
                            </label>
                            <label class="flex flex-col items-center cursor-pointer bg-white dark:bg-slate-600 p-2 rounded border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                <input type="checkbox" name="admin-visit-days" value="S" class="mb-1">
                                <span class="text-xs font-medium">S</span>
                            </label>
                            <label class="flex flex-col items-center cursor-pointer bg-white dark:bg-slate-600 p-2 rounded border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                <input type="checkbox" name="admin-visit-days" value="D" class="mb-1">
                                <span class="text-xs font-medium">D</span>
                            </label>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Horario Preferido</label>
                            <select id="admin-client-visit-time" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                <option value="">No especificado</option>
                                <option value="ma침ana">游깬 Ma침ana (8:00-12:00)</option>
                                <option value="tarde">驕勇 Tarde (12:00-18:00)</option>
                                <option value="noche">游깿 Noche (18:00-21:00)</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Frecuencia</label>
                            <select id="admin-client-visit-frequency" class="w-full p-2.5 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                <option value="">No especificado</option>
                                <option value="diario">Diario</option>
                                <option value="semanal">Semanal</option>
                                <option value="quincenal">Quincenal</option>
                                <option value="mensual">Mensual</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Secci칩n 6: Notas -->
                <div class="space-y-3 bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-300 flex items-center gap-2">
                        游닇 Notas Adicionales
                    </h3>
                    <textarea id="admin-client-notes" rows="3" placeholder="Observaciones, preferencias del cliente, etc." class="w-full p-2.5 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600"></textarea>
                </div>

                <!-- Botones de acci칩n -->
                <div class="flex justify-end gap-4 pt-4 border-t dark:border-slate-600">
                    <button type="button" onclick="closeAdminClientModal()" class="bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Guardar Cliente
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Plantillas WhatsApp -->
    <div id="whatsapp-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <svg class="w-7 h-7 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                    </svg>
                    Enviar Mensaje WhatsApp
                </h2>
                <button onclick="closeWhatsAppModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="mb-4">
                <p class="text-sm text-slate-600 dark:text-slate-400">
                    Cliente: <strong id="wa-client-name" class="text-slate-900 dark:text-white"></strong>
                </p>
                <p class="text-sm text-slate-600 dark:text-slate-400">
                    Tel칠fono: <strong id="wa-client-phone" class="text-slate-900 dark:text-white"></strong>
                </p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Selecciona una Plantilla</label>
                <div id="templates-selector" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Se llenar치 din치micamente -->
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Vista Previa del Mensaje</label>
                <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg min-h-[100px]">
                    <p id="wa-message-preview" class="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap">
                        Selecciona una plantilla para ver el mensaje...
                    </p>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="sendWhatsAppMessage()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                    </svg>
                    Enviar por WhatsApp
                </button>
                <button onclick="closeWhatsAppModal()" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 font-bold py-3 px-6 rounded-lg">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

<script>
    const { jsPDF } = window.jspdf;
    const firebaseConfig = { apiKey: "AIzaSyC08Np1t5rx2MiQmSfQrRKObSFEy0bZnHw", authDomain: "distribuidor-autorizado-f08bf.firebaseapp.com", projectId: "distribuidor-autorizado-f08bf", storageBucket: "distribuidor-autorizado-f08bf.appspot.com", messagingSenderId: "770396065529", appId: "1:770396065529:web:ef07592ce4b23076da5c28", measurementId: "G-EHMP32VLVT" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db_firestore = firebase.firestore();
    
    // Habilitar persistencia offline
    db_firestore.enablePersistence().catch((err) => {
        if (err.code == 'failed-precondition') {
            console.warn("La persistencia de Firestore fall칩, probablemente porque ya est치 activa en otra pesta침a.");
        } else if (err.code == 'unimplemented') {
            console.warn("El navegador actual no soporta la persistencia de datos offline.");
        }
    });

    // Registrar Service Worker para funcionamiento offline
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registrado exitosamente:', registration.scope);
                })
                .catch(error => {
                    console.log('Error al registrar Service Worker:', error);
                });
        });
    }

    // Detectar cambios en la conexi칩n
    let wasOffline = !navigator.onLine;

    window.addEventListener('online', () => {
        console.log('Conexi칩n restaurada - Firestore sincronizar치 autom치ticamente...');
        if (wasOffline) {
            // Firestore sincroniza autom치ticamente con su persistencia offline
            // Sincronizar cierres pendientes guardados localmente
            syncPendingClosures();

            // Solo necesitamos recargar la UI despu칠s de un momento
            setTimeout(() => {
                console.log('Actualizando UI tras reconexi칩n...');
                if (auth.currentUser) {
                    db_firestore.collection('users').doc(auth.currentUser.uid).get().then(doc => {
                        const isAdmin = doc.exists && doc.data().role === 'admin';
                        if (isAdmin) {
                            updateAdminDashboard();
                        } else {
                            checkCashRegisterStatus();
                            updateSellerDashboard();
                            updateCashClosureSummary();
                        }
                    });
                }
            }, 3000); // 3 segundos para dar tiempo a Firestore de sincronizar
        }
        wasOffline = false;
    });

    window.addEventListener('offline', () => {
        console.log('Conexi칩n perdida - modo offline activado');
        wasOffline = true;
    });

    // Detectar cuando la app se hace visible (usuario vuelve a la app)
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden && auth.currentUser) {
            console.log('App visible - actualizando dashboards y cierre de caja...');
            // Actualizar dashboards cuando el usuario vuelve a la app
            setTimeout(() => {
                db_firestore.collection('users').doc(auth.currentUser.uid).get().then(doc => {
                    const isAdmin = doc.exists && doc.data().role === 'admin';
                    if (isAdmin) {
                        updateAdminDashboard();
                    } else {
                        checkCashRegisterStatus();
                        updateSellerDashboard();
                        // Tambi칠n actualizar el cierre de caja si est치 visible
                        updateCashClosureSummary();
                    }
                });
            }, 1000);
        }
    });

    // Detectar cuando la p치gina se muestra desde el cach칠 (bfcache)
    window.addEventListener('pageshow', (event) => {
        if (event.persisted && auth.currentUser) {
            console.log('P치gina restaurada desde cach칠 - actualizando dashboards y cierre de caja...');
            setTimeout(() => {
                db_firestore.collection('users').doc(auth.currentUser.uid).get().then(doc => {
                    const isAdmin = doc.exists && doc.data().role === 'admin';
                    if (isAdmin) {
                        updateAdminDashboard();
                    } else {
                        checkCashRegisterStatus();
                        updateSellerDashboard();
                        // Tambi칠n actualizar el cierre de caja si est치 visible
                        updateCashClosureSummary();
                    }
                });
            }, 1000);
        }
    });

    let db = { products: [], sales: [], expenses: [], collections: [], expenseTypes: [], clients: [], visits: [], whatsappTemplates: [], vehicles: [], cashRegister: { isOpen: false, openingBalance: 0, transactions: [] }, usersMap: {} };
    let currentSaleItems = [];
    let filteredAdminReportsData = {};
    
    function getCurrentDate() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function formatDateDisplay(dateStr) {
        // Convierte YYYY-MM-DD a DD-MM-YYYY
        if (!dateStr) return '';
        const [year, month, day] = dateStr.split('-');
        return `${day}-${month}-${year}`;
    }

    const views = ['auth-view', 'admin-view', 'seller-view'];
    
    function showView(viewId) { views.forEach(id => { const el = document.getElementById(id); if (el) el.classList.add('hidden'); }); const targetViewEl = document.getElementById(`${viewId}-view`); if (targetViewEl) targetViewEl.classList.remove('hidden'); const sellerViewEl = document.getElementById('seller-view'); if (sellerViewEl) { viewId === 'seller' ? sellerViewEl.classList.add('flex') : sellerViewEl.classList.remove('flex'); } if (viewId === 'admin') { updateAdminDashboard(); } if (viewId === 'seller') { checkCashRegisterStatus(); updateSellerDashboard(); if(viewId === 'seller-credit-accounts') renderCreditAccounts(); } }
    const loginForm = document.getElementById('login-form');
    const authError = document.getElementById('auth-error');
    
    loginForm.addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('login-email').value, password = document.getElementById('login-password').value; auth.signInWithEmailAndPassword(email, password).catch(error => { authError.textContent = "Error: " + error.message; }); });

    function handleLogout() { auth.signOut(); }

    // Provincias de Ecuador
    const ecuadorProvinces = [
        "Azuay", "Bol칤var", "Ca침ar", "Carchi", "Chimborazo", "Cotopaxi", "El Oro",
        "Esmeraldas", "Gal치pagos", "Guayas", "Imbabura", "Loja", "Los R칤os",
        "Manab칤", "Morona Santiago", "Napo", "Orellana", "Pastaza", "Pichincha",
        "Santa Elena", "Santo Domingo de los Ts치chilas", "Sucumb칤os", "Tungurahua", "Zamora Chinchipe"
    ];

    function initializeProvinces() {
        const provinceSelect = document.getElementById('client-province');
        if (provinceSelect) {
            ecuadorProvinces.forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                provinceSelect.appendChild(option);
            });
        }
    }

    function renderClientDefaultProducts() {
        const container = document.getElementById('client-default-products');
        if (!container) return;

        // Verificar si hay productos cargados
        if (!db.products || db.products.length === 0) {
            container.innerHTML = `
                <div class="text-center py-6 bg-slate-50 dark:bg-slate-700/50 rounded-lg border-2 border-dashed border-slate-300 dark:border-slate-600">
                    <svg class="w-12 h-12 mx-auto mb-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    <p class="text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">No hay productos registrados</p>
                    <p class="text-xs text-slate-500 dark:text-slate-500">Contacte al administrador para agregar productos al sistema</p>
                </div>
            `;
            return;
        }

        container.innerHTML = db.products.map(p => `
            <label class="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-700 rounded-lg border cursor-pointer has-[:checked]:bg-purple-50 has-[:checked]:border-purple-500 dark:has-[:checked]:bg-purple-900/30 transition hover:shadow-sm">
                <input type="checkbox" name="default-products" value="${p.id}" class="w-4 h-4">
                <span class="flex-1 font-medium text-sm">${p.name}</span>
                <span class="text-xs text-slate-500">$${p.priceNormal.toFixed(2)}</span>
            </label>
        `).join('');
    }

    window.onload = function() {
        initializeProvinces();
        auth.onAuthStateChanged(user => {
            if (user) {
                console.log('Usuario autenticado:', user.email, 'UID:', user.uid);
                loadCashRegisterFromStorage(); // Cargar estado de la caja DESPU칄S de que el usuario inicie sesi칩n
                db_firestore.collection('users').doc(user.uid).get().then((doc) => {
                    console.log('Documento de usuario existe:', doc.exists);
                    if (doc.exists) {
                        console.log('Datos del usuario:', doc.data());
                        console.log('Rol del usuario:', doc.data().role);
                    }
                    const userRole = (doc.exists && doc.data().role) ? doc.data().role : 'seller';
                    console.log('Rol asignado:', userRole);
                    listenForData(userRole === 'admin'); // Iniciar listeners con el rol correcto
                    if (userRole === 'admin') {
                        console.log('Mostrando vista de administrador');
                        showView('admin');
                    } else {
                        console.log('Mostrando vista de vendedor');
                        showView('seller');
                    }
                }).catch(error => { console.error("Error al obtener rol de usuario:", error); showView('seller'); });
            } else {
                showView('auth');
            }
        });
        document.querySelectorAll('.logout-btn').forEach(btn => btn.addEventListener('click', handleLogout));
        initializeTheme(); setupTabNavigation('admin-tabs', 'admin-content'); setupClientsTabNavigation(); setupSidebarNavigation(); setupSaleFormListeners(); setupAdminProductListeners(); setupAdminVehicleListeners(); 
        document.getElementById('add-collection-form').addEventListener('submit', finalizeCollection); 
        
        document.getElementById('filter-closures-btn').addEventListener('click', filterClosures);
        // Sistema unificado de b칰squeda y selecci칩n de productos
        setupUnifiedProductSearch();
        // Sistema inteligente de b칰squeda de clientes
        setupIntelligentClientSearch();
        document.getElementById('credit-client-search').addEventListener('input', (e) => {
            const statusFilter = document.getElementById('credit-status-filter')?.value || 'all';
            renderCreditAccounts(e.target.value, statusFilter);
        });
        document.getElementById('credit-status-filter')?.addEventListener('change', (e) => {
            const searchTerm = document.getElementById('credit-client-search').value;
            renderCreditAccounts(searchTerm, e.target.value);
        });
        
        document.getElementById('query-admin-reports-btn').addEventListener('click', queryAndDisplayAdminReports);
        
        document.getElementById('expense-category-selector').addEventListener('change', handleExpenseCategoryChange);
        document.getElementById('filter-dashboard-btn').addEventListener('click', updateAdminDashboard);
        document.getElementById('reset-dashboard-btn').addEventListener('click', () => {
            document.getElementById('dashboard-start-date').value = '';
            document.getElementById('dashboard-end-date').value = '';
            updateAdminDashboard();
        });

        // Online/Offline Status
        updateOnlineStatus();
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // Convertir autom치ticamente a MAY칔SCULAS todos los inputs de texto y textareas
        setupUppercaseInputs();
    };

    function setupUppercaseInputs() {
        // Funci칩n para convertir a may칰sculas
        function convertToUppercase(e) {
            const target = e.target;
            const start = target.selectionStart;
            const end = target.selectionEnd;
            target.value = target.value.toUpperCase();
            target.setSelectionRange(start, end);
        }

        // Aplicar a todos los inputs de tipo text y textareas existentes
        const textInputs = document.querySelectorAll('input[type="text"], textarea');
        textInputs.forEach(input => {
            // Excluir campos de fecha, n칰mero, email, password y b칰squeda de productos
            if (!input.id.includes('date') &&
                !input.id.includes('latitude') &&
                !input.id.includes('longitude') &&
                !input.type.includes('number') &&
                !input.type.includes('email') &&
                !input.type.includes('password')) {
                input.addEventListener('input', convertToUppercase);
            }
        });

        // Observer para detectar nuevos inputs agregados din치micamente
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) { // Element node
                        const inputs = node.querySelectorAll ? node.querySelectorAll('input[type="text"], textarea') : [];
                        inputs.forEach(input => {
                            if (!input.id.includes('date') &&
                                !input.id.includes('latitude') &&
                                !input.id.includes('longitude') &&
                                !input.type.includes('number') &&
                                !input.type.includes('email') &&
                                !input.type.includes('password')) {
                                input.addEventListener('input', convertToUppercase);
                            }
                        });
                    }
                });
            });
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }

    function updateOnlineStatus() {
        const indicator = document.getElementById('status-indicator');
        if (navigator.onLine) {
            indicator.classList.remove('offline');
            indicator.classList.add('online');
            indicator.title = "En l칤nea";
            // Firestore sincroniza autom치ticamente - no necesitamos hacer nada manual
        } else {
            indicator.classList.remove('online');
            indicator.classList.add('offline');
            indicator.title = "Fuera de l칤nea";
        }
    }

    // Sistema de cola offline - DESHABILITADO
    // Firestore ya maneja la sincronizaci칩n offline autom치ticamente
    // Este sistema duplicaba las operaciones al reconectar
    function savePendingOperation(type, data) {
        console.log('丘멆잺 savePendingOperation deshabilitado - Firestore maneja offline autom치ticamente');
        // NO hacer nada - Firestore ya guarda las operaciones offline
    }

    async function syncPendingOperations() {
        console.log('丘멆잺 syncPendingOperations deshabilitado - Firestore sincroniza autom치ticamente');
        // NO hacer nada - Firestore ya sincroniza autom치ticamente
        // Limpiar cualquier operaci칩n pendiente antigua que pueda existir
        localStorage.removeItem('pendingOperations');
    }

    function handleExpenseCategoryChange() { const selector = document.getElementById('expense-category-selector'); const observationsTextarea = document.getElementById('expense-observations'); if (!selector || !observationsTextarea) return; const selectedOption = selector.options[selector.selectedIndex]; const selectedText = selectedOption ? selectedOption.text.toLowerCase().trim() : ''; if (selectedText === 'compra de producto' || selectedText === 'otros') { observationsTextarea.placeholder = "Observaciones (requerido)"; observationsTextarea.required = true; } else { observationsTextarea.placeholder = "Observaciones (opcional)"; observationsTextarea.required = false; } }

    function listenForData(isAdmin = false) {
        db_firestore.collection('products').onSnapshot((snapshot) => { db.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.name.localeCompare(b.name)); renderProductList(); renderClientDefaultProducts(); });
        db_firestore.collection('expense_types').onSnapshot((snapshot) => { db.expenseTypes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.name.localeCompare(b.name)); renderExpenseTypeList(); updateExpenseTypeDropdown(); }, error => console.error("Error en listener de expense_types:", error));
        db_firestore.collection('vehicles').onSnapshot((snapshot) => {
            db.vehicles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.plate.localeCompare(b.plate));
            renderVehiclesList();
            populateVehicleSellerDropdown();
            populateOpeningVehicleDropdown(); // Actualizar dropdown de apertura de caja
        }, error => console.error("Error en listener de vehicles:", error));
        if (isAdmin) {
            db_firestore.collection('users').onSnapshot(snapshot => {
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    db.usersMap[doc.id] = {
                        id: doc.id,
                        uid: doc.id,
                        email: userData.email,
                        displayName: userData.name || userData.displayName,
                        name: userData.name,
                        role: userData.role
                    };
                });
                loadSellersDropdown(snapshot.docs);
                // Update admin client seller dropdowns if they exist
                if (document.getElementById('admin-client-seller')) {
                    populateAdminSellerFilter();
                }
                // Update vehicle seller dropdown
                populateVehicleSellerDropdown();
            }, error => console.error("Error en listener de users:", error));
        }
        db_firestore.collection('sales').onSnapshot(snapshot => {
            db.sales = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            renderCreditAccounts();
            renderTodaySales();
        }, error => console.error("Error en listener de sales:", error));
        db_firestore.collection('expenses').onSnapshot(snapshot => db.expenses = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})));
        db_firestore.collection('collections').onSnapshot(snapshot => db.collections = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})));
        db_firestore.collection('clients').onSnapshot(snapshot => {
            db.clients = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})).sort((a,b) => a.name.localeCompare(b.name));
            renderClientsList();
            updateClientDropdown();
        }, error => console.error("Error en listener de clients:", error));

        // Listener para visitas
        db_firestore.collection('visits').onSnapshot(snapshot => {
            db.visits = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        }, error => console.error("Error en listener de visits:", error));

        // Listener para plantillas WhatsApp
        db_firestore.collection('whatsapp_templates').onSnapshot(snapshot => {
            db.whatsappTemplates = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            // Actualizar lista si estamos en el m칩dulo de admin
            const templatesList = document.getElementById('templates-list');
            if (templatesList && !document.getElementById('admin-whatsapp-templates').classList.contains('hidden')) {
                renderWhatsAppTemplatesList();
            }
        }, error => console.error("Error en listener de whatsapp_templates:", error));

        // Iniciar listener de inventario si la caja est치 abierta
        if (db.cashRegister.isOpen && db.cashRegister.sessionId) {
            startVehicleInventoryListener(db.cashRegister.sessionId);
        }
    }

    // Variable para guardar el unsubscribe del listener de inventario
    let vehicleInventoryUnsubscribe = null;

    // Funci칩n para iniciar listener de inventario en tiempo real
    function startVehicleInventoryListener(sessionId) {
        // Si ya hay un listener activo, desuscribirse primero
        if (vehicleInventoryUnsubscribe) {
            vehicleInventoryUnsubscribe();
        }

        console.log('游댃 Iniciando listener de inventario para sesi칩n:', sessionId);

        vehicleInventoryUnsubscribe = db_firestore.collection('vehicle_inventory')
            .where('sessionId', '==', sessionId)
            .onSnapshot(snapshot => {
                // Actualizar inventario en memoria
                db.cashRegister.vehicleInventory = snapshot.docs.map(doc => ({
                    id: doc.id,
                    productId: doc.data().productId,
                    quantity: doc.data().quantity
                }));

                console.log('游닍 Inventario actualizado en tiempo real:', db.cashRegister.vehicleInventory.length, 'productos');

                // Actualizar UI si el usuario est치 en vista de vendedor
                if (document.getElementById('seller-view') && !document.getElementById('seller-view').classList.contains('hidden')) {
                    updateSellerDashboard();
                    renderInventoryProducts();
                }

                // Guardar en localStorage para persistencia offline
                saveCashRegisterToStorage();
            }, error => console.error("Error en listener de vehicle_inventory:", error));
    }

    // Funci칩n para detener listener de inventario
    function stopVehicleInventoryListener() {
        if (vehicleInventoryUnsubscribe) {
            vehicleInventoryUnsubscribe();
            vehicleInventoryUnsubscribe = null;
            console.log('낓勇 Listener de inventario detenido');
        }
    }

    // ===== GESTI칍N DE CLIENTES =====
    function getClientLocation() {
        if (!navigator.geolocation) {
            alert('La geolocalizaci칩n no est치 soportada en este navegador');
            return;
        }

        const latInput = document.getElementById('client-latitude');
        const lonInput = document.getElementById('client-longitude');

        latInput.value = 'Obteniendo...';
        lonInput.value = 'Obteniendo...';

        navigator.geolocation.getCurrentPosition(
            (position) => {
                latInput.value = position.coords.latitude.toFixed(6);
                lonInput.value = position.coords.longitude.toFixed(6);
                alert('九 Ubicaci칩n capturada correctamente');
            },
            (error) => {
                latInput.value = '';
                lonInput.value = '';
                let errorMsg = 'Error al obtener ubicaci칩n';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg = 'Por favor, permite el acceso a la ubicaci칩n en tu navegador';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg = 'Informaci칩n de ubicaci칩n no disponible';
                        break;
                    case error.TIMEOUT:
                        errorMsg = 'Tiempo de espera agotado';
                        break;
                }
                alert(errorMsg);
            }
        );
    }

    document.getElementById('add-client-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const type = document.querySelector('input[name="client-form-type"]:checked').value;
        const name = document.getElementById('client-name-input').value.trim();
        const businessName = document.getElementById('client-business-name').value.trim();
        const phone = document.getElementById('client-phone').value.trim();

        // Ubicaci칩n
        const province = document.getElementById('client-province').value;
        const canton = document.getElementById('client-canton').value.trim();
        const parish = document.getElementById('client-parish').value.trim();
        const sector = document.getElementById('client-sector').value.trim();
        const address = document.getElementById('client-address').value.trim();
        const latitude = document.getElementById('client-latitude').value;
        const longitude = document.getElementById('client-longitude').value;

        // Productos predeterminados
        const defaultProducts = Array.from(document.querySelectorAll('input[name="default-products"]:checked')).map(cb => cb.value);

        // Planificaci칩n de visitas
        const visitDays = Array.from(document.querySelectorAll('input[name="visit-days"]:checked')).map(cb => cb.value);
        const visitTime = document.getElementById('client-visit-time').value;
        const visitFrequency = document.getElementById('client-visit-frequency').value;

        // Notas
        const notes = document.getElementById('client-notes').value.trim();

        if (!name) {
            alert('El nombre del cliente es obligatorio');
            return;
        }

        if (!province) {
            alert('La provincia es obligatoria');
            return;
        }

        // Verificar si estamos editando o creando
        const editingId = e.target.dataset.editingId;
        const isEditing = !!editingId;

        // Si estamos creando, verificar si el cliente ya existe
        if (!isEditing) {
            const existingClient = db.clients.find(c =>
                c.name.toLowerCase() === name.toLowerCase() ||
                (phone && c.phone === phone)
            );

            if (existingClient) {
                alert(`丘멆잺 Ya existe un cliente con ese nombre o tel칠fono.\n\nNombre: ${existingClient.name}\nTel칠fono: ${existingClient.phone || 'Sin tel칠fono'}`);
                return;
            }
        }

        const clientData = {
            type,
            name,
            businessName: type === 'negocio' ? businessName : '',
            phone,
            // Ubicaci칩n completa
            province,
            canton,
            parish,
            sector,
            address,
            location: latitude && longitude ? {
                latitude: parseFloat(latitude),
                longitude: parseFloat(longitude)
            } : null,
            // Productos predeterminados
            defaultProducts,
            // Planificaci칩n de visitas
            visitSchedule: {
                days: visitDays,
                time: visitTime,
                frequency: visitFrequency
            },
            // Notas
            notes,
            // Metadatos
            status: 'active' // active, inactive
        };

        // Si es un nuevo cliente, asignar autom치ticamente al vendedor que lo crea
        if (!isEditing) {
            clientData.assignedSeller = auth.currentUser.uid;
        }

        // Si no estamos editando, agregar campos de creaci칩n
        if (!isEditing) {
            clientData.createdBy = auth.currentUser.uid;
            clientData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        } else {
            // Si estamos editando, agregar campos de actualizaci칩n
            clientData.updatedBy = auth.currentUser.uid;
            clientData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
        }

        try {
            if (isEditing) {
                // Actualizar cliente existente
                await db_firestore.collection('clients').doc(editingId).update(clientData);

                // Actualizar en el array local
                const index = db.clients.findIndex(c => c.id === editingId);
                if (index !== -1) {
                    db.clients[index] = {
                        ...db.clients[index],
                        ...clientData,
                        id: editingId
                    };
                }

                alert('九 Cliente actualizado exitosamente');
            } else {
                // Crear nuevo cliente
                const docRef = await db_firestore.collection('clients').add(clientData);

                // Agregar el cliente al array local inmediatamente
                db.clients.push({
                    id: docRef.id,
                    ...clientData,
                    createdAt: new Date()
                });

                alert('九 Cliente guardado exitosamente');
            }

            db.clients.sort((a,b) => a.name.localeCompare(b.name));

            // Actualizar la lista visual
            renderClientsList();
            updateClientDropdown();

            // Limpiar formulario y dataset
            e.target.reset();
            delete e.target.dataset.editingId;
            document.getElementById('client-latitude').value = '';
            document.getElementById('client-longitude').value = '';

            const businessNameField = document.getElementById('business-name-field');
            if (businessNameField) {
                businessNameField.classList.add('hidden');
            }

            // Cambiar a la pesta침a de lista de clientes
            const tabButtons = document.querySelectorAll('[data-tab]');
            const listTabButton = document.querySelector('[data-tab="list-clients"]');
            const createClientTab = document.getElementById('create-client');
            const listClientsTab = document.getElementById('list-clients');

            if (tabButtons.length > 0) {
                tabButtons.forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-slate-200', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-300');
                });
            }

            if (listTabButton) {
                listTabButton.classList.remove('bg-slate-200', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-300');
                listTabButton.classList.add('bg-blue-600', 'text-white');
            }

            if (createClientTab) createClientTab.classList.add('hidden');
            if (listClientsTab) listClientsTab.classList.remove('hidden');
        } catch (error) {
            console.error('Error al guardar cliente:', error);
            alert('Error al guardar cliente: ' + error.message);
        }
    });

    // Mostrar/ocultar campo de nombre de negocio
    document.querySelectorAll('input[name="client-form-type"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const businessField = document.getElementById('business-name-field');
            if (e.target.value === 'negocio') {
                businessField.classList.remove('hidden');
            } else {
                businessField.classList.add('hidden');
            }
        });
    });

    // ===== FUNCIONES DE C칍DIGO QR =====

    async function generateClientQRCode(clientId, clientName) {
        return new Promise((resolve, reject) => {
            try {
                const tempContainer = document.createElement('div');
                tempContainer.style.display = 'none';
                document.body.appendChild(tempContainer);

                const qr = new QRCode(tempContainer, {
                    text: clientId,
                    width: 256,
                    height: 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                setTimeout(() => {
                    const canvas = tempContainer.querySelector('canvas');
                    if (canvas) {
                        const qrDataURL = canvas.toDataURL('image/png');
                        document.body.removeChild(tempContainer);
                        resolve(qrDataURL);
                    } else {
                        document.body.removeChild(tempContainer);
                        reject(new Error('No se pudo generar el QR'));
                    }
                }, 200);
            } catch (error) {
                reject(error);
            }
        });
    }

    // Funci칩n para obtener iniciales del nombre
    function getInitials(name) {
        if (!name) return '';
        const words = name.trim().split(/\s+/);
        return words.map(word => word.charAt(0).toUpperCase()).join('');
    }

    // Funci칩n para ocultar los 칰ltimos 4 d칤gitos del tel칠fono
    function maskPhoneNumber(phone) {
        if (!phone) return '';
        const cleaned = phone.replace(/\D/g, ''); // Quitar caracteres no num칠ricos
        if (cleaned.length <= 4) return 'XXXX';
        return cleaned.substring(0, cleaned.length - 4) + 'XXXX';
    }

    async function downloadClientQR(clientId, clientName) {
        try {
            const qrDataURL = await generateClientQRCode(clientId, clientName);

            // Crear PDF con jsPDF
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            // T칤tulo
            pdf.setFontSize(20);
            pdf.setFont(undefined, 'bold');
            pdf.text('DISTRIBUIDOR AUTORIZADO', 105, 20, { align: 'center' });

            // Iniciales del cliente
            pdf.setFontSize(24);
            pdf.setFont(undefined, 'bold');
            const initials = getInitials(clientName);
            pdf.text(initials, 105, 35, { align: 'center' });

            // C칩digo QR centrado
            const qrSize = 80;
            const qrX = (210 - qrSize) / 2;
            pdf.addImage(qrDataURL, 'PNG', qrX, 50, qrSize, qrSize);

            // ID del cliente (peque침o, al final)
            pdf.setFontSize(8);
            pdf.text(`ID: ${clientId}`, 105, 140, { align: 'center' });

            // Descargar
            pdf.save(`QR_${clientName.replace(/\s+/g, '_')}.pdf`);

            alert('九 C칩digo QR descargado correctamente');
        } catch (error) {
            console.error('Error al descargar QR:', error);
            alert('仇 Error al generar el c칩digo QR');
        }
    }

    async function downloadClientQRImage(clientId, clientName) {
        try {
            const qrDataURL = await generateClientQRCode(clientId, clientName);

            // Crear un canvas para a침adir el nombre del cliente
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Configurar tama침o del canvas
            const qrSize = 300;
            const padding = 40;
            const textHeight = 60;
            canvas.width = qrSize + (padding * 2);
            canvas.height = qrSize + (padding * 2) + textHeight;

            // Fondo blanco
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Cargar imagen QR
            const img = new Image();
            img.onload = function() {
                // Dibujar QR
                ctx.drawImage(img, padding, padding + textHeight, qrSize, qrSize);

                // A침adir nombre del cliente arriba
                ctx.fillStyle = '#000000';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(clientName, canvas.width / 2, padding + 30);

                // Convertir canvas a imagen y descargar
                const finalImage = canvas.toDataURL('image/jpeg', 1.0);
                const link = document.createElement('a');
                link.download = `QR_${clientName.replace(/\s+/g, '_')}.jpg`;
                link.href = finalImage;
                link.click();

                alert('九 C칩digo QR descargado correctamente');
            };
            img.onerror = function() {
                alert('仇 Error al generar la imagen del c칩digo QR');
            };
            img.src = qrDataURL;

        } catch (error) {
            console.error('Error al descargar QR:', error);
            alert('仇 Error al generar el c칩digo QR');
        }
    }

    // ===== BULK QR DOWNLOAD =====

    async function downloadAllClientQRs() {
        if (db.clients.length === 0) {
            alert('No hay clientes registrados para descargar.');
            return;
        }

        const confirmDownload = confirm(`쮻esea descargar los c칩digos QR de todos los ${db.clients.length} clientes en un solo PDF?\n\nEsto puede tardar unos momentos.`);
        if (!confirmDownload) return;

        try {
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const pageWidth = 210; // A4 width in mm
            const pageHeight = 297; // A4 height in mm
            const margin = 15;
            const qrSize = 50;
            const cellWidth = (pageWidth - margin * 2) / 2; // 2 columns
            const cellHeight = 110; // Aumentado para incluir m치s informaci칩n
            const cols = 2;
            const rows = 2; // 2 rows per page (reducido para dar m치s espacio)
            const itemsPerPage = cols * rows;

            let currentPage = 0;
            let itemIndex = 0;

            for (const client of db.clients) {
                const col = itemIndex % cols;
                const row = Math.floor((itemIndex % itemsPerPage) / cols);

                // Add new page if needed
                if (itemIndex > 0 && itemIndex % itemsPerPage === 0) {
                    pdf.addPage();
                    currentPage++;
                }

                // Calculate position
                const x = margin + col * cellWidth;
                const y = margin + row * cellHeight;

                // Generate QR code
                const qrDataURL = await generateClientQRCode(client.id, client.name);

                // Draw border
                pdf.setDrawColor(200, 200, 200);
                pdf.rect(x, y, cellWidth, cellHeight);

                // Title
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'bold');
                pdf.text('DISTRIBUIDOR AUTORIZADO', x + cellWidth / 2, y + 8, { align: 'center' });

                // Iniciales del cliente
                const displayName = client.type === 'negocio' && client.businessName
                    ? client.businessName
                    : client.name;
                const initials = getInitials(displayName);

                pdf.setFontSize(12);
                pdf.setFont(undefined, 'bold');
                pdf.text(initials, x + cellWidth / 2, y + 15, { align: 'center' });

                // QR Code (centered)
                const qrX = x + (cellWidth - qrSize) / 2;
                const qrY = y + 20;
                pdf.addImage(qrDataURL, 'PNG', qrX, qrY, qrSize, qrSize);

                // Informaci칩n de ubicaci칩n
                pdf.setFontSize(6);
                pdf.setTextColor(60, 60, 60);
                pdf.setFont(undefined, 'normal');

                let infoY = y + 72;
                const lineHeight = 3.5;

                // Tel칠fono (con 칰ltimos 4 d칤gitos ocultos)
                if (client.phone) {
                    const maskedPhone = maskPhoneNumber(client.phone);
                    pdf.text(`Tel: ${maskedPhone}`, x + cellWidth / 2, infoY, { align: 'center' });
                    infoY += lineHeight;
                }

                // Provincia
                if (client.province) {
                    pdf.text(`Prov: ${client.province}`, x + cellWidth / 2, infoY, { align: 'center' });
                    infoY += lineHeight;
                }

                // Cant칩n
                if (client.canton) {
                    pdf.text(`Cant: ${client.canton}`, x + cellWidth / 2, infoY, { align: 'center' });
                    infoY += lineHeight;
                }

                // Parroquia
                if (client.parish) {
                    pdf.text(`Parr: ${client.parish}`, x + cellWidth / 2, infoY, { align: 'center' });
                    infoY += lineHeight;
                }

                // Barrio
                if (client.neighborhood) {
                    const barrio = client.neighborhood.length > 20 ? client.neighborhood.substring(0, 20) + '...' : client.neighborhood;
                    pdf.text(`Barr: ${barrio}`, x + cellWidth / 2, infoY, { align: 'center' });
                    infoY += lineHeight;
                }

                pdf.setTextColor(0, 0, 0);
                itemIndex++;
            }

            // Save PDF
            const today = new Date().toISOString().split('T')[0];
            pdf.save(`Codigos_QR_Clientes_${today}.pdf`);

            alert(`九 Se descargaron ${db.clients.length} c칩digos QR correctamente en un solo PDF.`);

        } catch (error) {
            console.error('Error al generar PDF masivo:', error);
            alert('仇 Error al generar el PDF. Por favor, intenta de nuevo.');
        }
    }

    // ===== QR SCANNER FUNCTIONS =====

    let html5QrCode = null;

    function openQRScanner() {
        const modal = document.getElementById('qr-scanner-modal');
        modal.classList.remove('hidden');
        startQRScanner();
    }

    function closeQRScanner() {
        const modal = document.getElementById('qr-scanner-modal');
        modal.classList.add('hidden');
        stopQRScanner();
    }

    async function startQRScanner() {
        const qrReaderDiv = document.getElementById('qr-reader');
        const statusDiv = document.getElementById('qr-scanner-status');

        try {
            // Inicializar el esc치ner si no existe
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
            }

            // Configuraci칩n del esc치ner
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            // Funci칩n que se ejecuta cuando se escanea correctamente
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                console.log('QR escaneado:', decodedText);
                statusDiv.innerHTML = '九 춰C칩digo QR detectado!';
                statusDiv.className = 'text-center text-sm text-green-600 font-semibold';

                // Detener el esc치ner y procesar el cliente
                stopQRScanner();
                closeQRScanner();
                loadClientFromQR(decodedText);
            };

            // Funci칩n de error (silenciosa para no mostrar cada frame sin QR)
            const qrCodeErrorCallback = (errorMessage) => {
                // No hacer nada, es normal que no detecte QR en cada frame
            };

            // Iniciar el esc치ner con la c치mara trasera
            await html5QrCode.start(
                { facingMode: "environment" }, // C치mara trasera
                config,
                qrCodeSuccessCallback,
                qrCodeErrorCallback
            );

            statusDiv.innerHTML = '游닝 Apunta la c치mara hacia el c칩digo QR del cliente';
            statusDiv.className = 'text-center text-sm text-slate-600 dark:text-slate-400';

        } catch (err) {
            console.error('Error al iniciar el esc치ner:', err);
            statusDiv.innerHTML = '仇 Error al acceder a la c치mara. Por favor, permite el acceso a la c치mara.';
            statusDiv.className = 'text-center text-sm text-red-600 font-semibold';
        }
    }

    async function stopQRScanner() {
        if (html5QrCode && html5QrCode.isScanning) {
            try {
                await html5QrCode.stop();
                html5QrCode.clear();
            } catch (err) {
                console.error('Error al detener el esc치ner:', err);
            }
        }
    }

    async function loadClientFromQR(scannedText) {
        try {
            console.log('Texto escaneado:', scannedText);
            console.log('Total de clientes en db:', db.clients.length);
            console.log('IDs de clientes disponibles:', db.clients.map(c => c.id));

            // El texto escaneado debe ser el ID del cliente
            const clientId = scannedText.trim();

            // Buscar el cliente en la base de datos local
            const client = db.clients.find(c => c.id === clientId);

            console.log('Cliente encontrado:', client);

            if (!client) {
                console.error('Cliente no encontrado con ID:', clientId);
                alert(`仇 Cliente no encontrado.\n\nID escaneado: ${clientId}\n\nPor favor, verifica que el c칩digo QR sea v치lido y que tengas acceso a este cliente.`);
                return;
            }

            // Verificar que el cliente est칠 asignado al vendedor actual
            const currentUserId = auth.currentUser.uid;
            if (client.assignedSeller && client.assignedSeller !== currentUserId) {
                const userRole = (await auth.currentUser.getIdTokenResult()).claims.role;
                if (userRole !== 'admin') {
                    alert('仇 Este cliente no est치 asignado a ti. No puedes registrar ventas para este cliente.');
                    return;
                }
            }

            // Seleccionar el cliente en el dropdown
            const clientSelect = document.getElementById('sale-client');
            if (clientSelect) {
                clientSelect.value = clientId;
                // Disparar evento change para actualizar el precio
                clientSelect.dispatchEvent(new Event('change'));
            }

            // Cargar los productos predeterminados del cliente
            await loadClientDefaultProducts(clientId);

            // Mostrar mensaje de 칠xito
            const displayName = client.type === 'negocio' && client.businessName
                ? client.businessName
                : client.name;

            alert(`九 Cliente cargado: ${displayName}\n\n${client.defaultProducts && client.defaultProducts.length > 0 ? 'Productos predeterminados agregados al carrito.' : 'Este cliente no tiene productos predeterminados.'}`);

        } catch (error) {
            console.error('Error al cargar cliente desde QR:', error);
            alert(`仇 Error al cargar el cliente:\n\n${error.message}`);
        }
    }

    async function loadClientDefaultProducts(clientId) {
        const client = db.clients.find(c => c.id === clientId);

        if (!client || !client.defaultProducts || client.defaultProducts.length === 0) {
            return; // No hay productos predeterminados
        }

        // Limpiar el carrito actual
        currentSaleItems = [];

        // Agregar cada producto predeterminado al carrito con cantidad 1
        client.defaultProducts.forEach(productId => {
            const product = db.products.find(p => p.id === productId);
            if (product) {
                const priceType = client.type === 'negocio' ? 'priceBusiness' : 'priceNormal';
                const price = product[priceType];

                // Verificar que el precio exista y sea v치lido
                if (price !== undefined && price !== null && !isNaN(price)) {
                    currentSaleItems.push({
                        productId: product.id,
                        name: product.name,
                        quantity: 1,
                        price: parseFloat(price),
                        basePrice: parseFloat(price),
                        total: parseFloat(price)
                    });
                } else {
                    console.warn(`Producto ${product.name} no tiene precio ${priceType} configurado`);
                }
            }
        });

        // Actualizar la vista del carrito
        renderCurrentSaleTable();
    }

    function renderClientsList(searchTerm = '') {
        const container = document.getElementById('clients-list-container');
        const countEl = document.getElementById('clients-count');

        if (!container) return;

        const currentUserId = auth.currentUser.uid;
        const lowerSearch = searchTerm.toLowerCase();

        // Filtrar solo los clientes asignados al vendedor actual
        const filteredClients = db.clients.filter(c =>
            c.assignedSeller === currentUserId && (
                c.name.toLowerCase().includes(lowerSearch) ||
                (c.businessName && c.businessName.toLowerCase().includes(lowerSearch)) ||
                (c.phone && c.phone.includes(searchTerm))
            )
        );

        countEl.textContent = filteredClients.length;

        if (filteredClients.length === 0) {
            container.innerHTML = '<p class="text-center py-8 text-slate-500 dark:text-slate-400">No hay clientes registrados</p>';
            return;
        }

        container.innerHTML = filteredClients.map(client => {
            const displayName = client.type === 'negocio' && client.businessName
                ? `${client.businessName} (${client.name})`
                : client.name;

            const locationUrl = client.location
                ? `https://www.google.com/maps?q=${client.location.latitude},${client.location.longitude}`
                : null;

            return `
                <div class="bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg border border-slate-200 dark:border-slate-600">
                    <div class="flex items-start gap-3">
                        <!-- C칩digo QR -->
                        <div class="flex-shrink-0">
                            <div id="qr-${client.id}" class="w-20 h-20 bg-white p-1 rounded border-2 border-slate-300"></div>
                            <div class="mt-1 flex gap-1">
                                <button onclick="downloadClientQRImage('${client.id}', '${client.name.replace(/'/g, "\\'")}')" class="flex-1 bg-purple-100 hover:bg-purple-200 dark:bg-purple-900 dark:hover:bg-purple-800 text-purple-600 dark:text-purple-400 px-2 py-1 rounded text-xs font-semibold" title="Descargar JPG">
                                    JPG
                                </button>
                                <button onclick="downloadClientQR('${client.id}', '${client.name.replace(/'/g, "\\'")}')" class="flex-1 bg-blue-100 hover:bg-blue-200 dark:bg-blue-900 dark:hover:bg-blue-800 text-blue-600 dark:text-blue-400 px-2 py-1 rounded text-xs font-semibold" title="Descargar PDF">
                                    PDF
                                </button>
                            </div>
                        </div>

                        <!-- Informaci칩n del Cliente -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-lg">${client.type === 'negocio' ? '游끽' : '游녻'}</span>
                                <h4 class="font-semibold text-slate-800 dark:text-slate-200 truncate">${displayName}</h4>
                            </div>
                            ${client.phone ? `<p class="text-sm text-slate-600 dark:text-slate-400">游 ${client.phone}</p>` : ''}
                            ${client.province ? `<p class="text-sm text-slate-600 dark:text-slate-400">游늸 ${client.province}${client.canton ? ', ' + client.canton : ''}</p>` : ''}
                            ${client.address ? `<p class="text-xs text-slate-500 dark:text-slate-500">${client.address}</p>` : ''}
                            ${locationUrl ? `<a href="${locationUrl}" target="_blank" class="text-xs text-blue-600 dark:text-blue-400 hover:underline flex items-center gap-1 mt-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                Ver en Mapa
                            </a>` : ''}
                        </div>

                        <!-- Botones de Acci칩n -->
                        <div class="flex-shrink-0 flex flex-col gap-2">
                            <div class="flex gap-2">
                                <button onclick="editClient('${client.id}')" class="bg-blue-100 active:bg-blue-200 dark:bg-blue-900 dark:active:bg-blue-800 text-blue-600 dark:text-blue-400 px-3 py-2 rounded-lg transition text-sm font-semibold">
                                    Editar
                                </button>
                                <button onclick="deleteClient('${client.id}')" class="bg-red-100 active:bg-red-200 dark:bg-red-900 dark:active:bg-red-800 text-red-600 dark:text-red-400 px-3 py-2 rounded-lg transition text-sm font-semibold">
                                    Eliminar
                                </button>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="callClient('${client.phone ? client.phone.replace(/'/g, "\\'") : ""}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-xs font-semibold flex items-center justify-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                    </svg>
                                    Llamar
                                </button>
                                <button onclick="openWhatsAppTemplates('${client.id}')" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-xs font-semibold flex items-center justify-center gap-1">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                    </svg>
                                    WhatsApp
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // Generar c칩digos QR para cada cliente
        setTimeout(() => {
            filteredClients.forEach(client => {
                const qrContainer = document.getElementById(`qr-${client.id}`);
                if (qrContainer && qrContainer.children.length === 0) {
                    new QRCode(qrContainer, {
                        text: client.id,
                        width: 80,
                        height: 80,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.M
                    });
                }
            });
        }, 100);
    }

    document.getElementById('search-clients').addEventListener('input', (e) => {
        renderClientsList(e.target.value);
    });

    function editClient(clientId) {
        const client = db.clients.find(c => c.id === clientId);
        if (!client) {
            alert('Cliente no encontrado');
            return;
        }

        // Cambiar a la pesta침a de crear cliente
        const createTabButton = document.querySelector('[data-tab="create-client"]');
        const listTabButton = document.querySelector('[data-tab="list-clients"]');
        const createClientTab = document.getElementById('create-client');
        const listClientsTab = document.getElementById('list-clients');

        if (createTabButton && listTabButton) {
            // Actualizar estilos de botones
            createTabButton.classList.remove('bg-slate-200', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-300');
            createTabButton.classList.add('bg-blue-600', 'text-white');
            listTabButton.classList.remove('bg-blue-600', 'text-white');
            listTabButton.classList.add('bg-slate-200', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-300');
        }

        if (createClientTab) createClientTab.classList.remove('hidden');
        if (listClientsTab) listClientsTab.classList.add('hidden');

        // Guardar ID del cliente que se est치 editando
        const form = document.getElementById('add-client-form');
        if (!form.dataset) form.dataset = {};
        form.dataset.editingId = clientId;

        // Rellenar el formulario con los datos del cliente
        const typeRadio = document.querySelector(`input[name="client-form-type"][value="${client.type}"]`);
        if (typeRadio) typeRadio.checked = true;

        document.getElementById('client-name-input').value = client.name || '';

        const businessNameField = document.getElementById('business-name-field');
        const businessNameInput = document.getElementById('client-business-name');
        if (client.type === 'negocio') {
            if (businessNameField) businessNameField.classList.remove('hidden');
            if (businessNameInput) businessNameInput.value = client.businessName || '';
        } else {
            if (businessNameField) businessNameField.classList.add('hidden');
        }

        document.getElementById('client-phone').value = client.phone || '';
        document.getElementById('client-province').value = client.province || '';
        document.getElementById('client-canton').value = client.canton || '';
        document.getElementById('client-parish').value = client.parish || '';
        document.getElementById('client-sector').value = client.sector || '';
        document.getElementById('client-address').value = client.address || '';

        if (client.location) {
            document.getElementById('client-latitude').value = client.location.latitude || '';
            document.getElementById('client-longitude').value = client.location.longitude || '';
        }

        // Marcar productos predeterminados
        renderClientDefaultProducts();
        setTimeout(() => {
            document.querySelectorAll('input[name="default-products"]').forEach(cb => {
                cb.checked = client.defaultProducts && client.defaultProducts.includes(cb.value);
            });
        }, 100);

        // Marcar d칤as de visita
        document.querySelectorAll('input[name="visit-days"]').forEach(cb => {
            cb.checked = client.visitSchedule?.days && client.visitSchedule.days.includes(cb.value);
        });

        document.getElementById('client-visit-time').value = client.visitSchedule?.time || '';
        document.getElementById('client-visit-frequency').value = client.visitSchedule?.frequency || '';
        document.getElementById('client-notes').value = client.notes || '';

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function deleteClient(clientId) {
        if (!confirm('쮼st치 seguro de eliminar este cliente?')) return;

        try {
            await db_firestore.collection('clients').doc(clientId).delete();
            alert('Cliente eliminado');
        } catch (error) {
            alert('Error al eliminar: ' + error.message);
        }
    }

    function updateClientDropdown() {
        const select = document.getElementById('sale-client-selector');
        if (!select) return;

        const currentUserId = auth.currentUser.uid;

        select.innerHTML = '<option value="">Seleccione un cliente (opcional)</option>';

        // Filtrar solo los clientes asignados al vendedor actual
        db.clients
            .filter(client => client.assignedSeller === currentUserId)
            .forEach(client => {
                const displayName = client.type === 'negocio' && client.businessName
                    ? `${client.businessName} - ${client.name}`
                    : client.name;

                // Agregar tel칠fono al texto para permitir b칰squeda por n칰mero
                const optionText = client.phone
                    ? `${displayName} - ${client.phone}`
                    : displayName;

                select.innerHTML += `<option value="${client.id}" data-phone="${client.phone || ''}">${optionText}</option>`;
            });
    }

    function setupTabNavigation(tabsContainerId, contentContainerId) { const tabsContainer = document.getElementById(tabsContainerId); if (!tabsContainer) return; tabsContainer.querySelectorAll('.tab-button').forEach(tab => { tab.addEventListener('click', () => { tabsContainer.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active')); tab.classList.add('active'); const targetId = tab.dataset.target; Array.from(document.getElementById(contentContainerId).children).forEach(content => { content.classList.toggle('hidden', content.id !== targetId); }); if (targetId === 'admin-clients') { loadAdminClientsModule(); } if (targetId === 'admin-visits') { loadAdminVisitsModule(); } if (targetId === 'admin-whatsapp-templates') { loadWhatsAppTemplatesModule(); } if (targetId === 'admin-vehicles') { populateVehicleSellerDropdown(); } if (targetId === 'admin-losses') { loadAdminLossesPending(); loadAdminLossesHistory(); calculateLossesStats(); populateLossesSellerFilter(); } if (targetId === 'admin-transfers') { loadAdminTransfersPending(); loadAdminTransfersHistory(); calculateTransfersStats(); populateTransfersRequesterFilter(); } }); }); }

    function setupClientsTabNavigation() {
        const tabsContainer = document.getElementById('clients-tabs');
        if (!tabsContainer) return;

        tabsContainer.querySelectorAll('[data-tab]').forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;

                // Actualizar estilos de los botones
                tabsContainer.querySelectorAll('[data-tab]').forEach(btn => {
                    if (btn.dataset.tab === targetTab) {
                        btn.classList.remove('bg-slate-200', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-300');
                        btn.classList.add('bg-blue-600', 'text-white');
                    } else {
                        btn.classList.remove('bg-blue-600', 'text-white');
                        btn.classList.add('bg-slate-200', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-300');
                    }
                });

                // Mostrar/ocultar contenido
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('hidden', content.id !== targetTab);
                });

                // Si se abre la pesta침a de nuevo cliente, renderizar productos
                if (targetTab === 'create-client' || targetTab === 'client-tab-nuevo') {
                    renderClientDefaultProducts();
                }
            });
        });
    }
    // Sistema de tema oscuro/claro mejorado
    function updateThemeIcon(isDark) {
        // Actualizar iconos del vendedor
        const sellerIconLight = document.getElementById('theme-icon-light');
        const sellerIconDark = document.getElementById('theme-icon-dark');
        if (sellerIconLight) sellerIconLight.classList.toggle('hidden', !isDark);
        if (sellerIconDark) sellerIconDark.classList.toggle('hidden', isDark);

        // Actualizar iconos del admin
        const adminToggle = document.getElementById('admin-theme-toggle');
        if (adminToggle) {
            const adminIconLight = adminToggle.querySelector('.theme-icon-light');
            const adminIconDark = adminToggle.querySelector('.theme-icon-dark');
            if (adminIconLight) adminIconLight.classList.toggle('hidden', !isDark);
            if (adminIconDark) adminIconDark.classList.toggle('hidden', isDark);
        }
    }

    function toggleTheme() {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        updateThemeIcon(isDark);
    }

    function initializeTheme() {
        const isDark = localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
        if (isDark) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        updateThemeIcon(isDark);
    }

    // Agregar event listeners a ambos botones
    const sellerThemeToggle = document.getElementById('theme-toggle');
    const adminThemeToggle = document.getElementById('admin-theme-toggle');
    if (sellerThemeToggle) sellerThemeToggle.addEventListener('click', toggleTheme);
    if (adminThemeToggle) adminThemeToggle.addEventListener('click', toggleTheme);
    const sidebar = document.getElementById('seller-sidebar'), sidebarToggle = document.getElementById('sidebar-toggle'), mainContent = document.getElementById('seller-main-content'); function toggleSidebar() { sidebar.classList.toggle('-translate-x-full'); mainContent.classList.toggle('md:ml-64'); document.getElementById('menu-open-icon').classList.toggle('hidden'); document.getElementById('menu-close-icon').classList.toggle('hidden'); } if (sidebarToggle) { sidebarToggle.addEventListener('click', toggleSidebar); }
    function setupSidebarNavigation() {
        const menu = document.getElementById('seller-menu');
        if (!menu) return;
        const contentContainer = document.getElementById('seller-content');
        menu.querySelectorAll('.sidebar-button').forEach(button => {
            if(button.dataset.target) {
                button.addEventListener('click', () => {
                    menu.querySelectorAll('.sidebar-button').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    const targetId = button.dataset.target;
                    Array.from(contentContainer.children).forEach(content => content.classList.toggle('hidden', content.id !== targetId));
                    if(targetId === 'seller-credit-accounts') renderCreditAccounts();
                    if(targetId === 'seller-collections') updateCollectionsModule();
                    if(targetId === 'seller-expenses') updateExpensesModule();
                    if(targetId === 'seller-goals') loadGoalsModule();
                    if(targetId === 'seller-visits') loadVisitsModule();
                    if(targetId === 'seller-inventory') loadSellerInventoryModule();
                    if(targetId === 'seller-loaned-containers') loadLoanedContainersModule();
                    if(targetId === 'seller-losses') {
                        populateLossProductDropdown();
                        loadSellerLosses();
                    }
                    if(targetId === 'seller-transfers') {
                        populateTransferVehicleDropdowns();
                        populateTransferProductDropdown();
                        loadSellerTransfers();
                    }
                    if(targetId === 'seller-reports') {
                        renderTodaySales();
                        loadSellerClosures();
                    }
                    if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
                        toggleSidebar();
                    }
                });
            }
        });
        const firstButton = menu.querySelector('.sidebar-button[data-target]');
        if (firstButton) firstButton.click();
    }
    
    function updateSellerDashboard() {
        const dashboardSalesEl = document.getElementById('dashboard-total-sales');
        if (!dashboardSalesEl) return;

        // Actualizar nombre del vendedor
        db_firestore.collection('users').doc(auth.currentUser.uid).get().then((doc) => {
            if (doc.exists) {
                const userName = doc.data().name || doc.data().email || 'VENDEDOR';
                document.getElementById('seller-name-display').textContent = userName.toUpperCase();
            }
        }).catch(error => {
            console.error("Error al obtener nombre del vendedor:", error);
        });

        if (!db.cashRegister.isOpen) {
            // Resumen principal
            dashboardSalesEl.textContent = '$0.00';
            document.getElementById('dashboard-sales-count').textContent = '0 ventas';
            document.getElementById('dashboard-total-expenses').textContent = '$0.00';
            document.getElementById('dashboard-expenses-count').textContent = '0 gastos';

            // Alertas de stock
            document.getElementById('dashboard-stock-alerts').innerHTML = '<div class="text-center text-slate-500 py-4">Abra la caja para ver el inventario del veh칤culo.</div>';

            // Top productos
            document.getElementById('dashboard-top-products').innerHTML = '<div class="text-center text-slate-500 py-4">La caja est치 cerrada.</div>';

            return;
        }

        // Obtener TODAS las ventas del d칤a
        const todaySales = db.sales.filter(s => s.date === getCurrentDate() && s.sellerId === auth.currentUser.uid);
        const expensesInSession = db.cashRegister.transactions.filter(t => t.type === 'expense');

        // Calcular totales
        const totalSales = todaySales.reduce((sum, s) => sum + s.total, 0);
        const totalExpenses = expensesInSession.reduce((sum, e) => sum + e.amount, 0);
        const balance = totalSales - totalExpenses;

        // Calcular items vendidos
        let totalItems = 0;
        todaySales.forEach(sale => {
            sale.items.forEach(item => {
                totalItems += item.quantity;
            });
        });

        // RESUMEN PRINCIPAL: Total Ventas y Total Gastos
        dashboardSalesEl.textContent = `$${totalSales.toFixed(2)}`;
        document.getElementById('dashboard-sales-count').textContent = `${todaySales.length} venta${todaySales.length !== 1 ? 's' : ''}`;
        document.getElementById('dashboard-total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
        document.getElementById('dashboard-expenses-count').textContent = `${expensesInSession.length} gasto${expensesInSession.length !== 1 ? 's' : ''}`;

        // PRODUCTOS VENDIDOS
        const soldProducts = {};
        todaySales.forEach(sale => {
            sale.items.forEach(item => {
                if (!soldProducts[item.productId]) {
                    soldProducts[item.productId] = { name: item.name, quantity: 0, total: 0 };
                }
                soldProducts[item.productId].quantity += item.quantity;
                soldProducts[item.productId].total += (item.price * item.quantity);
            });
        });

        const sortedProducts = Object.entries(soldProducts)
            .sort(([, a], [, b]) => b.quantity - a.quantity)
            .slice(0, 10); // Mostrar top 10

        const topProductsContainer = document.getElementById('dashboard-top-products');
        if (sortedProducts.length === 0) {
            topProductsContainer.innerHTML = '<div class="text-center text-slate-500 py-4">No se han vendido productos.</div>';
        } else {
            const maxQuantity = sortedProducts[0][1].quantity;
            topProductsContainer.innerHTML = sortedProducts.map(([id, p], index) => {
                const percentage = (p.quantity / maxQuantity) * 100;
                const medals = ['游볞', '游볟', '游볠'];
                const medal = index < 3 ? medals[index] : `<span class="text-slate-500 text-xs">${index + 1}</span>`;

                return `
                    <div class="p-3 bg-slate-50 dark:bg-slate-700 rounded-lg mb-2">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-2 flex-1">
                                <span class="text-xl">${medal}</span>
                                <span class="font-medium text-sm text-slate-900 dark:text-white">${p.name}</span>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-blue-600 dark:text-blue-400">${p.quantity}</div>
                                <div class="text-xs text-slate-500">unidades</div>
                            </div>
                        </div>
                        <div class="w-full bg-slate-200 dark:bg-slate-600 rounded-full h-2">
                            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 h-2 rounded-full transition-all" style="width: ${percentage}%"></div>
                        </div>
                        <div class="text-xs text-slate-600 dark:text-slate-400 mt-1">Total vendido: $${p.total.toFixed(2)}</div>
                    </div>
                `;
            }).join('');
        }

        // ALERTAS DE STOCK DEL VEH칈CULO
        const stockAlertsContainer = document.getElementById('dashboard-stock-alerts');
        if (db.cashRegister.vehicleInventory && db.cashRegister.vehicleInventory.length > 0) {
            // Clasificar productos por nivel de stock
            const lowStock = [];  // <= 5
            const mediumStock = [];  // 6-10
            const goodStock = [];  // >= 11

            db.cashRegister.vehicleInventory.forEach(item => {
                const product = db.products.find(p => p.id === item.productId);
                if (product) {
                    const stockItem = {
                        name: product.name,
                        quantity: item.quantity
                    };

                    if (item.quantity <= 5) {
                        lowStock.push(stockItem);
                    } else if (item.quantity <= 10) {
                        mediumStock.push(stockItem);
                    } else {
                        goodStock.push(stockItem);
                    }
                }
            });

            // Ordenar por cantidad (menor a mayor para alertas)
            lowStock.sort((a, b) => a.quantity - b.quantity);
            mediumStock.sort((a, b) => a.quantity - b.quantity);
            goodStock.sort((a, b) => a.quantity - b.quantity);

            // Combinar todas las alertas
            const allStockItems = [...lowStock, ...mediumStock, ...goodStock];

            if (allStockItems.length === 0) {
                stockAlertsContainer.innerHTML = '<div class="text-center text-slate-500 py-4">No hay productos en el veh칤culo.</div>';
            } else {
                stockAlertsContainer.innerHTML = allStockItems.map(item => {
                    let bgColor, textColor, icon, statusText;

                    if (item.quantity <= 5) {
                        bgColor = 'bg-red-50 dark:bg-red-900/20';
                        textColor = 'text-red-700 dark:text-red-400';
                        icon = '游댮';
                        statusText = 'STOCK BAJO';
                    } else if (item.quantity <= 10) {
                        bgColor = 'bg-orange-50 dark:bg-orange-900/20';
                        textColor = 'text-orange-700 dark:text-orange-400';
                        icon = '游';
                        statusText = 'STOCK MEDIO';
                    } else {
                        bgColor = 'bg-green-50 dark:bg-green-900/20';
                        textColor = 'text-green-700 dark:text-green-400';
                        icon = '游릭';
                        statusText = 'STOCK BUENO';
                    }

                    return `
                        <div class="${bgColor} p-3 rounded-lg border-l-4 ${item.quantity <= 5 ? 'border-red-500' : item.quantity <= 10 ? 'border-orange-500' : 'border-green-500'}">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2 flex-1">
                                    <span class="text-lg">${icon}</span>
                                    <div>
                                        <div class="font-semibold text-sm text-slate-900 dark:text-white">${item.name}</div>
                                        <div class="text-xs ${textColor} font-medium">${statusText}</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold ${textColor}">${item.quantity}</div>
                                    <div class="text-xs text-slate-500 dark:text-slate-400">unidades</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        } else {
            stockAlertsContainer.innerHTML = '<div class="text-center text-slate-500 py-4">No hay productos en el veh칤culo.</div>';
        }
    }

    // FUNCIONES PARA M칍DULO DE INVENTARIO DEL CAMI칍N
    function loadSellerInventoryModule() {
        const statusMessage = document.getElementById('inventory-status-message');
        const content = document.getElementById('inventory-content');

        if (!db.cashRegister.isOpen) {
            statusMessage.classList.remove('hidden');
            content.classList.add('hidden');
            return;
        }

        statusMessage.classList.add('hidden');
        content.classList.remove('hidden');

        // Mostrar informaci칩n del veh칤culo
        const vehicle = db.vehicles.find(v => v.id === db.cashRegister.vehicleId);
        if (vehicle) {
            document.getElementById('inventory-vehicle-name').textContent = `${vehicle.plate} - ${vehicle.brand}`;
        }

        // Calcular total de productos
        let totalProducts = 0;
        if (db.cashRegister.vehicleInventory) {
            totalProducts = db.cashRegister.vehicleInventory.reduce((sum, item) => sum + item.quantity, 0);
        }
        document.getElementById('inventory-total-products').textContent = totalProducts;

        // Renderizar lista de productos
        renderInventoryProducts('all');
    }

    function renderInventoryProducts(filter = 'all') {
        const container = document.getElementById('inventory-products-list');
        if (!container) return;

        container.innerHTML = '';

        if (!db.cashRegister.vehicleInventory || db.cashRegister.vehicleInventory.length === 0) {
            container.innerHTML = '<div class="text-center text-slate-500 py-8">No hay productos en el inventario.</div>';
            return;
        }

        // Filtrar productos
        const filteredInventory = db.cashRegister.vehicleInventory.filter(item => {
            if (filter === 'all') return true;
            if (filter === 'low') return item.quantity <= 5;
            if (filter === 'medium') return item.quantity > 5 && item.quantity <= 10;
            if (filter === 'good') return item.quantity > 10;
            return true;
        });

        if (filteredInventory.length === 0) {
            container.innerHTML = '<div class="text-center text-slate-500 py-8">No hay productos con este filtro.</div>';
            return;
        }

        // Ordenar por cantidad (menor a mayor)
        filteredInventory.sort((a, b) => a.quantity - b.quantity);

        // Renderizar productos
        filteredInventory.forEach(item => {
            const product = db.products.find(p => p.id === item.productId);
            if (!product) return;

            let bgColor, textColor, icon, statusText;

            if (item.quantity <= 5) {
                bgColor = 'bg-red-50 dark:bg-red-900/20';
                textColor = 'text-red-700 dark:text-red-400';
                icon = '游댮';
                statusText = 'STOCK BAJO';
            } else if (item.quantity <= 10) {
                bgColor = 'bg-orange-50 dark:bg-orange-900/20';
                textColor = 'text-orange-700 dark:text-orange-400';
                icon = '游';
                statusText = 'STOCK MEDIO';
            } else {
                bgColor = 'bg-green-50 dark:bg-green-900/20';
                textColor = 'text-green-700 dark:text-green-400';
                icon = '游릭';
                statusText = 'STOCK BUENO';
            }

            const productDiv = document.createElement('div');
            productDiv.className = `${bgColor} p-4 rounded-lg border-l-4 ${item.quantity <= 5 ? 'border-red-500' : item.quantity <= 10 ? 'border-orange-500' : 'border-green-500'}`;
            productDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3 flex-1">
                        <span class="text-2xl">${icon}</span>
                        <div>
                            <div class="font-semibold text-lg text-slate-900 dark:text-white">${product.name}</div>
                            <div class="text-sm ${textColor} font-medium">${statusText}</div>
                            <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                                ${product.category}  ${product.weight || 0} kg
                                ${product.isReturnable ? '  <span class="text-blue-500">Retornable</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-4xl font-bold ${textColor}">${item.quantity}</div>
                        <div class="text-sm text-slate-500 dark:text-slate-400">unidades</div>
                    </div>
                </div>
            `;
            container.appendChild(productDiv);
        });
    }

    function filterInventory(filter) {
        // Actualizar botones activos
        document.querySelectorAll('.inventory-filter-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-blue-600', 'text-white');
            btn.classList.add('bg-slate-200', 'dark:bg-slate-600', 'text-slate-700', 'dark:text-slate-300');
        });

        event.target.classList.add('active', 'bg-blue-600', 'text-white');
        event.target.classList.remove('bg-slate-200', 'dark:bg-slate-600', 'text-slate-700', 'dark:text-slate-300');

        // Renderizar con el filtro
        renderInventoryProducts(filter);
    }

    async function loadSellerGoal() {
        const goalContainer = document.getElementById('seller-goal-container');
        if (!goalContainer) return;

        try {
            const currentDate = new Date();
            const currentMonth = currentDate.toISOString().slice(0, 7); // YYYY-MM
            const today = getCurrentDate(); // YYYY-MM-DD

            // Buscar meta del vendedor para el mes actual
            const goalSnapshot = await db_firestore.collection('sales_goals')
                .where('sellerId', '==', auth.currentUser.uid)
                .where('month', '==', currentMonth)
                .get();

            if (goalSnapshot.empty) {
                goalContainer.innerHTML = '';
                return;
            }

            const goalDoc = goalSnapshot.docs[0];
            const goal = goalDoc.data();

            // Calcular ventas del mes actual
            const year = currentMonth.split('-')[0];
            const month = currentMonth.split('-')[1];
            const startDate = `${year}-${month}-01`;
            const lastDay = new Date(year, month, 0).getDate();
            const endDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;

            // Obtener todas las ventas del mes
            const salesSnapshot = await db_firestore.collection('sales')
                .where('sellerId', '==', auth.currentUser.uid)
                .where('date', '>=', startDate)
                .where('date', '<=', endDate)
                .get();

            const totalSold = salesSnapshot.docs.reduce((sum, doc) => sum + doc.data().total, 0);

            // Calcular ventas de HOY
            const todaySales = salesSnapshot.docs
                .filter(doc => doc.data().date === today)
                .reduce((sum, doc) => sum + doc.data().total, 0);

            // C츼LCULOS DE META DIARIA
            const daysInMonth = lastDay;
            const dailyGoal = goal.goalAmount / daysInMonth;
            const currentDay = parseInt(today.split('-')[2]);
            const daysElapsed = currentDay;
            const expectedSales = dailyGoal * daysElapsed;
            const difference = totalSold - expectedSales;
            const differencePercentage = (difference / expectedSales) * 100;

            // Progreso mensual
            const percentage = (totalSold / goal.goalAmount) * 100;
            const remaining = goal.goalAmount - totalSold;

            // Progreso diario de hoy
            const todayPercentage = (todaySales / dailyGoal) * 100;

            // Determinar color seg칰n progreso general
            let bgColor, icon;
            if (percentage >= 100) {
                bgColor = 'from-green-500 to-emerald-600';
                icon = '游꿢';
            } else if (percentage >= 75) {
                bgColor = 'from-yellow-500 to-amber-600';
                icon = '丘';
            } else if (percentage >= 50) {
                bgColor = 'from-blue-500 to-indigo-600';
                icon = '游늳';
            } else {
                bgColor = 'from-red-500 to-rose-600';
                icon = '游꿢';
            }

            // Determinar estado de comparaci칩n
            let comparisonIcon, comparisonColor, comparisonText, adviceText;
            if (difference >= 0) {
                comparisonIcon = '九';
                comparisonColor = 'bg-green-500';
                const percentAhead = Math.abs(differencePercentage);
                comparisonText = `춰Vas ${percentAhead.toFixed(0)}% adelantado del ritmo necesario!`;
                const projection = (totalSold / daysElapsed) * daysInMonth;
                adviceText = `Si contin칰as as칤, terminar치s en $${projection.toFixed(2)}`;
            } else {
                comparisonIcon = '丘멆잺';
                comparisonColor = 'bg-orange-500';
                const percentBehind = Math.abs(differencePercentage);
                comparisonText = `Vas ${percentBehind.toFixed(0)}% por debajo del ritmo necesario`;
                const daysRemaining = daysInMonth - currentDay;
                const neededDaily = remaining / daysRemaining;
                adviceText = `춰Acelera! Necesitas vender $${neededDaily.toFixed(2)}/d칤a los pr칩ximos ${daysRemaining} d칤as`;
            }

            goalContainer.innerHTML = `
                <div class="bg-gradient-to-r ${bgColor} p-6 rounded-2xl shadow-xl text-white">
                    <!-- Encabezado -->
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-4xl">${icon}</span>
                        <div>
                            <h3 class="text-xl font-bold">Meta de Ventas</h3>
                            <p class="text-sm opacity-90">${formatMonth(currentMonth)}</p>
                        </div>
                    </div>

                    <!-- Resumen General -->
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-white/20 backdrop-blur-sm p-3 rounded-lg">
                            <div class="text-xs opacity-90">Meta Mensual</div>
                            <div class="text-lg font-bold">$${goal.goalAmount.toFixed(2)}</div>
                        </div>
                        <div class="bg-white/20 backdrop-blur-sm p-3 rounded-lg">
                            <div class="text-xs opacity-90">Total Vendido</div>
                            <div class="text-lg font-bold">$${totalSold.toFixed(2)}</div>
                        </div>
                        <div class="bg-white/20 backdrop-blur-sm p-3 rounded-lg">
                            <div class="text-xs opacity-90">Restante</div>
                            <div class="text-lg font-bold">$${remaining.toFixed(2)}</div>
                        </div>
                    </div>

                    <!-- Progreso General -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span>Progreso General</span>
                            <span class="font-bold">${percentage.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-white/30 rounded-full h-3">
                            <div class="bg-white h-3 rounded-full transition-all duration-500" style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                    </div>

                    <!-- Divisor -->
                    <div class="border-t border-white/30 my-4"></div>

                    <!-- AN츼LISIS DIARIO -->
                    <div class="mb-4">
                        <h4 class="text-sm font-bold mb-2 opacity-90">游늰 AN츼LISIS DIARIO</h4>
                        <p class="text-xs opacity-80 mb-3">Hoy es el d칤a ${currentDay} de ${daysInMonth} (${((currentDay/daysInMonth)*100).toFixed(0)}% del mes)</p>

                        <div class="bg-white/20 backdrop-blur-sm p-3 rounded-lg mb-3">
                            <div class="text-xs opacity-90 mb-1">Meta Diaria Promedio</div>
                            <div class="text-2xl font-bold">$${dailyGoal.toFixed(2)}/d칤a</div>
                            <div class="text-xs opacity-75">(Meta mensual 칭 ${daysInMonth} d칤as)</div>
                        </div>

                        <!-- Ventas de Hoy -->
                        <div class="bg-white/10 p-4 rounded-lg mb-3">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xl">游</span>
                                <span class="font-bold text-sm">Ventas de Hoy (${today.split('-')[2]} ${formatMonth(currentMonth).split(' ')[0]})</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <div class="text-xs opacity-80">Meta del D칤a</div>
                                    <div class="text-lg font-bold">$${dailyGoal.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div class="text-xs opacity-80">Vendido Hoy</div>
                                    <div class="text-lg font-bold">$${todaySales.toFixed(2)}</div>
                                </div>
                            </div>
                            <div class="w-full bg-white/30 rounded-full h-2 mb-1">
                                <div class="bg-white h-2 rounded-full transition-all" style="width: ${Math.min(todayPercentage, 100)}%"></div>
                            </div>
                            <div class="text-xs text-center font-semibold">
                                ${todayPercentage >= 100
                                    ? `九 춰Excelente! ${todayPercentage.toFixed(0)}% - Superaste la meta diaria`
                                    : todayPercentage >= 50
                                        ? `游늵 ${todayPercentage.toFixed(0)}% - Buen avance`
                                        : `游눩 ${todayPercentage.toFixed(0)}% - Sigue adelante`
                                }
                            </div>
                        </div>

                        <!-- Comparaci칩n con Ritmo Esperado -->
                        <div class="bg-white/10 p-4 rounded-lg">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="text-xl">游늵</span>
                                <span class="font-bold text-sm">Comparaci칩n con el Ritmo Esperado</span>
                            </div>
                            <div class="space-y-2 mb-3">
                                <div class="flex justify-between text-xs">
                                    <span class="opacity-80">A esta altura del mes (d칤a ${currentDay}) deber칤as llevar:</span>
                                    <span class="font-bold">$${expectedSales.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between text-xs">
                                    <span class="opacity-80">T칰 llevas vendido:</span>
                                    <span class="font-bold">$${totalSold.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between text-sm font-bold border-t border-white/30 pt-2">
                                    <span>Diferencia:</span>
                                    <span class="${difference >= 0 ? 'text-green-200' : 'text-orange-200'}">
                                        ${difference >= 0 ? '+' : ''}$${difference.toFixed(2)} ${difference >= 0 ? '拘勇' : '拘勇'}
                                    </span>
                                </div>
                            </div>
                            <div class="bg-white/20 p-3 rounded-lg text-center">
                                <div class="text-sm font-bold mb-1">${comparisonIcon} ${comparisonText}</div>
                                <div class="text-xs opacity-90">${adviceText}</div>
                            </div>
                        </div>
                    </div>

                    ${percentage >= 100
                        ? `<div class="text-center mt-4 p-3 bg-white/20 rounded-lg">
                            <p class="font-bold">游꿀 춰Felicidades! Meta alcanzada</p>
                           </div>`
                        : ''
                    }
                </div>
            `;
        } catch (error) {
            console.error('Error al cargar meta del vendedor:', error);
            goalContainer.innerHTML = '';
        }
    }

    async function loadGoalsModule() {
        if (!auth.currentUser) return;

        const dailyContent = document.getElementById('daily-goal-content');
        const monthlyContent = document.getElementById('monthly-goal-content');
        const yearlyContent = document.getElementById('yearly-goal-content');

        if (!dailyContent || !monthlyContent || !yearlyContent) return;

        try {
            const currentDate = new Date();
            const currentMonth = currentDate.toISOString().slice(0, 7); // YYYY-MM
            const currentYear = currentDate.getFullYear().toString();
            const today = getCurrentDate(); // YYYY-MM-DD

            // Buscar meta mensual
            const goalSnapshot = await db_firestore.collection('sales_goals')
                .where('sellerId', '==', auth.currentUser.uid)
                .where('month', '==', currentMonth)
                .get();

            // === META DIARIA ===
            if (!goalSnapshot.empty) {
                const goalDoc = goalSnapshot.docs[0];
                const goal = goalDoc.data();

                const year = currentMonth.split('-')[0];
                const month = currentMonth.split('-')[1];
                const startDate = `${year}-${month}-01`;
                const lastDay = new Date(year, month, 0).getDate();
                const endDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;

                const salesSnapshot = await db_firestore.collection('sales')
                    .where('sellerId', '==', auth.currentUser.uid)
                    .where('date', '>=', startDate)
                    .where('date', '<=', endDate)
                    .get();

                const todaySales = salesSnapshot.docs
                    .filter(doc => doc.data().date === today)
                    .reduce((sum, doc) => sum + doc.data().total, 0);

                const dailyGoal = goal.goalAmount / lastDay;
                const todayPercentage = (todaySales / dailyGoal) * 100;
                const todayRemaining = dailyGoal - todaySales;

                const dailyBgColor = todayPercentage >= 100 ? 'bg-green-50 dark:bg-green-900/20 border-green-500' : todayPercentage >= 50 ? 'bg-blue-50 dark:bg-blue-900/20 border-blue-500' : 'bg-orange-50 dark:bg-orange-900/20 border-orange-500';
                const dailyTextColor = todayPercentage >= 100 ? 'text-green-600 dark:text-green-400' : todayPercentage >= 50 ? 'text-blue-600 dark:text-blue-400' : 'text-orange-600 dark:text-orange-400';

                dailyContent.innerHTML = `
                    <div class="${dailyBgColor} border-2 p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <p class="text-sm text-slate-600 dark:text-slate-400">Hoy ${today.split('-')[2]}  de ${['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'][parseInt(month)-1]}</p>
                                <p class="text-4xl font-black ${dailyTextColor}">${todayPercentage.toFixed(0)}%</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-slate-600 dark:text-slate-400">Meta del D칤a</p>
                                <p class="text-2xl font-bold text-slate-900 dark:text-white">$${dailyGoal.toFixed(2)}</p>
                            </div>
                        </div>

                        <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-4 mb-4">
                            <div class="${todayPercentage >= 100 ? 'bg-green-600' : todayPercentage >= 50 ? 'bg-blue-600' : 'bg-orange-500'} h-4 rounded-full transition-all duration-500" style="width: ${Math.min(todayPercentage, 100)}%"></div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-slate-600 dark:text-slate-400">Vendido Hoy</p>
                                <p class="text-xl font-bold text-slate-900 dark:text-white">$${todaySales.toFixed(2)}</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-600 dark:text-slate-400">${todayRemaining > 0 ? 'Te falta' : 'Superaste por'}</p>
                                <p class="text-xl font-bold ${todayRemaining > 0 ? dailyTextColor : 'text-green-600 dark:text-green-400'}">$${Math.abs(todayRemaining).toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                `;

                // === META MENSUAL ===
                const totalSold = salesSnapshot.docs.reduce((sum, doc) => sum + doc.data().total, 0);
                const monthlyPercentage = (totalSold / goal.goalAmount) * 100;
                const monthlyRemaining = goal.goalAmount - totalSold;
                const currentDay = parseInt(today.split('-')[2]);

                const monthlyBgColor = monthlyPercentage >= 100 ? 'bg-green-50 dark:bg-green-900/20 border-green-500' : monthlyPercentage >= 75 ? 'bg-blue-50 dark:bg-blue-900/20 border-blue-500' : monthlyPercentage >= 50 ? 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-500' : 'bg-red-50 dark:bg-red-900/20 border-red-500';
                const monthlyTextColor = monthlyPercentage >= 100 ? 'text-green-600 dark:text-green-400' : monthlyPercentage >= 75 ? 'text-blue-600 dark:text-blue-400' : monthlyPercentage >= 50 ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-600 dark:text-red-400';

                monthlyContent.innerHTML = `
                    <div class="${monthlyBgColor} border-2 p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <p class="text-sm text-slate-600 dark:text-slate-400">${formatMonth(currentMonth)}</p>
                                <p class="text-4xl font-black ${monthlyTextColor}">${monthlyPercentage.toFixed(1)}%</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-slate-600 dark:text-slate-400">Meta Mensual</p>
                                <p class="text-2xl font-bold text-slate-900 dark:text-white">$${goal.goalAmount.toFixed(2)}</p>
                            </div>
                        </div>

                        <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-4 mb-4">
                            <div class="${monthlyPercentage >= 100 ? 'bg-green-600' : monthlyPercentage >= 75 ? 'bg-blue-600' : monthlyPercentage >= 50 ? 'bg-yellow-500' : 'bg-red-500'} h-4 rounded-full transition-all duration-500" style="width: ${Math.min(monthlyPercentage, 100)}%"></div>
                        </div>

                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div>
                                <p class="text-xs text-slate-600 dark:text-slate-400">Vendido</p>
                                <p class="text-lg font-bold text-slate-900 dark:text-white">$${totalSold.toFixed(2)}</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-600 dark:text-slate-400">Restante</p>
                                <p class="text-lg font-bold ${monthlyTextColor}">$${Math.max(monthlyRemaining, 0).toFixed(2)}</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-600 dark:text-slate-400">D칤a ${currentDay}/${lastDay}</p>
                                <p class="text-lg font-bold text-slate-900 dark:text-white">${((currentDay/lastDay)*100).toFixed(0)}%</p>
                            </div>
                        </div>

                        <div class="bg-white/50 dark:bg-slate-700/50 p-3 rounded-lg text-center">
                            <p class="text-sm font-semibold text-slate-700 dark:text-slate-300">
                                ${monthlyPercentage >= 100 ? '游꿀 춰Meta cumplida!' : `Promedio diario necesario: $${(monthlyRemaining / (lastDay - currentDay)).toFixed(2)}`}
                            </p>
                        </div>
                    </div>
                `;
            } else {
                dailyContent.innerHTML = '<p class="text-slate-500 dark:text-slate-400">No hay meta diaria asignada</p>';
                monthlyContent.innerHTML = '<p class="text-slate-500 dark:text-slate-400">No hay meta mensual asignada</p>';
            }

            // === META ANUAL ===
            const yearlySnapshot = await db_firestore.collection('sales_goals')
                .where('sellerId', '==', auth.currentUser.uid)
                .get();

            const yearlyGoals = yearlySnapshot.docs
                .filter(doc => doc.data().month.startsWith(currentYear))
                .map(doc => doc.data());

            if (yearlyGoals.length > 0) {
                const yearlyGoalAmount = yearlyGoals.reduce((sum, g) => sum + g.goalAmount, 0);

                const yearlySalesSnapshot = await db_firestore.collection('sales')
                    .where('sellerId', '==', auth.currentUser.uid)
                    .where('date', '>=', `${currentYear}-01-01`)
                    .where('date', '<=', `${currentYear}-12-31`)
                    .get();

                const yearlySales = yearlySalesSnapshot.docs.reduce((sum, doc) => sum + doc.data().total, 0);
                const yearlyPercentage = (yearlySales / yearlyGoalAmount) * 100;
                const yearlyRemaining = yearlyGoalAmount - yearlySales;

                const yearlyBgColor = yearlyPercentage >= 100 ? 'bg-green-50 dark:bg-green-900/20 border-green-500' : yearlyPercentage >= 75 ? 'bg-blue-50 dark:bg-blue-900/20 border-blue-500' : yearlyPercentage >= 50 ? 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-500' : 'bg-red-50 dark:bg-red-900/20 border-red-500';
                const yearlyTextColor = yearlyPercentage >= 100 ? 'text-green-600 dark:text-green-400' : yearlyPercentage >= 75 ? 'text-blue-600 dark:text-blue-400' : yearlyPercentage >= 50 ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-600 dark:text-red-400';

                yearlyContent.innerHTML = `
                    <div class="${yearlyBgColor} border-2 p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <p class="text-sm text-slate-600 dark:text-slate-400">A침o ${currentYear}</p>
                                <p class="text-4xl font-black ${yearlyTextColor}">${yearlyPercentage.toFixed(1)}%</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-slate-600 dark:text-slate-400">Meta Anual</p>
                                <p class="text-2xl font-bold text-slate-900 dark:text-white">$${yearlyGoalAmount.toFixed(2)}</p>
                            </div>
                        </div>

                        <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-4 mb-4">
                            <div class="${yearlyPercentage >= 100 ? 'bg-green-600' : yearlyPercentage >= 75 ? 'bg-blue-600' : yearlyPercentage >= 50 ? 'bg-yellow-500' : 'bg-red-500'} h-4 rounded-full transition-all duration-500" style="width: ${Math.min(yearlyPercentage, 100)}%"></div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-slate-600 dark:text-slate-400">Vendido en el A침o</p>
                                <p class="text-xl font-bold text-slate-900 dark:text-white">$${yearlySales.toFixed(2)}</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-600 dark:text-slate-400">Restante</p>
                                <p class="text-xl font-bold ${yearlyTextColor}">$${Math.max(yearlyRemaining, 0).toFixed(2)}</p>
                            </div>
                        </div>

                        <div class="bg-white/50 dark:bg-slate-700/50 p-3 rounded-lg text-center mt-4">
                            <p class="text-sm font-semibold text-slate-700 dark:text-slate-300">
                                ${yearlyPercentage >= 100 ? '游끥 춰Meta anual cumplida!' : `${yearlyGoals.length} meses con meta asignada`}
                            </p>
                        </div>
                    </div>
                `;
            } else {
                yearlyContent.innerHTML = '<p class="text-slate-500 dark:text-slate-400">No hay metas asignadas para este a침o</p>';
            }

        } catch (error) {
            console.error('Error al cargar m칩dulo de metas:', error);
            dailyContent.innerHTML = '<p class="text-red-500">Error al cargar meta diaria</p>';
            monthlyContent.innerHTML = '<p class="text-red-500">Error al cargar meta mensual</p>';
            yearlyContent.innerHTML = '<p class="text-red-500">Error al cargar meta anual</p>';
        }
    }

    function setupAdminProductListeners() {
        document.getElementById('add-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const productData = {
                name: document.getElementById('product-name').value,
                category: document.getElementById('product-category').value,
                weight: parseFloat(document.getElementById('product-weight').value),
                isReturnable: document.getElementById('product-is-returnable').checked,
                cost: parseFloat(document.getElementById('product-cost').value),
                priceNormal: parseFloat(document.getElementById('product-price-normal').value),
                priceBusiness: parseFloat(document.getElementById('product-price-business').value),
                warehouseStock: parseInt(document.getElementById('product-initial-stock').value) || 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db_firestore.collection('products').add(productData);
                alert('九 Producto registrado exitosamente');
                e.target.reset();
            } catch (error) {
                console.error('Error al registrar producto:', error);
                alert('仇 Error al registrar producto: ' + error.message);
            }
        });

        const editForm = document.getElementById('edit-product-form');
        if (editForm) {
            editForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const productId = e.target.dataset.editingId;
                const updatedData = {
                    name: document.getElementById('edit-product-name').value,
                    category: document.getElementById('edit-product-category').value,
                    weight: parseFloat(document.getElementById('edit-product-weight').value),
                    isReturnable: document.getElementById('edit-product-is-returnable').checked,
                    stock: parseInt(document.getElementById('edit-product-stock').value) || 0,
                    cost: parseFloat(document.getElementById('edit-product-cost').value),
                    priceNormal: parseFloat(document.getElementById('edit-product-price-normal').value),
                    priceBusiness: parseFloat(document.getElementById('edit-product-price-business').value)
                };
                db_firestore.collection('products').doc(productId).update(updatedData)
                    .then(() => {
                        alert('九 Producto actualizado correctamente');
                        closeEditModal();
                    })
                    .catch(error => alert('仇 Error: ' + error.message));
            });
        }

        document.getElementById('confirm-delete-btn').addEventListener('click', confirmDelete);

        const expenseTypeForm = document.getElementById('add-expense-type-form');
        if (expenseTypeForm) {
            expenseTypeForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('expense-type-name').value;
                if (name) {
                    db_firestore.collection('expense_types').add({ name }).then(() => e.target.reset()).catch(error => alert('Error: ' + error.message));
                }
            });
        }
    }
    function renderProductList() {
        const list = document.getElementById('product-list');
        if (!list) return;

        list.innerHTML = '';

        if (db.products.length === 0) {
            list.innerHTML = '<tr><td colspan="8" class="py-4 text-center text-slate-500 dark:text-slate-400">No hay productos registrados</td></tr>';
            return;
        }

        db.products.forEach(p => {
            const cost = p.cost || 0;
            const weight = p.weight || 0;
            const stock = p.warehouseStock || 0;
            const categoryLabels = {
                'bidon_lleno': 'Bid칩n Lleno',
                'bidon_vacio': 'Bid칩n Vac칤o',
                'recarga': 'Recarga',
                'equipo': 'Equipo',
                'paca': 'Paca'
            };
            const categoryLabel = categoryLabels[p.category] || p.category || 'N/A';
            const returnableBadge = p.isReturnable ? '<span class="ml-1 px-2 py-0.5 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs rounded">Retornable</span>' : '';

            list.innerHTML += `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700">
                    <td class="py-3 px-4 font-semibold text-slate-900 dark:text-white">${p.name}${returnableBadge}</td>
                    <td class="py-3 px-4 text-slate-700 dark:text-slate-300">${categoryLabel}</td>
                    <td class="py-3 px-4 text-slate-700 dark:text-slate-300">${weight.toFixed(2)}</td>
                    <td class="py-3 px-4 text-slate-700 dark:text-slate-300"><span class="px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded font-semibold">${stock}</span></td>
                    <td class="py-3 px-4 text-slate-700 dark:text-slate-300">$${cost.toFixed(2)}</td>
                    <td class="py-3 px-4 text-slate-700 dark:text-slate-300">$${p.priceNormal.toFixed(2)}</td>
                    <td class="py-3 px-4 text-slate-700 dark:text-slate-300">$${p.priceBusiness.toFixed(2)}</td>
                    <td class="py-3 px-4 space-x-2">
                        <button onclick="openEditModal('${p.id}')" class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 font-semibold">Editar</button>
                        <button onclick="promptDeleteProduct('${p.id}')" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-semibold">Anular</button>
                    </td>
                </tr>
            `;
        });
    }
    function openEditModal(productId) {
        const product = db.products.find(p => p.id === productId);
        if (product) {
            const form = document.getElementById('edit-product-form');
            form.dataset.editingId = productId;
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-category').value = product.category || '';
            document.getElementById('edit-product-weight').value = product.weight || 0;
            document.getElementById('edit-product-is-returnable').checked = product.isReturnable || false;
            document.getElementById('edit-product-stock').value = product.stock || 0;
            document.getElementById('edit-product-cost').value = product.cost || 0;
            document.getElementById('edit-product-price-normal').value = product.priceNormal;
            document.getElementById('edit-product-price-business').value = product.priceBusiness;
            document.getElementById('edit-product-modal').classList.remove('hidden');
        }
    }
    function closeEditModal() { document.getElementById('edit-product-modal').classList.add('hidden'); }
    function promptDeleteProduct(productId) { document.getElementById('confirm-delete-btn').dataset.deleteId = productId; document.getElementById('delete-confirm-modal').classList.remove('hidden'); document.getElementById('delete-confirm-modal').dataset.deleteType = 'product'; }
    function cancelDelete() { document.getElementById('delete-confirm-modal').classList.add('hidden'); }
    async function confirmDelete() {
        const modal = document.getElementById('delete-confirm-modal');
        const confirmBtn = document.getElementById('confirm-delete-btn');

        // Leer del bot칩n donde se guarda el ID
        const id = confirmBtn.dataset.deleteId;
        const type = modal.dataset.deleteType;
        let collectionName = '';

        console.log('confirmDelete - ID:', id, 'Type:', type);
        console.log('Leyendo de confirmBtn.dataset.deleteId:', confirmBtn.dataset.deleteId);
        console.log('Leyendo de modal.dataset.deleteType:', modal.dataset.deleteType);

        if(type === 'product') {
            collectionName = 'products';
        } else if(type === 'expense_type') {
            // Verificar si hay gastos registrados con este tipo
            const expenseType = db.expenseTypes.find(et => et.id === id);
            console.log('Tipo de gasto encontrado:', expenseType);

            if (expenseType) {
                const expensesWithType = db.expenses.filter(e => e.category === expenseType.name);
                console.log('Gastos encontrados con esta categor칤a:', expensesWithType.length);

                if (expensesWithType.length > 0) {
                    alert(`No se puede eliminar este tipo de gasto porque existen ${expensesWithType.length} gasto(s) registrado(s) con esta categor칤a.\n\nPrimero debe eliminar o reasignar los gastos asociados.`);
                    cancelDelete();
                    return;
                }
            }
            collectionName = 'expense_types';
        }

        console.log('Intentando eliminar de colecci칩n:', collectionName);

        if(collectionName) {
            try {
                await db_firestore.collection(collectionName).doc(id).delete();
                console.log('Eliminaci칩n exitosa de Firestore');
                cancelDelete();
                alert('Eliminado correctamente.');
            } catch(error) {
                console.error('Error al eliminar:', error);
                alert('Error: ' + error.message);
            }
        } else {
            console.error('No se determin칩 la colecci칩n para eliminar');
        }
    }
    function renderExpenseTypeList() {
        const list = document.getElementById('expense-type-list');
        if(!list) return;
        list.innerHTML = '';
        db.expenseTypes.forEach(et => {
            list.innerHTML += `<tr><td class="py-3 px-4">${et.name}</td><td class="py-3 px-4 space-x-2"><button onclick="openEditExpenseTypeModal('${et.id}')" class="text-blue-500 hover:underline">Editar</button><button onclick="promptDeleteExpenseType('${et.id}')" class="text-red-500 hover:underline">Eliminar</button></td></tr>`;
        });
    }
    function promptDeleteExpenseType(id) {
        console.log('promptDeleteExpenseType llamado con ID:', id);
        const modal = document.getElementById('delete-confirm-modal');
        const confirmBtn = document.getElementById('confirm-delete-btn');

        console.log('Modal encontrado:', modal);
        console.log('Bot칩n confirmar encontrado:', confirmBtn);

        confirmBtn.dataset.deleteId = id;
        modal.dataset.deleteType = 'expense_type';

        console.log('Dataset del bot칩n despu칠s de asignar:', confirmBtn.dataset.deleteId);
        console.log('Dataset del modal despu칠s de asignar:', modal.dataset.deleteType);

        modal.classList.remove('hidden');
    }

    // ===== ADMIN VEHICLE MANAGEMENT FUNCTIONS =====

    function setupAdminVehicleListeners() {
        const form = document.getElementById('add-vehicle-form');
        if (form) {
            // Remover listeners previos para evitar duplicados
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);

            newForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const editingId = newForm.dataset.editingId;

                // Si est치 en modo edici칩n
                if (editingId) {
                    const updatedData = {
                        plate: document.getElementById('vehicle-plate').value.toUpperCase(),
                        brand: document.getElementById('vehicle-brand').value,
                        year: parseInt(document.getElementById('vehicle-year').value) || null,
                        color: document.getElementById('vehicle-color').value || null,
                        type: document.getElementById('vehicle-type').value,
                        maxWeight: parseFloat(document.getElementById('vehicle-max-weight').value),
                        maxUnits: parseInt(document.getElementById('vehicle-max-units').value),
                        assignedSeller: document.getElementById('vehicle-assigned-seller').value || null,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    try {
                        await db_firestore.collection('vehicles').doc(editingId).update(updatedData);
                        alert('九 Veh칤culo actualizado exitosamente');

                        // Restaurar formulario
                        delete newForm.dataset.editingId;
                        newForm.reset();
                        const submitBtn = newForm.querySelector('button[type="submit"]');
                        submitBtn.innerHTML = `
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Registrar Veh칤culo
                        `;
                        submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    } catch (error) {
                        console.error('Error al actualizar veh칤culo:', error);
                        alert('仇 Error al actualizar veh칤culo: ' + error.message);
                    }
                    return;
                }

                // Modo creaci칩n
                const vehicleData = {
                    plate: document.getElementById('vehicle-plate').value.toUpperCase(),
                    brand: document.getElementById('vehicle-brand').value,
                    year: parseInt(document.getElementById('vehicle-year').value) || null,
                    color: document.getElementById('vehicle-color').value || null,
                    type: document.getElementById('vehicle-type').value,
                    maxWeight: parseFloat(document.getElementById('vehicle-max-weight').value),
                    maxUnits: parseInt(document.getElementById('vehicle-max-units').value),
                    assignedSeller: document.getElementById('vehicle-assigned-seller').value || null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active'
                };

                try {
                    await db_firestore.collection('vehicles').add(vehicleData);
                    alert('九 Veh칤culo registrado exitosamente');
                    e.target.reset();
                } catch (error) {
                    console.error('Error al registrar veh칤culo:', error);
                    alert('仇 Error al registrar veh칤culo: ' + error.message);
                }
            });
        }
    }

    function resetVehicleForm() {
        document.getElementById('add-vehicle-form').reset();
    }

    function renderVehiclesList() {
        const list = document.getElementById('vehicles-list');
        const countSpan = document.getElementById('vehicles-count');

        if (!list) return;

        list.innerHTML = '';

        if (db.vehicles.length === 0) {
            list.innerHTML = '<tr><td colspan="8" class="py-4 text-center text-slate-500 dark:text-slate-400">No hay veh칤culos registrados</td></tr>';
            if (countSpan) countSpan.textContent = '0';
            return;
        }

        if (countSpan) countSpan.textContent = db.vehicles.length;

        const vehiclesHTML = db.vehicles.map(vehicle => {
            const seller = db.usersMap[vehicle.assignedSeller];
            const sellerName = seller ? seller.displayName : 'Sin asignar';

            return `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700">
                    <td class="py-3 px-4 font-semibold text-slate-900 dark:text-white">${vehicle.plate}</td>
                    <td class="py-3 px-4 text-slate-700 dark:text-slate-300">${vehicle.brand}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded text-sm">
                            ${vehicle.type}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-slate-700 dark:text-slate-300">${vehicle.maxWeight} kg</td>
                    <td class="py-3 px-4 text-slate-700 dark:text-slate-300">${vehicle.maxUnits}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 ${vehicle.assignedSeller ? 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200' : 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400'} rounded text-sm">
                            ${sellerName}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-center">
                        <button onclick="openVehicleInventoryModal('${vehicle.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-semibold transition">
                            游닍 Ver Inventario
                        </button>
                    </td>
                    <td class="py-3 px-4 space-x-2">
                        <button onclick="editVehicle('${vehicle.id}')" class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 font-semibold">
                            Editar
                        </button>
                        <button onclick="deleteVehicle('${vehicle.id}')" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 font-semibold">
                            Eliminar
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        list.innerHTML = vehiclesHTML;
    }

    async function editVehicle(vehicleId) {
        const vehicle = db.vehicles.find(v => v.id === vehicleId);
        if (!vehicle) {
            alert('Veh칤culo no encontrado');
            return;
        }

        // Asegurar que el dropdown de vendedores est칠 poblado
        await populateVehicleSellerDropdown();

        // Rellenar el formulario con los datos actuales
        document.getElementById('vehicle-plate').value = vehicle.plate;
        document.getElementById('vehicle-brand').value = vehicle.brand;
        document.getElementById('vehicle-year').value = vehicle.year || '';
        document.getElementById('vehicle-color').value = vehicle.color || '';
        document.getElementById('vehicle-type').value = vehicle.type;
        document.getElementById('vehicle-max-weight').value = vehicle.maxWeight;
        document.getElementById('vehicle-max-units').value = vehicle.maxUnits;
        document.getElementById('vehicle-assigned-seller').value = vehicle.assignedSeller || '';

        // Cambiar el formulario a modo edici칩n
        const form = document.getElementById('add-vehicle-form');
        form.dataset.editingId = vehicleId;

        // Cambiar el bot칩n submit
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Actualizar Veh칤culo
        `;
        submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
        submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');

        // Scroll al formulario
        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function deleteVehicle(vehicleId) {
        const vehicle = db.vehicles.find(v => v.id === vehicleId);
        if (!vehicle) {
            alert('Veh칤culo no encontrado');
            return;
        }

        const confirmMsg = `쮼st치 seguro de eliminar el veh칤culo ${vehicle.plate}?`;
        if (!confirm(confirmMsg)) return;

        try {
            await db_firestore.collection('vehicles').doc(vehicleId).delete();
            alert('九 Veh칤culo eliminado exitosamente');
        } catch (error) {
            console.error('Error al eliminar veh칤culo:', error);
            alert('仇 Error al eliminar veh칤culo: ' + error.message);
        }
    }

    // ===== FUNCIONES PARA GESTIONAR INVENTARIO DE VEH칈CULOS (ADMIN) =====

    async function openVehicleInventoryModal(vehicleId) {
        const vehicle = db.vehicles.find(v => v.id === vehicleId);
        if (!vehicle) {
            alert('Veh칤culo no encontrado');
            return;
        }

        // Llenar informaci칩n del veh칤culo
        document.getElementById('modal-vehicle-id').value = vehicleId;
        document.getElementById('modal-vehicle-plate').textContent = vehicle.plate;
        document.getElementById('modal-vehicle-capacity').textContent = `${vehicle.maxUnits} unidades / ${vehicle.maxWeight} kg`;
        document.getElementById('modal-vehicle-capacity-max').textContent = vehicle.maxUnits;
        document.getElementById('modal-vehicle-weight-max').textContent = vehicle.maxWeight;

        // Cargar inventario actual del veh칤culo
        await loadModalVehicleInventory(vehicleId);

        // Mostrar modal
        document.getElementById('vehicle-inventory-modal').classList.remove('hidden');
    }

    async function loadModalVehicleInventory(vehicleId) {
        try {
            // Buscar la sesi칩n activa m치s reciente del veh칤culo
            const sessionSnapshot = await db_firestore.collection('cash_sessions')
                .where('vehicleId', '==', vehicleId)
                .orderBy('openedAt', 'desc')
                .limit(1)
                .get();

            let sessionId = null;
            if (!sessionSnapshot.empty) {
                sessionId = sessionSnapshot.docs[0].id;
            }

            // Obtener el inventario actual del veh칤culo desde Firestore
            let inventoryQuery = db_firestore.collection('vehicle_inventory')
                .where('vehicleId', '==', vehicleId);

            // Si hay una sesi칩n, filtrar por sessionId para obtener el inventario m치s reciente
            if (sessionId) {
                inventoryQuery = inventoryQuery.where('sessionId', '==', sessionId);
            }

            const inventorySnapshot = await inventoryQuery.get();

            const inventoryList = document.getElementById('modal-vehicle-inventory-list');
            inventoryList.innerHTML = '';

            // Crear un mapa del inventario existente
            const inventoryMap = {};
            inventorySnapshot.forEach(doc => {
                const invData = doc.data();
                inventoryMap[invData.productId] = {
                    quantity: invData.quantity,
                    docId: doc.id
                };
            });

            // Mostrar todos los productos con sus cantidades actuales
            db.products.forEach(product => {
                const existingQty = inventoryMap[product.id]?.quantity || 0;
                const docId = inventoryMap[product.id]?.docId || null;
                const productDiv = createModalInventoryItemInput(product, existingQty, docId);
                inventoryList.appendChild(productDiv);
            });

            updateModalVehicleCapacity();
        } catch (error) {
            console.error('Error al cargar inventario del veh칤culo:', error);
            alert('仇 Error al cargar inventario del veh칤culo');
        }
    }

    function createModalInventoryItemInput(product, quantity = 0, inventoryDocId = null) {
        const div = document.createElement('div');
        div.className = 'flex items-center gap-3 bg-slate-50 dark:bg-slate-700 p-3 rounded-lg';
        div.dataset.productId = product.id;
        div.dataset.productWeight = product.weight || 0;
        if (inventoryDocId) div.dataset.inventoryDocId = inventoryDocId;

        const categoryLabels = {
            'bidon_lleno': 'Bid칩n Lleno',
            'bidon_vacio': 'Bid칩n Vac칤o',
            'recarga': 'Recarga',
            'equipo': 'Equipo',
            'paca': 'Paca',
            'llaves': 'Llaves'
        };

        div.innerHTML = `
            <div class="flex-1">
                <div class="font-semibold text-slate-900 dark:text-white">${product.name}</div>
                <div class="text-xs text-slate-500 dark:text-slate-400">
                    ${categoryLabels[product.category] || product.category}  ${product.weight || 0} kg
                    ${product.isReturnable ? '  <span class="text-blue-500">Retornable</span>' : ''}
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button type="button" onclick="changeModalInventoryQty('${product.id}', -1)" class="bg-red-500 text-white w-8 h-8 rounded-lg hover:bg-red-600 flex items-center justify-center">-</button>
                <input type="number" id="modal-inv-qty-${product.id}" value="${quantity}" min="0" class="w-20 p-2 border-2 rounded-lg text-center dark:bg-slate-600 dark:border-slate-500 dark:text-white" onchange="updateModalVehicleCapacity()">
                <button type="button" onclick="changeModalInventoryQty('${product.id}', 1)" class="bg-green-500 text-white w-8 h-8 rounded-lg hover:bg-green-600 flex items-center justify-center">+</button>
            </div>
        `;

        return div;
    }

    function changeModalInventoryQty(productId, delta) {
        const input = document.getElementById(`modal-inv-qty-${productId}`);
        if (input) {
            const currentQty = parseInt(input.value) || 0;
            const newQty = Math.max(0, currentQty + delta);
            input.value = newQty;
            updateModalVehicleCapacity();
        }
    }

    function updateModalVehicleCapacity() {
        const inventoryList = document.getElementById('modal-vehicle-inventory-list');
        if (!inventoryList) return;

        let totalUnits = 0;
        let totalWeight = 0;

        const items = inventoryList.querySelectorAll('[data-product-id]');
        items.forEach(item => {
            const productId = item.dataset.productId;
            const weight = parseFloat(item.dataset.productWeight) || 0;
            const qtyInput = document.getElementById(`modal-inv-qty-${productId}`);
            const qty = parseInt(qtyInput?.value) || 0;

            totalUnits += qty;
            totalWeight += qty * weight;
        });

        document.getElementById('modal-vehicle-capacity-used').textContent = totalUnits;
        document.getElementById('modal-vehicle-weight-used').textContent = totalWeight.toFixed(2);
    }

    function closeVehicleInventoryModal() {
        document.getElementById('vehicle-inventory-modal').classList.add('hidden');
    }

    // Event listener para el formulario de inventario de veh칤culo
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('vehicle-inventory-form');
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const vehicleId = document.getElementById('modal-vehicle-id').value;
                const inventoryList = document.getElementById('modal-vehicle-inventory-list');
                const items = inventoryList.querySelectorAll('[data-product-id]');

                try {
                    // Guardar cada producto en el inventario
                    const batch = db_firestore.batch();

                    items.forEach(item => {
                        const productId = item.dataset.productId;
                        const qtyInput = document.getElementById(`modal-inv-qty-${productId}`);
                        const quantity = parseInt(qtyInput?.value) || 0;
                        const inventoryDocId = item.dataset.inventoryDocId;

                        if (inventoryDocId) {
                            // Actualizar documento existente
                            const docRef = db_firestore.collection('vehicle_inventory').doc(inventoryDocId);
                            batch.update(docRef, { quantity });
                        } else if (quantity > 0) {
                            // Crear nuevo documento solo si la cantidad es mayor a 0
                            const newDocRef = db_firestore.collection('vehicle_inventory').doc();
                            batch.set(newDocRef, {
                                vehicleId,
                                productId,
                                quantity,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    });

                    await batch.commit();
                    alert('九 Inventario actualizado exitosamente');
                    closeVehicleInventoryModal();
                } catch (error) {
                    console.error('Error al guardar inventario:', error);
                    alert('仇 Error al guardar inventario: ' + error.message);
                }
            });
        }
    });

    async function populateVehicleSellerDropdown() {
        const select = document.getElementById('vehicle-assigned-seller');
        if (!select) return;

        console.log('游녻 Poblando dropdown de vendedores para veh칤culos');
        console.log('db.usersMap keys:', Object.keys(db.usersMap).length);
        console.log('db.usersMap:', db.usersMap);

        // Limpiar opciones existentes (excepto "Sin asignar")
        select.innerHTML = '<option value="">Sin asignar</option>';

        // Si db.usersMap tiene datos, usarlos
        if (Object.keys(db.usersMap).length > 0) {
            let sellerCount = 0;
            Object.values(db.usersMap).forEach(user => {
                console.log('Usuario en usersMap:', user);
                if (user.role === 'vendedor' || user.role === 'seller') {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.displayName || user.name || user.email;
                    select.appendChild(option);
                    sellerCount++;
                }
            });
            console.log('九 Dropdown poblado con', sellerCount, 'vendedores');
            return;
        }

        // Si db.usersMap est치 vac칤o, cargar desde Firestore
        console.log('낍 db.usersMap vac칤o, consultando Firestore...');
        try {
            const usersSnapshot = await db_firestore.collection('users')
                .where('role', '==', 'vendedor')
                .get();

            console.log('Vendedores encontrados en Firestore:', usersSnapshot.size);

            if (!usersSnapshot.empty) {
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = userData.name || userData.displayName || userData.email;
                    select.appendChild(option);
                });
                console.log('九 Dropdown poblado desde Firestore con', usersSnapshot.size, 'vendedores');
            } else {
                console.log('丘멆잺 No se encontraron vendedores en Firestore');
            }
        } catch (error) {
            console.error('仇 Error al cargar vendedores:', error);
        }
    }

    // ===== ADMIN CLIENT MANAGEMENT FUNCTIONS =====

    async function loadAdminClientsModule() {
        // Populate seller dropdown and province dropdown
        populateAdminSellerFilter();
        populateAdminProvinceFilter();

        // Initialize product checkboxes
        renderAdminClientDefaultProducts();

        // Load and render client list
        await renderAdminClientsList();

        // Update statistics
        updateAdminClientsStats();

        // Setup filter listeners
        setupAdminClientFilters();

        // Setup form listeners
        setupAdminClientFormListeners();
    }

    function setupAdminClientFormListeners() {
        // Client type toggle - show/hide business name field
        const typeRadios = document.getElementsByName('admin-client-type');
        typeRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                const businessField = document.getElementById('admin-business-name-field');
                if (radio.value === 'negocio') {
                    businessField.classList.remove('hidden');
                } else {
                    businessField.classList.add('hidden');
                }
            });
        });

        // Form submission
        const form = document.getElementById('admin-client-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveAdminClient();
        });
    }

    function populateAdminSellerFilter() {
        const sellerDropdown = document.getElementById('admin-client-seller');
        const filterDropdown = document.getElementById('admin-filter-seller');

        if (!sellerDropdown || !filterDropdown) {
            return;
        }

        // Clear existing options (keep first "Sin asignar" for form, "Todos" for filter)
        sellerDropdown.innerHTML = '<option value="">Sin asignar</option>';
        filterDropdown.innerHTML = '<option value="">Todos los vendedores</option>';

        // Get sellers from db.usersMap (role can be 'seller' or 'vendedor')
        Object.values(db.usersMap).forEach(user => {
            if (user && (user.role === 'seller' || user.role === 'vendedor')) {
                const displayName = user.displayName || user.name || user.email || 'Vendedor';

                const option1 = document.createElement('option');
                option1.value = user.uid || user.id;
                option1.textContent = displayName;
                sellerDropdown.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = user.uid || user.id;
                option2.textContent = displayName;
                filterDropdown.appendChild(option2);
            }
        });
    }

    function populateAdminProvinceFilter() {
        const provinceSelect = document.getElementById('admin-client-province');
        const provinceFilter = document.getElementById('admin-filter-province');

        const ecuadorProvinces = [
            "Azuay", "Bol칤var", "Ca침ar", "Carchi", "Chimborazo", "Cotopaxi", "El Oro",
            "Esmeraldas", "Gal치pagos", "Guayas", "Imbabura", "Loja", "Los R칤os",
            "Manab칤", "Morona Santiago", "Napo", "Orellana", "Pastaza", "Pichincha",
            "Santa Elena", "Santo Domingo de los Ts치chilas", "Sucumb칤os", "Tungurahua", "Zamora Chinchipe"
        ];

        // Clear and populate form province select
        provinceSelect.innerHTML = '<option value="">Seleccione una provincia</option>';
        ecuadorProvinces.forEach(province => {
            const option = document.createElement('option');
            option.value = province;
            option.textContent = province;
            provinceSelect.appendChild(option);
        });

        // Clear and populate filter province select
        provinceFilter.innerHTML = '<option value="">Todas las provincias</option>';
        ecuadorProvinces.forEach(province => {
            const option = document.createElement('option');
            option.value = province;
            option.textContent = province;
            provinceFilter.appendChild(option);
        });
    }

    function renderAdminClientDefaultProducts() {
        const container = document.getElementById('admin-client-default-products');
        if (!container) return;

        container.innerHTML = '';

        if (!db.products || db.products.length === 0) {
            container.innerHTML = '<p class="text-sm text-slate-500 dark:text-slate-400 col-span-full text-center py-4">No hay productos registrados. Por favor, agregue productos primero en el m칩dulo de Productos.</p>';
            return;
        }

        db.products.forEach(product => {
            const label = document.createElement('label');
            label.className = 'flex items-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-2 rounded border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = 'admin-default-products';
            checkbox.value = product.id;
            checkbox.className = 'w-4 h-4 text-blue-600';

            const span = document.createElement('span');
            span.className = 'text-sm font-medium';
            span.textContent = product.name;

            label.appendChild(checkbox);
            label.appendChild(span);
            container.appendChild(label);
        });
    }

    function setupAdminClientFilters() {
        const searchInput = document.getElementById('admin-search-clients');
        const sellerFilter = document.getElementById('admin-filter-seller');
        const provinceFilter = document.getElementById('admin-filter-province');

        searchInput.addEventListener('input', renderAdminClientsList);
        sellerFilter.addEventListener('change', renderAdminClientsList);
        provinceFilter.addEventListener('change', renderAdminClientsList);
    }

    async function renderAdminClientsList() {
        const container = document.getElementById('admin-clients-list');
        const countSpan = document.getElementById('admin-clients-count');

        if (!container || !countSpan) {
            console.error('Admin clients container not found');
            return;
        }

        // Get filter values (con valores por defecto si no existen)
        const searchInput = document.getElementById('admin-search-clients');
        const sellerFilterInput = document.getElementById('admin-filter-seller');
        const provinceFilterInput = document.getElementById('admin-filter-province');

        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        const sellerFilter = sellerFilterInput ? sellerFilterInput.value : '';
        const provinceFilter = provinceFilterInput ? provinceFilterInput.value : '';

        // Filter clients
        let filteredClients = db.clients.filter(client => {
            // Search filter
            const matchesSearch = !searchTerm ||
                client.name.toLowerCase().includes(searchTerm) ||
                (client.businessName && client.businessName.toLowerCase().includes(searchTerm)) ||
                (client.phone && client.phone.includes(searchTerm));

            // Seller filter
            const matchesSeller = !sellerFilter ||
                (client.assignedSeller === sellerFilter);

            // Province filter
            const matchesProvince = !provinceFilter ||
                (client.province === provinceFilter);

            return matchesSearch && matchesSeller && matchesProvince;
        });

        countSpan.textContent = filteredClients.length;

        if (filteredClients.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                    <svg class="w-16 h-16 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <p class="text-lg font-medium">No hay clientes registrados</p>
                </div>
            `;
            return;
        }

        container.innerHTML = filteredClients.map(client => {
            const displayName = client.type === 'negocio' && client.businessName
                ? `${client.businessName} (${client.name})`
                : client.name;

            const sellerName = client.assignedSeller
                ? (db.usersMap[client.assignedSeller]?.displayName || 'Vendedor')
                : 'Sin asignar';

            const location = [client.province, client.canton].filter(Boolean).join(', ') || 'No especificada';

            const visitDays = client.visitSchedule?.days?.join(', ') || 'No especificado';
            const visitTime = client.visitSchedule?.time || '';
            const visitFreq = client.visitSchedule?.frequency || '';

            return `
                <div class="bg-white dark:bg-slate-700 p-4 rounded-xl shadow-sm hover:shadow-md transition flex items-start gap-4">
                    <!-- Checkbox para selecci칩n m칰ltiple -->
                    <div class="flex-shrink-0">
                        <input type="checkbox" class="client-select-checkbox w-5 h-5 text-blue-600 mt-2" data-client-id="${client.id}" onchange="updateBulkReassignBar()">
                    </div>

                    <!-- QR Code -->
                    <div class="flex-shrink-0">
                        <div id="admin-qr-${client.id}" class="w-20 h-20 bg-white p-1 rounded"></div>
                        <div class="mt-1 flex gap-1">
                            <button onclick="downloadClientQRImage('${client.id}', '${client.name}')" class="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">JPG</button>
                            <button onclick="downloadClientQR('${client.id}', '${client.name}')" class="text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">PDF</button>
                        </div>
                    </div>

                    <!-- Client Info -->
                    <div class="flex-1">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <h4 class="text-lg font-bold text-slate-900 dark:text-white">${displayName}</h4>
                                <p class="text-sm text-slate-600 dark:text-slate-400">${client.type === 'negocio' ? '游끽 Negocio' : '游녻 Consumidor Final'}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="openEditAdminClient('${client.id}')" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-700 transition">
                                    Editar
                                </button>
                                <button onclick="deleteAdminClient('${client.id}')" class="bg-red-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-700 transition">
                                    Eliminar
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                            <div><span class="font-semibold">游 Tel칠fono:</span> ${client.phone || 'No registrado'}</div>
                            <div><span class="font-semibold">游늸 Ubicaci칩n:</span> ${location}</div>
                            <div><span class="font-semibold">游녿꽳눺 Vendedor:</span> ${sellerName}</div>
                            <div><span class="font-semibold">游늰 Visitas:</span> ${visitDays} ${visitTime ? '(' + visitTime + ')' : ''}</div>
                        </div>

                        ${client.defaultProducts && client.defaultProducts.length > 0 ? `
                            <div class="mt-2">
                                <span class="text-xs font-semibold text-slate-600 dark:text-slate-400">Productos: </span>
                                <span class="text-xs text-slate-600 dark:text-slate-400">${client.defaultProducts.map(pid => db.products.find(p => p.id === pid)?.name || '').filter(Boolean).join(', ')}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');

        // Generate QR codes
        setTimeout(() => {
            filteredClients.forEach(client => {
                const qrContainer = document.getElementById(`admin-qr-${client.id}`);
                if (qrContainer && qrContainer.children.length === 0) {
                    new QRCode(qrContainer, {
                        text: client.id,
                        width: 80,
                        height: 80,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }
            });
        }, 100);
    }

    function updateAdminClientsStats() {
        const totalCount = db.clients.length;
        const activeCount = db.clients.filter(c => c.status === 'active').length;
        const unassignedCount = db.clients.filter(c => !c.assignedSeller).length;

        document.getElementById('admin-total-clients').textContent = totalCount;
        document.getElementById('admin-active-clients').textContent = activeCount;
        document.getElementById('admin-unassigned-clients').textContent = unassignedCount;
    }

    function openAdminClientModal() {
        // Reset form
        document.getElementById('admin-client-form').reset();
        document.getElementById('admin-client-id').value = '';
        document.getElementById('admin-client-modal-title').textContent = 'Registrar Nuevo Cliente';

        // Hide business name field by default
        document.getElementById('admin-business-name-field').classList.add('hidden');

        // Re-render products to ensure they are displayed
        renderAdminClientDefaultProducts();

        // Uncheck all checkboxes
        document.querySelectorAll('input[name="admin-default-products"]').forEach(cb => cb.checked = false);
        document.querySelectorAll('input[name="admin-visit-days"]').forEach(cb => cb.checked = false);

        // Show modal
        document.getElementById('admin-client-modal').classList.remove('hidden');
    }

    function closeAdminClientModal() {
        document.getElementById('admin-client-modal').classList.add('hidden');
    }

    async function saveAdminClient() {
        const clientId = document.getElementById('admin-client-id').value;
        const isEdit = !!clientId;

        // Collect form data
        const type = document.querySelector('input[name="admin-client-type"]:checked').value;
        const name = document.getElementById('admin-client-name').value.trim();
        const businessName = type === 'negocio' ? document.getElementById('admin-client-business-name').value.trim() : '';
        const phone = document.getElementById('admin-client-phone').value.trim();

        // Location
        const province = document.getElementById('admin-client-province').value;
        const canton = document.getElementById('admin-client-canton').value.trim();
        const parish = document.getElementById('admin-client-parish').value.trim();
        const sector = document.getElementById('admin-client-sector').value.trim();
        const address = document.getElementById('admin-client-address').value.trim();
        const latitude = parseFloat(document.getElementById('admin-client-latitude').value) || null;
        const longitude = parseFloat(document.getElementById('admin-client-longitude').value) || null;

        // Seller assignment
        const assignedSeller = document.getElementById('admin-client-seller').value || null;

        // Default products
        const defaultProducts = Array.from(document.querySelectorAll('input[name="admin-default-products"]:checked')).map(cb => cb.value);

        // Visit schedule
        const visitDays = Array.from(document.querySelectorAll('input[name="admin-visit-days"]:checked')).map(cb => cb.value);
        const visitTime = document.getElementById('admin-client-visit-time').value;
        const visitFrequency = document.getElementById('admin-client-visit-frequency').value;

        // Notes
        const notes = document.getElementById('admin-client-notes').value.trim();

        // Validation
        if (!name) {
            alert('El nombre del cliente es obligatorio');
            return;
        }
        if (!province) {
            alert('La provincia es obligatoria');
            return;
        }

        // Build client data
        const clientData = {
            type,
            name,
            businessName,
            phone,
            province,
            canton,
            parish,
            sector,
            address,
            location: latitude && longitude ? { latitude, longitude } : null,
            assignedSeller,
            defaultProducts,
            visitSchedule: {
                days: visitDays,
                time: visitTime,
                frequency: visitFrequency
            },
            notes,
            status: 'active'
        };

        try {
            if (isEdit) {
                // Update existing client
                await db_firestore.collection('clients').doc(clientId).update({
                    ...clientData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Cliente actualizado correctamente');
            } else {
                // Create new client
                await db_firestore.collection('clients').add({
                    ...clientData,
                    createdBy: auth.currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Cliente registrado correctamente');
            }

            closeAdminClientModal();
        } catch (error) {
            console.error('Error saving client:', error);
            alert('Error al guardar el cliente: ' + error.message);
        }
    }

    function openEditAdminClient(clientId) {
        const client = db.clients.find(c => c.id === clientId);
        if (!client) return;

        // Set form title
        document.getElementById('admin-client-modal-title').textContent = 'Editar Cliente';
        document.getElementById('admin-client-id').value = clientId;

        // Set basic info
        document.querySelector(`input[name="admin-client-type"][value="${client.type}"]`).checked = true;
        document.getElementById('admin-client-name').value = client.name || '';

        if (client.type === 'negocio') {
            document.getElementById('admin-business-name-field').classList.remove('hidden');
            document.getElementById('admin-client-business-name').value = client.businessName || '';
        }

        document.getElementById('admin-client-phone').value = client.phone || '';

        // Set location
        document.getElementById('admin-client-province').value = client.province || '';
        document.getElementById('admin-client-canton').value = client.canton || '';
        document.getElementById('admin-client-parish').value = client.parish || '';
        document.getElementById('admin-client-sector').value = client.sector || '';
        document.getElementById('admin-client-address').value = client.address || '';

        if (client.location) {
            document.getElementById('admin-client-latitude').value = client.location.latitude || '';
            document.getElementById('admin-client-longitude').value = client.location.longitude || '';
        }

        // Set seller
        document.getElementById('admin-client-seller').value = client.assignedSeller || '';

        // Re-render products to ensure they are displayed
        renderAdminClientDefaultProducts();

        // Set default products (wait a bit for rendering to complete)
        setTimeout(() => {
            document.querySelectorAll('input[name="admin-default-products"]').forEach(cb => {
                cb.checked = client.defaultProducts && client.defaultProducts.includes(cb.value);
            });
        }, 50);

        // Set visit schedule
        document.querySelectorAll('input[name="admin-visit-days"]').forEach(cb => {
            cb.checked = client.visitSchedule?.days && client.visitSchedule.days.includes(cb.value);
        });
        document.getElementById('admin-client-visit-time').value = client.visitSchedule?.time || '';
        document.getElementById('admin-client-visit-frequency').value = client.visitSchedule?.frequency || '';

        // Set notes
        document.getElementById('admin-client-notes').value = client.notes || '';

        // Show modal
        document.getElementById('admin-client-modal').classList.remove('hidden');
    }

    async function deleteAdminClient(clientId) {
        const client = db.clients.find(c => c.id === clientId);
        if (!client) return;

        const confirmMsg = `쮼st치 seguro de que desea eliminar al cliente "${client.name}"?\n\nEsta acci칩n no se puede deshacer.`;
        if (!confirm(confirmMsg)) return;

        try {
            await db_firestore.collection('clients').doc(clientId).delete();
            alert('Cliente eliminado correctamente');
        } catch (error) {
            console.error('Error deleting client:', error);
            alert('Error al eliminar el cliente: ' + error.message);
        }
    }

    // ===== BULK REASSIGNMENT FUNCTIONS =====

    function updateBulkReassignBar() {
        const checkboxes = document.querySelectorAll('.client-select-checkbox:checked');
        const count = checkboxes.length;
        const bar = document.getElementById('bulk-reassign-bar');
        const countSpan = document.getElementById('selected-clients-count');

        if (count > 0) {
            bar.classList.remove('hidden');
            countSpan.textContent = count;

            // Poblar el selector de vendedores si est치 vac칤o
            const bulkSellerSelect = document.getElementById('bulk-reassign-seller');
            if (bulkSellerSelect.options.length === 1) { // Solo tiene la opci칩n por defecto
                Object.values(db.usersMap).forEach(user => {
                    if (user && (user.role === 'seller' || user.role === 'vendedor')) {
                        const option = document.createElement('option');
                        option.value = user.uid || user.id;
                        option.textContent = user.displayName || user.name || user.email || 'Vendedor';
                        bulkSellerSelect.appendChild(option);
                    }
                });
            }
        } else {
            bar.classList.add('hidden');
        }
    }

    function toggleSelectAllClients() {
        const selectAll = document.getElementById('select-all-clients');
        const checkboxes = document.querySelectorAll('.client-select-checkbox');

        checkboxes.forEach(cb => {
            cb.checked = selectAll.checked;
        });

        updateBulkReassignBar();
    }

    async function bulkReassignClients() {
        const selectedSeller = document.getElementById('bulk-reassign-seller').value;

        if (!selectedSeller) {
            alert('Por favor, seleccione un vendedor para asignar');
            return;
        }

        const checkboxes = document.querySelectorAll('.client-select-checkbox:checked');
        const clientIds = Array.from(checkboxes).map(cb => cb.dataset.clientId);

        if (clientIds.length === 0) {
            alert('No hay clientes seleccionados');
            return;
        }

        const sellerName = db.usersMap[selectedSeller]?.displayName || db.usersMap[selectedSeller]?.name || 'el vendedor seleccionado';
        const confirmMsg = `쮼st치 seguro de reasignar ${clientIds.length} cliente(s) a ${sellerName}?`;

        if (!confirm(confirmMsg)) return;

        try {
            // Actualizar en batch
            const batch = db_firestore.batch();

            clientIds.forEach(clientId => {
                const clientRef = db_firestore.collection('clients').doc(clientId);
                batch.update(clientRef, {
                    assignedSeller: selectedSeller,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            await batch.commit();

            alert(`九 ${clientIds.length} cliente(s) reasignado(s) exitosamente a ${sellerName}`);

            // Limpiar selecci칩n
            cancelBulkReassign();

        } catch (error) {
            console.error('Error en reasignaci칩n m칰ltiple:', error);
            alert('Error al reasignar clientes: ' + error.message);
        }
    }

    function cancelBulkReassign() {
        // Desmarcar todos los checkboxes
        document.querySelectorAll('.client-select-checkbox').forEach(cb => {
            cb.checked = false;
        });
        document.getElementById('select-all-clients').checked = false;

        // Limpiar el selector de vendedor
        document.getElementById('bulk-reassign-seller').value = '';

        // Ocultar la barra
        document.getElementById('bulk-reassign-bar').classList.add('hidden');
    }

    // ===== VISITS MODULE FUNCTIONS =====

    async function loadVisitsModule() {
        // Cargar clientes a visitar hoy
        await renderClientVisitsToday();

        // Cargar clientes inactivos
        await renderInactiveClients();

        // Cargar historial de visitas
        await renderVisitHistory();

        // Actualizar contadores
        updateVisitsStats();
    }

    // ============================================
    // ADMIN VISITS MODULE
    // ============================================
    async function loadAdminVisitsModule() {
        // Populate seller filter
        populateAdminVisitsSellerFilter();

        // Set default dates (last 7 days)
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 7);

        document.getElementById('admin-visits-start-date').valueAsDate = startDate;
        document.getElementById('admin-visits-end-date').valueAsDate = endDate;

        // Load visits
        await renderAdminVisitsList();

        // Update statistics
        updateAdminVisitsStats();
    }

    function populateAdminVisitsSellerFilter() {
        const sellerDropdown = document.getElementById('admin-visits-seller-filter');
        sellerDropdown.innerHTML = '<option value="">Todos los vendedores</option>';

        Object.values(db.usersMap).forEach(user => {
            if (user && (user.role === 'seller' || user.role === 'vendedor')) {
                const option = document.createElement('option');
                option.value = user.uid || user.id;
                option.textContent = user.displayName || user.name || user.email || 'Vendedor';
                sellerDropdown.appendChild(option);
            }
        });
    }

    async function filterAdminVisits() {
        await renderAdminVisitsList();
        updateAdminVisitsStats();
    }

    async function renderAdminVisitsList() {
        const container = document.getElementById('admin-visits-list');
        const countSpan = document.getElementById('admin-visits-count');

        // Get filter values
        const sellerFilter = document.getElementById('admin-visits-seller-filter').value;
        const startDate = document.getElementById('admin-visits-start-date').value;
        const endDate = document.getElementById('admin-visits-end-date').value;

        // Filter visits
        let filteredVisits = db.visits.filter(visit => {
            // Seller filter
            const matchesSeller = !sellerFilter || visit.sellerId === sellerFilter;

            // Date filter
            let matchesDate = true;
            if (startDate && visit.date < startDate) matchesDate = false;
            if (endDate && visit.date > endDate) matchesDate = false;

            return matchesSeller && matchesDate;
        });

        // Sort by date (most recent first)
        filteredVisits.sort((a, b) => {
            const dateCompare = b.date.localeCompare(a.date);
            if (dateCompare !== 0) return dateCompare;
            return (b.time || '').localeCompare(a.time || '');
        });

        countSpan.textContent = filteredVisits.length;

        if (filteredVisits.length === 0) {
            container.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-8 text-slate-500 dark:text-slate-400">
                        No hay visitas registradas en el per칤odo seleccionado
                    </td>
                </tr>
            `;
            return;
        }

        container.innerHTML = filteredVisits.map(visit => {
            const client = db.clients.find(c => c.id === visit.clientId);
            const seller = db.usersMap[visit.sellerId];
            const clientName = client ? client.name : 'Cliente no encontrado';
            const sellerName = seller ? (seller.displayName || seller.email) : 'Vendedor';

            const location = client && client.province
                ? [client.province, client.canton].filter(Boolean).join(', ')
                : 'No especificada';

            return `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700">
                    <td class="py-3 px-4 text-sm">${visit.date}</td>
                    <td class="py-3 px-4 text-sm">${visit.time || '-'}</td>
                    <td class="py-3 px-4 text-sm font-medium">${sellerName}</td>
                    <td class="py-3 px-4 text-sm">${clientName}</td>
                    <td class="py-3 px-4 text-sm">${location}</td>
                    <td class="py-3 px-4 text-sm">${visit.notes || '-'}</td>
                    <td class="py-3 px-4 text-sm">
                        <button onclick="deleteAdminVisit('${visit.id}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function updateAdminVisitsStats() {
        const sellerFilter = document.getElementById('admin-visits-seller-filter').value;
        const startDate = document.getElementById('admin-visits-start-date').value;
        const endDate = document.getElementById('admin-visits-end-date').value;
        const today = getCurrentDate();

        // Filter visits
        let filteredVisits = db.visits.filter(visit => {
            const matchesSeller = !sellerFilter || visit.sellerId === sellerFilter;
            let matchesDate = true;
            if (startDate && visit.date < startDate) matchesDate = false;
            if (endDate && visit.date > endDate) matchesDate = false;
            return matchesSeller && matchesDate;
        });

        // Total visits
        document.getElementById('admin-total-visits').textContent = filteredVisits.length;

        // Visits today
        const visitsToday = filteredVisits.filter(v => v.date === today).length;
        document.getElementById('admin-visits-today').textContent = visitsToday;

        // Active sellers (sellers with at least one visit)
        const activeSellers = new Set(filteredVisits.map(v => v.sellerId));
        document.getElementById('admin-active-sellers').textContent = activeSellers.size;

        // Unique clients visited
        const uniqueClients = new Set(filteredVisits.map(v => v.clientId));
        document.getElementById('admin-unique-clients').textContent = uniqueClients.size;
    }

    async function deleteAdminVisit(visitId) {
        if (!confirm('쮼st치 seguro de eliminar este registro de visita?')) return;

        try {
            await db_firestore.collection('visits').doc(visitId).delete();
            showNotification('Visita eliminada correctamente', 'success');
            await renderAdminVisitsList();
            updateAdminVisitsStats();
        } catch (error) {
            console.error('Error al eliminar visita:', error);
            showNotification('Error al eliminar visita', 'error');
        }
    }

    async function exportVisitsToExcel() {
        const sellerFilter = document.getElementById('admin-visits-seller-filter').value;
        const startDate = document.getElementById('admin-visits-start-date').value;
        const endDate = document.getElementById('admin-visits-end-date').value;

        // Filter visits
        let filteredVisits = db.visits.filter(visit => {
            const matchesSeller = !sellerFilter || visit.sellerId === sellerFilter;
            let matchesDate = true;
            if (startDate && visit.date < startDate) matchesDate = false;
            if (endDate && visit.date > endDate) matchesDate = false;
            return matchesSeller && matchesDate;
        });

        if (filteredVisits.length === 0) {
            alert('No hay visitas para exportar');
            return;
        }

        // Prepare data for export
        const data = filteredVisits.map(visit => {
            const client = db.clients.find(c => c.id === visit.clientId);
            const seller = db.usersMap[visit.sellerId];

            return {
                'Fecha': visit.date,
                'Hora': visit.time || '',
                'Vendedor': seller ? (seller.displayName || seller.email) : '',
                'Cliente': client ? client.name : '',
                'Provincia': client?.province || '',
                'Cant칩n': client?.canton || '',
                'Notas': visit.notes || ''
            };
        });

        // Create worksheet
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Visitas");

        // Generate filename
        const filename = `Visitas_${startDate || 'inicio'}_${endDate || 'fin'}.xlsx`;

        // Download
        XLSX.writeFile(wb, filename);
    }

    // ===== ADMIN WHATSAPP TEMPLATES =====

    async function loadWhatsAppTemplatesModule() {
        await renderWhatsAppTemplatesList();

        // Event listener para el formulario
        const form = document.getElementById('whatsapp-template-form');
        if (form && !form.dataset.listenerAdded) {
            form.addEventListener('submit', saveWhatsAppTemplate);
            form.dataset.listenerAdded = 'true';
        }

        // Event listener para preview en tiempo real
        const messageInput = document.getElementById('template-message');
        if (messageInput) {
            messageInput.addEventListener('input', updateTemplatePreview);
        }
    }

    function updateTemplatePreview() {
        const message = document.getElementById('template-message').value;
        const preview = message
            .replace(/\[cliente\]/gi, 'Juan P칠rez')
            .replace(/\[vendedor\]/gi, 'Mar칤a L칩pez')
            .replace(/\[empresa\]/gi, 'Bijao Water')
            .replace(/\[dia\]/gi, 'lunes');

        document.getElementById('template-preview').textContent = preview || 'El preview aparecer치 aqu칤...';
    }

    async function saveWhatsAppTemplate(e) {
        e.preventDefault();

        const name = document.getElementById('template-name').value.trim();
        const message = document.getElementById('template-message').value.trim();

        if (!name || !message) {
            alert('Por favor, completa todos los campos');
            return;
        }

        const templateData = {
            name,
            message,
            createdBy: auth.currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await db_firestore.collection('whatsapp_templates').add(templateData);
            alert('九 Plantilla guardada exitosamente');
            e.target.reset();
            document.getElementById('template-preview').textContent = 'El preview aparecer치 aqu칤...';
        } catch (error) {
            console.error('Error al guardar plantilla:', error);
            alert('Error al guardar plantilla: ' + error.message);
        }
    }

    async function renderWhatsAppTemplatesList() {
        const container = document.getElementById('templates-list');
        const countSpan = document.getElementById('templates-count');

        if (!db.whatsappTemplates || db.whatsappTemplates.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                    <svg class="w-16 h-16 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                    </svg>
                    <p>No hay plantillas creadas a칰n</p>
                    <p class="text-xs mt-1">Crea tu primera plantilla usando el formulario de arriba</p>
                </div>
            `;
            countSpan.textContent = '0';
            return;
        }

        countSpan.textContent = db.whatsappTemplates.length;

        container.innerHTML = db.whatsappTemplates.map(template => `
            <div class="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg border border-slate-200 dark:border-slate-600">
                <div class="flex justify-between items-start gap-4">
                    <div class="flex-1">
                        <h4 class="font-semibold text-slate-900 dark:text-white mb-2">${template.name}</h4>
                        <p class="text-sm text-slate-600 dark:text-slate-400 whitespace-pre-wrap">${template.message}</p>
                    </div>
                    <button onclick="deleteWhatsAppTemplate('${template.id}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 flex-shrink-0">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `).join('');
    }

    async function deleteWhatsAppTemplate(templateId) {
        if (!confirm('쮼st치 seguro de eliminar esta plantilla?')) return;

        try {
            await db_firestore.collection('whatsapp_templates').doc(templateId).delete();
            alert('九 Plantilla eliminada');
        } catch (error) {
            console.error('Error al eliminar plantilla:', error);
            alert('Error al eliminar plantilla: ' + error.message);
        }
    }

    function getDayOfWeek() {
        const days = ['D', 'L', 'M', 'X', 'J', 'V', 'S'];
        return days[new Date().getDay()];
    }

    async function renderClientVisitsToday() {
        const container = document.getElementById('visits-today-list');
        const today = getDayOfWeek();
        const currentUserId = auth.currentUser.uid;

        // Filtrar clientes que deben ser visitados hoy y est치n asignados al vendedor actual
        const clientsToday = db.clients.filter(client => {
            if (!client.visitSchedule || !client.visitSchedule.days) return false;
            // Solo mostrar clientes asignados al vendedor actual
            if (client.assignedSeller !== currentUserId) return false;
            return client.visitSchedule.days.includes(today);
        });

        if (clientsToday.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                    <svg class="w-16 h-16 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <p class="text-lg font-medium">No hay visitas programadas para hoy</p>
                </div>
            `;
            return;
        }

        // Ordenar por horario
        const timeOrder = { 'ma침ana': 1, 'tarde': 2, 'noche': 3 };
        clientsToday.sort((a, b) => {
            const timeA = timeOrder[a.visitSchedule?.time] || 999;
            const timeB = timeOrder[b.visitSchedule?.time] || 999;
            return timeA - timeB;
        });

        container.innerHTML = clientsToday.map(client => {
            const displayName = client.type === 'negocio' && client.businessName
                ? client.businessName
                : client.name;

            const timeEmoji = {
                'ma침ana': '游깬',
                'tarde': '驕勇',
                'noche': '游깿'
            };

            const time = client.visitSchedule?.time || 'No especificado';
            const frequency = client.visitSchedule?.frequency || 'No especificado';
            const location = [client.province, client.canton].filter(Boolean).join(', ') || 'No especificada';

            // Verificar si ya se visit칩 hoy
            const todayDate = getCurrentDate();
            const visitedToday = db.visits && db.visits.some(v =>
                v.clientId === client.id && v.date === todayDate
            );

            return `
                <div class="bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg border-l-4 ${visitedToday ? 'border-green-500' : 'border-blue-500'}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="font-bold text-lg text-slate-900 dark:text-white flex items-center gap-2">
                                ${displayName}
                                ${visitedToday ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">九 Visitado</span>' : ''}
                            </h4>
                            <div class="mt-2 space-y-1 text-sm text-slate-600 dark:text-slate-400">
                                <p><strong>${timeEmoji[time] || '낋'} Horario:</strong> ${time}</p>
                                <p><strong>游늰 Frecuencia:</strong> ${frequency}</p>
                                <p><strong>游늸 Ubicaci칩n:</strong> ${location}</p>
                                ${client.phone ? `<p><strong>游 Tel칠fono:</strong> ${client.phone}</p>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="callClient('${client.phone ? client.phone.replace(/'/g, "\\'") : ""}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm flex items-center justify-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                </svg>
                                Llamar
                            </button>
                            <button onclick="openWhatsAppTemplates('${client.id}')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm flex items-center justify-center gap-1">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                </svg>
                                WhatsApp
                            </button>
                            ${!visitedToday ? `
                                <button onclick="recordVisit('${client.id}')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 rounded text-sm">
                                    Marcar Visitado
                                </button>
                            ` : ''}
                            ${client.location ? `
                                <button onclick="openMapForClient('${client.id}')" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                                    Ver Mapa
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function renderInactiveClients() {
        const container = document.getElementById('inactive-clients-list');
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
        const currentUserId = auth.currentUser.uid;

        // Obtener solo clientes asignados al vendedor actual con su 칰ltima venta
        const clientsWithLastSale = db.clients
            .filter(client => client.assignedSeller === currentUserId)
            .map(client => {
            const clientSales = db.sales.filter(s => s.clientId === client.id);
            const lastSale = clientSales.length > 0
                ? clientSales.sort((a, b) => b.date.localeCompare(a.date))[0]
                : null;

            return {
                ...client,
                lastSaleDate: lastSale?.date,
                daysSinceLastSale: lastSale
                    ? Math.floor((new Date() - new Date(lastSale.date)) / (1000 * 60 * 60 * 24))
                    : 999
            };
        });

        // Filtrar clientes inactivos (sin ventas en 30+ d칤as)
        const inactiveClients = clientsWithLastSale.filter(c => c.daysSinceLastSale >= 30);

        if (inactiveClients.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                    <svg class="w-16 h-16 mx-auto mb-3 opacity-50 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-lg font-medium">춰Todos los clientes est치n activos!</p>
                </div>
            `;
            return;
        }

        // Ordenar por d칤as sin comprar (m치s d칤as primero)
        inactiveClients.sort((a, b) => b.daysSinceLastSale - a.daysSinceLastSale);

        container.innerHTML = inactiveClients.map(client => {
            const displayName = client.type === 'negocio' && client.businessName
                ? client.businessName
                : client.name;

            const lastSaleText = client.lastSaleDate
                ? `칔ltima compra: ${formatDateDisplay(client.lastSaleDate)} (hace ${client.daysSinceLastSale} d칤as)`
                : 'Sin compras registradas';

            return `
                <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg border-l-4 border-red-500">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="font-bold text-lg text-slate-900 dark:text-white">${displayName}</h4>
                            <div class="mt-2 space-y-1 text-sm text-slate-600 dark:text-slate-400">
                                <p class="font-semibold text-red-600 dark:text-red-400">丘멆잺 ${lastSaleText}</p>
                                ${client.phone ? `<p><strong>游 Tel칠fono:</strong> ${client.phone}</p>` : ''}
                                ${client.province ? `<p><strong>游늸 Ubicaci칩n:</strong> ${client.province}, ${client.canton || ''}</p>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="callClient('${client.phone ? client.phone.replace(/'/g, "\\'") : ""}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm flex items-center justify-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                </svg>
                                Llamar
                            </button>
                            <button onclick="openWhatsAppTemplates('${client.id}')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm flex items-center justify-center gap-1">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                </svg>
                                WhatsApp
                            </button>
                            <button onclick="recordVisit('${client.id}')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 rounded text-sm">
                                Registrar Visita
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function renderVisitHistory() {
        const container = document.getElementById('visit-history-list');

        if (!db.visits || db.visits.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                    <svg class="w-16 h-16 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-lg font-medium">No hay visitas registradas</p>
                </div>
            `;
            return;
        }

        // Filtrar visitas de los 칰ltimos 7 d칤as
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];

        const recentVisits = db.visits
            .filter(v => v.date >= sevenDaysAgoStr)
            .sort((a, b) => b.date.localeCompare(a.date) || b.time.localeCompare(a.time));

        if (recentVisits.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                    <p class="text-lg font-medium">No hay visitas en los 칰ltimos 7 d칤as</p>
                </div>
            `;
            return;
        }

        container.innerHTML = recentVisits.map(visit => {
            const client = db.clients.find(c => c.id === visit.clientId);
            if (!client) return '';

            const displayName = client.type === 'negocio' && client.businessName
                ? client.businessName
                : client.name;

            return `
                <div class="bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-900 dark:text-white">${displayName}</h4>
                            <div class="mt-2 space-y-1 text-sm text-slate-600 dark:text-slate-400">
                                <p><strong>游늰 Fecha:</strong> ${formatDateDisplay(visit.date)}</p>
                                <p><strong>낋 Hora:</strong> ${visit.time}</p>
                                ${visit.notes ? `<p><strong>游닇 Notas:</strong> ${visit.notes}</p>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function updateVisitsStats() {
        const today = getDayOfWeek();
        const todayDate = getCurrentDate();

        // Contar visitas programadas para hoy
        const visitsTodayCount = db.clients.filter(c =>
            c.visitSchedule?.days?.includes(today)
        ).length;

        // Contar visitas completadas hoy
        const completedCount = db.visits ? db.visits.filter(v => v.date === todayDate).length : 0;

        // Contar pendientes
        const pendingCount = visitsTodayCount - completedCount;

        // Contar clientes inactivos
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];

        const inactiveCount = db.clients.filter(client => {
            const clientSales = db.sales.filter(s => s.clientId === client.id);
            if (clientSales.length === 0) return true;
            const lastSale = clientSales.sort((a, b) => b.date.localeCompare(a.date))[0];
            return lastSale.date < thirtyDaysAgoStr;
        }).length;

        document.getElementById('visits-today-count').textContent = visitsTodayCount;
        document.getElementById('visits-completed-count').textContent = completedCount;
        document.getElementById('visits-pending-count').textContent = Math.max(0, pendingCount);
        document.getElementById('clients-inactive-count').textContent = inactiveCount;
    }

    async function recordVisit(clientId) {
        const client = db.clients.find(c => c.id === clientId);
        if (!client) return;

        const notes = prompt(`Registrar visita a ${client.name}\n\nNotas (opcional):`);
        if (notes === null) return; // Usuario cancel칩

        const visitData = {
            clientId: clientId,
            date: getCurrentDate(),
            time: new Date().toLocaleTimeString('es-EC', { hour: '2-digit', minute: '2-digit' }),
            notes: notes || '',
            sellerId: auth.currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await db_firestore.collection('visits').add(visitData);
            alert('九 Visita registrada correctamente');
            loadVisitsModule(); // Recargar el m칩dulo
        } catch (error) {
            console.error('Error al registrar visita:', error);
            alert('仇 Error al registrar la visita');
        }
    }

    function openMapForClient(clientId) {
        const client = db.clients.find(c => c.id === clientId);
        if (!client || !client.location) {
            alert('Este cliente no tiene ubicaci칩n GPS registrada');
            return;
        }

        const url = `https://www.google.com/maps?q=${client.location.latitude},${client.location.longitude}`;
        window.open(url, '_blank');
    }

    // ===== SISTEMA DE PLANTILLAS WHATSAPP =====

    let currentWhatsAppClient = null;
    let selectedTemplate = null;

    function openWhatsAppTemplates(clientId) {
        const client = db.clients.find(c => c.id === clientId);
        if (!client) {
            alert('Cliente no encontrado');
            return;
        }

        if (!client.phone) {
            alert('Este cliente no tiene tel칠fono registrado');
            return;
        }

        currentWhatsAppClient = client;

        // Mostrar modal
        document.getElementById('whatsapp-modal').classList.remove('hidden');

        // Llenar informaci칩n del cliente
        document.getElementById('wa-client-name').textContent = client.name;
        document.getElementById('wa-client-phone').textContent = client.phone;

        // Cargar plantillas
        loadWhatsAppTemplatesSelector();
    }

    function closeWhatsAppModal() {
        document.getElementById('whatsapp-modal').classList.add('hidden');
        currentWhatsAppClient = null;
        selectedTemplate = null;
    }

    function loadWhatsAppTemplatesSelector() {
        const container = document.getElementById('templates-selector');

        if (!db.whatsappTemplates || db.whatsappTemplates.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                    <p class="mb-2">No hay plantillas disponibles</p>
                    <p class="text-xs">Pide al administrador que cree plantillas de mensajes</p>
                </div>
            `;
            return;
        }

        container.innerHTML = db.whatsappTemplates.map(template => `
            <label class="flex items-start gap-3 p-3 bg-white dark:bg-slate-600 rounded-lg border-2 border-slate-300 dark:border-slate-500 cursor-pointer has-[:checked]:border-green-500 has-[:checked]:bg-green-50 dark:has-[:checked]:bg-green-900/30 transition">
                <input type="radio" name="template-choice" value="${template.id}" onchange="selectWhatsAppTemplate('${template.id}')" class="mt-1 w-4 h-4 text-green-600">
                <div class="flex-1">
                    <p class="font-semibold text-slate-900 dark:text-white">${template.name}</p>
                    <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">${template.message.substring(0, 100)}${template.message.length > 100 ? '...' : ''}</p>
                </div>
            </label>
        `).join('');
    }

    function selectWhatsAppTemplate(templateId) {
        const template = db.whatsappTemplates.find(t => t.id === templateId);
        if (!template) return;

        selectedTemplate = template;

        // Generar vista previa con variables reemplazadas
        const preview = replaceWhatsAppVariables(template.message, currentWhatsAppClient);
        document.getElementById('wa-message-preview').textContent = preview;
    }

    function replaceWhatsAppVariables(message, client) {
        if (!client) return message;

        const currentUser = db.usersMap[auth.currentUser.uid];
        const sellerName = currentUser?.displayName || currentUser?.name || 'Vendedor';

        const days = ['domingo', 'lunes', 'martes', 'mi칠rcoles', 'jueves', 'viernes', 's치bado'];
        const today = days[new Date().getDay()];

        return message
            .replace(/\[cliente\]/gi, client.name)
            .replace(/\[vendedor\]/gi, sellerName)
            .replace(/\[empresa\]/gi, 'Bijao Water')
            .replace(/\[dia\]/gi, today);
    }

    function sendWhatsAppMessage() {
        if (!selectedTemplate) {
            alert('Por favor, selecciona una plantilla');
            return;
        }

        if (!currentWhatsAppClient) {
            alert('Cliente no encontrado');
            return;
        }

        const message = replaceWhatsAppVariables(selectedTemplate.message, currentWhatsAppClient);

        // Limpiar el n칰mero de tel칠fono (quitar espacios, guiones, par칠ntesis)
        let phone = currentWhatsAppClient.phone.replace(/\D/g, '');

        // Si el n칰mero no empieza con c칩digo de pa칤s, asumir Ecuador (+593)
        if (!phone.startsWith('593') && !phone.startsWith('+593')) {
            // Si empieza con 0, quitarlo
            if (phone.startsWith('0')) {
                phone = phone.substring(1);
            }
            phone = '593' + phone;
        }

        // Crear URL de WhatsApp con el mensaje
        const encodedMessage = encodeURIComponent(message);
        const whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;

        // Abrir WhatsApp
        window.open(whatsappUrl, '_blank');

        // Cerrar modal
        closeWhatsAppModal();

        // Opcional: Registrar que se envi칩 el mensaje
        console.log('Mensaje WhatsApp enviado a:', currentWhatsAppClient.name);
    }

    // ===== FUNCI칍N PARA LLAMAR A CLIENTES =====

    function callClient(phoneNumber) {
        if (!phoneNumber) {
            alert('Este cliente no tiene n칰mero de tel칠fono registrado');
            return;
        }

        // Limpiar el n칰mero de tel칠fono (quitar espacios, guiones, par칠ntesis)
        let phone = phoneNumber.replace(/\D/g, '');

        // Si el n칰mero no empieza con c칩digo de pa칤s, asumir Ecuador (+593)
        if (!phone.startsWith('593') && !phone.startsWith('+593')) {
            // Si empieza con 0, quitarlo
            if (phone.startsWith('0')) {
                phone = phone.substring(1);
            }
            phone = '+593' + phone;
        } else if (phone.startsWith('593')) {
            phone = '+' + phone;
        }

        // Crear URL tel: para iniciar la llamada
        const telUrl = `tel:${phone}`;

        // En dispositivos m칩viles, esto abrir치 directamente la aplicaci칩n de tel칠fono
        // En escritorio, preguntar치 qu칠 aplicaci칩n usar (Skype, Teams, etc.)
        window.location.href = telUrl;

        console.log('Iniciando llamada a:', phone);
    }

    // ===== MAPA INTERACTIVO CON RUTA OPTIMIZADA =====

    let visitsMap = null;
    let mapMarkers = [];
    let routeLine = null;

    async function openVisitsMap() {
        // Obtener clientes para visitar hoy
        const today = getDayOfWeek();
        const clientsToday = db.clients.filter(client => {
            if (!client.visitSchedule || !client.visitSchedule.days) return false;
            if (!client.location || !client.location.latitude || !client.location.longitude) return false;
            return client.visitSchedule.days.includes(today);
        });

        if (clientsToday.length === 0) {
            alert('No hay clientes con ubicaci칩n GPS programados para hoy.\n\nAseg칰rate de que los clientes tengan:\n1. D칤as de visita configurados\n2. Coordenadas GPS registradas');
            return;
        }

        // Abrir modal
        const modal = document.getElementById('visits-map-modal');
        modal.classList.remove('hidden');

        // Esperar a que el modal se muestre completamente
        setTimeout(() => {
            initializeVisitsMap(clientsToday);
        }, 200);
    }

    function closeVisitsMap() {
        const modal = document.getElementById('visits-map-modal');
        modal.classList.add('hidden');

        // Limpiar mapa
        if (visitsMap) {
            visitsMap.remove();
            visitsMap = null;
            mapMarkers = [];
            routeLine = null;
        }
    }

    function initializeVisitsMap(clients) {
        // Limpiar mapa anterior si existe
        if (visitsMap) {
            visitsMap.remove();
        }

        // Calcular centro del mapa (promedio de todas las ubicaciones)
        const avgLat = clients.reduce((sum, c) => sum + c.location.latitude, 0) / clients.length;
        const avgLng = clients.reduce((sum, c) => sum + c.location.longitude, 0) / clients.length;

        // Inicializar mapa
        visitsMap = L.map('visits-map').setView([avgLat, avgLng], 13);

        // Agregar capa de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '춸 OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(visitsMap);

        // Obtener ubicaci칩n actual del usuario
        getUserLocationForMap(clients);
    }

    function getUserLocationForMap(clients) {
        if (!navigator.geolocation) {
            // Si no hay geolocalizaci칩n, usar el primer cliente como punto de inicio
            calculateOptimizedRoute(clients, null);
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const userLocation = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                };

                // Agregar marcador de ubicaci칩n actual
                const userIcon = L.divIcon({
                    className: 'custom-user-marker',
                    html: `<div style="background-color: #3B82F6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                L.marker([userLocation.latitude, userLocation.longitude], { icon: userIcon })
                    .addTo(visitsMap)
                    .bindPopup('<b>游늸 Tu Ubicaci칩n</b>')
                    .openPopup();

                // Calcular ruta optimizada desde ubicaci칩n actual
                calculateOptimizedRoute(clients, userLocation);
            },
            (error) => {
                console.warn('No se pudo obtener la ubicaci칩n:', error);
                // Calcular ruta sin ubicaci칩n actual
                calculateOptimizedRoute(clients, null);
            }
        );
    }

    function calculateOptimizedRoute(clients, startLocation) {
        // Implementar algoritmo de optimizaci칩n de ruta (Nearest Neighbor TSP)
        const route = optimizeRoute(clients, startLocation);

        // Agregar marcadores de clientes en el mapa
        route.forEach((client, index) => {
            const markerColor = index === 0 ? '#10B981' : '#6366F1'; // Verde para primero, morado para los dem치s

            const customIcon = L.divIcon({
                className: 'custom-client-marker',
                html: `<div style="background-color: ${markerColor}; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">${index + 1}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            const displayName = client.type === 'negocio' && client.businessName
                ? client.businessName
                : client.name;

            const marker = L.marker([client.location.latitude, client.location.longitude], { icon: customIcon })
                .addTo(visitsMap)
                .bindPopup(`<b>${index + 1}. ${displayName}</b><br>${client.province}, ${client.canton || ''}`);

            mapMarkers.push(marker);
        });

        // Dibujar l칤nea de ruta
        const coordinates = [];
        if (startLocation) {
            coordinates.push([startLocation.latitude, startLocation.longitude]);
        }
        route.forEach(client => {
            coordinates.push([client.location.latitude, client.location.longitude]);
        });

        if (routeLine) {
            visitsMap.removeLayer(routeLine);
        }

        routeLine = L.polyline(coordinates, {
            color: '#3B82F6',
            weight: 3,
            opacity: 0.7,
            dashArray: '10, 5'
        }).addTo(visitsMap);

        // Ajustar vista del mapa para mostrar toda la ruta
        visitsMap.fitBounds(routeLine.getBounds(), { padding: [50, 50] });

        // Calcular distancia total y tiempo estimado
        const { totalDistance, estimatedTime } = calculateRouteMetrics(coordinates);

        // Actualizar UI
        updateRouteInfo(route, totalDistance, estimatedTime);
    }

    function optimizeRoute(clients, startLocation) {
        // Algoritmo Nearest Neighbor (vecino m치s cercano) para TSP
        const unvisited = [...clients];
        const route = [];
        let currentLocation = startLocation;

        while (unvisited.length > 0) {
            let nearestIndex = 0;
            let minDistance = Infinity;

            unvisited.forEach((client, index) => {
                const distance = currentLocation
                    ? calculateDistance(
                        currentLocation.latitude,
                        currentLocation.longitude,
                        client.location.latitude,
                        client.location.longitude
                    )
                    : 0; // Si no hay ubicaci칩n actual, tomar el primero

                if (distance < minDistance || !currentLocation) {
                    minDistance = distance;
                    nearestIndex = index;
                }
            });

            const nearest = unvisited.splice(nearestIndex, 1)[0];
            route.push(nearest);
            currentLocation = nearest.location;
        }

        return route;
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        // F칩rmula de Haversine para calcular distancia entre dos puntos
        const R = 6371; // Radio de la Tierra en km
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function toRad(degrees) {
        return degrees * (Math.PI / 180);
    }

    function calculateRouteMetrics(coordinates) {
        let totalDistance = 0;

        for (let i = 0; i < coordinates.length - 1; i++) {
            const [lat1, lon1] = coordinates[i];
            const [lat2, lon2] = coordinates[i + 1];
            totalDistance += calculateDistance(lat1, lon1, lat2, lon2);
        }

        // Estimar tiempo: 30 km/h promedio en ciudad + 5 min por cliente
        const travelTime = (totalDistance / 30) * 60; // minutos
        const visitTime = (coordinates.length - 1) * 5; // 5 min por cliente
        const estimatedTime = Math.round(travelTime + visitTime);

        return { totalDistance: totalDistance.toFixed(2), estimatedTime };
    }

    function updateRouteInfo(route, totalDistance, estimatedTime) {
        // Actualizar contadores
        document.getElementById('map-clients-count').textContent = route.length;
        document.getElementById('map-total-distance').textContent = `${totalDistance} km`;
        document.getElementById('map-estimated-time').textContent = `${estimatedTime} min`;

        // Generar lista de orden de visitas
        const listContainer = document.getElementById('route-order-list');
        listContainer.innerHTML = route.map((client, index) => {
            const displayName = client.type === 'negocio' && client.businessName
                ? client.businessName
                : client.name;

            const timeEmoji = {
                'ma침ana': '游깬',
                'tarde': '驕勇',
                'noche': '游깿'
            };

            const time = client.visitSchedule?.time || '';
            const location = [client.province, client.canton].filter(Boolean).join(', ');

            return `
                <div class="flex items-center gap-3 bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">
                        ${index + 1}
                    </div>
                    <div class="flex-1">
                        <h4 class="font-bold text-slate-900 dark:text-white">${displayName}</h4>
                        <p class="text-sm text-slate-600 dark:text-slate-400">
                            ${timeEmoji[time] || '낋'} ${time || 'No especificado'}  游늸 ${location}
                        </p>
                    </div>
                    <button onclick="focusOnMarker(${index})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        Ver en Mapa
                    </button>
                </div>
            `;
        }).join('');
    }

    function focusOnMarker(index) {
        if (mapMarkers[index]) {
            const marker = mapMarkers[index];
            visitsMap.setView(marker.getLatLng(), 16);
            marker.openPopup();
        }
    }

    function startNavigation() {
        if (mapMarkers.length === 0) {
            alert('No hay clientes en la ruta');
            return;
        }

        const firstClient = mapMarkers[0].getLatLng();
        const url = `https://www.google.com/maps/dir/?api=1&destination=${firstClient.lat},${firstClient.lng}&travelmode=driving`;
        window.open(url, '_blank');

        alert('九 Se abrir치 Google Maps para iniciar la navegaci칩n al primer cliente.\n\nLuego podr치s ir agregando los siguientes destinos en orden.');
    }

    async function updateAdminDashboard() {
        const startDateInput = document.getElementById('dashboard-start-date');
        const endDateInput = document.getElementById('dashboard-end-date');

        let startDate = startDateInput.value;
        let endDate = endDateInput.value;

        if (!startDate && !endDate) {
            const today = getCurrentDate();
            startDate = today;
            endDate = today;
        }

        let salesQuery = db_firestore.collection('sales');
        if (startDate) salesQuery = salesQuery.where('date', '>=', startDate);
        if (endDate) salesQuery = salesQuery.where('date', '<=', endDate);

        let expensesQuery = db_firestore.collection('expenses');
        if (startDate) expensesQuery = expensesQuery.where('date', '>=', startDate);
        if (endDate) expensesQuery = expensesQuery.where('date', '<=', endDate);

        try {
            const [salesSnapshot, expensesSnapshot] = await Promise.all([
                salesQuery.get(),
                expensesQuery.get()
            ]);

            const salesData = salesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            const expensesData = expensesSnapshot.docs.map(doc => doc.data());

            // Estad칤sticas Principales
            const totalSales = salesData.reduce((sum, s) => sum + s.total, 0);
            const totalExpenses = expensesData.reduce((sum, e) => sum + e.amount, 0);
            const balance = totalSales - totalExpenses;
            const creditSales = salesData.filter(s => s.paymentMethod === 'credito');
            const totalCredits = creditSales.reduce((sum, s) => sum + s.total, 0);

            document.getElementById('admin-total-sales').textContent = `$${totalSales.toFixed(2)}`;
            document.getElementById('admin-sales-count').textContent = `${salesData.length} venta${salesData.length !== 1 ? 's' : ''}`;
            document.getElementById('admin-total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
            document.getElementById('admin-expenses-count').textContent = `${expensesData.length} gasto${expensesData.length !== 1 ? 's' : ''}`;
            document.getElementById('admin-balance').textContent = `$${balance.toFixed(2)}`;
            document.getElementById('admin-credits-pending').textContent = `$${totalCredits.toFixed(2)}`;
            document.getElementById('admin-credits-count').textContent = `${creditSales.length} pendiente${creditSales.length !== 1 ? 's' : ''}`;

            // Calcular Producto M치s Vendido
            const productStats = {};
            salesData.forEach(sale => {
                if (sale.items && Array.isArray(sale.items)) {
                    sale.items.forEach(item => {
                        if (!productStats[item.name]) {
                            productStats[item.name] = { quantity: 0, total: 0 };
                        }
                        productStats[item.name].quantity += item.quantity;
                        productStats[item.name].total += item.total;
                    });
                }
            });

            // Producto m치s vendido (por cantidad)
            const topProduct = Object.entries(productStats)
                .sort((a, b) => b[1].quantity - a[1].quantity)[0];

            const topProductContainer = document.getElementById('top-product-container');
            if (topProduct) {
                topProductContainer.innerHTML = `
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-slate-700 dark:to-slate-700 p-4 rounded-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-2xl font-bold text-slate-900 dark:text-white">${topProduct[0]}</p>
                                <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">Cantidad vendida: ${topProduct[1].quantity} unidades</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold text-indigo-600 dark:text-indigo-400">$${topProduct[1].total.toFixed(2)}</p>
                                <p class="text-xs text-slate-500">Total generado</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                topProductContainer.innerHTML = '<p class="text-slate-500 text-center py-4">No hay datos de productos</p>';
            }

            // Top 5 Productos
            const top5Products = Object.entries(productStats)
                .sort((a, b) => b[1].quantity - a[1].quantity)
                .slice(0, 5);

            const top5Container = document.getElementById('top5-products-container');
            if (top5Products.length > 0) {
                top5Container.innerHTML = `
                    <table class="min-w-full">
                        <thead class="bg-slate-50 dark:bg-slate-700">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-bold">#</th>
                                <th class="py-3 px-4 text-left text-sm font-bold">Producto</th>
                                <th class="py-3 px-4 text-left text-sm font-bold">Cantidad</th>
                                <th class="py-3 px-4 text-left text-sm font-bold">Total</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                            ${top5Products.map((product, index) => `
                                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700">
                                    <td class="py-3 px-4">
                                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${
                                            index === 0 ? 'bg-yellow-100 text-yellow-800' :
                                            index === 1 ? 'bg-gray-100 text-gray-800' :
                                            index === 2 ? 'bg-orange-100 text-orange-800' :
                                            'bg-blue-100 text-blue-800'
                                        } font-bold text-sm">${index + 1}</span>
                                    </td>
                                    <td class="py-3 px-4 font-medium text-slate-900 dark:text-white">${product[0]}</td>
                                    <td class="py-3 px-4 text-slate-600 dark:text-slate-400">${product[1].quantity} unidades</td>
                                    <td class="py-3 px-4 font-bold text-teal-600 dark:text-teal-400">$${product[1].total.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                top5Container.innerHTML = '<p class="text-slate-500 text-center py-4">No hay datos de productos</p>';
            }

            // Vendedor con M치s Ventas
            const sellerStats = {};
            salesData.forEach(sale => {
                const sellerId = sale.sellerId;
                if (!sellerStats[sellerId]) {
                    sellerStats[sellerId] = { total: 0, count: 0 };
                }
                sellerStats[sellerId].total += sale.total;
                sellerStats[sellerId].count += 1;
            });

            const topSeller = Object.entries(sellerStats)
                .sort((a, b) => b[1].total - a[1].total)[0];

            const topSellerContainer = document.getElementById('top-seller-container');
            if (topSeller) {
                const seller = db.usersMap[topSeller[0]];
                const sellerName = seller ? (seller.displayName || seller.name || seller.email) : 'Usuario';
                topSellerContainer.innerHTML = `
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-slate-700 dark:to-slate-700 p-4 rounded-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-2xl font-bold text-slate-900 dark:text-white">${sellerName}</p>
                                <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">${topSeller[1].count} venta${topSeller[1].count !== 1 ? 's' : ''} realizada${topSeller[1].count !== 1 ? 's' : ''}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold text-purple-600 dark:text-purple-400">$${topSeller[1].total.toFixed(2)}</p>
                                <p class="text-xs text-slate-500">Total vendido</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                topSellerContainer.innerHTML = '<p class="text-slate-500 text-center py-4">No hay datos de vendedores</p>';
            }

        } catch (error) {
            console.error("Error filtering dashboard data: ", error);
            alert("Error al cargar los datos del dashboard.");
        }
    } 

    // Sistema unificado de b칰squeda y selecci칩n de productos
    let selectedProductId = null;

    function setupUnifiedProductSearch() {
        const searchInput = document.getElementById('product-search-input');
        const dropdown = document.getElementById('products-dropdown');
        const toggleBtn = document.getElementById('toggle-products-btn');

        if (!searchInput || !dropdown || !toggleBtn) return;

        // Evento de escritura en el input
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value;
            renderProductsDropdown(searchTerm);
            if (searchTerm.length > 0) {
                dropdown.classList.remove('hidden');
            }
        });

        // Evento de click en el input (mostrar todos)
        searchInput.addEventListener('focus', () => {
            renderProductsDropdown(searchInput.value);
            dropdown.classList.remove('hidden');
        });

        // Bot칩n de toggle (flecha)
        toggleBtn.addEventListener('click', () => {
            if (dropdown.classList.contains('hidden')) {
                searchInput.focus();
                renderProductsDropdown(searchInput.value);
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        });

        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !dropdown.contains(e.target) && !toggleBtn.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Renderizar productos inicialmente
        renderProductsDropdown('');
    }

    function renderProductsDropdown(searchTerm = '') {
        const container = document.getElementById('products-list');
        const dropdown = document.getElementById('products-dropdown');
        if (!container) return;

        const lowerSearch = searchTerm.toLowerCase();
        const filteredProducts = db.products.filter(p =>
            p.name.toLowerCase().includes(lowerSearch)
        );

        if (filteredProducts.length === 0) {
            container.innerHTML = `
                <div class="p-4 text-center text-slate-500 dark:text-slate-400">
                    <p class="text-sm">No se encontraron productos</p>
                </div>`;
            return;
        }

        container.innerHTML = filteredProducts.map(product => {
            const clientType = document.querySelector('input[name="client-type"]:checked')?.value || 'consumidor-final';
            const price = (clientType === 'negocio') ? product.priceBusiness : product.priceNormal;

            return `
                <button
                    type="button"
                    onclick="selectProductFromDropdown('${product.id}', '${product.name.replace(/'/g, "\\'")}', ${price})"
                    class="w-full p-3 sm:p-4 text-left hover:bg-blue-50 dark:hover:bg-slate-600 active:bg-blue-100 dark:active:bg-slate-500 transition flex justify-between items-center">
                    <div class="flex-1">
                        <div class="font-medium text-slate-900 dark:text-white">${product.name}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">Stock: ${product.stock}</div>
                    </div>
                    <div class="font-bold text-blue-600 dark:text-blue-400">$${price.toFixed(2)}</div>
                </button>`;
        }).join('');
    }

    function selectProductFromDropdown(productId, productName, price) {
        const searchInput = document.getElementById('product-search-input');
        const dropdown = document.getElementById('products-dropdown');

        // Guardar el producto seleccionado
        selectedProductId = productId;

        // Actualizar el input con el nombre del producto
        searchInput.value = productName;

        // Cerrar el dropdown
        dropdown.classList.add('hidden');

        // Enfocar en la cantidad para facilitar la entrada r치pida
        document.getElementById('sale-quantity').focus();
        document.getElementById('sale-quantity').select();
    }

    // Sistema inteligente de b칰squeda de clientes en ventas
    let selectedClientData = null;

    function setupIntelligentClientSearch() {
        const clientInput = document.getElementById('client-name');
        const dropdown = document.getElementById('clients-dropdown');
        const toggleBtn = document.getElementById('toggle-clients-btn');

        if (!clientInput || !dropdown || !toggleBtn) return;

        // Evento de escritura en el input
        clientInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value;
            renderClientsDropdown(searchTerm);
            dropdown.classList.remove('hidden');
            // Limpiar cliente seleccionado si se modifica el texto
            selectedClientData = null;
        });

        // Evento de focus en el input
        clientInput.addEventListener('focus', () => {
            renderClientsDropdown(clientInput.value);
            dropdown.classList.remove('hidden');
        });

        // Bot칩n de toggle (flecha)
        toggleBtn.addEventListener('click', () => {
            if (dropdown.classList.contains('hidden')) {
                clientInput.focus();
                renderClientsDropdown(clientInput.value);
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        });

        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', (e) => {
            if (!clientInput.contains(e.target) && !dropdown.contains(e.target) && !toggleBtn.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Renderizar clientes inicialmente
        renderClientsDropdown('');
    }

    function renderClientsDropdown(searchTerm = '') {
        const container = document.getElementById('clients-list');
        const dropdown = document.getElementById('clients-dropdown');
        if (!container) return;

        const lowerSearch = searchTerm.toLowerCase().trim();

        // Filtrar TODOS los clientes (compartidos entre vendedores)
        const allClients = db.clients.filter(c =>
            (c.name.toLowerCase().includes(lowerSearch) ||
             (c.businessName && c.businessName.toLowerCase().includes(lowerSearch)) ||
             (c.phone && c.phone.includes(searchTerm)))
        );

        let html = '';

        // Mostrar clientes encontrados
        if (allClients.length > 0) {
            html += allClients.map(client => {
                const displayName = client.type === 'negocio' && client.businessName
                    ? `${client.businessName} (${client.name})`
                    : client.name;
                const icon = client.type === 'negocio' ? '游끽' : '游녻';

                return `
                    <button
                        type="button"
                        onclick="selectClientFromDropdown('${client.id}')"
                        class="w-full p-3 sm:p-4 text-left hover:bg-blue-50 dark:hover:bg-slate-600 active:bg-blue-100 dark:active:bg-slate-500 transition">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">${icon}</span>
                            <div class="flex-1">
                                <div class="font-medium text-slate-900 dark:text-white">${displayName}</div>
                                ${client.phone ? `<div class="text-xs text-slate-500 dark:text-slate-400">游님 ${client.phone}</div>` : ''}
                            </div>
                        </div>
                    </button>`;
            }).join('');
        }

        // Opci칩n para crear nuevo cliente si hay texto de b칰squeda
        if (lowerSearch.length > 0) {
            const exactMatch = allClients.some(c =>
                c.name.toLowerCase() === lowerSearch
            );

            if (!exactMatch) {
                html += `
                    <button
                        type="button"
                        onclick="createNewClientFromSearch('${searchTerm.replace(/'/g, "\\'")}')"
                        class="w-full p-3 sm:p-4 text-left bg-green-50 dark:bg-green-900/30 hover:bg-green-100 dark:hover:bg-green-900/50 active:bg-green-200 dark:active:bg-green-900/70 transition border-t-2 border-green-300 dark:border-green-700">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">俱</span>
                            <div class="flex-1">
                                <div class="font-bold text-green-700 dark:text-green-400">Crear nuevo cliente</div>
                                <div class="text-sm text-green-600 dark:text-green-500">"${searchTerm}"</div>
                            </div>
                        </div>
                    </button>`;
            }
        }

        // Si no hay resultados ni opci칩n de crear
        if (html === '') {
            html = `
                <div class="p-4 text-center text-slate-500 dark:text-slate-400">
                    <p class="text-sm">Escribe un nombre para buscar o crear un cliente</p>
                </div>`;
        }

        container.innerHTML = html;
    }

    function selectClientFromDropdown(clientId) {
        const client = db.clients.find(c => c.id === clientId);
        if (!client) return;

        const clientInput = document.getElementById('client-name');
        const dropdown = document.getElementById('clients-dropdown');

        // Guardar datos del cliente seleccionado
        selectedClientData = client;

        // Mostrar el nombre en el input
        const displayName = client.type === 'negocio' && client.businessName
            ? client.businessName
            : client.name;
        clientInput.value = displayName;

        // Actualizar el tipo de cliente autom치ticamente
        const typeRadio = client.type === 'negocio'
            ? document.querySelector('input[name="client-type"][value="negocio"]')
            : document.querySelector('input[name="client-type"][value="consumidor-final"]');
        if (typeRadio) typeRadio.checked = true;

        // Actualizar precios de productos si ya hay tipo seleccionado
        const searchInput = document.getElementById('product-search-input');
        if (searchInput) renderProductsDropdown(searchInput.value);

        // Cargar bidones prestados del cliente
        loadClientLoanedContainers(clientId);

        // Cerrar dropdown
        dropdown.classList.add('hidden');
    }

    function createNewClientFromSearch(clientName) {
        const dropdown = document.getElementById('clients-dropdown');
        dropdown.classList.add('hidden');

        // Abrir el modal con el nombre pre-llenado
        openClientModal(clientName);
    }

    function openClientModal(clientName = '') {
        const modal = document.getElementById('create-client-modal');
        const nameInput = document.getElementById('modal-client-name');

        // Pre-llenar el nombre si se proporciona
        if (clientName) {
            nameInput.value = clientName;
        }

        // Poblar provincias
        const provinceSelect = document.getElementById('modal-client-province');
        if (provinceSelect && provinceSelect.options.length <= 1) {
            ecuadorProvinces.forEach(province => {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                provinceSelect.appendChild(option);
            });
        }

        // Poblar productos predeterminados
        const productsContainer = document.getElementById('modal-client-default-products');
        if (productsContainer && db.products && db.products.length > 0) {
            productsContainer.innerHTML = db.products.map(product => `
                <label class="flex items-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-2 rounded border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                    <input type="checkbox" name="modal-default-product" value="${product.id}" class="w-4 h-4">
                    <span class="text-xs font-medium">${product.name}</span>
                </label>
            `).join('');
        }

        // Mostrar el modal
        modal.classList.remove('hidden');
    }

    function closeClientModal() {
        const modal = document.getElementById('create-client-modal');
        const form = document.getElementById('modal-client-form');

        // Limpiar el formulario
        form.reset();
        document.getElementById('modal-client-latitude').value = '';
        document.getElementById('modal-client-longitude').value = '';
        document.getElementById('modal-business-name-field').classList.add('hidden');

        // Limpiar checkboxes de productos y d칤as
        document.querySelectorAll('input[name="modal-default-product"]').forEach(cb => cb.checked = false);
        document.querySelectorAll('input[name="modal-visit-days"]').forEach(cb => cb.checked = false);

        // Cerrar el modal
        modal.classList.add('hidden');
    }

    function captureModalClientLocation() {
        if (!navigator.geolocation) {
            alert('La geolocalizaci칩n no est치 soportada en este navegador');
            return;
        }

        const latInput = document.getElementById('modal-client-latitude');
        const lonInput = document.getElementById('modal-client-longitude');

        navigator.geolocation.getCurrentPosition(
            (position) => {
                latInput.value = position.coords.latitude.toFixed(6);
                lonInput.value = position.coords.longitude.toFixed(6);
                alert('九 Ubicaci칩n capturada correctamente');
            },
            (error) => {
                let errorMessage = 'Error al obtener la ubicaci칩n';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'Permiso de ubicaci칩n denegado. Por favor, habilita la ubicaci칩n en tu navegador.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'Ubicaci칩n no disponible';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'Tiempo de espera agotado';
                        break;
                }
                alert(errorMessage);
            }
        );
    }

    // Listener para mostrar/ocultar campo de nombre de negocio en el modal
    document.addEventListener('DOMContentLoaded', () => {
        const modalTypeSelector = document.getElementById('modal-client-type-selector');
        if (modalTypeSelector) {
            modalTypeSelector.addEventListener('change', (e) => {
                const businessField = document.getElementById('modal-business-name-field');
                if (e.target.value === 'negocio') {
                    businessField.classList.remove('hidden');
                } else {
                    businessField.classList.add('hidden');
                }
            });
        }

        // Listener para el formulario del modal
        const modalForm = document.getElementById('modal-client-form');
        if (modalForm) {
            modalForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const type = document.querySelector('input[name="modal-client-type"]:checked').value;
                const name = document.getElementById('modal-client-name').value.trim();
                const businessName = document.getElementById('modal-client-business-name').value.trim();
                const phone = document.getElementById('modal-client-phone').value.trim();
                const province = document.getElementById('modal-client-province').value;
                const canton = document.getElementById('modal-client-canton').value.trim();
                const parish = document.getElementById('modal-client-parish').value.trim();
                const sector = document.getElementById('modal-client-sector').value.trim();
                const address = document.getElementById('modal-client-address').value.trim();
                const latitude = document.getElementById('modal-client-latitude').value;
                const longitude = document.getElementById('modal-client-longitude').value;
                const frequency = document.getElementById('modal-client-frequency').value;
                const visitTime = document.getElementById('modal-client-visit-time').value;

                // Obtener d칤as de visita seleccionados
                const visitDays = Array.from(document.querySelectorAll('input[name="modal-visit-days"]:checked')).map(cb => cb.value);

                // Obtener productos predeterminados seleccionados
                const defaultProducts = Array.from(document.querySelectorAll('input[name="modal-default-product"]:checked')).map(cb => cb.value);

                try {
                    // Verificar si el cliente ya existe
                    const existingClient = db.clients.find(c =>
                        c.name.toLowerCase() === name.toLowerCase() ||
                        (phone && c.phone === phone)
                    );

                    if (existingClient) {
                        alert(`丘멆잺 Ya existe un cliente con ese nombre o tel칠fono.\n\nNombre: ${existingClient.name}\nTel칠fono: ${existingClient.phone || 'Sin tel칠fono'}\n\nSe seleccionar치 el cliente existente.`);

                        // Usar el cliente existente
                        selectedClientData = existingClient;
                        const clientInput = document.getElementById('client-name');
                        const displayName = existingClient.type === 'negocio' && existingClient.businessName ? existingClient.businessName : existingClient.name;
                        clientInput.value = displayName;

                        // Cerrar modal
                        document.getElementById('create-client-modal').classList.add('hidden');
                        modalForm.reset();
                        return;
                    }

                    const newClient = {
                        type,
                        name,
                        businessName: type === 'negocio' ? businessName : '',
                        phone,
                        province,
                        canton,
                        parish,
                        sector,
                        address,
                        location: latitude && longitude ? {
                            latitude: parseFloat(latitude),
                            longitude: parseFloat(longitude)
                        } : null,
                        visitSchedule: {
                            days: visitDays || [],
                            time: visitTime || '',
                            frequency: frequency || ''
                        },
                        defaultProducts: defaultProducts || [],
                        status: 'active',
                        assignedSeller: auth.currentUser.uid,
                        createdBy: auth.currentUser.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    const docRef = await db_firestore.collection('clients').add(newClient);

                    // Guardar referencia al cliente reci칠n creado
                    selectedClientData = { id: docRef.id, ...newClient };

                    // Actualizar el input del m칩dulo de ventas
                    const clientInput = document.getElementById('client-name');
                    const displayName = type === 'negocio' && businessName ? businessName : name;
                    clientInput.value = displayName;

                    // Actualizar el tipo de cliente en ventas
                    const typeRadio = type === 'negocio'
                        ? document.querySelector('input[name="client-type"][value="negocio"]')
                        : document.querySelector('input[name="client-type"][value="consumidor-final"]');
                    if (typeRadio) typeRadio.checked = true;

                    // Actualizar precios si es necesario
                    const searchInput = document.getElementById('product-search-input');
                    if (searchInput) renderProductsDropdown(searchInput.value);

                    alert(`九 Cliente "${name}" creado exitosamente`);
                    closeClientModal();
                } catch (error) {
                    console.error('Error creating client:', error);
                    alert('仇 Error al crear el cliente. Intenta nuevamente.');
                }
            });
        }
    });

    function updateExpenseTypeDropdown() { const select = document.getElementById('expense-category-selector'); if(!select) return; select.innerHTML = '<option value="">Seleccione tipo</option>'; db.expenseTypes.forEach(et => { select.innerHTML += `<option value="${et.id}">${et.name}</option>`; }); }
    // ===== FUNCIONES DE INVENTARIO DE VEH칈CULO =====

    // Bandera para evitar m칰ltiples llamadas simult치neas
    let isPopulatingVehicles = false;

    async function populateOpeningVehicleDropdown() {
        // Evitar llamadas simult치neas
        if (isPopulatingVehicles) {
            console.log('낒勇 Ya se est치 poblando el dropdown, omitiendo...');
            return;
        }

        isPopulatingVehicles = true;

        try {
            const select = document.getElementById('opening-vehicle');
            if (!select) {
                isPopulatingVehicles = false;
                return;
            }

            // Limpiar TODAS las opciones primero
            select.innerHTML = '';

            // Agregar opci칩n por defecto
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Seleccionar veh칤culo...';
            select.appendChild(defaultOption);

            console.log('游뚵 Poblando dropdown de veh칤culos para apertura de caja');
            console.log('Usuario actual:', auth.currentUser?.uid);
            console.log('Total de veh칤culos en db.vehicles:', db.vehicles?.length || 0);

        // Si db.vehicles ya tiene datos, usarlos
        if (db.vehicles && db.vehicles.length > 0) {
            console.log('Veh칤culos disponibles:', db.vehicles.map(v => ({ plate: v.plate, assignedSeller: v.assignedSeller })));
            const myVehicles = db.vehicles.filter(v => v.assignedSeller === auth.currentUser.uid);
            console.log('Veh칤culos asignados a m칤:', myVehicles.length);

            if (myVehicles.length > 0) {
                myVehicles.forEach(vehicle => {
                    const option = document.createElement('option');
                    option.value = vehicle.id;
                    option.textContent = `${vehicle.plate} - ${vehicle.brand}`;
                    option.dataset.maxUnits = vehicle.maxUnits;
                    option.dataset.maxWeight = vehicle.maxWeight;
                    select.appendChild(option);
                });
                console.log('九 Dropdown poblado con', myVehicles.length, 'veh칤culos');
            } else {
                const noVehiclesOption = document.createElement('option');
                noVehiclesOption.value = '';
                noVehiclesOption.textContent = 'No tiene veh칤culos asignados';
                select.appendChild(noVehiclesOption);
                console.log('丘멆잺 No hay veh칤culos asignados a este vendedor');
            }
            isPopulatingVehicles = false;
            return;
        }

        // Si db.vehicles est치 vac칤o, intentar cargar directamente desde Firestore (funcionar치 offline si hay cach칠)
        console.log('낍 db.vehicles vac칤o, consultando Firestore...');
        try {
            const vehiclesSnapshot = await db_firestore.collection('vehicles')
                .where('assignedSeller', '==', auth.currentUser.uid)
                .get();

            console.log('Documentos encontrados en Firestore:', vehiclesSnapshot.size);

            if (!vehiclesSnapshot.empty) {
                vehiclesSnapshot.forEach(doc => {
                    const vehicle = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${vehicle.plate} - ${vehicle.brand}`;
                    option.dataset.maxUnits = vehicle.maxUnits;
                    option.dataset.maxWeight = vehicle.maxWeight;
                    select.appendChild(option);
                });
                console.log('九 Dropdown poblado desde Firestore');
            } else {
                // Si no hay veh칤culos asignados
                select.innerHTML = '<option value="">No tiene veh칤culos asignados</option>';
                console.log('丘멆잺 No se encontraron veh칤culos asignados en Firestore');
            }
        } catch (error) {
            console.error('仇 Error al cargar veh칤culos:', error);
            const errorOption = document.createElement('option');
            errorOption.value = '';
            errorOption.textContent = 'Error al cargar veh칤culos (쯥in conexi칩n?)';
            select.appendChild(errorOption);
        } finally {
            isPopulatingVehicles = false;
        }
        } finally {
            isPopulatingVehicles = false;
        }
    }

    async function loadVehicleInventory(vehicleId) {
        if (!vehicleId) {
            document.getElementById('vehicle-inventory-section').classList.add('hidden');
            return;
        }

        try {
            const inventoryList = document.getElementById('vehicle-inventory-list');
            inventoryList.innerHTML = '';

            const vehicle = db.vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;

            // Mostrar capacidades del veh칤culo
            document.getElementById('vehicle-capacity-max').textContent = vehicle.maxUnits;
            document.getElementById('vehicle-weight-max').textContent = vehicle.maxWeight;

            // Si ya hay caja abierta con este veh칤culo, usar el inventario en memoria
            if (db.cashRegister.isOpen && db.cashRegister.vehicleId === vehicleId && db.cashRegister.vehicleInventory) {
                const productQuantities = {};
                db.cashRegister.vehicleInventory.forEach(item => {
                    productQuantities[item.productId] = item.quantity;
                });

                db.products.forEach(product => {
                    const qty = productQuantities[product.id] || 0;
                    const productDiv = createInventoryItemInput(product, qty);
                    inventoryList.appendChild(productDiv);
                });
            } else {
                // Nueva apertura - mostrar productos con cantidad 0
                db.products.forEach(product => {
                    const productDiv = createInventoryItemInput(product, 0);
                    inventoryList.appendChild(productDiv);
                });
            }

            document.getElementById('vehicle-inventory-section').classList.remove('hidden');
            updateVehicleCapacity();
        } catch (error) {
            console.error('Error al cargar inventario del veh칤culo:', error);
            alert('Error al cargar inventario del veh칤culo');
        }
    }

    function createInventoryItemInput(product, quantity = 0, inventoryDocId = null) {
        const div = document.createElement('div');
        div.className = 'flex items-center gap-3 bg-slate-50 dark:bg-slate-700 p-3 rounded-lg';
        div.dataset.productId = product.id;
        div.dataset.productWeight = product.weight || 0;
        if (inventoryDocId) div.dataset.inventoryDocId = inventoryDocId;

        const categoryLabels = {
            'bidon_lleno': 'Bid칩n Lleno',
            'bidon_vacio': 'Bid칩n Vac칤o',
            'recarga': 'Recarga',
            'equipo': 'Equipo',
            'paca': 'Paca'
        };

        div.innerHTML = `
            <div class="flex-1">
                <div class="font-semibold text-slate-900 dark:text-white">${product.name}</div>
                <div class="text-xs text-slate-500 dark:text-slate-400">
                    ${categoryLabels[product.category] || product.category}  ${product.weight || 0} kg
                    ${product.isReturnable ? '  <span class="text-blue-500">Retornable</span>' : ''}
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button type="button" onclick="changeInventoryQty('${product.id}', -1)" class="bg-red-500 text-white w-8 h-8 rounded-lg hover:bg-red-600 flex items-center justify-center">-</button>
                <input type="number" id="inv-qty-${product.id}" value="${quantity}" min="0" class="w-20 p-2 border-2 rounded-lg text-center dark:bg-slate-600 dark:border-slate-500 dark:text-white" onchange="updateVehicleCapacity()">
                <button type="button" onclick="changeInventoryQty('${product.id}', 1)" class="bg-green-500 text-white w-8 h-8 rounded-lg hover:bg-green-600 flex items-center justify-center">+</button>
            </div>
        `;

        return div;
    }

    function changeInventoryQty(productId, delta) {
        const input = document.getElementById(`inv-qty-${productId}`);
        if (input) {
            const currentQty = parseInt(input.value) || 0;
            const newQty = Math.max(0, currentQty + delta);
            input.value = newQty;
            updateVehicleCapacity();
        }
    }

    function updateVehicleCapacity() {
        const inventoryList = document.getElementById('vehicle-inventory-list');
        if (!inventoryList) return;

        let totalUnits = 0;
        let totalWeight = 0;

        const items = inventoryList.querySelectorAll('[data-product-id]');
        items.forEach(item => {
            const productId = item.dataset.productId;
            const productWeight = parseFloat(item.dataset.productWeight) || 0;
            const input = document.getElementById(`inv-qty-${productId}`);
            const qty = parseInt(input.value) || 0;

            totalUnits += qty;
            totalWeight += qty * productWeight;
        });

        document.getElementById('vehicle-capacity-used').textContent = totalUnits;
        document.getElementById('vehicle-weight-used').textContent = totalWeight.toFixed(2);

        // Validar capacidad
        const maxUnits = parseInt(document.getElementById('vehicle-capacity-max').textContent) || 0;
        const maxWeight = parseFloat(document.getElementById('vehicle-weight-max').textContent) || 0;

        const capacityUsedSpan = document.getElementById('vehicle-capacity-used');
        const weightUsedSpan = document.getElementById('vehicle-weight-used');

        if (totalUnits > maxUnits) {
            capacityUsedSpan.classList.add('text-red-600');
            capacityUsedSpan.classList.remove('text-blue-600');
        } else {
            capacityUsedSpan.classList.remove('text-red-600');
            capacityUsedSpan.classList.add('text-blue-600');
        }

        if (totalWeight > maxWeight) {
            weightUsedSpan.classList.add('text-red-600');
            weightUsedSpan.classList.remove('text-blue-600');
        } else {
            weightUsedSpan.classList.remove('text-red-600');
            weightUsedSpan.classList.add('text-blue-600');
        }
    }

    // Event listener para cuando cambie el veh칤culo seleccionado
    document.addEventListener('DOMContentLoaded', function() {
        const vehicleSelect = document.getElementById('opening-vehicle');
        if (vehicleSelect) {
            vehicleSelect.addEventListener('change', function(e) {
                loadVehicleInventory(e.target.value);
            });
        }
    });

    // ===== APERTURA DE CAJA CON VEH칈CULO E INVENTARIO =====

    document.getElementById('open-cash-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const balance = parseFloat(document.getElementById('opening-balance').value);
        const vehicleId = document.getElementById('opening-vehicle').value;
        const openingKm = parseInt(document.getElementById('opening-km').value) || 0;

        if (!vehicleId) {
            alert('仇 Debe seleccionar un veh칤culo');
            return;
        }

        if (isNaN(balance)) {
            alert('仇 El monto inicial es inv치lido');
            return;
        }

        // Validar capacidad del veh칤culo
        const maxUnits = parseInt(document.getElementById('vehicle-capacity-max').textContent) || 0;
        const maxWeight = parseFloat(document.getElementById('vehicle-weight-max').textContent) || 0;
        const usedUnits = parseInt(document.getElementById('vehicle-capacity-used').textContent) || 0;
        const usedWeight = parseFloat(document.getElementById('vehicle-weight-used').textContent) || 0;

        if (usedUnits > maxUnits) {
            alert(`仇 La cantidad de unidades (${usedUnits}) excede la capacidad del veh칤culo (${maxUnits})`);
            return;
        }

        if (usedWeight > maxWeight) {
            alert(`仇 El peso total (${usedWeight} kg) excede la capacidad del veh칤culo (${maxWeight} kg)`);
            return;
        }

        try {
            const vehicle = db.vehicles.find(v => v.id === vehicleId);

            // Recopilar inventario inicial
            const inventory = [];
            const inventoryList = document.getElementById('vehicle-inventory-list');
            const items = inventoryList.querySelectorAll('[data-product-id]');

            items.forEach(item => {
                const productId = item.dataset.productId;
                const input = document.getElementById(`inv-qty-${productId}`);
                const qty = parseInt(input.value) || 0;

                if (qty > 0) {
                    inventory.push({
                        productId: productId,
                        quantity: qty
                    });
                }
            });

            // Crear sesi칩n de caja en Firestore
            const sessionData = {
                sellerId: auth.currentUser.uid,
                vehicleId: vehicleId,
                vehiclePlate: vehicle ? vehicle.plate : '',
                isOpen: true,
                openingBalance: balance,
                openingKm: openingKm,
                openingInventory: inventory,
                openedAt: firebase.firestore.FieldValue.serverTimestamp(),
                date: getCurrentDate()
            };

            const sessionRef = await db_firestore.collection('cash_sessions').add(sessionData);

            // Actualizar inventario del veh칤culo en Firestore
            const batch = db_firestore.batch();

            // Intentar eliminar inventario anterior del veh칤culo para evitar duplicados
            // Esto funciona tanto online como offline gracias a Firestore persistence
            try {
                const oldInventorySnapshot = await db_firestore.collection('vehicle_inventory')
                    .where('vehicleId', '==', vehicleId)
                    .get();

                // Eliminar documentos de inventario anteriores
                oldInventorySnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                console.log(`游딈勇 Eliminando ${oldInventorySnapshot.size} documentos de inventario anterior`);
            } catch (deleteError) {
                // Si falla la eliminaci칩n (ej: primer uso offline), continuar sin eliminar
                console.warn('No se pudo eliminar inventario anterior, continuando...', deleteError);
            }

            // Crear nuevos documentos de inventario con el sessionId actual
            inventory.forEach(item => {
                const invRef = db_firestore.collection('vehicle_inventory').doc();
                batch.set(invRef, {
                    vehicleId: vehicleId,
                    productId: item.productId,
                    quantity: item.quantity,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    sessionId: sessionRef.id
                });
            });

            await batch.commit();

            db.cashRegister = {
                sessionId: sessionRef.id,
                isOpen: true,
                openingBalance: balance,
                vehicleId: vehicleId,
                vehiclePlate: vehicle ? vehicle.plate : '',
                openingKm: openingKm,
                vehicleInventory: inventory,
                transactions: []
            };

            saveCashRegisterToStorage();
            checkCashRegisterStatus();
            updateSellerDashboard();

            // Iniciar listener de inventario en tiempo real
            startVehicleInventoryListener(sessionRef.id);

            if (navigator.onLine) {
                alert('九 Caja abierta exitosamente');
            } else {
                alert('九 Caja abierta en modo offline. Los datos se sincronizar치n cuando haya conexi칩n.');
            }
        } catch (error) {
            console.error('Error al abrir caja:', error);

            // Si estamos offline, intentar abrir caja localmente
            if (!navigator.onLine || error.code === 'unavailable') {
                // Generar ID temporal para la sesi칩n
                const tempSessionId = 'temp_' + Date.now();

                db.cashRegister = {
                    sessionId: tempSessionId,
                    isOpen: true,
                    openingBalance: balance,
                    vehicleId: vehicleId,
                    vehiclePlate: vehicle ? vehicle.plate : '',
                    openingKm: openingKm,
                    vehicleInventory: inventory,
                    transactions: [],
                    pendingSync: true // Marcar como pendiente de sincronizaci칩n
                };

                saveCashRegisterToStorage();
                checkCashRegisterStatus();
                updateSellerDashboard();

                alert('九 Caja abierta en modo offline. Los datos se guardar치n cuando recupere la conexi칩n.');
            } else {
                alert('仇 Error al abrir caja: ' + error.message);
            }
        }
    });

    // --- Funciones de persistencia de caja ---
    function saveCashRegisterToStorage() {
        if (auth.currentUser) {
            localStorage.setItem(`cashRegister_${auth.currentUser.uid}`, JSON.stringify(db.cashRegister));
        }
    }

    async function loadCashRegisterFromStorage() {
        if (!auth.currentUser) return;

        try {
            // Primero verificar si hay una sesi칩n activa en Firestore
            const sessionsSnapshot = await db_firestore.collection('cash_sessions')
                .where('sellerId', '==', auth.currentUser.uid)
                .where('isOpen', '==', true)
                .where('date', '==', getCurrentDate())
                .limit(1)
                .get();

            if (!sessionsSnapshot.empty) {
                // Hay una sesi칩n activa en Firestore
                const sessionDoc = sessionsSnapshot.docs[0];
                const sessionData = sessionDoc.data();

                // Cargar inventario del veh칤culo desde Firestore
                let vehicleInventory = [];
                if (sessionData.vehicleId) {
                    const inventorySnapshot = await db_firestore.collection('vehicle_inventory')
                        .where('vehicleId', '==', sessionData.vehicleId)
                        .where('sessionId', '==', sessionDoc.id)
                        .get();

                    vehicleInventory = inventorySnapshot.docs.map(doc => ({
                        productId: doc.data().productId,
                        quantity: doc.data().quantity
                    }));
                }

                db.cashRegister = {
                    sessionId: sessionDoc.id,
                    isOpen: true,
                    openingBalance: sessionData.openingBalance,
                    vehicleId: sessionData.vehicleId || null,
                    vehiclePlate: sessionData.vehiclePlate || null,
                    openingKm: sessionData.openingKm || 0,
                    vehicleInventory: vehicleInventory,
                    transactions: []
                };

                saveCashRegisterToStorage();

                // Iniciar listener de inventario en tiempo real
                startVehicleInventoryListener(sessionDoc.id);

                console.log('九 Caja cargada desde Firestore:', sessionDoc.id);
            } else {
                // No hay sesi칩n en Firestore, intentar cargar de localStorage
                const savedState = localStorage.getItem(`cashRegister_${auth.currentUser.uid}`);
                if (savedState) {
                    const localSession = JSON.parse(savedState);
                    // Verificar si la sesi칩n local es del d칤a actual
                    if (localSession.isOpen) {
                        // Verificar en Firestore si la sesi칩n sigue activa
                        if (localSession.sessionId) {
                            const sessionDoc = await db_firestore.collection('cash_sessions').doc(localSession.sessionId).get();
                            if (sessionDoc.exists && sessionDoc.data().isOpen) {
                                db.cashRegister = localSession;

                                // Iniciar listener de inventario en tiempo real
                                startVehicleInventoryListener(localSession.sessionId);

                                console.log('九 Caja cargada desde localStorage:', localSession.sessionId);
                            } else {
                                // La sesi칩n no existe o est치 cerrada
                                db.cashRegister = { isOpen: false, openingBalance: 0, transactions: [] };
                                localStorage.removeItem(`cashRegister_${auth.currentUser.uid}`);
                            }
                        }
                    }
                }
            }
        } catch (error) {
            console.error('Error al cargar estado de caja:', error);
            // En caso de error, intentar cargar desde localStorage
            const savedState = localStorage.getItem(`cashRegister_${auth.currentUser.uid}`);
            if (savedState) {
                db.cashRegister = JSON.parse(savedState);
            }
        }

        // Actualizar la interfaz despu칠s de cargar
        setTimeout(() => {
            checkCashRegisterStatus();
        }, 500);
    }

    function updateCashClosureSummary() {
        const el = document.getElementById('closure-opening-balance');
        if (!el) return;

        if (!db.cashRegister.isOpen) {
            el.textContent = '$0.00';
            return;
        }

        const { openingBalance, transactions } = db.cashRegister;

        // Estad칤sticas del d칤a - OBTENER PRIMERO las ventas del d칤a
        const todaySales = db.sales.filter(s => s.date === getCurrentDate() && s.sellerId === auth.currentUser.uid);
        const todayExpenses = db.expenses.filter(e => e.date === getCurrentDate() && e.sellerId === auth.currentUser.uid);
        const todayCollections = db.collections.filter(c => c.date === getCurrentDate() && c.sellerId === auth.currentUser.uid);

        // Calcular totales por m칠todo de pago desde db.sales (TODAS las ventas del d칤a)
        const cashSales = todaySales.filter(s => s.paymentMethod === 'efectivo').reduce((sum, s) => sum + s.total, 0);
        const creditSales = todaySales.filter(s => s.paymentMethod === 'credito').reduce((sum, s) => sum + s.total, 0);
        const transferSales = todaySales.filter(s => s.paymentMethod === 'transferencia').reduce((sum, s) => sum + s.total, 0);

        // CORRECCI칍N: Gastos y cobros deben calcularse desde los datos del d칤a, no de 'transactions'
        const cashExpenses = todayExpenses.filter(e => e.paymentMethod === 'efectivo').reduce((sum, e) => sum + e.amount, 0);
        const collections = todayCollections.reduce((sum, c) => sum + c.amount, 0);

        const expected = openingBalance + cashSales + collections - cashExpenses;
        const totalDay = cashSales + creditSales + transferSales;

        const totalItems = todaySales.reduce((sum, sale) => {
            return sum + sale.items.reduce((itemSum, item) => itemSum + item.quantity, 0);
        }, 0);

        const totalExpensesAmount = todayExpenses.reduce((sum, e) => sum + e.amount, 0);
        const balance = totalDay - totalExpensesAmount;

        // Cargar informaci칩n de meta diaria
        loadClosureDailyGoal(todaySales);

        // Renderizar Top Productos
        renderClosureTopProducts(todaySales);

        // Cargar inventario para cierre
        loadClosingInventory();

        // Actualizar UI de Cierre
        el.textContent = `$${openingBalance.toFixed(2)}`;
        document.getElementById('closure-cash-sales').textContent = `$${cashSales.toFixed(2)}`;
        document.getElementById('closure-collections').textContent = `$${collections.toFixed(2)}`;
        document.getElementById('closure-cash-expenses').textContent = `$${cashExpenses.toFixed(2)}`;
        document.getElementById('closure-expected-cash').textContent = `$${expected.toFixed(2)}`;
        document.getElementById('closure-credit-sales').textContent = `$${creditSales.toFixed(2)}`;
        document.getElementById('closure-transfer-sales').textContent = `$${transferSales.toFixed(2)}`;

        // Total general del d칤a
        const totalDayEl = document.getElementById('closure-total-day');
        if (totalDayEl) totalDayEl.textContent = `$${totalDay.toFixed(2)}`;

        // Estad칤sticas
        const statsSales = document.getElementById('stats-total-sales');
        if (statsSales) statsSales.textContent = todaySales.length;

        const statsItems = document.getElementById('stats-total-items');
        if (statsItems) statsItems.textContent = totalItems;

        const statsExpenses = document.getElementById('stats-total-expenses');
        if (statsExpenses) statsExpenses.textContent = todayExpenses.length;

        const statsCollections = document.getElementById('stats-total-collections');
        if (statsCollections) statsCollections.textContent = todayCollections.length;
    }

    async function loadClosureDailyGoal(todaySales) {
        const goalContent = document.getElementById('closure-daily-goal-content');
        if (!goalContent) return;

        try {
            const currentDate = getCurrentDate();
            const [year, month] = currentDate.split('-');
            const monthKey = `${year}-${month}`;

            // Buscar meta del vendedor para el mes actual
            const goalSnapshot = await db_firestore.collection('sales_goals')
                .where('sellerId', '==', auth.currentUser.uid)
                .where('month', '==', monthKey)
                .get();

            if (goalSnapshot.empty) {
                goalContent.innerHTML = `
                    <div class="text-center py-4 opacity-90">
                        <div class="text-sm">No hay meta asignada para este mes</div>
                        <div class="text-xs mt-2 opacity-75">Consulta con tu administrador para asignar una meta</div>
                    </div>
                `;
                return;
            }

            const goal = goalSnapshot.docs[0].data();

            // Calcular meta diaria
            const lastDay = new Date(parseInt(year), parseInt(month), 0).getDate();
            const dailyGoal = goal.goalAmount / lastDay;

            // Calcular total de ventas del d칤a (todas las formas de pago)
            const totalDaySales = todaySales.reduce((sum, s) => sum + s.total, 0);

            // Calcular porcentaje de cumplimiento del d칤a
            const dailyPercentage = (totalDaySales / dailyGoal) * 100;

            // Determinar color y estado seg칰n cumplimiento
            let statusColor, statusIcon, statusText, progressColor;
            if (dailyPercentage >= 100) {
                statusColor = 'text-green-200';
                statusIcon = '九';
                statusText = '춰Meta diaria alcanzada!';
                progressColor = 'bg-green-400';
            } else if (dailyPercentage >= 75) {
                statusColor = 'text-yellow-200';
                statusIcon = '丘';
                statusText = 'Cerca de la meta';
                progressColor = 'bg-yellow-400';
            } else if (dailyPercentage >= 50) {
                statusColor = 'text-blue-200';
                statusIcon = '游늳';
                statusText = 'Buen avance';
                progressColor = 'bg-blue-400';
            } else {
                statusColor = 'text-orange-200';
                statusIcon = '丘멆잺';
                statusText = 'Por debajo de la meta';
                progressColor = 'bg-orange-400';
            }

            const remaining = Math.max(0, dailyGoal - totalDaySales);

            goalContent.innerHTML = `
                <!-- Barra de progreso -->
                <div class="w-full bg-white/30 rounded-full h-4 mb-4">
                    <div class="${progressColor} h-4 rounded-full transition-all duration-500" style="width: ${Math.min(dailyPercentage, 100)}%"></div>
                </div>

                <!-- Porcentaje -->
                <div class="text-center mb-4">
                    <div class="text-4xl font-extrabold">${dailyPercentage.toFixed(0)}%</div>
                    <div class="text-sm opacity-90 mt-1">${statusIcon} ${statusText}</div>
                </div>

                <!-- Valores -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white/20 backdrop-blur-sm p-3 rounded-lg">
                        <div class="text-xs opacity-90 mb-1">Meta del D칤a</div>
                        <div class="text-xl font-bold">$${dailyGoal.toFixed(2)}</div>
                    </div>
                    <div class="bg-white/20 backdrop-blur-sm p-3 rounded-lg">
                        <div class="text-xs opacity-90 mb-1">Vendido Hoy</div>
                        <div class="text-xl font-bold">$${totalDaySales.toFixed(2)}</div>
                    </div>
                    <div class="bg-white/20 backdrop-blur-sm p-3 rounded-lg">
                        <div class="text-xs opacity-90 mb-1">Falta por Vender</div>
                        <div class="text-xl font-bold ${remaining > 0 ? 'text-orange-200' : 'text-green-200'}">$${remaining.toFixed(2)}</div>
                    </div>
                    <div class="bg-white/20 backdrop-blur-sm p-3 rounded-lg">
                        <div class="text-xs opacity-90 mb-1">Total Ventas</div>
                        <div class="text-xl font-bold">${todaySales.length}</div>
                    </div>
                </div>
            `;
        } catch (error) {
            console.error('Error al cargar meta diaria en cierre de caja:', error);
            goalContent.innerHTML = `
                <div class="text-center py-4 opacity-90">
                    <div class="text-sm">Error al cargar informaci칩n de meta</div>
                </div>
            `;
        }
    }

    function renderClosureTopProducts(todaySales) {
        const container = document.getElementById('closure-top-products');
        if (!container) return;

        // Agrupar productos y contar cantidades
        const productStats = {};
        todaySales.forEach(sale => {
            sale.items.forEach(item => {
                if (!productStats[item.productId]) {
                    productStats[item.productId] = {
                        name: item.name,
                        quantity: 0,
                        revenue: 0
                    };
                }
                productStats[item.productId].quantity += item.quantity;
                productStats[item.productId].revenue += item.total;
            });
        });

        // Convertir a array y ordenar por cantidad
        const topProducts = Object.values(productStats)
            .sort((a, b) => b.quantity - a.quantity)
            .slice(0, 3);

        if (topProducts.length === 0) {
            container.innerHTML = '<p class="text-center text-slate-500 dark:text-slate-400 py-4 text-sm">No hay productos vendidos</p>';
            return;
        }

        const maxQuantity = topProducts[0].quantity;

        container.innerHTML = topProducts.map((product, index) => {
            const percentage = (product.quantity / maxQuantity) * 100;
            const medals = ['游볞', '游볟', '游볠'];
            const medal = medals[index];

            return `<div class="flex items-center gap-3 p-2 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                <span class="text-2xl">${medal}</span>
                <div class="flex-1">
                    <div class="font-semibold text-sm text-slate-700 dark:text-slate-300">${product.name}</div>
                    <div class="flex items-center gap-2">
                        <div class="flex-1 bg-slate-200 dark:bg-slate-600 rounded-full h-1.5">
                            <div class="bg-green-600 h-1.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <span class="text-xs text-slate-600 dark:text-slate-400">${product.quantity} uds</span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="font-bold text-green-600 dark:text-green-400 text-sm">$${product.revenue.toFixed(2)}</div>
                </div>
            </div>`;
        }).join('');
    }
    
    function checkCashRegisterStatus() {
        const openView = document.getElementById('open-cash-view');
        if (!openView) return;

        const openedView = document.getElementById('cash-opened-view');
        const menuButtons = document.querySelectorAll('#seller-menu button:not([data-target="seller-cash"]):not([data-target="seller-reports"]):not([data-target="seller-goals"])');
        const closeCashButton = document.getElementById('btn-close-cash');

        if (db.cashRegister.isOpen) {
            openView.classList.add('hidden');
            openedView.classList.remove('hidden');

            // Mostrar informaci칩n de apertura
            document.getElementById('display-opening-balance').textContent = `$${db.cashRegister.openingBalance.toFixed(2)}`;

            const displayVehicle = document.getElementById('display-vehicle');
            if (displayVehicle) {
                displayVehicle.textContent = db.cashRegister.vehiclePlate || 'N/A';
            }

            const displayKm = document.getElementById('display-km');
            if (displayKm) {
                displayKm.textContent = db.cashRegister.openingKm || '0';
            }

            menuButtons.forEach(btn => btn.disabled = false);
            if (closeCashButton) closeCashButton.disabled = false;
        } else {
            openView.classList.remove('hidden');
            openedView.classList.add('hidden');
            menuButtons.forEach(btn => btn.disabled = true);
            if (closeCashButton) closeCashButton.disabled = true;

            // Poblar dropdown de veh칤culos cuando se muestre el formulario
            populateOpeningVehicleDropdown();
        }

        updateCashClosureSummary();
        updateSellerDashboard();
        saveCashRegisterToStorage();
    }
    function setupSaleFormListeners() {
        document.getElementById('add-to-cart-btn').addEventListener('click', addProductToSale);
        document.getElementById('sale-form').addEventListener('submit', finalizeSale);
        document.getElementById('sale-payment-method').addEventListener('change', (e) => {
            const noteField = document.getElementById('sale-transfer-note');
            const paymentMethod = e.target.value;

            if (paymentMethod === 'transferencia') {
                noteField.classList.remove('hidden');
                noteField.placeholder = 'Nota de transferencia / referencia';
            } else if (paymentMethod === 'credito') {
                noteField.classList.remove('hidden');
                noteField.placeholder = 'Observaci칩n del cr칠dito (plazo, condiciones, etc.)';
            } else {
                noteField.classList.add('hidden');
                noteField.value = '';
            }
        });
        document.getElementById('client-type-selector').addEventListener('change', () => {
            if (currentSaleItems.length > 0) {
                alert('Cambiar el tipo de cliente vaciar치 el carrito actual para recalcular precios.');
                currentSaleItems = [];
                renderCurrentSaleTable();
            }
            // Actualizar los precios en el dropdown
            const searchInput = document.getElementById('product-search-input');
            renderProductsDropdown(searchInput.value);
        });
        document.getElementById('add-payment-form').addEventListener('submit', finalizePayment);

        // Event listener para el bot칩n de escanear QR
        const scanQrBtn = document.getElementById('scan-qr-btn');
        if (scanQrBtn) {
            scanQrBtn.addEventListener('click', openQRScanner);
        }

        // Event listener para cuando se selecciona un cliente manualmente
        const clientSelect = document.getElementById('sale-client');
        if (clientSelect) {
            clientSelect.addEventListener('change', (e) => {
                if (e.target.value) {
                    loadClientDefaultProducts(e.target.value);
                }
            });
        }
    }
    function addProductToSale() {
        const productId = selectedProductId;
        const quantity = parseInt(document.getElementById('sale-quantity').value);
        const product = db.products.find(p => p.id === productId);

        if(product && quantity > 0) {
            const clientType = document.querySelector('input[name="client-type"]:checked').value;
            const price = (clientType === 'negocio') ? product.priceBusiness : product.priceNormal;
            currentSaleItems.push({
                productId: product.id,
                name: product.name,
                quantity,
                price,
                basePrice: price,
                total: price * quantity
            });
            renderCurrentSaleTable();

            // Limpiar el input y resetear selecci칩n
            document.getElementById('product-search-input').value = '';
            selectedProductId = null;
            document.getElementById('sale-quantity').value = '1';
            document.getElementById('product-search-input').focus();
        } else {
            alert('Seleccione un producto y cantidad v치lida.');
        }
    }
    function renderCurrentSaleTable() {
        const container = document.getElementById('current-sale-table');
        const totalEl = document.getElementById('current-sale-total');
        const cartCount = document.getElementById('cart-count');
        container.innerHTML = '';
        let total = 0;

        if (currentSaleItems.length === 0) {
            container.innerHTML = `<div class="text-center py-6 px-3 text-slate-500 dark:text-slate-400">
                <svg class="w-10 h-10 mx-auto mb-1 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                </svg>
                <p class="text-xs">Vac칤o</p>
            </div>`;
            totalEl.textContent = '$0.00';
            cartCount.classList.add('hidden');
            return;
        }

        // Mostrar contador de items
        cartCount.textContent = currentSaleItems.length;
        cartCount.classList.remove('hidden');

        currentSaleItems.forEach((item, index) => {
            // Validar que price y total existan y sean n칰meros
            const price = (item.price !== undefined && item.price !== null && !isNaN(item.price)) ? parseFloat(item.price) : 0;
            const itemTotal = (item.total !== undefined && item.total !== null && !isNaN(item.total)) ? parseFloat(item.total) : 0;

            total += itemTotal;
            container.innerHTML += `
                <div class="p-2 hover:bg-slate-50 dark:hover:bg-slate-700/30 transition">
                    <div class="flex items-center justify-between gap-2">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-200 px-1.5 py-0.5 rounded text-xs font-bold">${item.quantity}x</span>
                                <h4 class="font-medium text-xs sm:text-sm text-slate-800 dark:text-slate-200 truncate">${item.name}</h4>
                            </div>
                            <div class="flex items-center gap-1 mt-0.5 text-xs text-slate-600 dark:text-slate-400">
                                <span>$</span>
                                <input type="number" class="price-input w-12 text-right bg-transparent border-0 border-b border-slate-300 dark:border-slate-600 focus:border-blue-500 p-0 text-xs" value="${price.toFixed(2)}" step="0.01" onchange="updateSaleItemPrice(${index}, this.value)">
                                <span class="text-slate-400">c/u</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="font-bold text-sm text-green-600 dark:text-green-400 whitespace-nowrap">$${itemTotal.toFixed(2)}</span>
                            <button type="button" onclick="removeSaleItem(${index})" class="bg-red-100 active:bg-red-200 dark:bg-red-900 dark:active:bg-red-800 text-red-600 dark:text-red-400 w-6 h-6 rounded-full transition font-bold text-xs flex-shrink-0">九</button>
                        </div>
                    </div>
                </div>`;
        });
        totalEl.textContent = `$${total.toFixed(2)}`;

        // Verificar autom치ticamente si hay bidones sin devolver
        checkUnreturnedContainers();
    }

    function clearSaleCart() {
        if (currentSaleItems.length === 0) return;
        if (confirm('쮼st치 seguro de que desea limpiar el carrito?')) {
            currentSaleItems = [];
            renderCurrentSaleTable();
        }
    }

    function renderTodaySales() {
        const todaySales = db.sales.filter(s => s.date === getCurrentDate() && s.sellerId === auth.currentUser.uid);

        // Actualizar resumen del d칤a
        updateTodaySummary(todaySales);

        // Renderizar lista de ventas
        renderTodaySalesList(todaySales);

        // Renderizar productos m치s vendidos
        renderTopProducts(todaySales);
    }

    function updateTodaySummary(todaySales) {
        const totalSales = todaySales.reduce((sum, s) => sum + s.total, 0);
        const cashSales = todaySales.filter(s => s.paymentMethod === 'efectivo').reduce((sum, s) => sum + s.total, 0);
        const transferSales = todaySales.filter(s => s.paymentMethod === 'transferencia').reduce((sum, s) => sum + s.total, 0);
        const creditSales = todaySales.filter(s => s.paymentMethod === 'credito').reduce((sum, s) => sum + s.total, 0);

        document.getElementById('today-total-sales').textContent = `$${totalSales.toFixed(2)}`;
        document.getElementById('today-sales-count').textContent = `${todaySales.length} ${todaySales.length === 1 ? 'venta' : 'ventas'}`;
        document.getElementById('today-cash-sales').textContent = `$${cashSales.toFixed(2)}`;
        document.getElementById('today-transfer-sales').textContent = `$${transferSales.toFixed(2)}`;
        document.getElementById('today-credit-sales').textContent = `$${creditSales.toFixed(2)}`;
    }

    function renderTodaySalesList(allSales = null) {
        const container = document.getElementById('today-sales-list');
        if (!container) return;

        const filter = document.getElementById('today-payment-filter')?.value || '';
        const todaySales = allSales || db.sales.filter(s => s.date === getCurrentDate() && s.sellerId === auth.currentUser.uid);
        const filteredSales = filter ? todaySales.filter(s => s.paymentMethod === filter) : todaySales;

        if (filteredSales.length === 0) {
            container.innerHTML = '<p class="text-center text-slate-500 dark:text-slate-400 py-6 text-sm">No hay ventas registradas</p>';
            return;
        }

        const paymentIcons = {
            'efectivo': '游눳',
            'transferencia': '游낁',
            'credito': '游늶'
        };
        const paymentColors = {
            'efectivo': 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300',
            'transferencia': 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300',
            'credito': 'bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300'
        };

        container.innerHTML = filteredSales.slice(-10).reverse().map(sale => {
            return `<div class="bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg border border-slate-200 dark:border-slate-600">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <div class="font-semibold text-sm text-slate-700 dark:text-slate-300">${sale.clientName || 'Cliente General'}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">${sale.items.length} producto(s)</div>
                    </div>
                    <span class="text-lg font-bold text-green-600 dark:text-green-400">$${sale.total.toFixed(2)}</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs ${paymentColors[sale.paymentMethod]} px-2 py-1 rounded-full font-medium">${paymentIcons[sale.paymentMethod]} ${sale.paymentMethod}</span>
                    <span class="text-xs text-slate-500 dark:text-slate-400">${new Date(sale.timestamp?.toDate ? sale.timestamp.toDate() : sale.timestamp).toLocaleTimeString()}</span>
                </div>
            </div>`;
        }).join('');
    }

    function renderTopProducts(todaySales) {
        const container = document.getElementById('top-products-today');
        if (!container) return;

        // Agrupar productos y contar cantidades
        const productStats = {};
        todaySales.forEach(sale => {
            sale.items.forEach(item => {
                if (!productStats[item.productId]) {
                    productStats[item.productId] = {
                        name: item.name,
                        quantity: 0,
                        revenue: 0
                    };
                }
                productStats[item.productId].quantity += item.quantity;
                productStats[item.productId].revenue += item.total;
            });
        });

        // Convertir a array y ordenar por cantidad
        const topProducts = Object.values(productStats)
            .sort((a, b) => b.quantity - a.quantity)
            .slice(0, 5);

        if (topProducts.length === 0) {
            container.innerHTML = '<p class="text-center text-slate-500 dark:text-slate-400 py-4 text-sm">No hay datos disponibles</p>';
            return;
        }

        const maxQuantity = topProducts[0].quantity;

        container.innerHTML = topProducts.map((product, index) => {
            const percentage = (product.quantity / maxQuantity) * 100;
            const medals = ['游볞', '游볟', '游볠'];
            const medal = medals[index] || '游닍';

            return `<div class="bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg border border-slate-200 dark:border-slate-600">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">${medal}</span>
                        <div>
                            <div class="font-semibold text-sm text-slate-700 dark:text-slate-300">${product.name}</div>
                            <div class="text-xs text-slate-500 dark:text-slate-400">${product.quantity} unidades vendidas</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-green-600 dark:text-green-400">$${product.revenue.toFixed(2)}</div>
                    </div>
                </div>
                <div class="w-full bg-slate-200 dark:bg-slate-600 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                </div>
            </div>`;
        }).join('');
    }

    // Listener para el filtro de pagos de hoy
    document.addEventListener('DOMContentLoaded', () => {
        const filterElement = document.getElementById('today-payment-filter');
        if (filterElement) {
            filterElement.addEventListener('change', () => {
                renderTodaySalesList();
            });
        }
    });

    function updateSaleItemPrice(index, newPriceStr) { const item = currentSaleItems[index]; const newPrice = parseFloat(newPriceStr); if (isNaN(newPrice) || newPrice < item.basePrice) { alert(`El precio no puede ser menor a $${item.basePrice.toFixed(2)}`); renderCurrentSaleTable(); return; } item.price = newPrice; item.total = newPrice * item.quantity; renderCurrentSaleTable(); }
    function removeSaleItem(index) { currentSaleItems.splice(index, 1); renderCurrentSaleTable(); }
    // ===== FUNCIONES DE GESTI칍N DE BIDONES RETORNABLES =====

    let currentSelectedClient = null; // Variable global para trackear cliente seleccionado

    function changeReturnedContainers(delta) {
        const input = document.getElementById('returned-containers');
        if (input) {
            const currentQty = parseInt(input.value) || 0;
            const newQty = Math.max(0, currentQty + delta);
            input.value = newQty;
            checkUnreturnedContainers(); // Verificar despu칠s de cambiar
        }
    }

    // Nueva funci칩n: Detectar bidones sin devolver autom치ticamente
    function checkUnreturnedContainers() {
        const returnedQty = parseInt(document.getElementById('returned-containers')?.value) || 0;

        // Contar cu치ntos bidones de recarga hay en el carrito
        let refillCount = 0;
        currentSaleItems.forEach(item => {
            const productName = item.name.toUpperCase();
            // Detectar si es una recarga (BCL, BSL, etc.)
            if (productName.includes('RECARGA') || productName.includes('BCL') || productName.includes('BSL')) {
                refillCount += item.quantity;
            }
        });

        // Si hay recargas pero NO devuelve suficientes bidones
        const unreturnedCount = Math.max(0, refillCount - returnedQty);

        const section = document.getElementById('unreturned-containers-section');
        const countSpan = document.getElementById('unreturned-count');

        if (unreturnedCount > 0) {
            // Mostrar secci칩n
            section?.classList.remove('hidden');
            if (countSpan) countSpan.textContent = unreturnedCount;

            // Sugerir fecha (7 d칤as desde hoy)
            const suggestedDate = new Date();
            suggestedDate.setDate(suggestedDate.getDate() + 7);
            const dateInput = document.getElementById('unreturned-return-date');
            if (dateInput && !dateInput.value) {
                dateInput.value = suggestedDate.toISOString().split('T')[0];
            }
        } else {
            // Ocultar secci칩n si no hay bidones sin devolver
            section?.classList.add('hidden');
        }
    }

    // Nueva funci칩n: Manejar checkbox de comodato
    function toggleUnreturnedComodato() {
        const checkbox = document.getElementById('unreturned-is-comodato');
        const dateInput = document.getElementById('unreturned-return-date');

        if (checkbox?.checked) {
            // Si es comodato, deshabilitar fecha
            if (dateInput) {
                dateInput.disabled = true;
                dateInput.classList.add('opacity-50', 'cursor-not-allowed');
            }
        } else {
            // Si no es comodato, habilitar fecha
            if (dateInput) {
                dateInput.disabled = false;
                dateInput.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
    }

    function changeLoanedContainers(delta) {
        const input = document.getElementById('loan-containers');
        if (input) {
            const currentQty = parseInt(input.value) || 0;
            const newQty = Math.max(0, currentQty + delta);
            input.value = newQty;
            validateLoanLimit();
        }
    }

    async function validateLoanLimit() {
        const loanInput = document.getElementById('loan-containers');
        const loanQty = parseInt(loanInput?.value) || 0;
        const warningDiv = document.getElementById('loan-limit-warning');
        const messageSpan = document.getElementById('loan-limit-message');

        if (!currentSelectedClient || loanQty === 0) {
            warningDiv?.classList.add('hidden');
            return true;
        }

        try {
            // Obtener datos del cliente
            const clientDoc = await db_firestore.collection('clients').doc(currentSelectedClient).get();
            if (!clientDoc.exists) {
                return true;
            }

            const clientData = clientDoc.data();
            const clientType = clientData.type || 'consumidor-final';

            // Obtener bidones actualmente prestados al cliente
            const loansSnapshot = await db_firestore.collection('loaned_containers')
                .where('clientId', '==', currentSelectedClient)
                .where('status', '==', 'active')
                .get();

            const currentLoans = loansSnapshot.docs.reduce((sum, doc) => sum + (doc.data().quantity || 0), 0);

            // Determinar l칤mite seg칰n tipo de cliente
            const limit = clientType === 'negocio' ? 10 : 2;
            const totalAfterLoan = currentLoans + loanQty;

            if (totalAfterLoan > limit) {
                warningDiv?.classList.remove('hidden');
                messageSpan.textContent = `El cliente ya tiene ${currentLoans} bid칩n(es) prestado(s). L칤mite para ${clientType === 'negocio' ? 'negocios' : 'particulares'}: ${limit}`;
                return false;
            } else {
                warningDiv?.classList.add('hidden');
                return true;
            }
        } catch (error) {
            console.error('Error validando l칤mite de pr칠stamo:', error);
            return true; // En caso de error, permitir la operaci칩n
        }
    }

    async function loadClientLoanedContainers(clientId) {
        if (!clientId) {
            document.getElementById('client-loaned-containers-info')?.classList.add('hidden');
            currentSelectedClient = null;
            return;
        }

        currentSelectedClient = clientId;

        try {
            // Obtener bidones prestados activos del cliente
            const loansSnapshot = await db_firestore.collection('loaned_containers')
                .where('clientId', '==', clientId)
                .where('status', '==', 'active')
                .get();

            const totalLoaned = loansSnapshot.docs.reduce((sum, doc) => sum + (doc.data().quantity || 0), 0);

            const infoDiv = document.getElementById('client-loaned-containers-info');
            const countSpan = document.getElementById('client-loaned-count');

            if (totalLoaned > 0) {
                countSpan.textContent = totalLoaned;
                infoDiv?.classList.remove('hidden');
            } else {
                infoDiv?.classList.add('hidden');
            }
        } catch (error) {
            console.error('Error cargando bidones prestados del cliente:', error);
        }
    }

    async function finalizeSale(e) {
        e.preventDefault();
        if (!db.cashRegister.isOpen) {
            alert("Abra la caja primero.");
            return;
        }
        if (currentSaleItems.length === 0) {
            alert("A침ada productos a la venta.");
            return;
        }

        const clientName = document.getElementById('client-name').value;

        // Validar que haya un cliente seleccionado
        if (!currentSelectedClient || !clientName.trim()) {
            alert("仇 Debe seleccionar o crear un cliente antes de finalizar la venta.\n\nUse el campo de b칰squeda de clientes o haga clic en 'Crear Nuevo Cliente' para registrar uno.");
            return;
        }
        const clientType = document.querySelector('input[name="client-type"]:checked').value;
        const paymentMethod = document.querySelector('input[name="sale-payment"]:checked').value;
        const paymentNote = document.getElementById('sale-transfer-note').value;
        const returnedContainers = parseInt(document.getElementById('returned-containers')?.value) || 0;
        const loanedContainers = parseInt(document.getElementById('loan-containers')?.value) || 0;

        // Validar l칤mite de pr칠stamo
        if (loanedContainers > 0) {
            const isValid = await validateLoanLimit();
            if (!isValid) {
                alert('仇 No se puede prestar esa cantidad de bidones. Excede el l칤mite permitido para este cliente.');
                return;
            }
        }

        // NUEVA VALIDACI칍N: Verificar registro de bidones sin devolver
        const unreturnedSection = document.getElementById('unreturned-containers-section');
        if (unreturnedSection && !unreturnedSection.classList.contains('hidden')) {
            // La secci칩n est치 visible, significa que hay bidones sin devolver
            const unreturnedDate = document.getElementById('unreturned-return-date')?.value;
            const isComodato = document.getElementById('unreturned-is-comodato')?.checked;

            if (!isComodato && !unreturnedDate) {
                alert('仇 El cliente no est치 devolviendo bidones vac칤os.\n\nDebe registrar la fecha de devoluci칩n esperada o marcar "Es comodato" antes de finalizar la venta.');
                return;
            }
        }

        const total = currentSaleItems.reduce((sum, item) => sum + item.total, 0);

        const saleDoc = {
            sellerId: auth.currentUser.uid,
            vehicleId: db.cashRegister.vehicleId || null,
            date: getCurrentDate(),
            clientName,
            clientId: currentSelectedClient || null,
            clientType,
            paymentMethod,
            paymentNote,
            items: currentSaleItems,
            total,
            returnedContainers: returnedContainers,
            loanedContainers: loanedContainers,
            status: (paymentMethod === 'credito' ? 'pendiente' : 'pagado'),
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Agregar a la base de datos local (db.sales) inmediatamente
        const tempId = 'temp_' + Date.now();
        const localSale = { id: tempId, ...saleDoc, timestamp: new Date() };
        db.sales.push(localSale);

        // GUARDAR REFERENCIAS ANTES DE LIMPIAR UI
        const soldItems = [...currentSaleItems];  // Clonar array para preservar los datos
        const savedClientId = currentSelectedClient; // Guardar cliente antes de limpiar

        // Capturar informaci칩n de bidones sin devolver ANTES de limpiar UI
        const hasUnreturnedContainers = unreturnedSection && !unreturnedSection.classList.contains('hidden');
        const unreturnedCount = hasUnreturnedContainers ? parseInt(document.getElementById('unreturned-count')?.textContent) || 0 : 0;
        const unreturnedDate = hasUnreturnedContainers ? document.getElementById('unreturned-return-date')?.value : null;
        const isComodato = hasUnreturnedContainers ? document.getElementById('unreturned-is-comodato')?.checked : false;

        // 九 ACTUALIZAR INVENTARIO LOCAL INMEDIATAMENTE (antes de Firestore)
        // Esto garantiza que funcione offline
        if (db.cashRegister.vehicleInventory && db.cashRegister.vehicleInventory.length > 0) {
            soldItems.forEach(soldItem => {
                const invItem = db.cashRegister.vehicleInventory.find(i => i.productId === soldItem.productId);
                if (invItem) {
                    invItem.quantity = Math.max(0, invItem.quantity - soldItem.quantity);
                    console.log(`游닍 Inventario local actualizado: ${soldItem.name} - Nueva cantidad: ${invItem.quantity}`);
                }
            });
            saveCashRegisterToStorage(); // Guardar cambios en localStorage
        }

        // Actualizar UI inmediatamente
        currentSaleItems = [];
        renderCurrentSaleTable();
        document.getElementById('sale-form').reset();
        document.getElementById('sale-transfer-note').classList.add('hidden');
        document.getElementById('sale-quantity').value = 1;
        document.getElementById('returned-containers').value = 0;
        document.getElementById('loan-containers').value = 0;

        // Limpiar secci칩n de bidones sin devolver (reutilizar variable)
        if (unreturnedSection) {
            unreturnedSection.classList.add('hidden');
            document.getElementById('unreturned-return-date').value = '';
            document.getElementById('unreturned-is-comodato').checked = false;
        }

        currentSelectedClient = null;
        updateCashClosureSummary();
        updateSellerDashboard();
        renderTodaySales();

        // Guardar en Firestore - Firestore maneja autom치ticamente si est치 offline
        try {
            const docRef = await db_firestore.collection('sales').add(saleDoc);

            // Reemplazar el ID temporal con el ID real de Firestore
            const saleIndex = db.sales.findIndex(s => s.id === tempId);
            if (saleIndex !== -1) {
                db.sales[saleIndex].id = docRef.id;
            }

            // Actualizar inventario del veh칤culo en Firestore (intentar치 sincronizar)
            if (db.cashRegister.vehicleId && db.cashRegister.sessionId) {
                await updateVehicleInventoryAfterSale(db.cashRegister.vehicleId, db.cashRegister.sessionId, soldItems, returnedContainers);
            }

            // Registrar pr칠stamo de bidones adicionales si aplica
            if (loanedContainers > 0 && savedClientId) {
                await registerContainerLoan(savedClientId, loanedContainers, docRef.id);
            }

            // NUEVO: Registrar bidones sin devolver (recargas sin devoluci칩n)
            // Usar variables capturadas antes de limpiar UI
            if (hasUnreturnedContainers && unreturnedCount > 0 && savedClientId) {
                await registerUnreturnedContainers(savedClientId, unreturnedCount, docRef.id, unreturnedDate, isComodato);
            }

            // Actualizar devoluci칩n de bidones prestados
            if (returnedContainers > 0 && savedClientId) {
                await processReturnedContainers(savedClientId, returnedContainers, docRef.id);
            }

            if (navigator.onLine) {
                alert('九 Venta finalizada con 칠xito!');
            } else {
                alert('九 Venta guardada. Se sincronizar치 autom치ticamente cuando haya conexi칩n.');
            }
        } catch (error) {
            console.error("Error al guardar venta:", error);
            alert('九 Venta guardada localmente. Se sincronizar치 autom치ticamente cuando haya conexi칩n.');
        }
    }

    async function updateVehicleInventoryAfterSale(vehicleId, sessionId, items, returnedEmpty) {
        try {
            // Obtener inventario actual del veh칤culo
            const inventorySnapshot = await db_firestore.collection('vehicle_inventory')
                .where('vehicleId', '==', vehicleId)
                .where('sessionId', '==', sessionId)
                .get();

            const batch = db_firestore.batch();

            // Actualizar cantidades vendidas
            items.forEach(item => {
                const invDoc = inventorySnapshot.docs.find(doc => doc.data().productId === item.productId);
                if (invDoc) {
                    const currentQty = invDoc.data().quantity;
                    const newQty = currentQty - item.quantity;
                    batch.update(invDoc.ref, {
                        quantity: Math.max(0, newQty),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                // ===== AGREGAR BID칍N VAC칈O AUTOM츼TICAMENTE =====
                // Si se vende RECARGA BCL o RECARGA BSL, agregar bid칩n vac칤o correspondiente
                const product = db.products.find(p => p.id === item.productId);
                if (product) {
                    const productName = product.name.toUpperCase();
                    let emptyProductName = null;

                    if (productName.includes('RECARGA BCL')) {
                        emptyProductName = 'BCL VACIO';
                    } else if (productName.includes('RECARGA BSL')) {
                        emptyProductName = 'BSL VACIO';
                    }

                    if (emptyProductName) {
                        const emptyProduct = db.products.find(p => p.name.toUpperCase().includes(emptyProductName));
                        if (emptyProduct) {
                            const emptyInvDoc = inventorySnapshot.docs.find(doc => doc.data().productId === emptyProduct.id);
                            if (emptyInvDoc) {
                                // Ya existe, incrementar cantidad
                                const currentEmptyQty = emptyInvDoc.data().quantity;
                                batch.update(emptyInvDoc.ref, {
                                    quantity: currentEmptyQty + item.quantity,
                                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            } else {
                                // No existe, crear nuevo registro
                                const newInvRef = db_firestore.collection('vehicle_inventory').doc();
                                batch.set(newInvRef, {
                                    vehicleId: vehicleId,
                                    productId: emptyProduct.id,
                                    quantity: item.quantity,
                                    sessionId: sessionId,
                                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                            console.log(`九 ${item.quantity}x ${emptyProductName} agregados al inventario por venta de ${product.name}`);
                        }
                    }
                }
            });

            // Si devolvieron bidones vac칤os, incrementar inventario de bidones vac칤os
            if (returnedEmpty > 0) {
                const emptyProduct = db.products.find(p => p.category === 'bidon_vacio');
                if (emptyProduct) {
                    const emptyInvDoc = inventorySnapshot.docs.find(doc => doc.data().productId === emptyProduct.id);
                    if (emptyInvDoc) {
                        const currentQty = emptyInvDoc.data().quantity;
                        batch.update(emptyInvDoc.ref, {
                            quantity: currentQty + returnedEmpty,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } else {
                        // Crear nuevo registro de bidones vac칤os
                        const newInvRef = db_firestore.collection('vehicle_inventory').doc();
                        batch.set(newInvRef, {
                            vehicleId: vehicleId,
                            productId: emptyProduct.id,
                            quantity: returnedEmpty,
                            sessionId: sessionId,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
            }

            await batch.commit();

            // Actualizar inventario en memoria (db.cashRegister.vehicleInventory)
            if (db.cashRegister.vehicleInventory) {
                items.forEach(item => {
                    // Reducir inventario del producto vendido
                    const invItem = db.cashRegister.vehicleInventory.find(i => i.productId === item.productId);
                    if (invItem) {
                        invItem.quantity = Math.max(0, invItem.quantity - item.quantity);
                    }

                    // ===== AGREGAR BID칍N VAC칈O AUTOM츼TICAMENTE EN MEMORIA =====
                    const product = db.products.find(p => p.id === item.productId);
                    if (product) {
                        const productName = product.name.toUpperCase();
                        let emptyProductName = null;

                        if (productName.includes('RECARGA BCL')) {
                            emptyProductName = 'BCL VACIO';
                        } else if (productName.includes('RECARGA BSL')) {
                            emptyProductName = 'BSL VACIO';
                        }

                        if (emptyProductName) {
                            const emptyProduct = db.products.find(p => p.name.toUpperCase().includes(emptyProductName));
                            if (emptyProduct) {
                                const emptyInv = db.cashRegister.vehicleInventory.find(i => i.productId === emptyProduct.id);
                                if (emptyInv) {
                                    emptyInv.quantity += item.quantity;
                                } else {
                                    db.cashRegister.vehicleInventory.push({
                                        productId: emptyProduct.id,
                                        quantity: item.quantity
                                    });
                                }
                                console.log(`九 Inventario en memoria: +${item.quantity} ${emptyProductName}`);
                            }
                        }
                    }
                });

                // Agregar bidones vac칤os devueltos
                if (returnedEmpty > 0) {
                    const emptyProduct = db.products.find(p => p.category === 'bidon_vacio');
                    if (emptyProduct) {
                        const emptyInv = db.cashRegister.vehicleInventory.find(i => i.productId === emptyProduct.id);
                        if (emptyInv) {
                            emptyInv.quantity += returnedEmpty;
                        } else {
                            db.cashRegister.vehicleInventory.push({
                                productId: emptyProduct.id,
                                quantity: returnedEmpty
                            });
                        }
                    }
                }

                saveCashRegisterToStorage();
                updateSellerDashboard();
            }

            console.log('九 Inventario del veh칤culo actualizado');
        } catch (error) {
            console.error('Error actualizando inventario del veh칤culo:', error);
        }
    }

    async function registerContainerLoan(clientId, quantity, saleId) {
        try {
            await db_firestore.collection('loaned_containers').add({
                clientId: clientId,
                sellerId: auth.currentUser.uid,
                quantity: quantity,
                saleId: saleId,
                loanDate: getCurrentDate(),
                status: 'active',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log(`九 Registrado pr칠stamo de ${quantity} bidones`);
        } catch (error) {
            console.error('Error registrando pr칠stamo de bidones:', error);
        }
    }

    // NUEVA FUNCI칍N: Registrar bidones sin devolver en una venta
    async function registerUnreturnedContainers(clientId, quantity, saleId, expectedReturnDate, isComodato) {
        try {
            // Obtener nombre del cliente
            const clientDoc = await db_firestore.collection('clients').doc(clientId).get();
            const clientName = clientDoc.exists ? clientDoc.data().name : 'Desconocido';

            const loanData = {
                clientId: clientId,
                clientName: clientName,
                sellerId: auth.currentUser.uid,
                vehicleId: db.cashRegister.vehicleId || null,
                quantity: quantity,
                saleId: saleId,
                loanDate: getCurrentDate(),
                expectedReturnDate: isComodato ? null : expectedReturnDate,
                isComodato: isComodato || false,
                transactionType: 'unreturned_refill', // Tipo espec칤fico para diferenciar
                status: 'active',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db_firestore.collection('loaned_containers').add(loanData);

            console.log(`九 Registrado ${quantity} bidones sin devolver${isComodato ? ' (COMODATO)' : ' con fecha: ' + expectedReturnDate}`);
        } catch (error) {
            console.error('Error registrando bidones sin devolver:', error);
        }
    }

    async function processReturnedContainers(clientId, quantity, saleId) {
        try {
            // Obtener pr칠stamos activos del cliente, ordenados por fecha (FIFO)
            const loansSnapshot = await db_firestore.collection('loaned_containers')
                .where('clientId', '==', clientId)
                .where('status', '==', 'active')
                .orderBy('timestamp', 'asc')
                .get();

            let remainingToReturn = quantity;
            const batch = db_firestore.batch();

            for (const loanDoc of loansSnapshot.docs) {
                if (remainingToReturn <= 0) break;

                const loanData = loanDoc.data();
                const loanQty = loanData.quantity;

                if (loanQty <= remainingToReturn) {
                    // Devolver todo el pr칠stamo
                    batch.update(loanDoc.ref, {
                        status: 'returned',
                        returnDate: getCurrentDate(),
                        returnSaleId: saleId,
                        returnedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    remainingToReturn -= loanQty;
                } else {
                    // Devolver parcialmente
                    batch.update(loanDoc.ref, {
                        quantity: loanQty - remainingToReturn
                    });
                    remainingToReturn = 0;
                }
            }

            await batch.commit();
            console.log(`九 Procesada devoluci칩n de ${quantity} bidones`);
        } catch (error) {
            console.error('Error procesando devoluci칩n de bidones:', error);
        }
    }

    // ===== M칍DULO DE BIDONES PRESTADOS =====
    async function loadLoanedContainersModule() {
        try {
            // Obtener todos los pr칠stamos del vendedor
            const loansSnapshot = await db_firestore.collection('loaned_containers')
                .where('sellerId', '==', auth.currentUser.uid)
                .orderBy('timestamp', 'desc')
                .get();

            const loans = [];
            loansSnapshot.forEach(doc => {
                loans.push({ id: doc.id, ...doc.data() });
            });

            // Calcular estad칤sticas
            const today = getCurrentDate();
            const activeLoans = loans.filter(l => l.status === 'active');
            const loanedToday = loans.filter(l => l.loanDate === today && l.status === 'active');
            const returnedToday = loans.filter(l => l.returnDate === today && l.status === 'returned');

            // Contar clientes 칰nicos con bidones activos
            const uniqueClients = new Set(activeLoans.map(l => l.clientId));

            // Total de bidones prestados activos
            const totalActive = activeLoans.reduce((sum, l) => sum + (l.quantity || 0), 0);
            const totalLoanedToday = loanedToday.reduce((sum, l) => sum + (l.quantity || 0), 0);
            const totalReturnedToday = returnedToday.reduce((sum, l) => sum + (l.quantity || 0), 0);

            // Actualizar estad칤sticas
            document.getElementById('total-loaned-containers').textContent = totalActive;
            document.getElementById('returned-today-containers').textContent = totalReturnedToday;
            document.getElementById('loaned-today-containers').textContent = totalLoanedToday;
            document.getElementById('clients-with-containers').textContent = uniqueClients.size;

            // Renderizar lista
            renderLoanedContainersList(loans);
        } catch (error) {
            console.error('Error cargando m칩dulo de bidones prestados:', error);
        }
    }

    function renderLoanedContainersList(loans) {
        const tbody = document.getElementById('loaned-containers-list');
        const emptyDiv = document.getElementById('loaned-containers-empty');

        if (!loans || loans.length === 0) {
            tbody.innerHTML = '';
            emptyDiv.classList.remove('hidden');
            return;
        }

        emptyDiv.classList.add('hidden');
        tbody.innerHTML = '';

        loans.forEach(loan => {
            const loanDate = loan.loanDate || '-';
            const returnDate = loan.returnDate || '-';
            const status = loan.status || 'active';

            // Calcular d칤as prestado
            let daysBorrowed = '-';
            if (status === 'active' && loan.loanDate) {
                const today = new Date();
                const loanDateObj = new Date(loan.loanDate);
                const diffTime = Math.abs(today - loanDateObj);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                daysBorrowed = diffDays;
            } else if (status === 'returned' && loan.loanDate && loan.returnDate) {
                const loanDateObj = new Date(loan.loanDate);
                const returnDateObj = new Date(loan.returnDate);
                const diffTime = Math.abs(returnDateObj - loanDateObj);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                daysBorrowed = diffDays;
            }

            const statusBadge = status === 'active'
                ? '<span class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs font-semibold rounded">Activo</span>'
                : '<span class="px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs font-semibold rounded">Devuelto</span>';

            const row = document.createElement('tr');
            row.className = 'hover:bg-slate-50 dark:hover:bg-slate-700';
            row.dataset.clientName = (loan.clientName || '').toLowerCase();
            row.dataset.status = status;

            row.innerHTML = `
                <td class="py-3 px-4 text-sm">${loanDate}</td>
                <td class="py-3 px-4 text-sm font-semibold">${loan.clientName || 'N/A'}</td>
                <td class="py-3 px-4 text-sm">
                    <span class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded font-bold">${loan.quantity || 0}</span>
                </td>
                <td class="py-3 px-4 text-sm">${daysBorrowed} ${daysBorrowed !== '-' ? 'd칤a(s)' : ''}</td>
                <td class="py-3 px-4 text-sm">${statusBadge}</td>
                <td class="py-3 px-4 text-sm">${returnDate}</td>
            `;

            tbody.appendChild(row);
        });
    }

    function filterLoanedContainers() {
        const searchTerm = document.getElementById('loaned-client-search').value.toLowerCase();
        const statusFilter = document.getElementById('loaned-status-filter').value;

        const rows = document.querySelectorAll('#loaned-containers-list tr');

        rows.forEach(row => {
            const clientName = row.dataset.clientName || '';
            const status = row.dataset.status || '';

            const matchesSearch = clientName.includes(searchTerm);
            const matchesStatus = statusFilter === 'all' || status === statusFilter;

            if (matchesSearch && matchesStatus) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    async function finalizeCollection(e) {
        e.preventDefault();
        if (!db.cashRegister.isOpen) {
            alert("Abra la caja primero.");
            return;
        }
        const clientName = document.getElementById('collection-client-name').value;
        const amount = parseFloat(document.getElementById('collection-amount').value);
        const reason = document.getElementById('collection-reason').value;

        if(clientName && reason && !isNaN(amount) && amount > 0) {
            const collection = {
                sellerId: auth.currentUser.uid,
                type: 'collection',
                date: getCurrentDate(),
                clientName,
                amount,
                reason
            };

            // Agregar a base de datos local inmediatamente
            const tempId = 'temp_col_' + Date.now();
            const localCollection = { id: tempId, ...collection };
            db.collections.push(localCollection);

            // Actualizar transacciones de caja
            db.cashRegister.transactions.push(collection);

            // Actualizar UI inmediatamente
            e.target.reset();
            updateCashClosureSummary();
            updateSellerDashboard();
            updateCollectionsModule();

            // Guardar en Firestore - Firestore maneja autom치ticamente si est치 offline
            try {
                const docRef = await db_firestore.collection('collections').add(collection);

                // Reemplazar ID temporal con ID real
                const colIndex = db.collections.findIndex(c => c.id === tempId);
                if (colIndex !== -1) {
                    db.collections[colIndex].id = docRef.id;
                }

                if (navigator.onLine) {
                    alert('九 Ingreso registrado con 칠xito!');
                } else {
                    alert('九 Ingreso guardado. Se sincronizar치 autom치ticamente cuando haya conexi칩n.');
                }
            } catch (error) {
                console.error("Error al guardar ingreso:", error);
                alert('九 Ingreso guardado localmente. Se sincronizar치 autom치ticamente cuando haya conexi칩n.');
            }
        } else {
            alert('Por favor, complete todos los campos del ingreso.');
        }
    }
    document.getElementById('add-expense-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!db.cashRegister.isOpen) {
            alert("Abra la caja primero.");
            return;
        }
        const categoryId = document.getElementById('expense-category-selector').value;
        const category = db.expenseTypes.find(et => et.id === categoryId);
        const paymentMethod = document.querySelector('input[name="expense-payment"]:checked').value;

        if (!category) {
            alert('Por favor, seleccione un tipo de gasto.');
            return;
        }

        let amount, observations, invoiceNumber, productDetails;

        // Verificar si es compra de productos
        if (category.name.toLowerCase().includes('compra de productos')) {
            // Obtener detalles del carrito de compra
            if (purchaseCart.length === 0) {
                alert('Por favor, agregue al menos un producto al carrito.');
                return;
            }

            productDetails = [];
            let total = 0;

            purchaseCart.forEach(item => {
                const product = db.products.find(p => p.id === item.productId);
                if (product) {
                    const cost = product.cost || 0;
                    const subtotal = item.quantity * cost;
                    total += subtotal;
                    productDetails.push({
                        productId: product.id,
                        productName: product.name,
                        quantity: item.quantity,
                        unitCost: cost,
                        subtotal
                    });
                }
            });

            amount = total;
            invoiceNumber = document.getElementById('invoice-number').value;
            observations = document.getElementById('purchase-observations').value;

            if (!invoiceNumber.trim()) {
                alert('Por favor, ingrese el n칰mero de factura o recibo.');
                return;
            }
        } else {
            // Gasto normal
            amount = parseFloat(document.getElementById('expense-amount').value);
            observations = document.getElementById('expense-observations').value;

            if (isNaN(amount) || amount <= 0) {
                alert('Por favor, ingrese un monto v치lido.');
                return;
            }

            if (observations.trim() === '' && (category.name.toLowerCase() === 'compra de producto' || category.name.toLowerCase() === 'otros')) {
                alert('Se requiere una observaci칩n para este tipo de gasto.');
                return;
            }
        }

        const expense = {
            sellerId: auth.currentUser.uid,
            type: 'expense',
            date: getCurrentDate(),
            categoryId,
            categoryName: category.name,
            amount,
            observations,
            paymentMethod,
            invoiceNumber: invoiceNumber || null,
            productDetails: productDetails || null
        };

        // Agregar a base de datos local inmediatamente
        const tempId = 'temp_exp_' + Date.now();
        const localExpense = { id: tempId, ...expense };
        db.expenses.push(localExpense);

        // Actualizar transacciones de caja
        if(paymentMethod === 'efectivo') {
            db.cashRegister.transactions.push(expense);
        }

        // Actualizar UI inmediatamente
        updateCashClosureSummary();
        updateSellerDashboard();
        updateExpensesModule();
        this.reset();

        // Limpiar carrito de compra si fue compra de productos
        if (category.name.toLowerCase().includes('compra de productos')) {
            purchaseCart = [];
            renderPurchaseCart();
        }

        // Guardar en Firestore - Firestore maneja autom치ticamente si est치 offline
        try {
            const docRef = await db_firestore.collection('expenses').add(expense);

            // Reemplazar ID temporal con ID real
            const expIndex = db.expenses.findIndex(e => e.id === tempId);
            if (expIndex !== -1) {
                db.expenses[expIndex].id = docRef.id;
            }

            // Si es compra de productos, actualizar inventario del veh칤culo
            if (category.name.toLowerCase().includes('compra de productos') && productDetails && productDetails.length > 0) {
                try {
                    await updateVehicleInventoryFromPurchase(productDetails, db.cashRegister.sessionId, db.cashRegister.vehicleId);
                    if (navigator.onLine) {
                        alert('九 Gasto registrado e inventario actualizado!');
                    } else {
                        alert('九 Gasto guardado. Se sincronizar치 autom치ticamente cuando haya conexi칩n.');
                    }
                } catch (invError) {
                    console.error("Error actualizando inventario:", invError);
                    alert('九 Gasto registrado, pero hubo un error al actualizar el inventario. Contacte al administrador.');
                }
            } else {
                if (navigator.onLine) {
                    alert('九 Gasto registrado!');
                } else {
                    alert('九 Gasto guardado. Se sincronizar치 autom치ticamente cuando haya conexi칩n.');
                }
            }
        } catch (error) {
            console.error("Error al guardar gasto:", error);
            alert('九 Gasto guardado localmente. Se sincronizar치 autom치ticamente cuando haya conexi칩n.');
        }
    });

    // ===== FUNCI칍N DE ACTUALIZACI칍N DE INVENTARIO POR COMPRA =====

    async function updateVehicleInventoryFromPurchase(productDetails, sessionId, vehicleId) {
        if (!sessionId || !vehicleId) {
            throw new Error('No hay sesi칩n activa o veh칤culo asignado');
        }

        const batch = db_firestore.batch();

        for (const item of productDetails) {
            try {
                // Buscar si ya existe inventario de este producto en esta sesi칩n
                const inventorySnapshot = await db_firestore.collection('vehicle_inventory')
                    .where('sessionId', '==', sessionId)
                    .where('vehicleId', '==', vehicleId)
                    .where('productId', '==', item.productId)
                    .limit(1)
                    .get();

                if (!inventorySnapshot.empty) {
                    // Ya existe, actualizar cantidad
                    const inventoryDoc = inventorySnapshot.docs[0];
                    const currentQuantity = inventoryDoc.data().quantity || 0;
                    const newQuantity = currentQuantity + item.quantity;

                    batch.update(inventoryDoc.ref, {
                        quantity: newQuantity,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    console.log(`Inventario actualizado: ${item.productName} - Cantidad anterior: ${currentQuantity}, Nueva cantidad: ${newQuantity}`);
                } else {
                    // No existe, crear nuevo registro
                    const newInventoryRef = db_firestore.collection('vehicle_inventory').doc();
                    batch.set(newInventoryRef, {
                        sessionId: sessionId,
                        vehicleId: vehicleId,
                        productId: item.productId,
                        quantity: item.quantity,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    console.log(`Nuevo inventario creado: ${item.productName} - Cantidad: ${item.quantity}`);
                }

                // ===== L칍GICA DE BIDONES VAC칈OS =====
                // Si se compra RECARGA BCL o RECARGA BSL, reducir bidones vac칤os correspondientes
                const productName = item.productName.toUpperCase();
                let emptyProductName = null;

                if (productName.includes('RECARGA BCL')) {
                    emptyProductName = 'BCL VACIO';
                } else if (productName.includes('RECARGA BSL')) {
                    emptyProductName = 'BSL VACIO';
                }

                if (emptyProductName) {
                    // Buscar el producto vac칤o en la base de datos
                    const emptyProduct = db.products.find(p => p.name.toUpperCase().includes(emptyProductName));

                    if (emptyProduct) {
                        // Buscar inventario del bid칩n vac칤o
                        const emptyInventorySnapshot = await db_firestore.collection('vehicle_inventory')
                            .where('sessionId', '==', sessionId)
                            .where('vehicleId', '==', vehicleId)
                            .where('productId', '==', emptyProduct.id)
                            .limit(1)
                            .get();

                        if (!emptyInventorySnapshot.empty) {
                            const emptyInventoryDoc = emptyInventorySnapshot.docs[0];
                            const currentEmptyQuantity = emptyInventoryDoc.data().quantity || 0;
                            const newEmptyQuantity = currentEmptyQuantity - item.quantity;

                            // No permitir cantidades negativas
                            if (newEmptyQuantity < 0) {
                                console.warn(`丘멆잺 No hay suficientes ${emptyProductName}. Actual: ${currentEmptyQuantity}, Requerido: ${item.quantity}`);
                                throw new Error(`No hay suficientes ${emptyProductName} en el cami칩n. Disponibles: ${currentEmptyQuantity}, Requerido: ${item.quantity}`);
                            }

                            batch.update(emptyInventoryDoc.ref, {
                                quantity: newEmptyQuantity,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });

                            console.log(`九 ${emptyProductName} reducidos: ${currentEmptyQuantity}  ${newEmptyQuantity} (${item.quantity} recargados)`);
                        } else {
                            console.warn(`丘멆잺 No se encontr칩 inventario de ${emptyProductName} en el veh칤culo`);
                            throw new Error(`No hay ${emptyProductName} registrados en el cami칩n para recargar`);
                        }
                    } else {
                        console.warn(`丘멆잺 No se encontr칩 el producto ${emptyProductName} en el cat치logo`);
                    }
                }
            } catch (error) {
                console.error(`Error procesando producto ${item.productName}:`, error);
                throw error;
            }
        }

        // Ejecutar todas las operaciones en batch
        await batch.commit();
        console.log('九 Inventario del veh칤culo actualizado exitosamente');

        // Actualizar inventario en memoria (db.cashRegister.vehicleInventory)
        if (db.cashRegister.vehicleInventory) {
            productDetails.forEach(item => {
                // Actualizar producto comprado
                const invItem = db.cashRegister.vehicleInventory.find(i => i.productId === item.productId);
                if (invItem) {
                    invItem.quantity += item.quantity;
                } else {
                    db.cashRegister.vehicleInventory.push({
                        productId: item.productId,
                        quantity: item.quantity
                    });
                }

                // Reducir bidones vac칤os correspondientes
                const productName = item.productName.toUpperCase();
                let emptyProductName = null;

                if (productName.includes('RECARGA BCL')) {
                    emptyProductName = 'BCL VACIO';
                } else if (productName.includes('RECARGA BSL')) {
                    emptyProductName = 'BSL VACIO';
                }

                if (emptyProductName) {
                    const emptyProduct = db.products.find(p => p.name.toUpperCase().includes(emptyProductName));
                    if (emptyProduct) {
                        const emptyInv = db.cashRegister.vehicleInventory.find(i => i.productId === emptyProduct.id);
                        if (emptyInv) {
                            emptyInv.quantity = Math.max(0, emptyInv.quantity - item.quantity);
                            console.log(`九 Inventario en memoria actualizado: ${emptyProductName}  ${emptyInv.quantity}`);
                        }
                    }
                }
            });

            // Actualizar UI
            updateSellerDashboard();
            renderInventoryProducts();
            saveCashRegisterToStorage();
        }
    }

    // ===== FUNCIONES DE P칄RDIDAS/DA칌OS =====

    function populateLossProductDropdown() {
        const select = document.getElementById('loss-product');
        if (!select) return;

        select.innerHTML = '<option value="">Seleccionar producto...</option>';

        db.products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = `${product.name} (${product.category || 'N/A'})`;
            select.appendChild(option);
        });
    }

    document.getElementById('add-loss-form')?.addEventListener('submit', async function(e) {
        e.preventDefault();

        if (!db.cashRegister.isOpen) {
            alert("仇 Debe tener la caja abierta para reportar p칠rdidas.");
            return;
        }

        const productId = document.getElementById('loss-product').value;
        const quantity = parseInt(document.getElementById('loss-quantity').value);
        const lossType = document.getElementById('loss-type').value;
        const description = document.getElementById('loss-description').value;

        if (!productId || !quantity || !lossType || !description.trim()) {
            alert('仇 Por favor complete todos los campos.');
            return;
        }

        const product = db.products.find(p => p.id === productId);
        if (!product) {
            alert('仇 Producto no encontrado.');
            return;
        }

        const lossReport = {
            sellerId: auth.currentUser.uid,
            sellerName: auth.currentUser.displayName || 'Vendedor',
            vehicleId: db.cashRegister.vehicleId || null,
            vehiclePlate: db.cashRegister.vehiclePlate || null,
            sessionId: db.cashRegister.sessionId || null,
            productId: productId,
            productName: product.name,
            quantity: quantity,
            lossType: lossType,
            description: description,
            date: getCurrentDate(),
            status: 'pending', // pending, approved, rejected
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            const docRef = await db_firestore.collection('inventory_losses').add(lossReport);

            alert('九 Reporte enviado para aprobaci칩n del administrador');
            this.reset();

            // Recargar lista de reportes
            loadSellerLosses();
        } catch (error) {
            console.error('Error al crear reporte de p칠rdida:', error);
            alert('仇 Error al enviar reporte: ' + error.message);
        }
    });

    async function loadSellerLosses() {
        if (!auth.currentUser) return;

        try {
            const lossesList = document.getElementById('losses-list');
            if (!lossesList) return;

            const lossesSnapshot = await db_firestore.collection('inventory_losses')
                .where('sellerId', '==', auth.currentUser.uid)
                .orderBy('createdAt', 'desc')
                .limit(20)
                .get();

            if (lossesSnapshot.empty) {
                lossesList.innerHTML = '<p class="text-center py-8 text-slate-500 dark:text-slate-400">No hay reportes</p>';
                return;
            }

            const lossTypeLabels = {
                'perdida': 'P칠rdida/Extrav칤o',
                'rotura': 'Rotura/Da침o',
                'robo': 'Robo',
                'vencimiento': 'Vencimiento',
                'otro': 'Otro'
            };

            lossesList.innerHTML = lossesSnapshot.docs.map(doc => {
                const loss = doc.data();
                const statusColors = {
                    'pending': 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200 border-yellow-300 dark:border-yellow-700',
                    'approved': 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 border-green-300 dark:border-green-700',
                    'rejected': 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200 border-red-300 dark:border-red-700'
                };

                const statusIcons = {
                    'pending': '낍',
                    'approved': '九',
                    'rejected': '仇'
                };

                const statusLabels = {
                    'pending': 'Pendiente',
                    'approved': 'Aprobado',
                    'rejected': 'Rechazado'
                };

                return `
                    <div class="p-4 rounded-lg border ${statusColors[loss.status]} ">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <h4 class="font-bold text-sm">${loss.productName}</h4>
                                <p class="text-xs opacity-75">Cantidad: ${loss.quantity}</p>
                            </div>
                            <span class="px-2 py-1 rounded text-xs font-bold whitespace-nowrap">
                                ${statusIcons[loss.status]} ${statusLabels[loss.status]}
                            </span>
                        </div>
                        <div class="text-xs space-y-1">
                            <p><strong>Tipo:</strong> ${lossTypeLabels[loss.lossType] || loss.lossType}</p>
                            <p><strong>Fecha:</strong> ${loss.date}</p>
                            <p><strong>Descripci칩n:</strong> ${loss.description}</p>
                            ${loss.adminNotes ? `<p class="mt-2 p-2 bg-white dark:bg-slate-800 rounded"><strong>Notas del Admin:</strong> ${loss.adminNotes}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error cargando reportes de p칠rdidas:', error);
        }
    }

    // ===== FUNCIONES DE TRANSFERENCIAS =====

    function populateTransferVehicleDropdowns() {
        const fromSelect = document.getElementById('transfer-from-vehicle');
        const toSelect = document.getElementById('transfer-to-vehicle');

        if (!fromSelect || !toSelect) return;

        fromSelect.innerHTML = '<option value="">Seleccionar veh칤culo origen...</option>';
        toSelect.innerHTML = '<option value="">Seleccionar veh칤culo destino...</option>';

        db.vehicles.forEach(vehicle => {
            const optionFrom = document.createElement('option');
            optionFrom.value = vehicle.id;
            optionFrom.setAttribute('data-plate', vehicle.plate);
            optionFrom.textContent = `${vehicle.plate} - ${vehicle.driver || 'Sin conductor'}`;
            fromSelect.appendChild(optionFrom);

            const optionTo = document.createElement('option');
            optionTo.value = vehicle.id;
            optionTo.setAttribute('data-plate', vehicle.plate);
            optionTo.textContent = `${vehicle.plate} - ${vehicle.driver || 'Sin conductor'}`;
            toSelect.appendChild(optionTo);
        });
    }

    function populateTransferProductDropdown() {
        const select = document.getElementById('transfer-product');
        if (!select) return;

        select.innerHTML = '<option value="">Seleccionar producto...</option>';

        db.products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = `${product.name} (${product.category || 'N/A'})`;
            select.appendChild(option);
        });
    }

    document.getElementById('add-transfer-form')?.addEventListener('submit', async function(e) {
        e.preventDefault();

        const fromVehicleId = document.getElementById('transfer-from-vehicle').value;
        const toVehicleId = document.getElementById('transfer-to-vehicle').value;
        const productId = document.getElementById('transfer-product').value;
        const quantity = parseInt(document.getElementById('transfer-quantity').value);
        const reason = document.getElementById('transfer-reason').value;

        // Validaciones
        if (fromVehicleId === toVehicleId) {
            alert('仇 El veh칤culo origen y destino deben ser diferentes');
            return;
        }

        const fromVehicle = db.vehicles.find(v => v.id === fromVehicleId);
        const toVehicle = db.vehicles.find(v => v.id === toVehicleId);
        const product = db.products.find(p => p.id === productId);

        if (!fromVehicle || !toVehicle || !product) {
            alert('仇 Error: Informaci칩n inv치lida');
            return;
        }

        try {
            const transferRequest = {
                requestedBy: auth.currentUser.uid,
                requestedByName: auth.currentUser.displayName || 'Vendedor',
                fromVehicleId: fromVehicleId,
                fromVehiclePlate: fromVehicle.plate,
                toVehicleId: toVehicleId,
                toVehiclePlate: toVehicle.plate,
                productId: productId,
                productName: product.name,
                quantity: quantity,
                reason: reason,
                status: 'pending',
                date: getCurrentDate(),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db_firestore.collection('inventory_transfers').add(transferRequest);

            alert('九 Solicitud de transferencia enviada al administrador');
            this.reset();
            loadSellerTransfers();

        } catch (error) {
            console.error('Error creando solicitud de transferencia:', error);
            alert('仇 Error al crear la solicitud: ' + error.message);
        }
    });

    async function loadSellerTransfers() {
        try {
            const transfersList = document.getElementById('transfers-list');
            if (!transfersList) return;

            const transfersSnapshot = await db_firestore.collection('inventory_transfers')
                .where('requestedBy', '==', auth.currentUser.uid)
                .orderBy('createdAt', 'desc')
                .limit(20)
                .get();

            if (transfersSnapshot.empty) {
                transfersList.innerHTML = '<p class="text-center py-8 text-slate-500 dark:text-slate-400">No hay transferencias registradas</p>';
                return;
            }

            const statusColors = {
                'pending': 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200 border-yellow-300 dark:border-yellow-700',
                'approved': 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 border-green-300 dark:border-green-700',
                'rejected': 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200 border-red-300 dark:border-red-700'
            };

            const statusIcons = {
                'pending': '낍',
                'approved': '九',
                'rejected': '仇'
            };

            const statusLabels = {
                'pending': 'Pendiente',
                'approved': 'Aprobado',
                'rejected': 'Rechazado'
            };

            transfersList.innerHTML = transfersSnapshot.docs.map(doc => {
                const transfer = doc.data();
                return `
                    <div class="p-4 rounded-lg border ${statusColors[transfer.status]}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <h4 class="font-bold text-sm">${transfer.productName}</h4>
                                <p class="text-xs opacity-75">Cantidad: ${transfer.quantity}</p>
                            </div>
                            <span class="px-2 py-1 rounded text-xs font-bold whitespace-nowrap">
                                ${statusIcons[transfer.status]} ${statusLabels[transfer.status]}
                            </span>
                        </div>
                        <div class="text-xs space-y-1">
                            <p><strong>De:</strong> ${transfer.fromVehiclePlate}</p>
                            <p><strong>Para:</strong> ${transfer.toVehiclePlate}</p>
                            <p><strong>Fecha:</strong> ${transfer.date}</p>
                            <p><strong>Motivo:</strong> ${transfer.reason}</p>
                            ${transfer.adminNotes ? `<p class="mt-2 p-2 bg-white dark:bg-slate-800 rounded"><strong>Notas del Admin:</strong> ${transfer.adminNotes}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error cargando transferencias:', error);
        }
    }

    // ===== FUNCIONES ADMIN DE P칄RDIDAS/DA칌OS =====

    async function loadAdminLossesPending() {
        try {
            const pendingContainer = document.getElementById('admin-losses-pending');
            if (!pendingContainer) return;

            const pendingSnapshot = await db_firestore.collection('inventory_losses')
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'asc')
                .get();

            if (pendingSnapshot.empty) {
                pendingContainer.innerHTML = '<div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md text-center text-slate-500 dark:text-slate-400">No hay reportes pendientes de aprobaci칩n</div>';
                return;
            }

            const lossTypeLabels = {
                'perdida': 'P칠rdida/Extrav칤o',
                'rotura': 'Rotura/Da침o',
                'robo': 'Robo',
                'vencimiento': 'Vencimiento',
                'otro': 'Otro'
            };

            pendingContainer.innerHTML = pendingSnapshot.docs.map(doc => {
                const loss = doc.data();
                return `
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border-l-4 border-yellow-500">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <h4 class="text-lg font-bold text-slate-800 dark:text-white mb-2">${loss.productName}</h4>
                                <div class="space-y-1 text-sm text-slate-600 dark:text-slate-300">
                                    <p><strong>Vendedor:</strong> ${loss.sellerName}</p>
                                    <p><strong>Veh칤culo:</strong> ${loss.vehiclePlate || 'N/A'}</p>
                                    <p><strong>Cantidad:</strong> ${loss.quantity} unidades</p>
                                    <p><strong>Tipo:</strong> <span class="font-semibold text-yellow-600 dark:text-yellow-400">${lossTypeLabels[loss.lossType] || loss.lossType}</span></p>
                                </div>
                            </div>
                            <div>
                                <div class="space-y-1 text-sm text-slate-600 dark:text-slate-300">
                                    <p><strong>Fecha:</strong> ${loss.date}</p>
                                    <p><strong>Descripci칩n:</strong></p>
                                    <p class="p-3 bg-slate-50 dark:bg-slate-700 rounded-lg italic">${loss.description}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 pt-4 border-t border-slate-200 dark:border-slate-700">
                            <button onclick="approveLoss('${doc.id}')" class="flex-1 min-w-[120px] bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition-all">
                                九 Aprobar
                            </button>
                            <button onclick="rejectLoss('${doc.id}')" class="flex-1 min-w-[120px] bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition-all">
                                仇 Rechazar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error cargando p칠rdidas pendientes:', error);
        }
    }

    async function approveLoss(lossId) {
        try {
            const lossDoc = await db_firestore.collection('inventory_losses').doc(lossId).get();
            if (!lossDoc.exists) {
                alert('仇 Error: Reporte no encontrado');
                return;
            }

            const loss = lossDoc.data();

            // Confirmar aprobaci칩n
            if (!confirm(`쮸probar la p칠rdida de ${loss.quantity} unidades de ${loss.productName}?\n\nEsto ajustar치 el inventario del veh칤culo.`)) {
                return;
            }

            const batch = db_firestore.batch();

            // Actualizar el reporte de p칠rdida
            batch.update(db_firestore.collection('inventory_losses').doc(lossId), {
                status: 'approved',
                approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                approvedBy: auth.currentUser.uid,
                approvedByName: auth.currentUser.displayName || 'Admin'
            });

            // Actualizar el inventario del veh칤culo si hay sessionId
            if (loss.sessionId && loss.vehicleId && loss.productId) {
                const inventorySnapshot = await db_firestore.collection('vehicle_inventory')
                    .where('sessionId', '==', loss.sessionId)
                    .where('vehicleId', '==', loss.vehicleId)
                    .where('productId', '==', loss.productId)
                    .limit(1)
                    .get();

                if (!inventorySnapshot.empty) {
                    const inventoryDoc = inventorySnapshot.docs[0];
                    const currentQuantity = inventoryDoc.data().quantity || 0;
                    const newQuantity = Math.max(0, currentQuantity - loss.quantity);

                    batch.update(inventoryDoc.ref, {
                        quantity: newQuantity,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            }

            await batch.commit();

            alert(`九 P칠rdida aprobada exitosamente\n\nSe ha ajustado el inventario del veh칤culo.`);

            // Recargar datos
            loadAdminLossesPending();
            loadAdminLossesHistory();
            calculateLossesStats();

        } catch (error) {
            console.error('Error aprobando p칠rdida:', error);
            alert('仇 Error al aprobar la p칠rdida: ' + error.message);
        }
    }

    async function rejectLoss(lossId) {
        try {
            const adminNotes = prompt('Ingrese el motivo del rechazo:');

            if (!adminNotes || adminNotes.trim() === '') {
                alert('仇 Debe ingresar un motivo para rechazar');
                return;
            }

            await db_firestore.collection('inventory_losses').doc(lossId).update({
                status: 'rejected',
                rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                rejectedBy: auth.currentUser.uid,
                rejectedByName: auth.currentUser.displayName || 'Admin',
                adminNotes: adminNotes.trim()
            });

            alert('九 P칠rdida rechazada exitosamente');

            // Recargar datos
            loadAdminLossesPending();
            loadAdminLossesHistory();
            calculateLossesStats();

        } catch (error) {
            console.error('Error rechazando p칠rdida:', error);
            alert('仇 Error al rechazar la p칠rdida: ' + error.message);
        }
    }

    async function loadAdminLossesHistory() {
        try {
            const historyContainer = document.getElementById('admin-losses-history');
            if (!historyContainer) return;

            const filterStatus = document.getElementById('losses-filter-status')?.value || 'all';
            const filterSeller = document.getElementById('losses-filter-seller')?.value || 'all';

            let query = db_firestore.collection('inventory_losses')
                .orderBy('createdAt', 'desc')
                .limit(50);

            if (filterStatus !== 'all') {
                query = query.where('status', '==', filterStatus);
            }

            if (filterSeller !== 'all') {
                query = query.where('sellerId', '==', filterSeller);
            }

            const historySnapshot = await query.get();

            if (historySnapshot.empty) {
                historyContainer.innerHTML = '<div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md text-center text-slate-500 dark:text-slate-400">No hay reportes en el historial</div>';
                return;
            }

            const lossTypeLabels = {
                'perdida': 'P칠rdida/Extrav칤o',
                'rotura': 'Rotura/Da침o',
                'robo': 'Robo',
                'vencimiento': 'Vencimiento',
                'otro': 'Otro'
            };

            const statusColors = {
                'pending': 'border-yellow-500 bg-yellow-50 dark:bg-yellow-900/20',
                'approved': 'border-green-500 bg-green-50 dark:bg-green-900/20',
                'rejected': 'border-red-500 bg-red-50 dark:bg-red-900/20'
            };

            const statusIcons = {
                'pending': '낍',
                'approved': '九',
                'rejected': '仇'
            };

            const statusLabels = {
                'pending': 'Pendiente',
                'approved': 'Aprobado',
                'rejected': 'Rechazado'
            };

            historyContainer.innerHTML = historySnapshot.docs.map(doc => {
                const loss = doc.data();
                return `
                    <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-md border-l-4 ${statusColors[loss.status]}">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h4 class="text-lg font-bold text-slate-800 dark:text-white">${loss.productName}</h4>
                                <p class="text-sm text-slate-600 dark:text-slate-300">Por: ${loss.sellerName}</p>
                            </div>
                            <span class="px-3 py-1 rounded-lg text-sm font-bold ${statusColors[loss.status]}">
                                ${statusIcons[loss.status]} ${statusLabels[loss.status]}
                            </span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-slate-600 dark:text-slate-300">
                            <div>
                                <p><strong>Cantidad:</strong> ${loss.quantity} unidades</p>
                                <p><strong>Tipo:</strong> ${lossTypeLabels[loss.lossType] || loss.lossType}</p>
                                <p><strong>Veh칤culo:</strong> ${loss.vehiclePlate || 'N/A'}</p>
                            </div>
                            <div>
                                <p><strong>Fecha:</strong> ${loss.date}</p>
                                <p><strong>Descripci칩n:</strong> ${loss.description}</p>
                            </div>
                        </div>
                        ${loss.adminNotes ? `
                            <div class="mt-3 p-3 bg-slate-100 dark:bg-slate-700 rounded-lg">
                                <p class="text-sm"><strong>Notas del Admin:</strong> ${loss.adminNotes}</p>
                                ${loss.approvedByName ? `<p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Por: ${loss.approvedByName || loss.rejectedByName}</p>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error cargando historial de p칠rdidas:', error);
        }
    }

    async function calculateLossesStats() {
        try {
            const now = new Date();
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            // Obtener p칠rdidas del mes actual
            const monthSnapshot = await db_firestore.collection('inventory_losses')
                .where('createdAt', '>=', firstDayOfMonth)
                .get();

            let pendingCount = 0;
            let approvedCount = 0;
            let rejectedCount = 0;
            let totalValue = 0;

            monthSnapshot.docs.forEach(doc => {
                const loss = doc.data();
                if (loss.status === 'pending') pendingCount++;
                if (loss.status === 'approved') {
                    approvedCount++;
                    // Calcular valor si el producto existe
                    const product = db.products.find(p => p.id === loss.productId);
                    if (product) {
                        totalValue += (product.price || 0) * loss.quantity;
                    }
                }
                if (loss.status === 'rejected') rejectedCount++;
            });

            // Actualizar la UI
            const pendingCountEl = document.getElementById('losses-pending-count');
            const approvedCountEl = document.getElementById('losses-approved-count');
            const rejectedCountEl = document.getElementById('losses-rejected-count');
            const totalValueEl = document.getElementById('losses-total-value');

            if (pendingCountEl) pendingCountEl.textContent = pendingCount;
            if (approvedCountEl) approvedCountEl.textContent = approvedCount;
            if (rejectedCountEl) rejectedCountEl.textContent = rejectedCount;
            if (totalValueEl) totalValueEl.textContent = '$' + totalValue.toFixed(2);

        } catch (error) {
            console.error('Error calculando estad칤sticas de p칠rdidas:', error);
        }
    }

    async function populateLossesSellerFilter() {
        try {
            const select = document.getElementById('losses-filter-seller');
            if (!select) return;

            select.innerHTML = '<option value="all">Todos los vendedores</option>';

            const usersSnapshot = await db_firestore.collection('users')
                .where('role', '==', 'seller')
                .orderBy('name')
                .get();

            usersSnapshot.docs.forEach(doc => {
                const user = doc.data();
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = user.name || user.email;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error poblando filtro de vendedores:', error);
        }
    }

    // ===== FUNCIONES ADMIN DE TRANSFERENCIAS =====

    async function loadAdminTransfersPending() {
        try {
            const pendingContainer = document.getElementById('admin-transfers-pending');
            if (!pendingContainer) return;

            const pendingSnapshot = await db_firestore.collection('inventory_transfers')
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'asc')
                .get();

            if (pendingSnapshot.empty) {
                pendingContainer.innerHTML = '<div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md text-center text-slate-500 dark:text-slate-400">No hay solicitudes pendientes de aprobaci칩n</div>';
                return;
            }

            pendingContainer.innerHTML = pendingSnapshot.docs.map(doc => {
                const transfer = doc.data();
                return `
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <h4 class="text-lg font-bold text-slate-800 dark:text-white mb-2">${transfer.productName}</h4>
                                <div class="space-y-1 text-sm text-slate-600 dark:text-slate-300">
                                    <p><strong>Solicitado por:</strong> ${transfer.requestedByName}</p>
                                    <p><strong>Cantidad:</strong> ${transfer.quantity} unidades</p>
                                    <p><strong>Fecha:</strong> ${transfer.date}</p>
                                </div>
                            </div>
                            <div>
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center gap-2 p-2 bg-red-50 dark:bg-red-900/20 rounded">
                                        <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                                        <span class="text-red-800 dark:text-red-200"><strong>Origen:</strong> ${transfer.fromVehiclePlate}</span>
                                    </div>
                                    <div class="flex items-center gap-2 p-2 bg-green-50 dark:bg-green-900/20 rounded">
                                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                                        <span class="text-green-800 dark:text-green-200"><strong>Destino:</strong> ${transfer.toVehiclePlate}</span>
                                    </div>
                                    <p class="p-2 bg-slate-50 dark:bg-slate-700 rounded"><strong>Motivo:</strong> ${transfer.reason}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2 pt-4 border-t border-slate-200 dark:border-slate-700">
                            <button onclick="approveTransfer('${doc.id}')" class="flex-1 min-w-[120px] bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition-all">
                                九 Aprobar Transferencia
                            </button>
                            <button onclick="rejectTransfer('${doc.id}')" class="flex-1 min-w-[120px] bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition-all">
                                仇 Rechazar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error cargando transferencias pendientes:', error);
        }
    }

    async function approveTransfer(transferId) {
        try {
            const transferDoc = await db_firestore.collection('inventory_transfers').doc(transferId).get();
            if (!transferDoc.exists) {
                alert('仇 Error: Transferencia no encontrada');
                return;
            }

            const transfer = transferDoc.data();

            // Confirmar aprobaci칩n
            if (!confirm(`쮸probar transferencia de ${transfer.quantity} unidades de ${transfer.productName}?\n\nDe: ${transfer.fromVehiclePlate}\nPara: ${transfer.toVehiclePlate}\n\nEsto ajustar치 el inventario de ambos veh칤culos.`)) {
                return;
            }

            const batch = db_firestore.batch();

            // Actualizar la transferencia
            batch.update(db_firestore.collection('inventory_transfers').doc(transferId), {
                status: 'approved',
                approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                approvedBy: auth.currentUser.uid,
                approvedByName: auth.currentUser.displayName || 'Admin'
            });

            // Buscar sesiones activas de ambos veh칤culos
            const fromSessionsSnapshot = await db_firestore.collection('cash_sessions')
                .where('vehicleId', '==', transfer.fromVehicleId)
                .where('status', '==', 'open')
                .limit(1)
                .get();

            const toSessionsSnapshot = await db_firestore.collection('cash_sessions')
                .where('vehicleId', '==', transfer.toVehicleId)
                .where('status', '==', 'open')
                .limit(1)
                .get();

            if (fromSessionsSnapshot.empty || toSessionsSnapshot.empty) {
                alert('丘멆잺 Advertencia: Uno o ambos veh칤culos no tienen sesi칩n activa.\n\nLa transferencia se aprobar치 pero no se ajustar치 el inventario autom치ticamente.');
                await batch.commit();
                loadAdminTransfersPending();
                loadAdminTransfersHistory();
                calculateTransfersStats();
                return;
            }

            const fromSessionId = fromSessionsSnapshot.docs[0].id;
            const toSessionId = toSessionsSnapshot.docs[0].id;

            // Actualizar inventario del veh칤culo origen (restar)
            const fromInventorySnapshot = await db_firestore.collection('vehicle_inventory')
                .where('sessionId', '==', fromSessionId)
                .where('vehicleId', '==', transfer.fromVehicleId)
                .where('productId', '==', transfer.productId)
                .limit(1)
                .get();

            if (!fromInventorySnapshot.empty) {
                const fromInventoryDoc = fromInventorySnapshot.docs[0];
                const currentQuantity = fromInventoryDoc.data().quantity || 0;

                if (currentQuantity < transfer.quantity) {
                    alert(`仇 Error: El veh칤culo origen (${transfer.fromVehiclePlate}) no tiene suficiente inventario.\n\nDisponible: ${currentQuantity}\nSolicitado: ${transfer.quantity}`);
                    return;
                }

                const newFromQuantity = currentQuantity - transfer.quantity;

                batch.update(fromInventoryDoc.ref, {
                    quantity: newFromQuantity,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                alert(`仇 Error: No se encontr칩 inventario del producto en el veh칤culo origen.`);
                return;
            }

            // Actualizar inventario del veh칤culo destino (sumar)
            const toInventorySnapshot = await db_firestore.collection('vehicle_inventory')
                .where('sessionId', '==', toSessionId)
                .where('vehicleId', '==', transfer.toVehicleId)
                .where('productId', '==', transfer.productId)
                .limit(1)
                .get();

            if (!toInventorySnapshot.empty) {
                // Ya existe, sumamos
                const toInventoryDoc = toInventorySnapshot.docs[0];
                const currentQuantity = toInventoryDoc.data().quantity || 0;
                const newToQuantity = currentQuantity + transfer.quantity;

                batch.update(toInventoryDoc.ref, {
                    quantity: newToQuantity,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                // No existe, creamos nuevo registro
                const newInventoryRef = db_firestore.collection('vehicle_inventory').doc();
                batch.set(newInventoryRef, {
                    sessionId: toSessionId,
                    vehicleId: transfer.toVehicleId,
                    productId: transfer.productId,
                    quantity: transfer.quantity,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            await batch.commit();

            alert(`九 Transferencia aprobada exitosamente\n\nSe ha ajustado el inventario de ambos veh칤culos.`);

            // Recargar datos
            loadAdminTransfersPending();
            loadAdminTransfersHistory();
            calculateTransfersStats();

        } catch (error) {
            console.error('Error aprobando transferencia:', error);
            alert('仇 Error al aprobar la transferencia: ' + error.message);
        }
    }

    async function rejectTransfer(transferId) {
        try {
            const adminNotes = prompt('Ingrese el motivo del rechazo:');

            if (!adminNotes || adminNotes.trim() === '') {
                alert('仇 Debe ingresar un motivo para rechazar');
                return;
            }

            await db_firestore.collection('inventory_transfers').doc(transferId).update({
                status: 'rejected',
                rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                rejectedBy: auth.currentUser.uid,
                rejectedByName: auth.currentUser.displayName || 'Admin',
                adminNotes: adminNotes.trim()
            });

            alert('九 Transferencia rechazada exitosamente');

            // Recargar datos
            loadAdminTransfersPending();
            loadAdminTransfersHistory();
            calculateTransfersStats();

        } catch (error) {
            console.error('Error rechazando transferencia:', error);
            alert('仇 Error al rechazar la transferencia: ' + error.message);
        }
    }

    async function loadAdminTransfersHistory() {
        try {
            const historyContainer = document.getElementById('admin-transfers-history');
            if (!historyContainer) return;

            const filterStatus = document.getElementById('transfers-filter-status')?.value || 'all';
            const filterRequester = document.getElementById('transfers-filter-requester')?.value || 'all';

            let query = db_firestore.collection('inventory_transfers')
                .orderBy('createdAt', 'desc')
                .limit(50);

            if (filterStatus !== 'all') {
                query = query.where('status', '==', filterStatus);
            }

            if (filterRequester !== 'all') {
                query = query.where('requestedBy', '==', filterRequester);
            }

            const historySnapshot = await query.get();

            if (historySnapshot.empty) {
                historyContainer.innerHTML = '<div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md text-center text-slate-500 dark:text-slate-400">No hay transferencias en el historial</div>';
                return;
            }

            const statusColors = {
                'pending': 'border-yellow-500 bg-yellow-50 dark:bg-yellow-900/20',
                'approved': 'border-green-500 bg-green-50 dark:bg-green-900/20',
                'rejected': 'border-red-500 bg-red-50 dark:bg-red-900/20'
            };

            const statusIcons = {
                'pending': '낍',
                'approved': '九',
                'rejected': '仇'
            };

            const statusLabels = {
                'pending': 'Pendiente',
                'approved': 'Aprobado',
                'rejected': 'Rechazado'
            };

            historyContainer.innerHTML = historySnapshot.docs.map(doc => {
                const transfer = doc.data();
                return `
                    <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-md border-l-4 ${statusColors[transfer.status]}">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h4 class="text-lg font-bold text-slate-800 dark:text-white">${transfer.productName}</h4>
                                <p class="text-sm text-slate-600 dark:text-slate-300">Por: ${transfer.requestedByName}</p>
                            </div>
                            <span class="px-3 py-1 rounded-lg text-sm font-bold ${statusColors[transfer.status]}">
                                ${statusIcons[transfer.status]} ${statusLabels[transfer.status]}
                            </span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-slate-600 dark:text-slate-300">
                            <div>
                                <p><strong>Cantidad:</strong> ${transfer.quantity} unidades</p>
                                <p><strong>De:</strong> ${transfer.fromVehiclePlate}</p>
                                <p><strong>Para:</strong> ${transfer.toVehiclePlate}</p>
                            </div>
                            <div>
                                <p><strong>Fecha:</strong> ${transfer.date}</p>
                                <p><strong>Motivo:</strong> ${transfer.reason}</p>
                            </div>
                        </div>
                        ${transfer.adminNotes ? `
                            <div class="mt-3 p-3 bg-slate-100 dark:bg-slate-700 rounded-lg">
                                <p class="text-sm"><strong>Notas del Admin:</strong> ${transfer.adminNotes}</p>
                                ${transfer.approvedByName || transfer.rejectedByName ? `<p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Por: ${transfer.approvedByName || transfer.rejectedByName}</p>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error cargando historial de transferencias:', error);
        }
    }

    async function calculateTransfersStats() {
        try {
            const now = new Date();
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            // Obtener transferencias del mes actual
            const monthSnapshot = await db_firestore.collection('inventory_transfers')
                .where('createdAt', '>=', firstDayOfMonth)
                .get();

            let pendingCount = 0;
            let approvedCount = 0;
            let rejectedCount = 0;

            monthSnapshot.docs.forEach(doc => {
                const transfer = doc.data();
                if (transfer.status === 'pending') pendingCount++;
                if (transfer.status === 'approved') approvedCount++;
                if (transfer.status === 'rejected') rejectedCount++;
            });

            // Actualizar la UI
            const pendingCountEl = document.getElementById('transfers-pending-count');
            const approvedCountEl = document.getElementById('transfers-approved-count');
            const rejectedCountEl = document.getElementById('transfers-rejected-count');

            if (pendingCountEl) pendingCountEl.textContent = pendingCount;
            if (approvedCountEl) approvedCountEl.textContent = approvedCount;
            if (rejectedCountEl) rejectedCountEl.textContent = rejectedCount;

        } catch (error) {
            console.error('Error calculando estad칤sticas de transferencias:', error);
        }
    }

    async function populateTransfersRequesterFilter() {
        try {
            const select = document.getElementById('transfers-filter-requester');
            if (!select) return;

            select.innerHTML = '<option value="all">Todos los solicitantes</option>';

            const usersSnapshot = await db_firestore.collection('users')
                .where('role', '==', 'seller')
                .orderBy('name')
                .get();

            usersSnapshot.docs.forEach(doc => {
                const user = doc.data();
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = user.name || user.email;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error poblando filtro de solicitantes:', error);
        }
    }

    // ===== FUNCIONES DE INVENTARIO DE CIERRE =====

    let isLoadingClosingInventory = false;

    async function loadClosingInventory() {
        if (!db.cashRegister.isOpen || !db.cashRegister.vehicleId) {
            return;
        }

        // Prevenir m칰ltiples ejecuciones simult치neas
        if (isLoadingClosingInventory) {
            return;
        }
        isLoadingClosingInventory = true;

        try {
            // Obtener el inventario actual del veh칤culo
            const inventorySnapshot = await db_firestore.collection('vehicle_inventory')
                .where('vehicleId', '==', db.cashRegister.vehicleId)
                .where('sessionId', '==', db.cashRegister.sessionId)
                .get();

            const inventoryList = document.getElementById('closing-inventory-list');
            if (!inventoryList) return;

            inventoryList.innerHTML = '';

            // Obtener inventario de apertura de la sesi칩n
            const sessionDoc = await db_firestore.collection('cash_sessions').doc(db.cashRegister.sessionId).get();
            const sessionData = sessionDoc.data();
            const openingInventory = sessionData.openingInventory || [];

            // Mostrar KM inicial
            const displayOpeningKm = document.getElementById('display-opening-km');
            if (displayOpeningKm) {
                displayOpeningKm.textContent = sessionData.openingKm || 0;
            }

            // Crear mapa de inventario inicial
            const openingMap = {};
            openingInventory.forEach(item => {
                openingMap[item.productId] = item.quantity;
            });

            // Crear mapa de inventario actual desde Firestore
            const currentMap = {};
            inventorySnapshot.docs.forEach(doc => {
                const data = doc.data();
                currentMap[data.productId] = data.quantity;
            });

            // Combinar ambos: usar todos los productos que tengan cantidad inicial O actual
            const allProductIds = new Set([...Object.keys(openingMap), ...Object.keys(currentMap)]);

            // Crear lista de productos con inventario
            allProductIds.forEach(productId => {
                const product = db.products.find(p => p.id === productId);
                if (!product) return;

                const initialQty = openingMap[productId] || 0;
                const currentQty = currentMap[productId] || 0;

                const div = document.createElement('div');
                div.className = 'flex items-center justify-between gap-3 bg-slate-50 dark:bg-slate-700 p-3 rounded-lg';
                div.dataset.productId = product.id;
                div.dataset.initialQty = initialQty;

                const categoryLabels = {
                    'bidon_lleno': 'Bid칩n Lleno',
                    'bidon_vacio': 'Bid칩n Vac칤o',
                    'recarga': 'Recarga',
                    'equipo': 'Equipo',
                    'paca': 'Paca'
                };

                div.innerHTML = `
                    <div class="flex-1">
                        <div class="font-semibold text-slate-900 dark:text-white">${product.name}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">
                            ${categoryLabels[product.category] || product.category}  Inicial: ${initialQty}
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button type="button" onclick="changeClosingInvQty('${product.id}', -1)" class="bg-red-500 text-white w-8 h-8 rounded-lg hover:bg-red-600">-</button>
                        <input type="number" id="closing-inv-${product.id}" value="${currentQty}" min="0" class="w-20 p-2 border-2 rounded-lg text-center dark:bg-slate-600 dark:border-slate-500 dark:text-white">
                        <button type="button" onclick="changeClosingInvQty('${product.id}', 1)" class="bg-green-500 text-white w-8 h-8 rounded-lg hover:bg-green-600">+</button>
                    </div>
                `;

                inventoryList.appendChild(div);
            });
        } catch (error) {
            console.error('Error al cargar inventario de cierre:', error);
        } finally {
            isLoadingClosingInventory = false;
        }
    }

    function changeClosingInvQty(productId, delta) {
        const input = document.getElementById(`closing-inv-${productId}`);
        if (input) {
            const currentQty = parseInt(input.value) || 0;
            const newQty = Math.max(0, currentQty + delta);
            input.value = newQty;
        }
    }

    async function calculateInventoryDifferences() {
        const inventoryList = document.getElementById('closing-inventory-list');
        if (!inventoryList) return;

        const differencesSection = document.getElementById('inventory-differences-section');
        const differencesList = document.getElementById('inventory-differences-list');

        if (!differencesSection || !differencesList) return;

        const items = inventoryList.querySelectorAll('[data-product-id]');
        const differences = [];

        // Calcular diferencias de inventario
        items.forEach(item => {
            const productId = item.dataset.productId;
            const initialQty = parseInt(item.dataset.initialQty) || 0;
            const closingInput = document.getElementById(`closing-inv-${productId}`);
            const closingQty = parseInt(closingInput.value) || 0;

            const product = db.products.find(p => p.id === productId);
            if (!product) return;

            // Calcular ventas del d칤a de este producto
            const todaySales = db.sales.filter(s => s.date === getCurrentDate() && s.sellerId === auth.currentUser.uid);
            const soldQty = todaySales.reduce((sum, sale) => {
                const saleItem = sale.items.find(i => i.productId === productId);
                return sum + (saleItem ? saleItem.quantity : 0);
            }, 0);

            const expectedQty = initialQty - soldQty;
            const difference = closingQty - expectedQty;

            if (difference !== 0) {
                differences.push({
                    productName: product.name,
                    initial: initialQty,
                    sold: soldQty,
                    expected: expectedQty,
                    physical: closingQty,
                    difference: difference
                });
            }
        });

        // Mostrar diferencias
        if (differences.length === 0) {
            differencesList.innerHTML = '<p class="text-green-600 dark:text-green-400 font-semibold">九 No hay diferencias de inventario</p>';
            differencesSection.classList.remove('hidden');
        } else {
            differencesList.innerHTML = differences.map(diff => {
                const diffClass = diff.difference > 0 ? 'text-blue-600 dark:text-blue-400' : 'text-red-600 dark:text-red-400';
                const diffSign = diff.difference > 0 ? '+' : '';
                const diffIcon = diff.difference > 0 ? '游늳' : '游늴';

                return `
                    <div class="flex justify-between items-center p-2 bg-white dark:bg-slate-800 rounded">
                        <div class="flex-1">
                            <div class="font-semibold text-slate-900 dark:text-white">${diff.productName}</div>
                            <div class="text-xs text-slate-600 dark:text-slate-400">
                                Inicial: ${diff.initial} | Vendido: ${diff.sold} | Esperado: ${diff.expected} | F칤sico: ${diff.physical}
                            </div>
                        </div>
                        <div class="${diffClass} font-bold text-lg">
                            ${diffIcon} ${diffSign}${diff.difference}
                        </div>
                    </div>
                `;
            }).join('');
            differencesSection.classList.remove('hidden');
        }

        // Calcular kilometraje recorrido
        const closingKm = parseInt(document.getElementById('closing-km').value) || 0;
        const openingKm = db.cashRegister.openingKm || 0;
        const kmTraveled = closingKm - openingKm;

        if (kmTraveled > 0) {
            const kmInfo = document.createElement('div');
            kmInfo.className = 'mt-3 p-2 bg-blue-50 dark:bg-blue-900/30 rounded';
            kmInfo.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-slate-900 dark:text-white">游뚱 Kil칩metros Recorridos:</span>
                    <span class="font-bold text-blue-600 dark:text-blue-400 text-lg">${kmTraveled} km</span>
                </div>
            `;
            differencesList.appendChild(kmInfo);
        }

        alert('九 Diferencias calculadas. Revise la secci칩n de abajo.');
    }

    async function closeCashRegister() {
        const physicalCash = parseFloat(document.getElementById('closure-physical-cash').value) || 0;

        if (physicalCash === 0) {
            alert('Por favor, ingrese el efectivo f칤sico contado antes de cerrar la caja.');
            return;
        }

        const { openingBalance, transactions } = db.cashRegister;

        // Obtener las ventas del d칤a del vendedor actual
        const todaySales = db.sales.filter(s => s.date === getCurrentDate() && s.sellerId === auth.currentUser.uid);
        const todayExpenses = db.expenses.filter(e => e.date === getCurrentDate() && e.sellerId === auth.currentUser.uid);
        const todayCollections = db.collections.filter(c => c.date === getCurrentDate() && c.sellerId === auth.currentUser.uid);

        // Calcular totales por m칠todo de pago desde db.sales (TODAS las ventas del d칤a)
        const cashSales = todaySales.filter(s => s.paymentMethod === 'efectivo').reduce((sum, s) => sum + s.total, 0);
        const creditSales = todaySales.filter(s => s.paymentMethod === 'credito').reduce((sum, s) => sum + s.total, 0);
        const transferSales = todaySales.filter(s => s.paymentMethod === 'transferencia').reduce((sum, s) => sum + s.total, 0);

        // Gastos en efectivo del d칤a
        const cashExpenses = todayExpenses.filter(e => e.paymentMethod === 'efectivo').reduce((sum, e) => sum + e.amount, 0);

        // Cobros/ingresos adicionales del d칤a
        const collections = todayCollections.reduce((sum, c) => sum + c.amount, 0);

        // Calcular abonos de cr칠ditos del d칤a (en efectivo)
        let creditPayments = 0;
        const creditSalesToday = todaySales.filter(s => s.paymentMethod === 'credito');

        try {
            for (const sale of creditSalesToday) {
                const paymentsSnapshot = await db_firestore.collection('sales').doc(sale.id).collection('payments').get();
                const todayPayments = paymentsSnapshot.docs
                    .filter(doc => doc.data().date === getCurrentDate())
                    .reduce((sum, doc) => sum + doc.data().amount, 0);
                creditPayments += todayPayments;
            }
        } catch (error) {
            console.error('Error al calcular abonos de cr칠ditos:', error);
        }

        const expectedCash = openingBalance + cashSales + collections + creditPayments - cashExpenses;
        const difference = physicalCash - expectedCash;

        // Mostrar efectivo esperado y diferencia
        document.getElementById('closure-expected-section').classList.remove('hidden');
        document.getElementById('closure-difference-section').classList.remove('hidden');
        document.getElementById('closure-expected-cash').textContent = `$${expectedCash.toFixed(2)}`;
        document.getElementById('closure-difference').textContent = `$${difference.toFixed(2)}`;

        // Actualizar color de la diferencia
        const diffSection = document.getElementById('closure-difference-section');
        if (difference < 0) {
            diffSection.classList.remove('bg-yellow-50', 'dark:bg-yellow-900/30', 'border-yellow-300', 'dark:border-yellow-700');
            diffSection.classList.add('bg-red-50', 'dark:bg-red-900/30', 'border-red-300', 'dark:border-red-700');
            document.getElementById('closure-difference').classList.add('text-red-800', 'dark:text-red-300');
        } else if (difference > 0) {
            diffSection.classList.remove('bg-yellow-50', 'dark:bg-yellow-900/30', 'border-yellow-300', 'dark:border-yellow-700');
            diffSection.classList.add('bg-green-50', 'dark:bg-green-900/30', 'border-green-300', 'dark:border-green-700');
            document.getElementById('closure-difference').classList.add('text-green-800', 'dark:text-green-300');
        }

        // Recopilar inventario final
        const closingInventory = [];
        const closingInventoryList = document.getElementById('closing-inventory-list');
        if (closingInventoryList) {
            const items = closingInventoryList.querySelectorAll('[data-product-id]');
            items.forEach(item => {
                const productId = item.dataset.productId;
                const initialQty = parseInt(item.dataset.initialQty) || 0;
                const closingInput = document.getElementById(`closing-inv-${productId}`);
                const closingQty = parseInt(closingInput?.value) || 0;

                if (initialQty > 0 || closingQty > 0) {
                    closingInventory.push({
                        productId: productId,
                        initialQuantity: initialQty,
                        quantity: closingQty,
                        difference: closingQty - initialQty
                    });
                }
            });
        }

        const closingKm = parseInt(document.getElementById('closing-km')?.value) || 0;
        const openingKm = db.cashRegister.openingKm || 0;

        // Confirmar el cierre
        const confirmMsg = `쮺onfirmar cierre de caja?\n\nEfectivo Esperado: $${expectedCash.toFixed(2)}\nEfectivo Contado: $${physicalCash.toFixed(2)}\nDiferencia: $${difference.toFixed(2)}\n\nKM Recorridos: ${closingKm - openingKm} km`;

        if (!confirm(confirmMsg)) {
            return;
        }

        const closureData = {
            sellerId: auth.currentUser.uid,
            vehicleId: db.cashRegister.vehicleId || null,
            vehiclePlate: db.cashRegister.vehiclePlate || null,
            closeTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
            openingBalance, cashSales, cashExpenses, collections, creditPayments, expectedCash, physicalCash, difference,
            creditSales, transferSales, transactions,
            openingKm: openingKm,
            closingKm: closingKm,
            kmTraveled: closingKm - openingKm,
            closingInventory: closingInventory
        };

        try {
            await db_firestore.collection('cash_closures').add(closureData);

            // Cerrar la sesi칩n de caja en Firestore
            if (db.cashRegister.sessionId) {
                await db_firestore.collection('cash_sessions').doc(db.cashRegister.sessionId).update({
                    isOpen: false,
                    closedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    physicalCash,
                    difference,
                    closingKm: closingKm,
                    closingInventory: closingInventory
                });
            }

            // Actualizar inventario del veh칤culo en Firestore
            if (db.cashRegister.vehicleId && closingInventory.length > 0) {
                // Eliminar inventario antiguo de esta sesi칩n
                const oldInventorySnapshot = await db_firestore.collection('vehicle_inventory')
                    .where('vehicleId', '==', db.cashRegister.vehicleId)
                    .where('sessionId', '==', db.cashRegister.sessionId)
                    .get();

                const batch = db_firestore.batch();

                oldInventorySnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                // Agregar nuevo inventario final (sin sessionId, ya que la sesi칩n est치 cerrada)
                closingInventory.forEach(item => {
                    if (item.quantity > 0) {
                        const invRef = db_firestore.collection('vehicle_inventory').doc();
                        batch.set(invRef, {
                            vehicleId: db.cashRegister.vehicleId,
                            productId: item.productId,
                            quantity: item.quantity,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });

                await batch.commit();
            }

            // Mostrar reporte en modal
            const closureDate = getCurrentDate(); // Guardar la fecha del cierre
            document.getElementById('report-date').textContent = new Date().toLocaleString();
            document.getElementById('report-date').setAttribute('data-closure-date', closureDate); // Guardar fecha en formato YYYY-MM-DD
            document.getElementById('report-initial').textContent = `$${openingBalance.toFixed(2)}`;
            document.getElementById('report-cash-sales').textContent = `$${cashSales.toFixed(2)}`;
            document.getElementById('report-collections').textContent = `$${collections.toFixed(2)}`;
            document.getElementById('report-credit-payments').textContent = `$${creditPayments.toFixed(2)}`;
            document.getElementById('report-cash-expenses').textContent = `-$${cashExpenses.toFixed(2)}`;
            document.getElementById('report-total').textContent = `$${expectedCash.toFixed(2)}`;
            document.getElementById('report-physical-cash').textContent = `$${physicalCash.toFixed(2)}`;
            const diffEl = document.getElementById('report-difference');
            diffEl.textContent = `${difference < 0 ? 'Faltante: ' : 'Sobrante: '}$${Math.abs(difference).toFixed(2)}`;
            diffEl.className = `font-bold text-xl ${difference < 0 ? 'text-red-500' : 'text-green-500'}`;

            // Cargar informaci칩n de meta diaria
            await loadDailyGoalForClosure(closureDate, todaySales);

            document.getElementById('cash-close-report-modal').classList.remove('hidden');

            // Detener listener de inventario
            stopVehicleInventoryListener();

            // Resetear caja y ocultar secciones de nuevo
            db.cashRegister = { isOpen: false, openingBalance: 0, transactions: [] };
            document.getElementById('closure-physical-cash').value = '';
            document.getElementById('closure-expected-section').classList.add('hidden');
            document.getElementById('closure-difference-section').classList.add('hidden');

            // Limpiar localStorage
            localStorage.removeItem(`cashRegister_${auth.currentUser.uid}`);

            checkCashRegisterStatus();
        } catch(error) {
            console.error('Error al guardar el cierre:', error);

            // Si estamos offline, guardar cierre localmente
            if (!navigator.onLine || error.code === 'unavailable') {
                // Guardar cierre local
                const localClosure = {
                    ...closureData,
                    closeTimestamp: new Date().toISOString(),
                    pendingSync: true,
                    localId: 'closure_' + Date.now()
                };

                // Guardar en localStorage para sincronizaci칩n posterior
                const pendingClosures = JSON.parse(localStorage.getItem('pendingClosures') || '[]');
                pendingClosures.push(localClosure);
                localStorage.setItem('pendingClosures', JSON.stringify(pendingClosures));

                // Mostrar reporte en modal
                const closureDate = getCurrentDate();
                document.getElementById('report-date').textContent = new Date().toLocaleString();
                document.getElementById('report-date').setAttribute('data-closure-date', closureDate);
                document.getElementById('report-initial').textContent = `$${openingBalance.toFixed(2)}`;
                document.getElementById('report-cash-sales').textContent = `$${cashSales.toFixed(2)}`;
                document.getElementById('report-collections').textContent = `$${collections.toFixed(2)}`;
                document.getElementById('report-credit-payments').textContent = `$${creditPayments.toFixed(2)}`;
                document.getElementById('report-cash-expenses').textContent = `-$${cashExpenses.toFixed(2)}`;
                document.getElementById('report-total').textContent = `$${expectedCash.toFixed(2)}`;
                document.getElementById('report-physical-cash').textContent = `$${physicalCash.toFixed(2)}`;
                const diffEl = document.getElementById('report-difference');
                diffEl.textContent = `${difference < 0 ? 'Faltante: ' : 'Sobrante: '}$${Math.abs(difference).toFixed(2)}`;
                diffEl.className = `font-bold text-xl ${difference < 0 ? 'text-red-500' : 'text-green-500'}`;

                document.getElementById('cash-close-report-modal').classList.remove('hidden');

                // Detener listener de inventario
                stopVehicleInventoryListener();

                // Resetear caja
                db.cashRegister = { isOpen: false, openingBalance: 0, transactions: [] };
                document.getElementById('closure-physical-cash').value = '';
                document.getElementById('closure-expected-section').classList.add('hidden');
                document.getElementById('closure-difference-section').classList.add('hidden');

                // Limpiar localStorage de caja
                localStorage.removeItem(`cashRegister_${auth.currentUser.uid}`);

                checkCashRegisterStatus();

                alert('九 Caja cerrada en modo offline. Los datos se sincronizar치n cuando haya conexi칩n.');
            } else {
                alert("仇 Error al guardar el cierre: " + error.message);
            }
        }
    }

    async function syncPendingClosures() {
        try {
            const pendingClosures = JSON.parse(localStorage.getItem('pendingClosures') || '[]');

            if (pendingClosures.length === 0) {
                return;
            }

            console.log(`游닋 Sincronizando ${pendingClosures.length} cierres pendientes...`);

            for (const closure of pendingClosures) {
                try {
                    // Convertir timestamp ISO string a Firestore Timestamp
                    const closureData = {
                        ...closure,
                        closeTimestamp: firebase.firestore.Timestamp.fromDate(new Date(closure.closeTimestamp))
                    };
                    delete closureData.pendingSync;
                    delete closureData.localId;

                    // Guardar en Firestore
                    await db_firestore.collection('cash_closures').add(closureData);

                    // Actualizar sesi칩n si existe
                    if (closure.sessionId && !closure.sessionId.startsWith('temp_')) {
                        await db_firestore.collection('cash_sessions').doc(closure.sessionId).update({
                            isOpen: false,
                            closedAt: firebase.firestore.Timestamp.fromDate(new Date(closure.closeTimestamp)),
                            physicalCash: closure.physicalCash,
                            difference: closure.difference,
                            closingKm: closure.closingKm,
                            closingInventory: closure.closingInventory
                        });
                    }

                    console.log(`九 Cierre ${closure.localId} sincronizado`);
                } catch (error) {
                    console.error(`仇 Error sincronizando cierre ${closure.localId}:`, error);
                }
            }

            // Limpiar cierres sincronizados
            localStorage.removeItem('pendingClosures');
            console.log('九 Todos los cierres pendientes sincronizados');
        } catch (error) {
            console.error('Error al sincronizar cierres pendientes:', error);
        }
    }

    async function loadDailyGoalForClosure(closureDate, todaySales) {
        const goalContent = document.getElementById('report-daily-goal-content');
        if (!goalContent) return;

        try {
            // Obtener meta del vendedor actual para el mes de cierre
            const [year, month] = closureDate.split('-');
            const monthKey = `${year}-${month}`;

            const goalsSnapshot = await db_firestore.collection('sales_goals')
                .where('sellerId', '==', auth.currentUser.uid)
                .where('month', '==', monthKey)
                .get();

            if (goalsSnapshot.empty) {
                goalContent.innerHTML = '<p class="text-slate-600 dark:text-slate-400 text-sm">No hay meta asignada para este mes</p>';
                return;
            }

            const goal = goalsSnapshot.docs[0].data();

            // Calcular meta diaria
            const lastDay = new Date(parseInt(year), parseInt(month), 0).getDate();
            const dailyGoal = goal.goalAmount / lastDay;

            // Calcular total de ventas del d칤a (todas las formas de pago)
            const totalDaySales = todaySales.reduce((sum, s) => sum + s.total, 0);

            // Calcular porcentaje de cumplimiento del d칤a
            const dailyPercentage = (totalDaySales / dailyGoal) * 100;

            // Determinar color seg칰n cumplimiento
            let statusColor, statusIcon, statusText;
            if (dailyPercentage >= 100) {
                statusColor = 'text-green-600 dark:text-green-400';
                statusIcon = '九';
                statusText = '춰Meta diaria alcanzada!';
            } else if (dailyPercentage >= 75) {
                statusColor = 'text-yellow-600 dark:text-yellow-400';
                statusIcon = '丘';
                statusText = 'Cerca de la meta';
            } else {
                statusColor = 'text-red-600 dark:text-red-400';
                statusIcon = '丘멆잺';
                statusText = 'Por debajo de la meta';
            }

            goalContent.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="text-slate-700 dark:text-slate-300">Meta Diaria:</span>
                    <span class="font-bold text-slate-900 dark:text-white">$${dailyGoal.toFixed(2)}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-slate-700 dark:text-slate-300">Vendido Hoy:</span>
                    <span class="font-bold text-slate-900 dark:text-white">$${totalDaySales.toFixed(2)}</span>
                </div>
                <div class="flex justify-between items-center pt-2 border-t border-blue-200 dark:border-blue-700">
                    <span class="text-slate-700 dark:text-slate-300">Cumplimiento:</span>
                    <span class="font-bold ${statusColor}">${statusIcon} ${dailyPercentage.toFixed(0)}%</span>
                </div>
                <p class="text-sm ${statusColor} font-semibold text-center mt-2">${statusText}</p>
            `;
        } catch (error) {
            console.error('Error al cargar meta diaria:', error);
            goalContent.innerHTML = '<p class="text-slate-600 dark:text-slate-400 text-sm">Error al cargar informaci칩n de meta</p>';
        }
    }

    async function renderCreditAccounts(searchTerm = '', statusFilter = 'all') {
        const list = document.getElementById('credit-sales-list');
        if (!list) return;

        list.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-slate-500">Cargando...</td></tr>';

        const lowerCaseSearchTerm = searchTerm.toLowerCase();
        const creditSales = db.sales.filter(s => s.paymentMethod === 'credito' && (s.clientName || '').toLowerCase().includes(lowerCaseSearchTerm));

        let totalPending = 0;
        let totalSales = 0;
        let totalPayments = 0;
        let paidCount = 0;
        let pendingAccounts = [];

        list.innerHTML = '';

        if (creditSales.length === 0) {
            list.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-slate-500">No hay cuentas por cobrar${searchTerm ? ' que coincidan.' : '.'}</td></tr>`;
            updateCreditSummary(0, 0, 0, 0, 0);
            return;
        }

        for (const sale of creditSales) {
            const paymentsSnapshot = await db_firestore.collection('sales').doc(sale.id).collection('payments').get();
            const totalPaid = paymentsSnapshot.docs.reduce((sum, doc) => sum + doc.data().amount, 0);
            const balance = sale.total - totalPaid;
            const isPaid = balance <= 0;

            totalSales += sale.total;
            totalPayments += totalPaid;

            if (isPaid) {
                paidCount++;
            } else {
                totalPending += balance;
            }

            // Aplicar filtro de estado
            if (statusFilter === 'pending' && isPaid) continue;
            if (statusFilter === 'paid' && !isPaid) continue;

            const statusBadge = isPaid
                ? '<span class="px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs rounded-full">Saldada</span>'
                : '<span class="px-2 py-1 bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200 text-xs rounded-full">Pendiente</span>';

            list.innerHTML += `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
                    <td class="py-3 px-4 text-xs">${sale.date}</td>
                    <td class="py-3 px-4 text-xs font-medium">${sale.clientName}</td>
                    <td class="py-3 px-4 text-xs">$${sale.total.toFixed(2)}</td>
                    <td class="py-3 px-4 text-xs text-blue-600 dark:text-blue-400">$${totalPaid.toFixed(2)}</td>
                    <td class="py-3 px-4 text-xs font-bold ${isPaid ? 'text-green-600' : 'text-red-600'}">$${balance.toFixed(2)}</td>
                    <td class="py-3 px-4">${statusBadge}</td>
                    <td class="py-3 px-4">
                        ${!isPaid ? `<button onclick="openPaymentModal('${sale.id}', ${balance})" class="text-blue-500 hover:text-blue-700 text-xs font-medium hover:underline">游눯 Abonar</button>` : '<span class="text-xs text-slate-400">-</span>'}
                    </td>
                </tr>`;
        }

        updateCreditSummary(totalPending, totalSales, totalPayments, paidCount, creditSales.length - paidCount);
    }

    function updateCreditSummary(totalPending, totalSales, totalPayments, paidCount, pendingCount) {
        document.getElementById('credit-total-pending').textContent = `$${totalPending.toFixed(2)}`;
        document.getElementById('credit-accounts-count').textContent = `${pendingCount} cuenta${pendingCount !== 1 ? 's' : ''}`;
        document.getElementById('credit-total-sales').textContent = `$${totalSales.toFixed(2)}`;
        document.getElementById('credit-total-payments').textContent = `$${totalPayments.toFixed(2)}`;
        document.getElementById('credit-paid-count').textContent = paidCount.toString();
    }
    function openPaymentModal(saleId, balance) { const modal = document.getElementById('payment-modal'); const form = document.getElementById('add-payment-form'); const amountInput = document.getElementById('payment-amount'); form.dataset.saleId = saleId; document.getElementById('payment-modal-balance').textContent = `$${balance.toFixed(2)}`; amountInput.max = balance; modal.classList.remove('hidden'); }
    function closePaymentModal() { document.getElementById('payment-modal').classList.add('hidden'); }
    async function finalizePayment(e) { e.preventDefault(); if (!db.cashRegister.isOpen) { alert("Abra la caja primero para registrar un cobro."); return; } const form = e.target; const saleId = form.dataset.saleId; const amount = parseFloat(document.getElementById('payment-amount').value); const balance = parseFloat(document.getElementById('payment-modal-balance').textContent.replace('$', '')); if (isNaN(amount) || amount <= 0 || amount > balance) { alert('Monto inv치lido.'); return; } const paymentData = { amount, date: getCurrentDate(), sellerId: auth.currentUser.uid }; const sale = db.sales.find(s => s.id === saleId); db.cashRegister.transactions.push({ type: 'collection', amount, reason: `Abono a venta para ${sale.clientName}` }); updateCashClosureSummary(); updateSellerDashboard(); renderCreditAccounts(); closePaymentModal(); alert(navigator.onLine ? 'Abono registrado con 칠xito.' : 'Abono guardado localmente. Se sincronizar치 al recuperar la conexi칩n.'); db_firestore.collection('sales').doc(saleId).collection('payments').add(paymentData).catch(error => console.error("Error al sincronizar abono con Firestore: ", error)); }

    // ===== INGRESOS ADICIONALES =====
    function updateCollectionsModule() {
        const todayCollections = db.collections.filter(c => c.date === getCurrentDate() && c.sellerId === auth.currentUser.uid);
        const currentMonth = getCurrentDate().substring(0, 7); // YYYY-MM
        const monthCollections = db.collections.filter(c => c.date.startsWith(currentMonth) && c.sellerId === auth.currentUser.uid);

        const todayTotal = todayCollections.reduce((sum, c) => sum + c.amount, 0);
        const monthTotal = monthCollections.reduce((sum, c) => sum + c.amount, 0);
        const maxAmount = Math.max(...todayCollections.map(c => c.amount), 0);

        document.getElementById('collections-today-total').textContent = `$${todayTotal.toFixed(2)}`;
        document.getElementById('collections-today-count').textContent = `${todayCollections.length} ingreso${todayCollections.length !== 1 ? 's' : ''}`;
        document.getElementById('collections-month-total').textContent = `$${monthTotal.toFixed(2)}`;
        document.getElementById('collections-max').textContent = `$${maxAmount.toFixed(2)}`;

        // Renderizar historial del d칤a
        const listContainer = document.getElementById('collections-today-list');
        if (todayCollections.length === 0) {
            listContainer.innerHTML = '<div class="text-center text-slate-500 py-4">No hay ingresos registrados hoy.</div>';
        } else {
            listContainer.innerHTML = todayCollections.sort((a, b) => b.amount - a.amount).map(c => `
                <div class="p-3 bg-slate-50 dark:bg-slate-700 rounded-lg">
                    <div class="flex justify-between items-start mb-1">
                        <div class="font-medium text-sm">${c.clientName}</div>
                        <div class="font-bold text-green-600 dark:text-green-400">$${c.amount.toFixed(2)}</div>
                    </div>
                    <div class="text-xs text-slate-600 dark:text-slate-400">${c.reason}</div>
                </div>
            `).join('');
        }
    }

    // ===== GASTOS =====
    function updateExpensesModule() {
        initializeExpenseTypeListener();
        const todayExpenses = db.expenses.filter(e => e.date === getCurrentDate() && e.sellerId === auth.currentUser.uid);

        const todayTotal = todayExpenses.reduce((sum, e) => sum + e.amount, 0);
        const cashExpenses = todayExpenses.filter(e => e.paymentMethod === 'efectivo').reduce((sum, e) => sum + e.amount, 0);
        const otherExpenses = todayExpenses.filter(e => e.paymentMethod !== 'efectivo').reduce((sum, e) => sum + e.amount, 0);
        const maxAmount = Math.max(...todayExpenses.map(e => e.amount), 0);

        document.getElementById('expenses-today-total').textContent = `$${todayTotal.toFixed(2)}`;
        document.getElementById('expenses-today-count').textContent = `${todayExpenses.length} gasto${todayExpenses.length !== 1 ? 's' : ''}`;
        document.getElementById('expenses-cash-total').textContent = `$${cashExpenses.toFixed(2)}`;
        document.getElementById('expenses-other-total').textContent = `$${otherExpenses.toFixed(2)}`;
        document.getElementById('expenses-max').textContent = `$${maxAmount.toFixed(2)}`;

        // Renderizar historial del d칤a
        const listContainer = document.getElementById('expenses-today-list');
        if (todayExpenses.length === 0) {
            listContainer.innerHTML = '<div class="text-center text-slate-500 py-4">No hay gastos registrados hoy.</div>';
        } else {
            listContainer.innerHTML = todayExpenses.sort((a, b) => b.amount - a.amount).map(e => {
                const paymentIcons = { 'efectivo': '游눳', 'transferencia': '游눱', 'credito': '游낁' };
                const icon = paymentIcons[e.paymentMethod] || '游눯';
                return `
                    <div class="p-3 bg-slate-50 dark:bg-slate-700 rounded-lg">
                        <div class="flex justify-between items-start mb-1">
                            <div class="font-medium text-sm">${e.categoryName}</div>
                            <div class="font-bold text-red-600 dark:text-red-400">$${e.amount.toFixed(2)}</div>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-xs text-slate-600 dark:text-slate-400">${e.observations || 'Sin observaciones'}</div>
                            <div class="text-xs">${icon}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Gastos por categor칤a
        const expensesByCategory = {};
        todayExpenses.forEach(e => {
            if (!expensesByCategory[e.categoryId]) {
                expensesByCategory[e.categoryId] = { name: e.categoryName, total: 0, count: 0 };
            }
            expensesByCategory[e.categoryId].total += e.amount;
            expensesByCategory[e.categoryId].count++;
        });

        const categoryContainer = document.getElementById('expenses-by-category');
        const categories = Object.values(expensesByCategory).sort((a, b) => b.total - a.total);

        if (categories.length === 0) {
            categoryContainer.innerHTML = '<div class="col-span-full text-center text-slate-500 py-4">No hay gastos por categor칤a hoy.</div>';
        } else {
            const maxCategoryTotal = categories[0].total;
            categoryContainer.innerHTML = categories.map(cat => {
                const percentage = (cat.total / maxCategoryTotal) * 100;
                return `
                    <div class="p-4 bg-slate-50 dark:bg-slate-700 rounded-lg">
                        <div class="font-medium text-sm mb-2">${cat.name}</div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-slate-600 dark:text-slate-400">${cat.count} gasto${cat.count !== 1 ? 's' : ''}</span>
                            <span class="font-bold text-red-600 dark:text-red-400">$${cat.total.toFixed(2)}</span>
                        </div>
                        <div class="w-full bg-slate-200 dark:bg-slate-600 rounded-full h-2 mt-2">
                            <div class="bg-gradient-to-r from-red-500 to-pink-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    }

    // Inicializar listener para cambio de tipo de gasto
    function initializeExpenseTypeListener() {
        const expenseCategorySelector = document.getElementById('expense-category-selector');
        if (expenseCategorySelector) {
            expenseCategorySelector.addEventListener('change', function() {
                const selectedType = db.expenseTypes.find(et => et.id === this.value);
                const normalFields = document.getElementById('normal-expense-fields');
                const purchaseFields = document.getElementById('product-purchase-fields');

                // Verificar si es "Compra de Productos"
                if (selectedType && selectedType.name.toLowerCase().includes('compra de productos')) {
                    normalFields.classList.add('hidden');
                    purchaseFields.classList.remove('hidden');
                    renderProductPurchaseList();
                } else {
                    normalFields.classList.remove('hidden');
                    purchaseFields.classList.add('hidden');
                }
            });
        }
    }

    // Carrito de compra de productos (SIN mostrar costos)
    let purchaseCart = [];

    function renderProductPurchaseList() {
        const searchInput = document.getElementById('purchase-product-search');
        const searchResults = document.getElementById('purchase-search-results');

        if (searchInput) {
            // Limpiar listener anterior
            searchInput.removeEventListener('input', handlePurchaseSearch);
            // Agregar nuevo listener
            searchInput.addEventListener('input', handlePurchaseSearch);
        }

        renderPurchaseCart();
    }

    function handlePurchaseSearch(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        const searchResults = document.getElementById('purchase-search-results');

        if (!searchTerm) {
            searchResults.classList.add('hidden');
            return;
        }

        const filteredProducts = db.products.filter(p =>
            p.name.toLowerCase().includes(searchTerm)
        );

        if (filteredProducts.length === 0) {
            searchResults.innerHTML = '<p class="text-sm text-slate-500 p-2">No se encontraron productos</p>';
            searchResults.classList.remove('hidden');
            return;
        }

        searchResults.innerHTML = filteredProducts.map(p => `
            <div onclick="addToProductPurchaseCart('${p.id}')" class="p-2 hover:bg-blue-100 dark:hover:bg-blue-900 cursor-pointer rounded border-b dark:border-slate-600">
                <div class="font-medium text-sm">${p.name}</div>
            </div>
        `).join('');
        searchResults.classList.remove('hidden');
    }

    function addToProductPurchaseCart(productId) {
        const product = db.products.find(p => p.id === productId);
        if (!product) return;

        const existingItem = purchaseCart.find(item => item.productId === productId);

        if (existingItem) {
            existingItem.quantity++;
        } else {
            purchaseCart.push({
                productId: product.id,
                productName: product.name,
                quantity: 1
            });
        }

        // Limpiar b칰squeda
        document.getElementById('purchase-product-search').value = '';
        document.getElementById('purchase-search-results').classList.add('hidden');

        renderPurchaseCart();
    }

    function updatePurchaseQuantity(productId, newQuantity) {
        const item = purchaseCart.find(i => i.productId === productId);
        if (item) {
            item.quantity = Math.max(1, parseInt(newQuantity) || 1);
            renderPurchaseCart();
        }
    }

    function removePurchaseItem(productId) {
        purchaseCart = purchaseCart.filter(i => i.productId !== productId);
        renderPurchaseCart();
    }

    function renderPurchaseCart() {
        const cartContainer = document.getElementById('purchase-cart-items');
        const totalDisplay = document.getElementById('purchase-total-display');
        const totalAmount = document.getElementById('purchase-total-amount');

        if (!cartContainer) return;

        if (purchaseCart.length === 0) {
            cartContainer.innerHTML = '<p class="text-sm text-slate-500 dark:text-slate-400 text-center py-4">No hay productos agregados</p>';
            if (totalDisplay) totalDisplay.classList.add('hidden');
            return;
        }

        cartContainer.innerHTML = purchaseCart.map(item => `
            <div class="flex items-center gap-3 p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600">
                <div class="flex-1">
                    <div class="font-medium text-sm">${item.productName}</div>
                </div>
                <div class="flex items-center gap-2">
                    <button type="button" onclick="updatePurchaseQuantity('${item.productId}', ${item.quantity - 1})" class="w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-lg flex items-center justify-center font-bold">-</button>
                    <input type="number" value="${item.quantity}" min="1" onchange="updatePurchaseQuantity('${item.productId}', this.value)" class="w-16 text-center p-1 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                    <button type="button" onclick="updatePurchaseQuantity('${item.productId}', ${item.quantity + 1})" class="w-8 h-8 bg-green-500 hover:bg-green-600 text-white rounded-lg flex items-center justify-center font-bold">+</button>
                    <button type="button" onclick="removePurchaseItem('${item.productId}')" class="w-8 h-8 bg-slate-400 hover:bg-slate-500 text-white rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>
        `).join('');

        // Mostrar total
        const total = calculatePurchaseTotal();
        if (totalDisplay && totalAmount) {
            totalDisplay.classList.remove('hidden');
            totalAmount.textContent = `$${total.toFixed(2)}`;
        }
    }

    function calculatePurchaseTotal() {
        // Calcula el total y lo muestra
        let total = 0;
        purchaseCart.forEach(item => {
            const product = db.products.find(p => p.id === item.productId);
            if (product) {
                const cost = product.cost || 0;
                total += item.quantity * cost;
            }
        });

        return total;
    }

    // Eliminar funciones antiguas
    function increaseProductQuantity(productId) {
        // Ya no se usa
    }

    function decreaseProductQuantity(productId) {
        // Ya no se usa
    }

    function filterClosures() { let query = db_firestore.collection('cash_closures'); const startDate = document.getElementById('closure-start-date').value; const endDate = document.getElementById('closure-end-date').value; if(startDate) query = query.where('closeTimestamp', '>=', new Date(startDate)); if(endDate) query = query.where('closeTimestamp', '<=', new Date(endDate + 'T23:59:59')); query.get().then(snapshot => { const closures = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})); renderClosuresList(closures); }); }
    function renderClosuresList(closures) {
        const list = document.getElementById('closures-list');
        list.innerHTML = '';
        closures.forEach(c => {
            const diff = c.difference;
            const diffText = `${diff < 0 ? 'Faltante' : 'Sobrante'}: $${Math.abs(diff).toFixed(2)}`;
            const seller = db.usersMap[c.sellerId];
            const sellerName = seller ? (seller.displayName || seller.name || seller.email) : 'Usuario';
            list.innerHTML += `
                <tr>
                    <td class="py-3 px-4">${c.closeTimestamp.toDate().toLocaleString()}</td>
                    <td class="py-3 px-4">${sellerName}</td>
                    <td class="py-3 px-4 ${diff < 0 ? 'text-red-500' : 'text-green-500'}">${diffText}</td>
                    <td class="py-3 px-4 space-x-2">
                        <button onclick="openEditClosureModal('${c.id}')" class="text-blue-500 hover:underline">Editar</button>
                        <button onclick="generateAdminClosurePdf('${c.id}')" class="text-green-500 hover:underline">PDF</button>
                        <button onclick="deleteClosureAdmin('${c.id}')" class="text-red-500 hover:underline">Eliminar</button>
                    </td>
                </tr>
            `;
        });
    }
    
    async function generateDetailedReport(type, creditOnly = false) {
        const data = creditOnly ? filteredAdminReportsData.creditSales : filteredAdminReportsData[type];
        if (!data) {
            alert("Por favor, primero consulte la informaci칩n.");
            return;
        }

        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;
        const doc = new jsPDF();
        let title = '', head = [], body = [];
        const dateRange = `${startDate || 'Inicio'} al ${endDate || 'Fin'}`;

        switch(type) {
            case 'sales':
                title = creditOnly ? `Reporte de Cuentas por Cobrar` : `Reporte Detallado de Ventas`;
                head = [['Fecha', 'Vendedor', 'Cliente', 'Producto', 'Cant.', 'Total', 'M칠todo']];
                body = data.flatMap(s => {
                    const seller = db.usersMap[s.sellerId];
                    const sellerName = seller ? (seller.displayName || seller.name || seller.email) : 'Usuario';
                    return s.items.map(i => [s.date, sellerName, s.clientName, i.name, i.quantity, `$${i.total.toFixed(2)}`, s.paymentMethod]);
                });
                break;
            case 'expenses':
                title = 'Reporte Detallado de Gastos';
                head = [['Fecha', 'Vendedor', 'Categor칤a', 'Monto', 'M칠todo']];
                body = data.map(e => {
                    const seller = db.usersMap[e.sellerId];
                    const sellerName = seller ? (seller.displayName || seller.name || seller.email) : 'Usuario';
                    return [e.date, sellerName, e.categoryName, `$${e.amount.toFixed(2)}`, e.paymentMethod];
                });
                break;
            case 'collections':
                title = 'Reporte de Ingresos Adicionales';
                head = [['Fecha', 'Vendedor', 'Origen', 'Monto', 'Raz칩n']];
                body = data.map(c => {
                    const seller = db.usersMap[c.sellerId];
                    const sellerName = seller ? (seller.displayName || seller.name || seller.email) : 'Usuario';
                    return [c.date, sellerName, c.clientName, `$${c.amount.toFixed(2)}`, c.reason];
                });
                break;
        }
        doc.setFontSize(18); doc.text(title, 14, 22); doc.setFontSize(10); doc.text(`Periodo: ${dateRange}`, 14, 28); doc.autoTable({ startY: 35, head, body });
        doc.save(`${type}_report_${getCurrentDate()}.pdf`);
    }

    async function generateAdminClosurePdf(closureId) {
        let currentY = 0; // Declarar currentY al inicio para usarlo en toda la funci칩n
        try {
            const docSnap = await db_firestore.collection('cash_closures').doc(closureId).get();
            if (!docSnap.exists) {
                alert('No se encontr칩 el cierre.');
                return;
            }

            const closure = docSnap.data();

            // Obtener las ventas del d칤a del cierre usando fecha local
            const closureDateTime = closure.closeTimestamp.toDate();
            const year = closureDateTime.getFullYear();
            const month = String(closureDateTime.getMonth() + 1).padStart(2, '0');
            const day = String(closureDateTime.getDate()).padStart(2, '0');
            const closureDate = `${year}-${month}-${day}`;
            console.log('Admin PDF - Fecha del cierre:', closureDate);
            console.log('Admin PDF - Seller ID:', closure.sellerId);

            const salesSnapshot = await db_firestore.collection('sales')
                .where('sellerId', '==', closure.sellerId)
                .where('date', '==', closureDate)
                .get();

            const todaySales = salesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            console.log('Admin PDF - Ventas encontradas:', todaySales.length);
            console.log('Admin PDF - Ventas:', todaySales);

            // Calcular totales por m칠todo de pago
            const totalCashSales = todaySales.filter(s => s.paymentMethod === 'efectivo').reduce((sum, s) => sum + s.total, 0);
            const totalTransferSales = todaySales.filter(s => s.paymentMethod === 'transferencia').reduce((sum, s) => sum + s.total, 0);
            const totalCreditSales = todaySales.filter(s => s.paymentMethod === 'credito').reduce((sum, s) => sum + s.total, 0);
            const totalAllSales = totalCashSales + totalTransferSales + totalCreditSales;

            const doc = new jsPDF();

            // Encabezado
            doc.setFontSize(18);
            doc.setTextColor(22, 160, 133);
            doc.text('Reporte de Cierre de Caja', 14, 20);

            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text(`Fecha: ${closure.closeTimestamp.toDate().toLocaleString()}`, 14, 28);
            // Obtener nombre del vendedor
            const sellerDoc = await db_firestore.collection('users').doc(closure.sellerId).get();
            const sellerName = sellerDoc.exists ? (sellerDoc.data().name || sellerDoc.data().email) : 'Usuario';
            doc.text(`Vendedor: ${sellerName}`, 14, 34);

            // Resumen de Efectivo
            doc.setFontSize(14);
            doc.setTextColor(22, 160, 133);
            doc.text('Resumen de Efectivo', 14, 45);

            doc.autoTable({
                startY: 50,
                theme: 'grid',
                body: [
                    ['(+) Monto Inicial', `$${closure.openingBalance.toFixed(2)}`],
                    ['(+) Ventas Efectivo', `$${closure.cashSales.toFixed(2)}`],
                    ['(+) Cobros', `$${closure.collections.toFixed(2)}`],
                    ['(+) Abonos Cr칠ditos', `$${(closure.creditPayments || 0).toFixed(2)}`],
                    ['(-) Gastos Efectivo', `-$${closure.cashExpenses.toFixed(2)}`],
                    ['(=) Total Esperado', `$${closure.expectedCash.toFixed(2)}`],
                    ['Fisico Contado', `$${closure.physicalCash.toFixed(2)}`],
                    ['Diferencia', `${closure.difference < 0 ? 'Faltante' : 'Sobrante'}: $${Math.abs(closure.difference).toFixed(2)}`]
                ],
                styles: { fontSize: 10 },
                headStyles: { fillColor: [22, 160, 133] },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 90 },
                    1: { halign: 'right', cellWidth: 50 }
                }
            });

            let currentY = doc.lastAutoTable.finalY + 10;

            // Resumen de Ventas por M칠todo de Pago
            doc.setFontSize(14);
            doc.setTextColor(22, 160, 133);
            doc.text('Resumen de Ventas', 14, currentY);

            doc.autoTable({
                startY: currentY + 5,
                theme: 'grid',
                head: [['Metodo de Pago', 'Cantidad', 'Total']],
                body: [
                    ['Efectivo', todaySales.filter(s => s.paymentMethod === 'efectivo').length.toString(), `$${totalCashSales.toFixed(2)}`],
                    ['Transferencia', todaySales.filter(s => s.paymentMethod === 'transferencia').length.toString(), `$${totalTransferSales.toFixed(2)}`],
                    ['Credito', todaySales.filter(s => s.paymentMethod === 'credito').length.toString(), `$${totalCreditSales.toFixed(2)}`],
                    ['TOTAL GENERAL', todaySales.length.toString(), `$${totalAllSales.toFixed(2)}`]
                ],
                styles: { fontSize: 10 },
                headStyles: { fillColor: [22, 160, 133] },
                columnStyles: {
                    0: { cellWidth: 70 },
                    1: { halign: 'center', cellWidth: 30 },
                    2: { halign: 'right', cellWidth: 40, fontStyle: 'bold' }
                },
                bodyStyles: {
                    3: { fillColor: [220, 220, 220], fontStyle: 'bold' }
                }
            });

            currentY = doc.lastAutoTable.finalY + 10;

            // Detalle de Ventas
            if (todaySales.length > 0) {
                doc.setFontSize(14);
                doc.setTextColor(22, 160, 133);
                doc.text('Detalle de Ventas', 14, currentY);

                // Preparar datos para la tabla con detalle de productos
                const salesData = [];
                todaySales.forEach((sale, index) => {
                    const items = sale.items || [];
                    const itemsText = items.length > 0
                        ? items.map(i => `${i.name} (${i.quantity}x$${i.price.toFixed(2)})`).join(', ')
                        : 'Sin productos';

                    salesData.push([
                        (index + 1).toString(),
                        sale.clientName || 'Cliente General',
                        sale.paymentMethod,
                        itemsText,
                        `$${sale.total.toFixed(2)}`
                    ]);
                });

                doc.autoTable({
                    startY: currentY + 5,
                    theme: 'striped',
                    head: [['#', 'Cliente', 'Metodo', 'Productos', 'Total']],
                    body: salesData,
                    styles: { fontSize: 7, cellPadding: 2 },
                    headStyles: { fillColor: [22, 160, 133], fontSize: 8 },
                    columnStyles: {
                        0: { cellWidth: 10, halign: 'center' },
                        1: { cellWidth: 35 },
                        2: { cellWidth: 23 },
                        3: { cellWidth: 95 },
                        4: { cellWidth: 25, halign: 'right', fontStyle: 'bold' }
                    },
                    margin: { left: 10, right: 10 }
                });

                currentY = doc.lastAutoTable.finalY + 10;

                // Productos m치s vendidos
                const productStats = {};
                todaySales.forEach(sale => {
                    sale.items.forEach(item => {
                        if (!productStats[item.name]) {
                            productStats[item.name] = 0;
                        }
                        productStats[item.name] += item.quantity;
                    });
                });

                const topProducts = Object.entries(productStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                if (topProducts.length > 0) {
                    if (currentY > 250) {
                        doc.addPage();
                        currentY = 20;
                    }

                    doc.setFontSize(14);
                    doc.setTextColor(22, 160, 133);
                    doc.text('Productos Mas Vendidos', 14, currentY);

                    const productsData = topProducts.map(([name, qty], index) => {
                        return [
                            (index + 1).toString(),
                            name,
                            qty.toString()
                        ];
                    });

                    doc.autoTable({
                        startY: currentY + 5,
                        theme: 'grid',
                        head: [['Pos', 'Producto', 'Cantidad']],
                        body: productsData,
                        styles: { fontSize: 10 },
                        headStyles: { fillColor: [22, 160, 133] },
                        columnStyles: {
                            0: { cellWidth: 20, halign: 'center' },
                            1: { cellWidth: 90 },
                            2: { cellWidth: 30, halign: 'center', fontStyle: 'bold' }
                        }
                    });
                }
            } else {
                doc.setFontSize(11);
                doc.setTextColor(100, 100, 100);
                doc.text('No se registraron ventas en este periodo', 14, currentY);
            }

            // Inventario Final
            currentY = doc.lastAutoTable.finalY + 10 || currentY + 10;
            if (currentY > 250) {
                doc.addPage();
                currentY = 20;
            }

            if (closure.closingInventory && closure.closingInventory.length > 0) {
                doc.setFontSize(14);
                doc.setTextColor(22, 160, 133);
                doc.text('Inventario Final', 14, currentY);

                const inventoryData = closure.closingInventory.map((item) => {
                    const product = db.products.find(p => p.id === item.productId);
                    const productName = product ? product.name : 'Desconocido';
                    const initialQty = item.initialQuantity || 0;
                    const finalQty = item.quantity;
                    const diff = finalQty - initialQty;
                    const diffText = diff >= 0 ? `+${diff}` : diff.toString();

                    const categoryLabels = {
                        'bidon_lleno': 'Bid칩n Lleno',
                        'bidon_vacio': 'Bid칩n Vac칤o',
                        'recarga': 'Recarga',
                        'equipo': 'Equipo',
                        'paca': 'Paca'
                    };
                    const categoryLabel = product ? (categoryLabels[product.category] || product.category) : '';

                    return [
                        productName,
                        categoryLabel,
                        initialQty.toString(),
                        finalQty.toString(),
                        diffText
                    ];
                });

                doc.autoTable({
                    startY: currentY + 5,
                    theme: 'grid',
                    head: [['Producto', 'Categoria', 'Inicial', 'Final', 'Diferencia']],
                    body: inventoryData,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [22, 160, 133] },
                    columnStyles: {
                        0: { cellWidth: 70 },
                        1: { cellWidth: 35 },
                        2: { halign: 'center', cellWidth: 25 },
                        3: { halign: 'center', cellWidth: 25, fontStyle: 'bold' },
                        4: { halign: 'center', cellWidth: 25 }
                    }
                });
            }

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Pagina ${i} de ${pageCount}`, 14, 285);
                doc.text(`Generado el ${new Date().toLocaleString()}`, 120, 285);
            }

            doc.save(`cierre_caja_${closureDate}.pdf`);
        } catch (error) {
            console.error('Error al generar PDF:', error);
            alert('Error al generar el PDF: ' + error.message);
        }
    }
    
    async function queryAndDisplayAdminReports() {
        const displayArea = document.getElementById('admin-reports-display');
        displayArea.classList.remove('hidden');

        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;

        try {
            // Fetch Sales
            let salesQuery = db_firestore.collection('sales');
            if (startDate) salesQuery = salesQuery.where('date', '>=', startDate);
            if (endDate) salesQuery = salesQuery.where('date', '<=', endDate);
            const salesSnapshot = await salesQuery.get();
            const salesData = salesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            filteredAdminReportsData.sales = salesData;

            const creditSalesData = salesData.filter(s => s.paymentMethod === 'credito');
            filteredAdminReportsData.creditSales = creditSalesData;

            // Fetch Expenses
            let expensesQuery = db_firestore.collection('expenses');
            if (startDate) expensesQuery = expensesQuery.where('date', '>=', startDate);
            if (endDate) expensesQuery = expensesQuery.where('date', '<=', endDate);
            const expensesSnapshot = await expensesQuery.get();
            const expensesData = expensesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            filteredAdminReportsData.expenses = expensesData;

            // Fetch Collections
            let collectionsQuery = db_firestore.collection('collections');
            if (startDate) collectionsQuery = collectionsQuery.where('date', '>=', startDate);
            if (endDate) collectionsQuery = collectionsQuery.where('date', '<=', endDate);
            const collectionsSnapshot = await collectionsQuery.get();
            const collectionsData = collectionsSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            filteredAdminReportsData.collections = collectionsData;

            renderAllAdminReportTables();
        } catch (error) {
            console.error("Error querying reports:", error);
            alert("Error al consultar los reportes.");
        }
    }

    function renderAllAdminReportTables() {
        // Render Sales
        const salesHead = document.getElementById('admin-sales-report-head');
        const salesBody = document.getElementById('admin-sales-report-body');
        salesHead.innerHTML = `<th>Fecha</th><th>Vendedor</th><th>Cliente</th><th>Items</th><th>Total</th><th>M칠todo</th>`;
        salesBody.innerHTML = filteredAdminReportsData.sales.map(s => {
            const seller = db.usersMap[s.sellerId];
            const sellerName = seller ? (seller.displayName || seller.name || seller.email) : '';
            return `<tr>
            <td class="p-2">${s.date}</td>
            <td class="p-2">${sellerName}</td>
            <td class="p-2">${s.clientName}</td>
            <td class="p-2">${s.items.map(i => i.name).join(', ')}</td>
            <td class="p-2">$${s.total.toFixed(2)}</td>
            <td class="p-2">${s.paymentMethod}</td>
        </tr>`;
        }).join('') || `<tr><td colspan="6" class="text-center p-4">No hay datos.</td></tr>`;

        // Render Credit Sales
        const creditHead = document.getElementById('admin-credit-report-head');
        const creditBody = document.getElementById('admin-credit-report-body');
        creditHead.innerHTML = `<th>Fecha</th><th>Vendedor</th><th>Cliente</th><th>Total</th>`;
        creditBody.innerHTML = filteredAdminReportsData.creditSales.map(s => {
            const seller = db.usersMap[s.sellerId];
            const sellerName = seller ? (seller.displayName || seller.name || seller.email) : '';
            return `<tr>
            <td class="p-2">${s.date}</td>
            <td class="p-2">${sellerName}</td>
            <td class="p-2">${s.clientName}</td>
            <td class="p-2">$${s.total.toFixed(2)}</td>
        </tr>`;
        }).join('') || `<tr><td colspan="4" class="text-center p-4">No hay datos.</td></tr>`;

        // Render Expenses
        const expensesHead = document.getElementById('admin-expenses-report-head');
        const expensesBody = document.getElementById('admin-expenses-report-body');
        expensesHead.innerHTML = `<th>Fecha</th><th>Vendedor</th><th>Categor칤a</th><th>Monto</th><th>M칠todo</th>`;
        expensesBody.innerHTML = filteredAdminReportsData.expenses.map(e => {
            const seller = db.usersMap[e.sellerId];
            const sellerName = seller ? (seller.displayName || seller.name || seller.email) : '';
            return `<tr>
            <td class="p-2">${e.date}</td>
            <td class="p-2">${sellerName}</td>
            <td class="p-2">${e.categoryName}</td>
            <td class="p-2">$${e.amount.toFixed(2)}</td>
            <td class="p-2">${e.paymentMethod}</td>
        </tr>`;
        }).join('') || `<tr><td colspan="5" class="text-center p-4">No hay datos.</td></tr>`;

        // Render Collections
        const collectionsHead = document.getElementById('admin-collections-report-head');
        const collectionsBody = document.getElementById('admin-collections-report-body');
        collectionsHead.innerHTML = `<th>Fecha</th><th>Vendedor</th><th>Origen</th><th>Monto</th><th>Raz칩n</th>`;
        collectionsBody.innerHTML = filteredAdminReportsData.collections.map(c => {
            const seller = db.usersMap[c.sellerId];
            const sellerName = seller ? (seller.displayName || seller.name || seller.email) : '';
            return `<tr>
            <td class="p-2">${c.date}</td>
            <td class="p-2">${sellerName}</td>
            <td class="p-2">${c.clientName}</td>
            <td class="p-2">$${c.amount.toFixed(2)}</td>
            <td class="p-2">${c.reason}</td>
        </tr>`;
        }).join('') || `<tr><td colspan="5" class="text-center p-4">No hay datos.</td></tr>`;
    }

    function filterSellerReports() {
        const startDate = document.getElementById('seller-start-date').value;
        const endDate = document.getElementById('seller-end-date').value;
        const paymentFilter = document.getElementById('report-payment-filter')?.value || '';

        if (!startDate || !endDate) {
            alert('Por favor seleccione las fechas de inicio y fin');
            return;
        }

        // Filtrar ventas
        let sales = db.sales.filter(s => s.sellerId === auth.currentUser.uid && s.date >= startDate && s.date <= endDate);
        if (paymentFilter) {
            sales = sales.filter(s => s.paymentMethod === paymentFilter);
        }

        // Filtrar gastos
        const expenses = db.expenses.filter(e => e.sellerId === auth.currentUser.uid && e.date >= startDate && e.date <= endDate);

        // Calcular totales
        const totalSales = sales.reduce((sum, s) => sum + s.total, 0);
        const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
        const balance = totalSales - totalExpenses;
        const totalProducts = sales.reduce((sum, s) => sum + s.items.reduce((itemSum, item) => itemSum + item.quantity, 0), 0);

        // Actualizar resumen
        document.getElementById('report-total-sales').textContent = `$${totalSales.toFixed(2)}`;
        document.getElementById('report-sales-count').textContent = `${sales.length} ${sales.length === 1 ? 'venta' : 'ventas'}`;
        document.getElementById('report-total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
        document.getElementById('report-expenses-count').textContent = `${expenses.length} ${expenses.length === 1 ? 'gasto' : 'gastos'}`;
        document.getElementById('report-balance').textContent = `$${balance.toFixed(2)}`;
        document.getElementById('report-products-count').textContent = totalProducts;

        // Renderizar tablas
        renderSalesReport(sales);
        renderExpensesReport(expenses);
    }

    function renderSalesReport(sales) {
        const container = document.getElementById('seller-sales-report');
        if (!container) return;

        if (sales.length === 0) {
            container.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-slate-500 dark:text-slate-400 text-sm">No hay ventas en el per칤odo seleccionado</td></tr>';
            return;
        }

        const paymentIcons = { 'efectivo': '游눳', 'transferencia': '游낁', 'credito': '游늶' };

        container.innerHTML = sales.map(sale => {
            return `<tr>
                <td class="py-2 px-2 text-xs">${sale.date}</td>
                <td class="py-2 px-2 text-xs">${sale.clientName || 'General'}</td>
                <td class="py-2 px-2 text-xs">${paymentIcons[sale.paymentMethod]} ${sale.paymentMethod}</td>
                <td class="py-2 px-2 text-xs text-right font-bold text-green-600 dark:text-green-400">$${sale.total.toFixed(2)}</td>
            </tr>`;
        }).join('');
    }

    function renderExpensesReport(expenses) {
        const container = document.getElementById('seller-expenses-report');
        if (!container) return;

        if (expenses.length === 0) {
            container.innerHTML = '<tr><td colspan="3" class="py-4 text-center text-slate-500 dark:text-slate-400 text-sm">No hay gastos en el per칤odo seleccionado</td></tr>';
            return;
        }

        container.innerHTML = expenses.map(expense => {
            const expenseType = db.expenseTypes.find(et => et.id === expense.typeId);
            return `<tr>
                <td class="py-2 px-2 text-xs">${expense.date}</td>
                <td class="py-2 px-2 text-xs">${expenseType ? expenseType.name : expense.description}</td>
                <td class="py-2 px-2 text-xs text-right font-bold text-red-600 dark:text-red-400">$${expense.amount.toFixed(2)}</td>
            </tr>`;
        }).join('');
    }

    async function generateSellerReportPDF() {
        const startDate = document.getElementById('seller-start-date').value;
        const endDate = document.getElementById('seller-end-date').value;

        if (!startDate || !endDate) {
            alert('Por favor genere el reporte primero');
            return;
        }

        const doc = new jsPDF();
        const totalSales = document.getElementById('report-total-sales').textContent;
        const totalExpenses = document.getElementById('report-total-expenses').textContent;
        const balance = document.getElementById('report-balance').textContent;
        const salesCount = document.getElementById('report-sales-count').textContent;
        const expensesCount = document.getElementById('report-expenses-count').textContent;

        doc.setFontSize(18);
        doc.text('Reporte de Ventas y Gastos', 14, 22);
        doc.setFontSize(12);
        doc.text(`Per칤odo: ${startDate} al ${endDate}`, 14, 30);
        // Obtener nombre del vendedor
        const currentUserDoc = await db_firestore.collection('users').doc(auth.currentUser.uid).get();
        const currentUserName = currentUserDoc.exists ? (currentUserDoc.data().name || auth.currentUser.email) : auth.currentUser.email;
        doc.text(`Vendedor: ${currentUserName}`, 14, 36);

        doc.autoTable({
            startY: 45,
            theme: 'grid',
            head: [['Concepto', 'Valor']],
            body: [
                ['Total Ventas', totalSales + ' (' + salesCount + ')'],
                ['Total Gastos', totalExpenses + ' (' + expensesCount + ')'],
                ['Balance', balance]
            ],
            styles: { fontSize: 12 },
            headStyles: { fillColor: [22, 160, 133] }
        });

        doc.save(`reporte_${startDate}_${endDate}.pdf`);
    }
    async function generateCloseCashPDF() {
        const doc = new jsPDF();
        const date = document.getElementById('report-date').textContent;
        const closureDate = document.getElementById('report-date').getAttribute('data-closure-date') || getCurrentDate();
        const initial = document.getElementById('report-initial').textContent;
        const cashSales = document.getElementById('report-cash-sales').textContent;
        const collections = document.getElementById('report-collections').textContent;
        const creditPayments = document.getElementById('report-credit-payments').textContent;
        const cashExpenses = document.getElementById('report-cash-expenses').textContent;
        const total = document.getElementById('report-total').textContent;
        const physical = document.getElementById('report-physical-cash').textContent;
        const difference = document.getElementById('report-difference').textContent;

        console.log('Generando PDF para fecha:', closureDate);
        console.log('Fecha mostrada:', date);

        // Obtener ventas del d칤a del cierre desde Firestore
        const salesSnapshot = await db_firestore.collection('sales')
            .where('sellerId', '==', auth.currentUser.uid)
            .where('date', '==', closureDate)
            .get();

        const todaySales = salesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        console.log('Ventas encontradas:', todaySales.length);
        console.log('Ventas:', todaySales);

        // Obtener el cierre de caja del d칤a para acceder al inventario
        let closingInventory = [];
        try {
            const closureSnapshot = await db_firestore.collection('cash_closures')
                .where('sellerId', '==', auth.currentUser.uid)
                .orderBy('closeTimestamp', 'desc')
                .limit(1)
                .get();

            if (!closureSnapshot.empty) {
                const closureData = closureSnapshot.docs[0].data();
                closingInventory = closureData.closingInventory || [];
            }
        } catch (error) {
            console.error('Error al obtener inventario del cierre:', error);
        }

        // Calcular totales por m칠todo de pago
        const totalCashSales = todaySales.filter(s => s.paymentMethod === 'efectivo').reduce((sum, s) => sum + s.total, 0);
        const totalTransferSales = todaySales.filter(s => s.paymentMethod === 'transferencia').reduce((sum, s) => sum + s.total, 0);
        const totalCreditSales = todaySales.filter(s => s.paymentMethod === 'credito').reduce((sum, s) => sum + s.total, 0);
        const totalAllSales = totalCashSales + totalTransferSales + totalCreditSales;

        // Encabezado
        doc.setFontSize(18);
        doc.setTextColor(22, 160, 133);
        doc.text('Reporte de Cierre de Caja', 14, 20);

        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        doc.text(`Fecha: ${date}`, 14, 28);
        // Obtener nombre del vendedor
        const userDoc = await db_firestore.collection('users').doc(auth.currentUser.uid).get();
        const userName = userDoc.exists ? (userDoc.data().name || auth.currentUser.email) : auth.currentUser.email;
        doc.text(`Vendedor: ${userName}`, 14, 34);

        // Resumen de Efectivo
        doc.setFontSize(14);
        doc.setTextColor(22, 160, 133);
        doc.text('Resumen de Efectivo', 14, 45);

        doc.autoTable({
            startY: 50,
            theme: 'grid',
            body: [
                ['(+) Monto Inicial', initial],
                ['(+) Ventas Efectivo', cashSales],
                ['(+) Cobros', collections],
                ['(+) Abonos Cr칠ditos', creditPayments],
                ['(-) Gastos Efectivo', cashExpenses],
                ['(=) Total Esperado', total],
                ['Fisico Contado', physical],
                ['Diferencia', difference]
            ],
            styles: { fontSize: 10 },
            headStyles: { fillColor: [22, 160, 133] },
            columnStyles: {
                0: { fontStyle: 'bold', cellWidth: 90 },
                1: { halign: 'right', cellWidth: 50 }
            }
        });

        let currentY = doc.lastAutoTable.finalY + 10;

        // Resumen de Ventas por M칠todo de Pago
        doc.setFontSize(14);
        doc.setTextColor(22, 160, 133);
        doc.text('Resumen de Ventas', 14, currentY);

        doc.autoTable({
            startY: currentY + 5,
            theme: 'grid',
            head: [['Metodo de Pago', 'Cantidad', 'Total']],
            body: [
                ['Efectivo', todaySales.filter(s => s.paymentMethod === 'efectivo').length.toString(), `$${totalCashSales.toFixed(2)}`],
                ['Transferencia', todaySales.filter(s => s.paymentMethod === 'transferencia').length.toString(), `$${totalTransferSales.toFixed(2)}`],
                ['Credito', todaySales.filter(s => s.paymentMethod === 'credito').length.toString(), `$${totalCreditSales.toFixed(2)}`],
                ['TOTAL GENERAL', todaySales.length.toString(), `$${totalAllSales.toFixed(2)}`]
            ],
            styles: { fontSize: 10 },
            headStyles: { fillColor: [22, 160, 133] },
            columnStyles: {
                0: { cellWidth: 70 },
                1: { halign: 'center', cellWidth: 30 },
                2: { halign: 'right', cellWidth: 40, fontStyle: 'bold' }
            },
            bodyStyles: {
                3: { fillColor: [220, 220, 220], fontStyle: 'bold' }
            }
        });

        currentY = doc.lastAutoTable.finalY + 10;

        // Detalle de Ventas
        if (todaySales.length > 0) {
            doc.setFontSize(14);
            doc.setTextColor(22, 160, 133);
            doc.text('Detalle de Ventas', 14, currentY);

            // Preparar datos para la tabla con detalle de productos
            const salesData = [];
            todaySales.forEach((sale, index) => {
                const items = sale.items || [];
                const itemsText = items.length > 0
                    ? items.map(i => `${i.name} (${i.quantity}x$${i.price.toFixed(2)})`).join(', ')
                    : 'Sin productos';

                salesData.push([
                    (index + 1).toString(),
                    sale.clientName || 'Cliente General',
                    sale.paymentMethod,
                    itemsText,
                    `$${sale.total.toFixed(2)}`
                ]);
            });

            doc.autoTable({
                startY: currentY + 5,
                theme: 'striped',
                head: [['#', 'Cliente', 'Metodo', 'Productos', 'Total']],
                body: salesData,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [22, 160, 133] },
                columnStyles: {
                    0: { cellWidth: 8, halign: 'center' },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 80 },
                    4: { cellWidth: 25, halign: 'right', fontStyle: 'bold' }
                },
                margin: { left: 14, right: 14 }
            });

            currentY = doc.lastAutoTable.finalY + 10;

            // Productos m치s vendidos
            const productStats = {};
            todaySales.forEach(sale => {
                sale.items.forEach(item => {
                    if (!productStats[item.name]) {
                        productStats[item.name] = 0;
                    }
                    productStats[item.name] += item.quantity;
                });
            });

            const topProducts = Object.entries(productStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            if (topProducts.length > 0) {
                // Verificar si necesitamos una nueva p치gina
                if (currentY > 250) {
                    doc.addPage();
                    currentY = 20;
                }

                doc.setFontSize(14);
                doc.setTextColor(22, 160, 133);
                doc.text('Productos Mas Vendidos', 14, currentY);

                const productsData = topProducts.map(([name, qty], index) => {
                    return [
                        (index + 1).toString(),
                        name,
                        qty.toString()
                    ];
                });

                doc.autoTable({
                    startY: currentY + 5,
                    theme: 'grid',
                    head: [['Pos', 'Producto', 'Cantidad']],
                    body: productsData,
                    styles: { fontSize: 10 },
                    headStyles: { fillColor: [22, 160, 133] },
                    columnStyles: {
                        0: { cellWidth: 20, halign: 'center' },
                        1: { cellWidth: 90 },
                        2: { cellWidth: 30, halign: 'center', fontStyle: 'bold' }
                    }
                });
            }
        } else {
            doc.setFontSize(11);
            doc.setTextColor(100, 100, 100);
            doc.text('No se registraron ventas en este periodo', 14, currentY);
        }

        // Informaci칩n de Meta Diaria
        try {
            const [year, month] = closureDate.split('-');
            const monthKey = `${year}-${month}`;

            const goalsSnapshot = await db_firestore.collection('sales_goals')
                .where('sellerId', '==', auth.currentUser.uid)
                .where('month', '==', monthKey)
                .get();

            if (!goalsSnapshot.empty) {
                const goal = goalsSnapshot.docs[0].data();
                const lastDay = new Date(parseInt(year), parseInt(month), 0).getDate();
                const dailyGoal = goal.goalAmount / lastDay;
                const dailyPercentage = (totalAllSales / dailyGoal) * 100;

                currentY = doc.lastAutoTable.finalY + 10;

                // Verificar si necesitamos una nueva p치gina
                if (currentY > 240) {
                    doc.addPage();
                    currentY = 20;
                }

                doc.setFontSize(14);
                doc.setTextColor(22, 160, 133);
                doc.text('Meta Diaria', 14, currentY);

                let statusText = '';
                if (dailyPercentage >= 100) {
                    statusText = 'Meta diaria alcanzada';
                } else if (dailyPercentage >= 75) {
                    statusText = 'Cerca de la meta';
                } else {
                    statusText = 'Por debajo de la meta';
                }

                doc.autoTable({
                    startY: currentY + 5,
                    theme: 'grid',
                    body: [
                        ['Meta Diaria', `$${dailyGoal.toFixed(2)}`],
                        ['Vendido Hoy', `$${totalAllSales.toFixed(2)}`],
                        ['Cumplimiento', `${dailyPercentage.toFixed(0)}% - ${statusText}`]
                    ],
                    styles: { fontSize: 10 },
                    columnStyles: {
                        0: { fontStyle: 'bold', cellWidth: 70 },
                        1: { halign: 'right', cellWidth: 70 }
                    }
                });
            }
        } catch (error) {
            console.error('Error al agregar meta diaria al PDF:', error);
        }

        // Inventario Final
        if (closingInventory.length > 0) {
            currentY = doc.lastAutoTable.finalY + 10 || currentY + 10;
            if (currentY > 250) {
                doc.addPage();
                currentY = 20;
            }

            doc.setFontSize(14);
            doc.setTextColor(22, 160, 133);
            doc.text('Inventario Final', 14, currentY);

            const inventoryData = closingInventory.map((item) => {
                const product = db.products.find(p => p.id === item.productId);
                const productName = product ? product.name : 'Desconocido';
                const initialQty = item.initialQuantity || 0;
                const finalQty = item.quantity;
                const diff = finalQty - initialQty;
                const diffText = diff >= 0 ? `+${diff}` : diff.toString();

                const categoryLabels = {
                    'bidon_lleno': 'Bid칩n Lleno',
                    'bidon_vacio': 'Bid칩n Vac칤o',
                    'recarga': 'Recarga',
                    'equipo': 'Equipo',
                    'paca': 'Paca'
                };
                const categoryLabel = product ? (categoryLabels[product.category] || product.category) : '';

                return [
                    productName,
                    categoryLabel,
                    initialQty.toString(),
                    finalQty.toString(),
                    diffText
                ];
            });

            doc.autoTable({
                startY: currentY + 5,
                theme: 'grid',
                head: [['Producto', 'Categoria', 'Inicial', 'Final', 'Diferencia']],
                body: inventoryData,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [22, 160, 133] },
                columnStyles: {
                    0: { cellWidth: 70 },
                    1: { cellWidth: 35 },
                    2: { halign: 'center', cellWidth: 25 },
                    3: { halign: 'center', cellWidth: 25, fontStyle: 'bold' },
                    4: { halign: 'center', cellWidth: 25 }
                }
            });
        }

        // Footer
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`Pagina ${i} de ${pageCount}`, 14, 285);
            doc.text(`Generado el ${new Date().toLocaleString()}`, 120, 285);
        }

        doc.save(`cierre_caja_${getCurrentDate()}.pdf`);
    }

    // ========== FUNCIONES PARA GESTI칍N DE VENTAS Y GASTOS ==========

    let managementSalesData = [];
    let managementExpensesData = [];

    async function queryManagement() {
        const startDate = document.getElementById('management-start-date').value;
        const endDate = document.getElementById('management-end-date').value;
        const sellerFilter = document.getElementById('management-seller-filter').value;

        if (!startDate || !endDate) {
            alert('Por favor, seleccione un rango de fechas.');
            return;
        }

        // Consultar ventas
        let salesQuery = db_firestore.collection('sales')
            .where('date', '>=', startDate)
            .where('date', '<=', endDate);

        if (sellerFilter) {
            salesQuery = salesQuery.where('sellerId', '==', sellerFilter);
        }

        const salesSnapshot = await salesQuery.orderBy('date', 'desc').get();
        managementSalesData = salesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

        // Consultar gastos
        let expensesQuery = db_firestore.collection('expenses')
            .where('date', '>=', startDate)
            .where('date', '<=', endDate);

        if (sellerFilter) {
            expensesQuery = expensesQuery.where('sellerId', '==', sellerFilter);
        }

        const expensesSnapshot = await expensesQuery.orderBy('date', 'desc').get();
        managementExpensesData = expensesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

        // Calcular estad칤sticas
        const totalSales = managementSalesData.reduce((sum, s) => sum + s.total, 0);
        const totalExpenses = managementExpensesData.reduce((sum, e) => sum + e.amount, 0);
        const totalCredits = managementSalesData.filter(s => s.paymentMethod === 'credito').reduce((sum, s) => sum + s.total, 0);
        const creditsCount = managementSalesData.filter(s => s.paymentMethod === 'credito').length;

        document.getElementById('management-total-sales').textContent = '$' + totalSales.toFixed(2);
        document.getElementById('management-count-sales').textContent = managementSalesData.length + ' registro' + (managementSalesData.length !== 1 ? 's' : '');
        document.getElementById('management-total-expenses').textContent = '$' + totalExpenses.toFixed(2);
        document.getElementById('management-count-expenses').textContent = managementExpensesData.length + ' registro' + (managementExpensesData.length !== 1 ? 's' : '');
        document.getElementById('management-balance').textContent = '$' + (totalSales - totalExpenses).toFixed(2);
        document.getElementById('management-total-credits').textContent = '$' + totalCredits.toFixed(2);
        document.getElementById('management-count-credits').textContent = creditsCount + ' pendiente' + (creditsCount !== 1 ? 's' : '');

        document.getElementById('management-stats').classList.remove('hidden');

        // Renderizar tablas
        renderManagementSales();
        renderManagementExpenses();
    }

    function loadSellersDropdown(users) {
        // Dropdown de filtro de gesti칩n
        const dropdown = document.getElementById('management-seller-filter');
        const currentValue = dropdown.value;
        dropdown.innerHTML = '<option value="">Todos los vendedores</option>';

        users.forEach(doc => {
            const userData = doc.data();
            // Solo agregar si es vendedor y tiene nombre v치lido
            if (userData && (userData.role === 'seller' || userData.role === 'vendedor')) {
                const name = userData.displayName || userData.name || userData.email || 'Vendedor';
                dropdown.innerHTML += `<option value="${doc.id}">${name}</option>`;
            }
        });

        dropdown.value = currentValue;

        // Dropdown de metas
        const goalDropdown = document.getElementById('goal-seller');
        if (goalDropdown) {
            const currentGoalValue = goalDropdown.value;
            goalDropdown.innerHTML = '<option value="">Seleccionar vendedor</option>';

            users.forEach(doc => {
                const userData = doc.data();
                // Solo agregar si es vendedor y tiene nombre v치lido
                if (userData && (userData.role === 'seller' || userData.role === 'vendedor')) {
                    const name = userData.displayName || userData.name || userData.email || 'Vendedor';
                    goalDropdown.innerHTML += `<option value="${doc.id}">${name}</option>`;
                }
            });

            goalDropdown.value = currentGoalValue;
        }
    }

    // ========== FUNCIONES PARA METAS DE VENTAS ==========

    // Listener para guardar nueva meta
    document.getElementById('add-sales-goal-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const sellerId = document.getElementById('goal-seller').value;
        const month = document.getElementById('goal-month').value;
        const goalAmount = parseFloat(document.getElementById('goal-amount').value);

        if (!sellerId || !month || !goalAmount) {
            alert('Por favor complete todos los campos.');
            return;
        }

        try {
            // Verificar si ya existe una meta para este vendedor en este mes
            const existingGoal = await db_firestore.collection('sales_goals')
                .where('sellerId', '==', sellerId)
                .where('month', '==', month)
                .get();

            if (!existingGoal.empty) {
                alert('Ya existe una meta para este vendedor en este mes. Por favor elimine la meta existente primero.');
                return;
            }

            await db_firestore.collection('sales_goals').add({
                sellerId,
                month,
                goalAmount,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert('Meta creada exitosamente');
            document.getElementById('add-sales-goal-form').reset();
            // No llamar loadSalesGoals() aqu칤 porque el onSnapshot lo har치 autom치ticamente
        } catch (error) {
            console.error('Error creating sales goal:', error);
            alert('Error al crear la meta: ' + error.message);
        }
    });

    async function loadSalesGoals() {
        try {
            const snapshot = await db_firestore.collection('sales_goals')
                .orderBy('month', 'desc')
                .get();

            const goalsList = document.getElementById('sales-goals-list');
            goalsList.innerHTML = '';

            if (snapshot.empty) {
                goalsList.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">No hay metas registradas</td></tr>';
                return;
            }

            for (const doc of snapshot.docs) {
                const goal = doc.data();
                const goalId = doc.id;

                // Calcular ventas del mes
                const [year, month] = goal.month.split('-');
                const startDate = `${year}-${month}-01`;
                const lastDay = new Date(year, month, 0).getDate();
                const endDate = `${year}-${month}-${lastDay}`;

                const salesSnapshot = await db_firestore.collection('sales')
                    .where('sellerId', '==', goal.sellerId)
                    .where('date', '>=', startDate)
                    .where('date', '<=', endDate)
                    .get();

                const totalSold = salesSnapshot.docs.reduce((sum, doc) => sum + doc.data().total, 0);
                const percentage = (totalSold / goal.goalAmount) * 100;

                const seller = db.usersMap[goal.sellerId];
                const sellerName = seller ? (seller.displayName || seller.name || seller.email) : 'Usuario';

                const row = `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                        <td class="py-3 px-6">${sellerName}</td>
                        <td class="py-3 px-6">${formatMonth(goal.month)}</td>
                        <td class="py-3 px-6 font-semibold text-orange-600 dark:text-orange-400">$${goal.goalAmount.toFixed(2)}</td>
                        <td class="py-3 px-6 font-semibold text-green-600 dark:text-green-400">$${totalSold.toFixed(2)}</td>
                        <td class="py-3 px-6">
                            <div class="flex items-center gap-2">
                                <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                    <div class="h-2 rounded-full ${percentage >= 100 ? 'bg-green-500' : percentage >= 75 ? 'bg-yellow-500' : 'bg-red-500'}"
                                         style="width: ${Math.min(percentage, 100)}%"></div>
                                </div>
                                <span class="text-sm font-bold ${percentage >= 100 ? 'text-green-600' : percentage >= 75 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${percentage.toFixed(1)}%
                                </span>
                            </div>
                        </td>
                        <td class="py-3 px-6">
                            <button onclick="downloadGoalPDF('${goalId}', '${goal.sellerId}', '${goal.month}', ${goal.goalAmount}, ${totalSold}, ${percentage})" class="text-blue-600 hover:text-blue-800 font-medium mr-3">
                                <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                PDF
                            </button>
                            <button onclick="deleteSalesGoal('${goalId}')" class="text-red-600 hover:text-red-800 font-medium">Eliminar</button>
                        </td>
                    </tr>
                `;
                goalsList.innerHTML += row;
            }

        } catch (error) {
            console.error('Error loading sales goals:', error);
        }
    }

    async function deleteSalesGoal(goalId) {
        if (!confirm('쮼st치 seguro de eliminar esta meta?')) return;

        try {
            await db_firestore.collection('sales_goals').doc(goalId).delete();
            alert('Meta eliminada correctamente');
            loadSalesGoals();
        } catch (error) {
            console.error('Error deleting sales goal:', error);
            alert('Error al eliminar la meta: ' + error.message);
        }
    }

    async function downloadGoalPDF(goalId, sellerId, month, goalAmount, totalSold, overallPercentage) {
        try {
            const doc = new jsPDF();

            // Header
            doc.setFontSize(20);
            doc.setTextColor(22, 160, 133);
            doc.text('Reporte de Meta de Ventas', 14, 20);

            // Informaci칩n b치sica
            const seller = db.usersMap[sellerId];
            const sellerName = seller ? (seller.displayName || seller.name || seller.email) : 'Usuario';
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text(`Vendedor: ${sellerName}`, 14, 28);
            doc.text(`Per칤odo: ${formatMonth(month)}`, 14, 34);
            doc.text(`Fecha de reporte: ${new Date().toLocaleDateString()}`, 14, 40);

            // Resumen de Meta Mensual
            doc.setFontSize(14);
            doc.setTextColor(22, 160, 133);
            doc.text('Resumen del Mes', 14, 50);

            const [year, monthNum] = month.split('-');
            const daysInMonth = new Date(year, monthNum, 0).getDate();
            const remainingMonth = goalAmount - totalSold;

            doc.autoTable({
                startY: 55,
                theme: 'grid',
                head: [['Concepto', 'Valor']],
                body: [
                    ['Meta del Mes', `$${goalAmount.toFixed(2)}`],
                    ['Total Vendido', `$${totalSold.toFixed(2)}`],
                    ['Porcentaje Cumplido', `${overallPercentage.toFixed(1)}%`],
                    [remainingMonth > 0 ? 'Falta para Cumplir' : 'Excedente', `$${Math.abs(remainingMonth).toFixed(2)}`],
                    ['Meta Diaria Promedio', `$${(goalAmount / daysInMonth).toFixed(2)}/d칤a`],
                    ['D칤as en el Mes', `${daysInMonth} d칤as`]
                ],
                styles: { fontSize: 10 },
                headStyles: { fillColor: [22, 160, 133] },
                columnStyles: {
                    0: { cellWidth: 90, fontStyle: 'bold' },
                    1: { halign: 'right', cellWidth: 50, fontStyle: 'bold' }
                },
                bodyStyles: (data) => {
                    if (data.row.index === 2) {
                        return { fillColor: [255, 255, 200] };
                    }
                }
            });

            let currentY = doc.lastAutoTable.finalY + 10;

            // Obtener ventas detalladas por d칤a
            const startDate = `${year}-${monthNum}-01`;
            const lastDay = daysInMonth;
            const endDate = `${year}-${monthNum}-${String(lastDay).padStart(2, '0')}`;

            const salesSnapshot = await db_firestore.collection('sales')
                .where('sellerId', '==', sellerId)
                .where('date', '>=', startDate)
                .where('date', '<=', endDate)
                .orderBy('date', 'asc')
                .get();

            // Agrupar ventas por d칤a
            const dailySales = {};
            salesSnapshot.docs.forEach(doc => {
                const sale = doc.data();
                if (!dailySales[sale.date]) {
                    dailySales[sale.date] = 0;
                }
                dailySales[sale.date] += sale.total;
            });

            // Crear tabla de progreso diario
            doc.setFontSize(14);
            doc.setTextColor(22, 160, 133);
            doc.text('Progreso Diario', 14, currentY);

            const dailyGoal = goalAmount / daysInMonth;
            const today = getCurrentDate();
            const currentDay = today.slice(0, 7) === month ? parseInt(today.split('-')[2]) : daysInMonth;

            const dailyData = [];
            let accumulatedSales = 0;
            let accumulatedGoal = 0;

            for (let day = 1; day <= currentDay; day++) {
                const dateStr = `${year}-${monthNum}-${String(day).padStart(2, '0')}`;
                const daySales = dailySales[dateStr] || 0;
                accumulatedSales += daySales;
                accumulatedGoal += dailyGoal;

                const dayPercentage = (daySales / dailyGoal) * 100;
                const difference = daySales - dailyGoal;

                dailyData.push([
                    `${day}/${monthNum}`,
                    `$${daySales.toFixed(2)}`,
                    `$${dailyGoal.toFixed(2)}`,
                    `${dayPercentage.toFixed(1)}%`,
                    `${difference >= 0 ? '+' : ''}$${difference.toFixed(2)}`,
                    `$${accumulatedSales.toFixed(2)}`
                ]);
            }

            doc.autoTable({
                startY: currentY + 5,
                theme: 'striped',
                head: [['D칤a', 'Vendido', 'Meta D칤a', '%', 'Dif.', 'Acumulado']],
                body: dailyData,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [22, 160, 133] },
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { halign: 'right', cellWidth: 28 },
                    2: { halign: 'right', cellWidth: 28 },
                    3: { halign: 'center', cellWidth: 20 },
                    4: { halign: 'right', cellWidth: 28 },
                    5: { halign: 'right', cellWidth: 30, fontStyle: 'bold' }
                },
                bodyStyles: (data) => {
                    const difference = parseFloat(data.row.raw[4].replace('$', '').replace('+', ''));
                    if (difference >= 0) {
                        return { 4: { textColor: [0, 128, 0] } };
                    } else {
                        return { 4: { textColor: [255, 0, 0] } };
                    }
                }
            });

            currentY = doc.lastAutoTable.finalY + 10;

            // An치lisis de cumplimiento
            doc.setFontSize(14);
            doc.setTextColor(22, 160, 133);
            doc.text('An치lisis de Cumplimiento', 14, currentY);

            const expectedSales = dailyGoal * currentDay;
            const differenceVsExpected = totalSold - expectedSales;
            const performanceRate = (totalSold / expectedSales) * 100;

            doc.autoTable({
                startY: currentY + 5,
                theme: 'grid',
                head: [['Concepto', 'Valor']],
                body: [
                    ['D칤as Transcurridos', `${currentDay} de ${daysInMonth} d칤as`],
                    ['Ventas Esperadas a la Fecha', `$${expectedSales.toFixed(2)}`],
                    ['Ventas Reales a la Fecha', `$${totalSold.toFixed(2)}`],
                    ['Diferencia vs Esperado', `${differenceVsExpected >= 0 ? '+' : ''}$${differenceVsExpected.toFixed(2)}`],
                    ['Ritmo de Cumplimiento', `${performanceRate.toFixed(1)}%`],
                    ['Proyecci칩n de Cierre', `$${((totalSold / currentDay) * daysInMonth).toFixed(2)}`]
                ],
                styles: { fontSize: 10 },
                headStyles: { fillColor: [22, 160, 133] },
                columnStyles: {
                    0: { cellWidth: 90, fontStyle: 'bold' },
                    1: { halign: 'right', cellWidth: 50, fontStyle: 'bold' }
                },
                bodyStyles: (data) => {
                    if (data.row.index === 3) {
                        const diff = differenceVsExpected;
                        return { 1: { textColor: diff >= 0 ? [0, 128, 0] : [255, 0, 0] } };
                    }
                    if (data.row.index === 4) {
                        return { fillColor: [255, 255, 200] };
                    }
                }
            });

            // Footer
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('Generado con Sistema de Ventas - Distribuidor Autorizado', 14, 285);

            // Guardar PDF
            doc.save(`Meta_${sellerName}_${formatMonth(month).replace(' ', '_')}.pdf`);

        } catch (error) {
            console.error('Error generating goal PDF:', error);
            alert('Error al generar el PDF: ' + error.message);
        }
    }

    function formatMonth(monthStr) {
        const [year, month] = monthStr.split('-');
        const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                       'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        return `${months[parseInt(month) - 1]} ${year}`;
    }

    // Cargar metas cuando se abre la pesta침a (solo para administradores)
    auth.onAuthStateChanged(user => {
        if (user) {
            db_firestore.collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists && doc.data().role === 'admin') {
                    db_firestore.collection('sales_goals').onSnapshot(() => {
                        loadSalesGoals();
                    });
                }
            });
        }
    });

    function renderManagementSales() {
        const searchTerm = document.getElementById('search-sales').value.toLowerCase();
        const paymentFilter = document.getElementById('filter-sales-payment').value;

        let filtered = managementSalesData.filter(sale => {
            const matchSearch = sale.clientName.toLowerCase().includes(searchTerm);
            const matchPayment = !paymentFilter || sale.paymentMethod === paymentFilter;
            return matchSearch && matchPayment;
        });

        const salesList = document.getElementById('management-sales-list');
        salesList.innerHTML = '';

        filtered.forEach(sale => {
            const seller = db.usersMap[sale.sellerId];
            const sellerName = seller ? (seller.displayName || seller.name || seller.email) : 'Usuario';
            const row = `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                    <td class="py-3 px-6">${formatDateDisplay(sale.date)}</td>
                    <td class="py-3 px-6">${sellerName}</td>
                    <td class="py-3 px-6">${sale.clientName}</td>
                    <td class="py-3 px-6 font-semibold text-green-600 dark:text-green-400">$${sale.total.toFixed(2)}</td>
                    <td class="py-3 px-6"><span class="px-2 py-1 text-xs rounded-full ${
                        sale.paymentMethod === 'efectivo' ? 'bg-green-100 text-green-800' :
                        sale.paymentMethod === 'transferencia' ? 'bg-blue-100 text-blue-800' :
                        'bg-yellow-100 text-yellow-800'
                    }">${sale.paymentMethod}</span></td>
                    <td class="py-3 px-6">
                        <button onclick="openEditSaleModal('${sale.id}')" class="text-blue-600 hover:text-blue-800 mr-3 font-medium">Editar</button>
                        <button onclick="deleteSale('${sale.id}')" class="text-red-600 hover:text-red-800 font-medium">Eliminar</button>
                    </td>
                </tr>
            `;
            salesList.innerHTML += row;
        });

        if (filtered.length === 0) {
            salesList.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">No se encontraron ventas</td></tr>';
        }
    }

    function renderManagementExpenses() {
        const searchTerm = document.getElementById('search-expenses').value.toLowerCase();
        const paymentFilter = document.getElementById('filter-expenses-payment').value;

        let filtered = managementExpensesData.filter(expense => {
            const category = expense.category || '';
            const matchSearch = category.toLowerCase().includes(searchTerm);
            const matchPayment = !paymentFilter || expense.paymentMethod === paymentFilter;
            return matchSearch && matchPayment;
        });

        const expensesList = document.getElementById('management-expenses-list');
        expensesList.innerHTML = '';

        filtered.forEach(expense => {
            const seller = db.usersMap[expense.sellerId];
            const sellerName = seller ? (seller.displayName || seller.name || seller.email) : 'Usuario';
            const row = `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                    <td class="py-3 px-6">${formatDateDisplay(expense.date)}</td>
                    <td class="py-3 px-6">${sellerName}</td>
                    <td class="py-3 px-6">${expense.category || 'Sin categor칤a'}</td>
                    <td class="py-3 px-6 font-semibold text-red-600 dark:text-red-400">$${expense.amount.toFixed(2)}</td>
                    <td class="py-3 px-6"><span class="px-2 py-1 text-xs rounded-full ${
                        expense.paymentMethod === 'efectivo' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'
                    }">${expense.paymentMethod}</span></td>
                    <td class="py-3 px-6">
                        <button onclick="openEditExpenseModal('${expense.id}')" class="text-blue-600 hover:text-blue-800 mr-3 font-medium">Editar</button>
                        <button onclick="deleteExpense('${expense.id}')" class="text-red-600 hover:text-red-800 font-medium">Eliminar</button>
                    </td>
                </tr>
            `;
            expensesList.innerHTML += row;
        });

        if (filtered.length === 0) {
            expensesList.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">No se encontraron gastos</td></tr>';
        }
    }

    // Event listeners para filtros
    document.getElementById('search-sales').addEventListener('input', renderManagementSales);
    document.getElementById('filter-sales-payment').addEventListener('change', renderManagementSales);
    document.getElementById('search-expenses').addEventListener('input', renderManagementExpenses);
    document.getElementById('filter-expenses-payment').addEventListener('change', renderManagementExpenses);

    // Funciones de exportaci칩n a Excel
    function exportSalesToExcel() {
        const searchTerm = document.getElementById('search-sales').value.toLowerCase();
        const paymentFilter = document.getElementById('filter-sales-payment').value;

        let filtered = managementSalesData.filter(sale => {
            const matchSearch = sale.clientName.toLowerCase().includes(searchTerm);
            const matchPayment = !paymentFilter || sale.paymentMethod === paymentFilter;
            return matchSearch && matchPayment;
        });

        if (filtered.length === 0) {
            alert('No hay datos para exportar');
            return;
        }

        let csv = 'Fecha,Vendedor,Cliente,Total,M칠todo de Pago,Productos\n';
        filtered.forEach(sale => {
            const productos = sale.items ? sale.items.map(i => `${i.name} (${i.quantity})`).join('; ') : '';
            const seller = db.usersMap[sale.sellerId];
            const vendedor = seller ? (seller.displayName || seller.name || seller.email) : sale.sellerId;
            csv += `${sale.date},"${vendedor}","${sale.clientName}",${sale.total},${sale.paymentMethod},"${productos}"\n`;
        });

        downloadCSV(csv, 'ventas_' + new Date().toISOString().split('T')[0] + '.csv');
    }

    function exportExpensesToExcel() {
        const searchTerm = document.getElementById('search-expenses').value.toLowerCase();
        const paymentFilter = document.getElementById('filter-expenses-payment').value;

        let filtered = managementExpensesData.filter(expense => {
            const category = expense.category || '';
            const matchSearch = category.toLowerCase().includes(searchTerm);
            const matchPayment = !paymentFilter || expense.paymentMethod === paymentFilter;
            return matchSearch && matchPayment;
        });

        if (filtered.length === 0) {
            alert('No hay datos para exportar');
            return;
        }

        let csv = 'Fecha,Vendedor,Categor칤a,Monto,M칠todo de Pago,Descripci칩n\n';
        filtered.forEach(expense => {
            const seller = db.usersMap[expense.sellerId];
            const vendedor = seller ? (seller.displayName || seller.name || seller.email) : expense.sellerId;
            const desc = expense.description || '';
            csv += `${expense.date},"${vendedor}","${expense.category}",${expense.amount},${expense.paymentMethod},"${desc}"\n`;
        });

        downloadCSV(csv, 'gastos_' + new Date().toISOString().split('T')[0] + '.csv');
    }

    function downloadCSV(csv, filename) {
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    let editSaleProducts = [];

    async function openEditSaleModal(saleId) {
        const docSnap = await db_firestore.collection('sales').doc(saleId).get();
        if (!docSnap.exists) {
            alert('Venta no encontrada.');
            return;
        }

        const sale = docSnap.data();
        document.getElementById('edit-sale-id').value = saleId;
        document.getElementById('edit-sale-date').value = sale.date;
        document.getElementById('edit-sale-client').value = sale.clientName;
        document.getElementById('edit-sale-payment').value = sale.paymentMethod;

        // Cargar productos
        editSaleProducts = sale.items ? JSON.parse(JSON.stringify(sale.items)) : [];
        renderEditSaleProducts();

        document.getElementById('edit-sale-modal').classList.remove('hidden');
    }

    function renderEditSaleProducts() {
        const container = document.getElementById('edit-sale-products-container');
        container.innerHTML = '';

        if (editSaleProducts.length === 0) {
            container.innerHTML = '<p class="text-slate-500 text-sm text-center py-4">No hay productos. Haga clic en "+ Agregar Producto"</p>';
            updateEditSaleTotal();
            return;
        }

        editSaleProducts.forEach((item, index) => {
            const productRow = document.createElement('div');
            productRow.className = 'grid grid-cols-12 gap-2 items-center bg-slate-50 dark:bg-slate-700 p-2 rounded-lg';
            productRow.innerHTML = `
                <div class="col-span-5">
                    <select class="w-full p-2 text-sm border rounded-lg dark:bg-slate-600 dark:border-slate-500" onchange="updateEditSaleProductName(${index}, this.value)">
                        <option value="">Seleccionar producto</option>
                        ${db.products.map(p => `<option value="${p.name}" ${p.name === item.name ? 'selected' : ''}>${p.name}</option>`).join('')}
                    </select>
                </div>
                <div class="col-span-2">
                    <input type="number" value="${item.quantity}" min="1" step="1" placeholder="Cant."
                        class="w-full p-2 text-sm border rounded-lg dark:bg-slate-600 dark:border-slate-500"
                        onchange="updateEditSaleProductQuantity(${index}, this.value)">
                </div>
                <div class="col-span-2">
                    <input type="number" value="${item.price}" min="0" step="0.01" placeholder="Precio"
                        class="w-full p-2 text-sm border rounded-lg dark:bg-slate-600 dark:border-slate-500"
                        onchange="updateEditSaleProductPrice(${index}, this.value)">
                </div>
                <div class="col-span-2">
                    <span class="text-sm font-semibold text-slate-900 dark:text-white">$${item.total.toFixed(2)}</span>
                </div>
                <div class="col-span-1 text-right">
                    <button type="button" onclick="removeEditSaleProduct(${index})" class="text-red-500 hover:text-red-700">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            `;
            container.appendChild(productRow);
        });

        updateEditSaleTotal();
    }

    function addEditSaleProduct() {
        editSaleProducts.push({
            name: '',
            quantity: 1,
            price: 0,
            total: 0
        });
        renderEditSaleProducts();
    }

    function removeEditSaleProduct(index) {
        editSaleProducts.splice(index, 1);
        renderEditSaleProducts();
    }

    function updateEditSaleProductName(index, name) {
        editSaleProducts[index].name = name;
        const product = db.products.find(p => p.name === name);
        if (product) {
            editSaleProducts[index].price = product.price;
            editSaleProducts[index].total = editSaleProducts[index].quantity * product.price;
        }
        renderEditSaleProducts();
    }

    function updateEditSaleProductQuantity(index, quantity) {
        const qty = parseInt(quantity) || 1;
        editSaleProducts[index].quantity = qty;
        editSaleProducts[index].total = qty * editSaleProducts[index].price;
        renderEditSaleProducts();
    }

    function updateEditSaleProductPrice(index, price) {
        const p = parseFloat(price) || 0;
        editSaleProducts[index].price = p;
        editSaleProducts[index].total = editSaleProducts[index].quantity * p;
        renderEditSaleProducts();
    }

    function updateEditSaleTotal() {
        const total = editSaleProducts.reduce((sum, item) => sum + item.total, 0);
        document.getElementById('edit-sale-total-display').textContent = '$' + total.toFixed(2);
    }

    function closeEditSaleModal() {
        document.getElementById('edit-sale-modal').classList.add('hidden');
        document.getElementById('edit-sale-form').reset();
    }

    async function openEditExpenseModal(expenseId) {
        const docSnap = await db_firestore.collection('expenses').doc(expenseId).get();
        if (!docSnap.exists) {
            alert('Gasto no encontrado.');
            return;
        }

        const expense = docSnap.data();
        document.getElementById('edit-expense-id').value = expenseId;

        // Cargar fecha
        document.getElementById('edit-expense-date').value = expense.date || getCurrentDate();

        // Poblar categor칤as
        const categorySelect = document.getElementById('edit-expense-category');
        categorySelect.innerHTML = '';
        db.expenseTypes.forEach(type => {
            categorySelect.innerHTML += `<option value="${type.name}">${type.name}</option>`;
        });

        categorySelect.value = expense.category;
        document.getElementById('edit-expense-amount').value = expense.amount;
        document.getElementById('edit-expense-payment').value = expense.paymentMethod;
        document.getElementById('edit-expense-description').value = expense.description || '';

        document.getElementById('edit-expense-modal').classList.remove('hidden');
    }

    function closeEditExpenseModal() {
        document.getElementById('edit-expense-modal').classList.add('hidden');
        document.getElementById('edit-expense-form').reset();
    }

    async function deleteSale(saleId) {
        if (!confirm('쮼st치 seguro de eliminar esta venta? Esta acci칩n no se puede deshacer.')) {
            return;
        }

        try {
            await db_firestore.collection('sales').doc(saleId).delete();

            // Actualizar db local
            const index = db.sales.findIndex(s => s.id === saleId);
            if (index !== -1) {
                db.sales.splice(index, 1);
            }

            alert('Venta eliminada correctamente.');
            queryManagement();
        } catch (error) {
            alert('Error al eliminar la venta: ' + error.message);
        }
    }

    async function deleteExpense(expenseId) {
        if (!confirm('쮼st치 seguro de eliminar este gasto? Esta acci칩n no se puede deshacer.')) {
            return;
        }

        try {
            console.log('Eliminando gasto con ID:', expenseId);

            // Eliminar de Firestore
            await db_firestore.collection('expenses').doc(expenseId).delete();

            console.log('Gasto eliminado de Firestore');

            // Actualizar db local
            const index = db.expenses.findIndex(e => e.id === expenseId);
            if (index !== -1) {
                db.expenses.splice(index, 1);
                console.log('Gasto eliminado del array local');
            }

            alert('Gasto eliminado correctamente.');

            // Refrescar la lista
            await queryManagement();
        } catch (error) {
            console.error('Error al eliminar gasto:', error);
            alert('Error al eliminar el gasto: ' + error.message);
        }
    }

    // Listener para el formulario de edici칩n de ventas
    document.getElementById('edit-sale-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const saleId = document.getElementById('edit-sale-id').value;
        const date = document.getElementById('edit-sale-date').value;
        const clientName = document.getElementById('edit-sale-client').value;
        const paymentMethod = document.getElementById('edit-sale-payment').value;

        // Validar que haya al menos un producto
        if (editSaleProducts.length === 0) {
            alert('Debe agregar al menos un producto a la venta.');
            return;
        }

        // Validar que todos los productos tengan nombre
        const invalidProducts = editSaleProducts.filter(p => !p.name || p.name === '');
        if (invalidProducts.length > 0) {
            alert('Todos los productos deben tener un nombre seleccionado.');
            return;
        }

        // Calcular el total
        const total = editSaleProducts.reduce((sum, item) => sum + item.total, 0);

        if (total <= 0) {
            alert('El total de la venta debe ser mayor a 0.');
            return;
        }

        try {
            await db_firestore.collection('sales').doc(saleId).update({
                date,
                clientName,
                items: editSaleProducts,
                total,
                paymentMethod,
                status: (paymentMethod === 'credito' ? 'pendiente' : 'pagado')
            });

            // Actualizar db local
            const index = db.sales.findIndex(s => s.id === saleId);
            if (index !== -1) {
                db.sales[index].date = date;
                db.sales[index].clientName = clientName;
                db.sales[index].items = JSON.parse(JSON.stringify(editSaleProducts));
                db.sales[index].total = total;
                db.sales[index].paymentMethod = paymentMethod;
                db.sales[index].status = (paymentMethod === 'credito' ? 'pendiente' : 'pagado');
            }

            alert('Venta actualizada correctamente.');
            closeEditSaleModal();
            queryManagement();
        } catch (error) {
            alert('Error al actualizar la venta: ' + error.message);
        }
    });

    // Listener para el formulario de edici칩n de gastos
    document.getElementById('edit-expense-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const expenseId = document.getElementById('edit-expense-id').value;
        const date = document.getElementById('edit-expense-date').value;
        const category = document.getElementById('edit-expense-category').value;
        const amount = parseFloat(document.getElementById('edit-expense-amount').value);
        const paymentMethod = document.getElementById('edit-expense-payment').value;
        const description = document.getElementById('edit-expense-description').value;

        try {
            await db_firestore.collection('expenses').doc(expenseId).update({
                date,
                category,
                amount,
                paymentMethod,
                description
            });

            // Actualizar db local
            const index = db.expenses.findIndex(e => e.id === expenseId);
            if (index !== -1) {
                db.expenses[index].date = date;
                db.expenses[index].category = category;
                db.expenses[index].amount = amount;
                db.expenses[index].paymentMethod = paymentMethod;
                db.expenses[index].description = description;
            }

            alert('Gasto actualizado correctamente.');
            closeEditExpenseModal();
            queryManagement();
        } catch (error) {
            alert('Error al actualizar el gasto: ' + error.message);
        }
    });

    // Listener para el bot칩n de consultar en gesti칩n
    document.getElementById('query-management-btn').addEventListener('click', queryManagement);

    // ========== FUNCIONES PARA EDITAR TIPOS DE GASTO ==========

    function openEditExpenseTypeModal(expenseTypeId) {
        const expenseType = db.expenseTypes.find(et => et.id === expenseTypeId);
        if (!expenseType) {
            alert('Tipo de gasto no encontrado.');
            return;
        }

        document.getElementById('edit-expense-type-id').value = expenseTypeId;
        document.getElementById('edit-expense-type-name').value = expenseType.name;
        document.getElementById('edit-expense-type-modal').classList.remove('hidden');
    }

    function closeEditExpenseTypeModal() {
        document.getElementById('edit-expense-type-modal').classList.add('hidden');
        document.getElementById('edit-expense-type-form').reset();
    }

    // Listener para el formulario de edici칩n de tipos de gasto
    document.getElementById('edit-expense-type-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const expenseTypeId = document.getElementById('edit-expense-type-id').value;
        const newName = document.getElementById('edit-expense-type-name').value.trim();

        if (!newName) {
            alert('El nombre del tipo de gasto no puede estar vac칤o.');
            return;
        }

        // Verificar si ya existe otro tipo de gasto con el mismo nombre
        const existingType = db.expenseTypes.find(et => et.name.toLowerCase() === newName.toLowerCase() && et.id !== expenseTypeId);
        if (existingType) {
            alert('Ya existe un tipo de gasto con ese nombre.');
            return;
        }

        try {
            const oldExpenseType = db.expenseTypes.find(et => et.id === expenseTypeId);
            const oldName = oldExpenseType.name;

            // Actualizar el tipo de gasto en Firestore
            await db_firestore.collection('expense_types').doc(expenseTypeId).update({
                name: newName
            });

            // Si el nombre cambi칩, actualizar todos los gastos que usen este tipo
            if (oldName !== newName) {
                const expensesToUpdate = db.expenses.filter(e => e.category === oldName);

                if (expensesToUpdate.length > 0) {
                    const batch = db_firestore.batch();
                    expensesToUpdate.forEach(expense => {
                        const expenseRef = db_firestore.collection('expenses').doc(expense.id);
                        batch.update(expenseRef, { category: newName });
                    });
                    await batch.commit();

                    alert(`Tipo de gasto actualizado correctamente.\nSe actualizaron ${expensesToUpdate.length} gasto(s) asociado(s).`);
                } else {
                    alert('Tipo de gasto actualizado correctamente.');
                }
            } else {
                alert('Tipo de gasto actualizado correctamente.');
            }

            closeEditExpenseTypeModal();
        } catch (error) {
            alert('Error al actualizar el tipo de gasto: ' + error.message);
        }
    });

    // ========== FUNCIONES PARA EDITAR CIERRES DE CAJA (ADMINISTRADOR) ==========

    async function openEditClosureModal(closureId) {
        try {
            const docSnap = await db_firestore.collection('cash_closures').doc(closureId).get();
            if (!docSnap.exists) {
                alert('Cierre de caja no encontrado.');
                return;
            }

            const closure = docSnap.data();

            // Poblar dropdown de veh칤culos
            const vehicleSelect = document.getElementById('edit-closure-vehicle');
            vehicleSelect.innerHTML = '<option value="">Sin veh칤culo</option>';
            db.vehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle.id;
                option.textContent = `${vehicle.plate} - ${vehicle.brand}`;
                if (closure.vehicleId === vehicle.id) {
                    option.selected = true;
                }
                vehicleSelect.appendChild(option);
            });

            // Llenar campos
            document.getElementById('edit-closure-id').value = closureId;
            document.getElementById('edit-closure-opening-km').value = closure.openingKm || '';
            document.getElementById('edit-closure-closing-km').value = closure.closingKm || '';
            document.getElementById('edit-closure-opening').value = closure.openingBalance || 0;
            document.getElementById('edit-closure-cash-sales').value = closure.cashSales || 0;
            document.getElementById('edit-closure-cash-expenses').value = closure.cashExpenses || 0;
            document.getElementById('edit-closure-collections').value = closure.collections || 0;
            document.getElementById('edit-closure-physical').value = closure.physicalCash || 0;
            document.getElementById('edit-closure-credit-sales').value = closure.creditSales || 0;
            document.getElementById('edit-closure-transfer-sales').value = closure.transferSales || 0;

            document.getElementById('edit-closure-modal').classList.remove('hidden');
        } catch (error) {
            console.error('Error al abrir modal de edici칩n:', error);
            alert('Error al cargar el cierre de caja: ' + error.message);
        }
    }

    function closeEditClosureModal() {
        document.getElementById('edit-closure-modal').classList.add('hidden');
        document.getElementById('edit-closure-form').reset();
    }

    async function deleteClosureAdmin(closureId) {
        if (!confirm('쮼st치 seguro de eliminar este cierre de caja? Esta acci칩n no se puede deshacer.')) {
            return;
        }

        try {
            await db_firestore.collection('cash_closures').doc(closureId).delete();
            alert('Cierre de caja eliminado correctamente.');
            filterClosures(); // Recargar la lista
        } catch (error) {
            console.error('Error al eliminar cierre:', error);
            alert('Error al eliminar el cierre: ' + error.message);
        }
    }

    // Listener para el formulario de edici칩n de cierres
    document.getElementById('edit-closure-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const closureId = document.getElementById('edit-closure-id').value;
        const vehicleId = document.getElementById('edit-closure-vehicle').value || null;
        const openingKm = parseInt(document.getElementById('edit-closure-opening-km').value) || null;
        const closingKm = parseInt(document.getElementById('edit-closure-closing-km').value) || null;
        const openingBalance = parseFloat(document.getElementById('edit-closure-opening').value);
        const cashSales = parseFloat(document.getElementById('edit-closure-cash-sales').value);
        const cashExpenses = parseFloat(document.getElementById('edit-closure-cash-expenses').value);
        const collections = parseFloat(document.getElementById('edit-closure-collections').value);
        const physicalCash = parseFloat(document.getElementById('edit-closure-physical').value);
        const creditSales = parseFloat(document.getElementById('edit-closure-credit-sales').value) || 0;
        const transferSales = parseFloat(document.getElementById('edit-closure-transfer-sales').value) || 0;

        // Calcular el efectivo esperado y la diferencia
        const expectedCash = openingBalance + cashSales + collections - cashExpenses;
        const difference = physicalCash - expectedCash;

        try {
            const updateData = {
                openingBalance,
                cashSales,
                cashExpenses,
                collections,
                physicalCash,
                creditSales,
                transferSales,
                expectedCash,
                difference
            };

            // Solo agregar vehicleId y KMs si se proporcionaron
            if (vehicleId) {
                updateData.vehicleId = vehicleId;
            }
            if (openingKm !== null) {
                updateData.openingKm = openingKm;
            }
            if (closingKm !== null) {
                updateData.closingKm = closingKm;
            }

            await db_firestore.collection('cash_closures').doc(closureId).update(updateData);

            alert('九 Cierre de caja actualizado correctamente.');
            closeEditClosureModal();
            filterClosures(); // Recargar la lista
        } catch (error) {
            console.error('Error al actualizar cierre:', error);
            alert('Error al actualizar el cierre: ' + error.message);
        }
    });

    // ========== FUNCIONES PARA HISTORIAL DE CIERRES DEL VENDEDOR ==========

    async function loadSellerClosures() {
        const list = document.getElementById('seller-closures-list');
        if (!list) return;

        list.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-500">Cargando...</td></tr>';

        try {
            const snapshot = await db_firestore.collection('cash_closures')
                .where('sellerId', '==', auth.currentUser.uid)
                .orderBy('closeTimestamp', 'desc')
                .limit(20)
                .get();

            if (snapshot.empty) {
                list.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-500">No se encontraron cierres de caja</td></tr>';
                return;
            }

            list.innerHTML = '';
            snapshot.forEach(doc => {
                const closure = doc.data();
                const diff = closure.difference;
                const diffClass = diff < 0 ? 'text-red-500' : (diff > 0 ? 'text-green-500' : 'text-slate-500');
                const diffText = diff < 0 ? `Faltante: $${Math.abs(diff).toFixed(2)}` : (diff > 0 ? `Sobrante: $${diff.toFixed(2)}` : '$0.00');

                const row = `
                    <tr>
                        <td class="py-3 px-4">${closure.closeTimestamp.toDate().toLocaleString()}</td>
                        <td class="py-3 px-4">$${closure.openingBalance.toFixed(2)}</td>
                        <td class="py-3 px-4">$${closure.expectedCash.toFixed(2)}</td>
                        <td class="py-3 px-4">$${closure.physicalCash.toFixed(2)}</td>
                        <td class="py-3 px-4 ${diffClass} font-semibold">${diffText}</td>
                        <td class="py-3 px-4">
                            <button onclick="generateSellerClosurePdf('${doc.id}')" class="text-blue-500 hover:underline">Descargar PDF</button>
                        </td>
                    </tr>
                `;
                list.innerHTML += row;
            });
        } catch (error) {
            console.error('Error al cargar cierres:', error);
            list.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Error al cargar los cierres</td></tr>';
        }
    }

    async function generateSellerClosurePdf(closureId) {
        let currentY = 0; // Declarar currentY al inicio para usarlo en toda la funci칩n
        try {
            const docSnap = await db_firestore.collection('cash_closures').doc(closureId).get();
            if (!docSnap.exists) {
                alert('No se encontr칩 el cierre.');
                return;
            }

            const closure = docSnap.data();

            // Obtener las ventas del d칤a del cierre usando fecha local
            const closureDateTime = closure.closeTimestamp.toDate();
            const year = closureDateTime.getFullYear();
            const month = String(closureDateTime.getMonth() + 1).padStart(2, '0');
            const day = String(closureDateTime.getDate()).padStart(2, '0');
            const closureDate = `${year}-${month}-${day}`;

            const salesSnapshot = await db_firestore.collection('sales')
                .where('sellerId', '==', closure.sellerId)
                .where('date', '==', closureDate)
                .get();

            const todaySales = salesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

            // Calcular totales por m칠todo de pago
            const totalCashSales = todaySales.filter(s => s.paymentMethod === 'efectivo').reduce((sum, s) => sum + s.total, 0);
            const totalTransferSales = todaySales.filter(s => s.paymentMethod === 'transferencia').reduce((sum, s) => sum + s.total, 0);
            const totalCreditSales = todaySales.filter(s => s.paymentMethod === 'credito').reduce((sum, s) => sum + s.total, 0);
            const totalAllSales = totalCashSales + totalTransferSales + totalCreditSales;

            const doc = new jsPDF();

            // Encabezado
            doc.setFontSize(18);
            doc.setTextColor(22, 160, 133);
            doc.text('Reporte de Cierre de Caja', 14, 20);

            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text(`Fecha: ${closure.closeTimestamp.toDate().toLocaleString()}`, 14, 28);
            // Obtener nombre del vendedor
            const sellerDoc = await db_firestore.collection('users').doc(closure.sellerId).get();
            const sellerName = sellerDoc.exists ? (sellerDoc.data().name || sellerDoc.data().email) : 'Usuario';
            doc.text(`Vendedor: ${sellerName}`, 14, 34);

            // Resumen de Efectivo
            doc.setFontSize(14);
            doc.setTextColor(22, 160, 133);
            doc.text('Resumen de Efectivo', 14, 45);

            doc.autoTable({
                startY: 50,
                theme: 'grid',
                body: [
                    ['(+) Monto Inicial', `$${closure.openingBalance.toFixed(2)}`],
                    ['(+) Ventas Efectivo', `$${closure.cashSales.toFixed(2)}`],
                    ['(+) Cobros', `$${closure.collections.toFixed(2)}`],
                    ['(+) Abonos Cr칠ditos', `$${(closure.creditPayments || 0).toFixed(2)}`],
                    ['(-) Gastos Efectivo', `-$${closure.cashExpenses.toFixed(2)}`],
                    ['(=) Total Esperado', `$${closure.expectedCash.toFixed(2)}`],
                    ['Fisico Contado', `$${closure.physicalCash.toFixed(2)}`],
                    ['Diferencia', `${closure.difference < 0 ? 'Faltante' : 'Sobrante'}: $${Math.abs(closure.difference).toFixed(2)}`]
                ],
                styles: { fontSize: 10 },
                headStyles: { fillColor: [22, 160, 133] },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 90 },
                    1: { halign: 'right', cellWidth: 50 }
                }
            });

            let currentY = doc.lastAutoTable.finalY + 10;

            // Resumen de Ventas por M칠todo de Pago
            doc.setFontSize(14);
            doc.setTextColor(22, 160, 133);
            doc.text('Resumen de Ventas', 14, currentY);

            doc.autoTable({
                startY: currentY + 5,
                theme: 'grid',
                head: [['Metodo de Pago', 'Cantidad', 'Total']],
                body: [
                    ['Efectivo', todaySales.filter(s => s.paymentMethod === 'efectivo').length.toString(), `$${totalCashSales.toFixed(2)}`],
                    ['Transferencia', todaySales.filter(s => s.paymentMethod === 'transferencia').length.toString(), `$${totalTransferSales.toFixed(2)}`],
                    ['Credito', todaySales.filter(s => s.paymentMethod === 'credito').length.toString(), `$${totalCreditSales.toFixed(2)}`],
                    ['TOTAL GENERAL', todaySales.length.toString(), `$${totalAllSales.toFixed(2)}`]
                ],
                styles: { fontSize: 10 },
                headStyles: { fillColor: [22, 160, 133] },
                columnStyles: {
                    0: { cellWidth: 70 },
                    1: { halign: 'center', cellWidth: 30 },
                    2: { halign: 'right', cellWidth: 40, fontStyle: 'bold' }
                },
                bodyStyles: {
                    3: { fillColor: [220, 220, 220], fontStyle: 'bold' }
                }
            });

            currentY = doc.lastAutoTable.finalY + 10;

            // Detalle de Ventas
            if (todaySales.length > 0) {
                doc.setFontSize(14);
                doc.setTextColor(22, 160, 133);
                doc.text('Detalle de Ventas', 14, currentY);

                // Preparar datos para la tabla con detalle de productos
                const salesData = [];
                todaySales.forEach((sale, index) => {
                    const items = sale.items || [];
                    const itemsText = items.length > 0
                        ? items.map(i => `${i.name} (${i.quantity}x$${i.price.toFixed(2)})`).join(', ')
                        : 'Sin productos';

                    salesData.push([
                        (index + 1).toString(),
                        sale.clientName || 'Cliente General',
                        sale.paymentMethod,
                        itemsText,
                        `$${sale.total.toFixed(2)}`
                    ]);
                });

                doc.autoTable({
                    startY: currentY + 5,
                    theme: 'striped',
                    head: [['#', 'Cliente', 'Metodo', 'Productos', 'Total']],
                    body: salesData,
                    styles: { fontSize: 7, cellPadding: 2 },
                    headStyles: { fillColor: [22, 160, 133], fontSize: 8 },
                    columnStyles: {
                        0: { cellWidth: 10, halign: 'center' },
                        1: { cellWidth: 35 },
                        2: { cellWidth: 23 },
                        3: { cellWidth: 95 },
                        4: { cellWidth: 25, halign: 'right', fontStyle: 'bold' }
                    },
                    margin: { left: 10, right: 10 }
                });

                currentY = doc.lastAutoTable.finalY + 10;

                // Productos m치s vendidos
                const productStats = {};
                todaySales.forEach(sale => {
                    sale.items.forEach(item => {
                        if (!productStats[item.name]) {
                            productStats[item.name] = 0;
                        }
                        productStats[item.name] += item.quantity;
                    });
                });

                const topProducts = Object.entries(productStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                if (topProducts.length > 0) {
                    if (currentY > 250) {
                        doc.addPage();
                        currentY = 20;
                    }

                    doc.setFontSize(14);
                    doc.setTextColor(22, 160, 133);
                    doc.text('Productos Mas Vendidos', 14, currentY);

                    const productsData = topProducts.map(([name, qty], index) => {
                        return [
                            (index + 1).toString(),
                            name,
                            qty.toString()
                        ];
                    });

                    doc.autoTable({
                        startY: currentY + 5,
                        theme: 'grid',
                        head: [['Pos', 'Producto', 'Cantidad']],
                        body: productsData,
                        styles: { fontSize: 10 },
                        headStyles: { fillColor: [22, 160, 133] },
                        columnStyles: {
                            0: { cellWidth: 20, halign: 'center' },
                            1: { cellWidth: 90 },
                            2: { cellWidth: 30, halign: 'center', fontStyle: 'bold' }
                        }
                    });
                }
            } else {
                doc.setFontSize(11);
                doc.setTextColor(100, 100, 100);
                doc.text('No se registraron ventas en este periodo', 14, currentY);
            }

            // Inventario Final
            currentY = doc.lastAutoTable.finalY + 10 || currentY + 10;
            if (currentY > 250) {
                doc.addPage();
                currentY = 20;
            }

            if (closure.closingInventory && closure.closingInventory.length > 0) {
                doc.setFontSize(14);
                doc.setTextColor(22, 160, 133);
                doc.text('Inventario Final', 14, currentY);

                const inventoryData = closure.closingInventory.map((item) => {
                    const product = db.products.find(p => p.id === item.productId);
                    const productName = product ? product.name : 'Desconocido';
                    const initialQty = item.initialQuantity || 0;
                    const finalQty = item.quantity;
                    const diff = finalQty - initialQty;
                    const diffText = diff >= 0 ? `+${diff}` : diff.toString();

                    const categoryLabels = {
                        'bidon_lleno': 'Bid칩n Lleno',
                        'bidon_vacio': 'Bid칩n Vac칤o',
                        'recarga': 'Recarga',
                        'equipo': 'Equipo',
                        'paca': 'Paca'
                    };
                    const categoryLabel = product ? (categoryLabels[product.category] || product.category) : '';

                    return [
                        productName,
                        categoryLabel,
                        initialQty.toString(),
                        finalQty.toString(),
                        diffText
                    ];
                });

                doc.autoTable({
                    startY: currentY + 5,
                    theme: 'grid',
                    head: [['Producto', 'Categoria', 'Inicial', 'Final', 'Diferencia']],
                    body: inventoryData,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [22, 160, 133] },
                    columnStyles: {
                        0: { cellWidth: 70 },
                        1: { cellWidth: 35 },
                        2: { halign: 'center', cellWidth: 25 },
                        3: { halign: 'center', cellWidth: 25, fontStyle: 'bold' },
                        4: { halign: 'center', cellWidth: 25 }
                    }
                });
            }

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Pagina ${i} de ${pageCount}`, 14, 285);
                doc.text(`Generado el ${new Date().toLocaleString()}`, 120, 285);
            }

            doc.save(`cierre_caja_${closureDate}.pdf`);
        } catch (error) {
            console.error('Error al generar PDF:', error);
            alert('Error al generar el PDF: ' + error.message);
        }
    }

</script>
</body>
</html>
