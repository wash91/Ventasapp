<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ventas y Administración</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bibliotecas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- SDK de Firebase (versión compat para facilidad de uso) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <!-- Estilos personalizados -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        .tab-button { transition: all 0.3s ease; }
        .tab-button.active { border-color: #3b82f6; color: #3b82f6; background-color: #eff6ff; }
        .dark .tab-button.active { border-color: #60a5fa; color: #60a5fa; background-color: #1e293b; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 50; }
        .sidebar-button { transition: all 0.2s ease-in-out; }
        .sidebar-button.active { background-color: #eff6ff; color: #3b82f6; font-weight: 600; }
        .dark .sidebar-button.active { background-color: #334155; color: #60a5fa; }
        .sidebar-button:not(.active):hover { background-color: #f3f4f6; }
        .dark .sidebar-button:not(.active):hover { background-color: #1e293b; }
        .price-input {
            width: 80px;
            background-color: transparent;
            border: 1px solid transparent;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        .price-input:hover, .price-input:focus {
            border-color: #9ca3af;
        }
        .dark .price-input:hover, .dark .price-input:focus {
            border-color: #4b5563;
        }
        #status-indicator {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            z-index: 100;
            transition: background-color 0.3s ease;
        }
        .online { background-color: #22c55e; } /* green-500 */
        .offline { background-color: #ef4444; } /* red-500 */
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="antialiased text-slate-700 dark:text-slate-300 bg-gray-100 dark:bg-slate-900">
    
    <div id="status-indicator" title="Estado de la conexión"></div>

    <!-- Vista de Autenticación -->
    <div id="auth-view" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg">
            <div id="login-container">
                <h1 class="text-3xl font-bold text-center text-slate-800 dark:text-white mb-6">Iniciar Sesión</h1>
                <form id="login-form" class="space-y-4 mb-4">
                    <input type="email" id="login-email" placeholder="Correo Electrónico" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600" required>
                    <input type="password" id="login-password" placeholder="Contraseña" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600" required>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Ingresar</button>
                </form>
            </div>
            <p id="auth-error" class="text-red-500 text-center text-sm mt-4 h-4"></p>
        </div>
    </div>

    <!-- Módulo de Administrador -->
    <div id="admin-view" class="hidden min-h-screen p-4 sm:p-6 md:p-8">
        <div class="max-w-7xl mx-auto">
            <header class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-extrabold text-slate-900 dark:text-white tracking-tight">Módulo de Administrador</h1>
                <div class="flex items-center gap-4">
                    <button class="logout-btn bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition">Salir</button>
                </div>
            </header>
            <div id="admin-tabs" class="mb-6 border-b border-slate-200 dark:border-slate-700">
                <nav class="flex space-x-4 flex-wrap"><button data-target="admin-dashboard" class="tab-button active font-semibold py-3 px-1 border-b-2 border-transparent">Dashboard</button><button data-target="admin-products" class="tab-button font-semibold py-3 px-1 border-b-2 border-transparent">Productos</button><button data-target="admin-expense-types" class="tab-button font-semibold py-3 px-1 border-b-2 border-transparent">Tipos de Gasto</button><button data-target="admin-sales-goals" class="tab-button font-semibold py-3 px-1 border-b-2 border-transparent">Metas</button><button data-target="admin-management" class="tab-button font-semibold py-3 px-1 border-b-2 border-transparent">Gestión</button><button data-target="admin-closures" class="tab-button font-semibold py-3 px-1 border-b-2 border-transparent">Cierres de Caja</button><button data-target="admin-reports" class="tab-button font-semibold py-3 px-1 border-b-2 border-transparent">Reportes</button></nav>
            </div>
            <div id="admin-content">
                <div id="admin-dashboard">
                    <!-- Filtros Dashboard -->
                    <div class="bg-gradient-to-r from-purple-500 to-pink-600 p-6 rounded-2xl shadow-lg mb-6">
                        <div class="flex items-center gap-3 mb-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <h2 class="text-2xl font-bold text-white">Dashboard de Ventas</h2>
                        </div>
                        <div class="flex flex-wrap gap-3 items-end">
                            <div>
                                <label class="text-white text-sm font-medium mb-1 block">Fecha Inicio</label>
                                <input type="date" id="dashboard-start-date" class="p-2.5 border-0 rounded-lg bg-white/90 backdrop-blur shadow-sm focus:ring-2 focus:ring-white">
                            </div>
                            <div>
                                <label class="text-white text-sm font-medium mb-1 block">Fecha Fin</label>
                                <input type="date" id="dashboard-end-date" class="p-2.5 border-0 rounded-lg bg-white/90 backdrop-blur shadow-sm focus:ring-2 focus:ring-white">
                            </div>
                            <button id="filter-dashboard-btn" class="bg-white text-purple-600 font-bold py-2.5 px-6 rounded-lg hover:bg-purple-50 transition shadow-md">
                                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                Filtrar
                            </button>
                            <button id="reset-dashboard-btn" class="bg-white/20 text-white font-bold py-2.5 px-6 rounded-lg hover:bg-white/30 transition border border-white/50">Ver Hoy</button>
                        </div>
                    </div>

                    <!-- Estadísticas Principales -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl shadow-lg text-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Ventas Totales</span>
                                <svg class="w-10 h-10 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <p id="admin-total-sales" class="text-4xl font-bold">$0.00</p>
                            <p id="admin-sales-count" class="text-xs opacity-75 mt-1">0 ventas</p>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-xl shadow-lg text-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Gastos Totales</span>
                                <svg class="w-10 h-10 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <p id="admin-total-expenses" class="text-4xl font-bold">$0.00</p>
                            <p id="admin-expenses-count" class="text-xs opacity-75 mt-1">0 gastos</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl shadow-lg text-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Balance General</span>
                                <svg class="w-10 h-10 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <p id="admin-balance" class="text-4xl font-bold">$0.00</p>
                            <p class="text-xs opacity-75 mt-1">Ventas - Gastos</p>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 p-6 rounded-xl shadow-lg text-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Créditos Pendientes</span>
                                <svg class="w-10 h-10 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <p id="admin-credits-pending" class="text-4xl font-bold">$0.00</p>
                            <p id="admin-credits-count" class="text-xs opacity-75 mt-1">0 pendientes</p>
                        </div>
                    </div>

                    <!-- Top Productos y Vendedores -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Producto Más Vendido -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-indigo-100 dark:bg-indigo-900 p-3 rounded-xl">
                                    <svg class="w-6 h-6 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Producto Más Vendido</h3>
                            </div>
                            <div id="top-product-container" class="space-y-3">
                                <p class="text-slate-500 text-center py-4">Consultando datos...</p>
                            </div>
                        </div>

                        <!-- Vendedor con Más Ventas -->
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="bg-purple-100 dark:bg-purple-900 p-3 rounded-xl">
                                    <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Vendedor con Más Ventas</h3>
                            </div>
                            <div id="top-seller-container" class="space-y-3">
                                <p class="text-slate-500 text-center py-4">Consultando datos...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Top 5 Productos -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="bg-teal-100 dark:bg-teal-900 p-3 rounded-xl">
                                <svg class="w-6 h-6 text-teal-600 dark:text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-slate-900 dark:text-white">Top 5 Productos Más Vendidos</h3>
                        </div>
                        <div id="top5-products-container" class="overflow-x-auto">
                            <p class="text-slate-500 text-center py-4">Consultando datos...</p>
                        </div>
                    </div>
                </div>
                <div id="admin-products" class="hidden"><div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md"><h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Registrar Nuevo Producto</h2><form id="add-product-form" class="grid grid-cols-1 md:grid-cols-4 gap-4"><input type="text" id="product-name" placeholder="Nombre del Producto" class="p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required><input type="number" id="product-price-normal" placeholder="Precio Normal" min="0" step="0.01" class="p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required><input type="number" id="product-price-business" placeholder="Precio Negocio" min="0" step="0.01" class="p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white" required><button type="submit" class="md:col-span-1 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Agregar Producto</button></form><hr class="my-6 border-slate-200 dark:border-slate-700"><h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Lista de Productos</h3><div class="overflow-x-auto"><table class="min-w-full bg-white dark:bg-slate-800"><thead class="bg-slate-50 dark:bg-slate-700"><tr><th class="py-3 px-4 text-left font-semibold text-sm">Nombre</th><th class="py-3 px-4 text-left font-semibold text-sm">Precio Normal</th><th class="py-3 px-4 text-left font-semibold text-sm">Precio Negocio</th><th class="py-3 px-4 text-left font-semibold text-sm">Acciones</th></tr></thead><tbody id="product-list" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody></table></div></div></div>
                <div id="admin-expense-types" class="hidden"><div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md"><h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Definir Tipos de Gasto</h2><form id="add-expense-type-form" class="flex gap-4 mb-6"><input type="text" id="expense-type-name" placeholder="Nombre del Tipo de Gasto" class="flex-grow p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600" required><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Agregar</button></form><h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Lista de Tipos de Gasto</h3><div class="overflow-x-auto"><table class="min-w-full bg-white dark:bg-slate-800"><thead class="bg-slate-50 dark:bg-slate-700"><tr><th class="py-3 px-4 text-left font-semibold text-sm">Nombre</th><th class="py-3 px-4 text-left font-semibold text-sm">Acciones</th></tr></thead><tbody id="expense-type-list" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody></table></div></div></div>

                <!-- Módulo de Metas de Ventas -->
                <div id="admin-sales-goals" class="hidden">
                    <div class="bg-gradient-to-r from-orange-500 to-red-600 p-6 rounded-2xl shadow-lg mb-6">
                        <div class="flex items-center gap-3 mb-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                            </svg>
                            <h2 class="text-2xl font-bold text-white">Asignación de Metas de Ventas</h2>
                        </div>
                        <p class="text-white/90 text-sm">Asigna metas mensuales a tus vendedores para motivar y medir el desempeño</p>
                    </div>

                    <!-- Formulario de Nueva Meta -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg mb-6 border border-slate-200 dark:border-slate-700">
                        <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Crear Nueva Meta</h3>
                        <form id="add-sales-goal-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="text-sm font-medium text-slate-700 dark:text-slate-300 block mb-1">Vendedor</label>
                                <select id="goal-seller" class="w-full p-2.5 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:ring-2 focus:ring-orange-500" required>
                                    <option value="">Seleccionar vendedor</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-slate-700 dark:text-slate-300 block mb-1">Mes</label>
                                <input type="month" id="goal-month" class="w-full p-2.5 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:ring-2 focus:ring-orange-500" required>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-slate-700 dark:text-slate-300 block mb-1">Meta ($)</label>
                                <input type="number" id="goal-amount" placeholder="5000.00" min="0" step="0.01" class="w-full p-2.5 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:ring-2 focus:ring-orange-500" required>
                            </div>
                            <div class="flex items-end">
                                <button type="submit" class="w-full bg-orange-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-orange-700 transition">
                                    <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Crear Meta
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Lista de Metas Activas -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                        <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Metas Activas</h3>
                        <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
                            <table class="min-w-full bg-white dark:bg-slate-800">
                                <thead class="bg-gradient-to-r from-orange-50 to-red-50 dark:from-slate-700 dark:to-slate-700">
                                    <tr>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-orange-900 dark:text-orange-400">Vendedor</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-orange-900 dark:text-orange-400">Mes</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-orange-900 dark:text-orange-400">Meta</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-orange-900 dark:text-orange-400">Vendido</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-orange-900 dark:text-orange-400">Cumplimiento</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-orange-900 dark:text-orange-400">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="sales-goals-list" class="divide-y divide-slate-200 dark:divide-slate-700">
                                    <tr><td colspan="6" class="text-center py-8 text-slate-500">No hay metas registradas</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="admin-management" class="hidden">
                    <!-- Filtros -->
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-6 rounded-2xl shadow-lg mb-6">
                        <div class="flex items-center gap-3 mb-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                            </svg>
                            <h2 class="text-2xl font-bold text-white">Gestión de Ventas y Gastos</h2>
                        </div>
                        <div class="flex flex-wrap gap-3 items-end">
                            <div>
                                <label class="text-white text-sm font-medium mb-1 block">Fecha Inicio</label>
                                <input type="date" id="management-start-date" class="p-2.5 border-0 rounded-lg bg-white/90 backdrop-blur shadow-sm focus:ring-2 focus:ring-white">
                            </div>
                            <div>
                                <label class="text-white text-sm font-medium mb-1 block">Fecha Fin</label>
                                <input type="date" id="management-end-date" class="p-2.5 border-0 rounded-lg bg-white/90 backdrop-blur shadow-sm focus:ring-2 focus:ring-white">
                            </div>
                            <div>
                                <label class="text-white text-sm font-medium mb-1 block">Vendedor</label>
                                <select id="management-seller-filter" class="p-2.5 border-0 rounded-lg bg-white/90 backdrop-blur shadow-sm focus:ring-2 focus:ring-white">
                                    <option value="">Todos los vendedores</option>
                                </select>
                            </div>
                            <button id="query-management-btn" class="bg-white text-indigo-600 font-bold py-2.5 px-6 rounded-lg hover:bg-indigo-50 transition shadow-md">
                                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                Consultar
                            </button>
                        </div>
                    </div>

                    <!-- Estadísticas Resumen -->
                    <div id="management-stats" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-green-500 to-green-600 p-5 rounded-xl shadow-lg text-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Total Ventas</span>
                                <svg class="w-8 h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <p id="management-total-sales" class="text-3xl font-bold">$0.00</p>
                            <p id="management-count-sales" class="text-xs opacity-75 mt-1">0 registros</p>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 p-5 rounded-xl shadow-lg text-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Total Gastos</span>
                                <svg class="w-8 h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
                                </svg>
                            </div>
                            <p id="management-total-expenses" class="text-3xl font-bold">$0.00</p>
                            <p id="management-count-expenses" class="text-xs opacity-75 mt-1">0 registros</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-5 rounded-xl shadow-lg text-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Balance</span>
                                <svg class="w-8 h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <p id="management-balance" class="text-3xl font-bold">$0.00</p>
                            <p class="text-xs opacity-75 mt-1">Ventas - Gastos</p>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 p-5 rounded-xl shadow-lg text-white">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium opacity-90">Créditos</span>
                                <svg class="w-8 h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <p id="management-total-credits" class="text-3xl font-bold">$0.00</p>
                            <p id="management-count-credits" class="text-xs opacity-75 mt-1">0 pendientes</p>
                        </div>
                    </div>

                    <!-- Ventas -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg mb-6 border border-slate-200 dark:border-slate-700">
                        <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                            <div class="flex items-center gap-3">
                                <div class="bg-green-100 dark:bg-green-900 p-3 rounded-xl">
                                    <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-2xl font-bold text-slate-900 dark:text-white">Ventas Registradas</h3>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <input type="text" id="search-sales" placeholder="Buscar por cliente..." class="px-3 py-2 text-sm border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:ring-2 focus:ring-green-500">
                                <select id="filter-sales-payment" class="px-3 py-2 text-sm border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:ring-2 focus:ring-green-500">
                                    <option value="">Todos los métodos</option>
                                    <option value="efectivo">Efectivo</option>
                                    <option value="transferencia">Transferencia</option>
                                    <option value="credito">Crédito</option>
                                </select>
                                <button onclick="exportSalesToExcel()" class="px-3 py-2 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Excel
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
                            <table class="min-w-full bg-white dark:bg-slate-800">
                                <thead class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-slate-700 dark:to-slate-700">
                                    <tr>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-green-900 dark:text-green-400">Fecha</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-green-900 dark:text-green-400">Vendedor</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-green-900 dark:text-green-400">Cliente</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-green-900 dark:text-green-400">Total</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-green-900 dark:text-green-400">Método</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-green-900 dark:text-green-400">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="management-sales-list" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Gastos -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                        <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                            <div class="flex items-center gap-3">
                                <div class="bg-red-100 dark:bg-red-900 p-3 rounded-xl">
                                    <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-2xl font-bold text-slate-900 dark:text-white">Gastos Registrados</h3>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <input type="text" id="search-expenses" placeholder="Buscar por categoría..." class="px-3 py-2 text-sm border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:ring-2 focus:ring-red-500">
                                <select id="filter-expenses-payment" class="px-3 py-2 text-sm border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:ring-2 focus:ring-red-500">
                                    <option value="">Todos los métodos</option>
                                    <option value="efectivo">Efectivo</option>
                                    <option value="transferencia">Transferencia</option>
                                </select>
                                <button onclick="exportExpensesToExcel()" class="px-3 py-2 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Excel
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
                            <table class="min-w-full bg-white dark:bg-slate-800">
                                <thead class="bg-gradient-to-r from-red-50 to-rose-50 dark:from-slate-700 dark:to-slate-700">
                                    <tr>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-red-900 dark:text-red-400">Fecha</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-red-900 dark:text-red-400">Vendedor</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-red-900 dark:text-red-400">Categoría</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-red-900 dark:text-red-400">Monto</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-red-900 dark:text-red-400">Método</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-red-900 dark:text-red-400">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="management-expenses-list" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="admin-closures" class="hidden">
                    <!-- Filtros -->
                    <div class="bg-gradient-to-r from-cyan-500 to-blue-600 p-6 rounded-2xl shadow-lg mb-6">
                        <div class="flex items-center gap-3 mb-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            <h2 class="text-2xl font-bold text-white">Consultar Cierres de Caja</h2>
                        </div>
                        <div class="flex flex-wrap gap-3 items-end">
                            <div>
                                <label class="text-white text-sm font-medium mb-1 block">Fecha Inicio</label>
                                <input type="date" id="closure-start-date" class="p-2.5 border-0 rounded-lg bg-white/90 backdrop-blur shadow-sm focus:ring-2 focus:ring-white">
                            </div>
                            <div>
                                <label class="text-white text-sm font-medium mb-1 block">Fecha Fin</label>
                                <input type="date" id="closure-end-date" class="p-2.5 border-0 rounded-lg bg-white/90 backdrop-blur shadow-sm focus:ring-2 focus:ring-white">
                            </div>
                            <button id="filter-closures-btn" class="bg-white text-cyan-600 font-bold py-2.5 px-6 rounded-lg hover:bg-cyan-50 transition shadow-md">
                                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                Consultar
                            </button>
                        </div>
                    </div>

                    <!-- Tabla de Cierres -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="bg-cyan-100 dark:bg-cyan-900 p-3 rounded-xl">
                                <svg class="w-6 h-6 text-cyan-600 dark:text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-slate-900 dark:text-white">Historial de Cierres</h3>
                        </div>
                        <div class="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
                            <table class="min-w-full bg-white dark:bg-slate-800">
                                <thead class="bg-gradient-to-r from-cyan-50 to-blue-50 dark:from-slate-700 dark:to-slate-700">
                                    <tr>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-cyan-900 dark:text-cyan-400">Fecha</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-cyan-900 dark:text-cyan-400">Vendedor</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-cyan-900 dark:text-cyan-400">Diferencia</th>
                                        <th class="py-4 px-6 text-left text-sm font-bold text-cyan-900 dark:text-cyan-400">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="closures-list" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="admin-reports" class="hidden"><div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Generador de Reportes</h2>
                    <div class="flex flex-wrap gap-4 items-center mb-6">
                        <input type="date" id="report-start-date" class="p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                        <input type="date" id="report-end-date" class="p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                        <button id="query-admin-reports-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Consultar</button>
                    </div>

                    <div id="admin-reports-display" class="hidden space-y-8">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Detalle de Ventas</h3>
                                <button onclick="generateDetailedReport('sales')" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Descargar PDF</button>
                            </div>
                            <div class="overflow-x-auto max-h-96"><table class="min-w-full"><thead class="bg-slate-50 dark:bg-slate-700 sticky top-0"><tr id="admin-sales-report-head"></tr></thead><tbody id="admin-sales-report-body" class="divide-y divide-slate-700"></tbody></table></div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Cuentas por Cobrar</h3>
                                <button onclick="generateDetailedReport('sales', true)" class="bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-700">Descargar PDF</button>
                            </div>
                            <div class="overflow-x-auto max-h-96"><table class="min-w-full"><thead class="bg-slate-50 dark:bg-slate-700 sticky top-0"><tr id="admin-credit-report-head"></tr></thead><tbody id="admin-credit-report-body" class="divide-y divide-slate-700"></tbody></table></div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Detalle de Gastos</h3>
                                <button onclick="generateDetailedReport('expenses')" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Descargar PDF</button>
                            </div>
                             <div class="overflow-x-auto max-h-96"><table class="min-w-full"><thead class="bg-slate-50 dark:bg-slate-700 sticky top-0"><tr id="admin-expenses-report-head"></tr></thead><tbody id="admin-expenses-report-body" class="divide-y divide-slate-700"></tbody></table></div>
                        </div>
                        <div>
                             <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Ingresos Adicionales</h3>
                                <button onclick="generateDetailedReport('collections')" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700">Descargar PDF</button>
                            </div>
                            <div class="overflow-x-auto max-h-96"><table class="min-w-full"><thead class="bg-slate-50 dark:bg-slate-700 sticky top-0"><tr id="admin-collections-report-head"></tr></thead><tbody id="admin-collections-report-body" class="divide-y divide-slate-700"></tbody></table></div>
                        </div>
                    </div>
                </div></div>
            </div>
        </div>
    </div>

    <!-- Módulo de Vendedor -->
    <div id="seller-view" class="hidden">
        <aside id="seller-sidebar" class="bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 w-64 min-h-screen flex flex-col fixed inset-y-0 left-0 z-40 transform -translate-x-full transition-transform duration-300 ease-in-out shadow-lg">
            <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center"><h2 class="text-2xl font-bold text-slate-900 dark:text-white">Vendedor</h2></div>
            <nav id="seller-menu" class="flex-1 p-4 space-y-1"><button data-target="seller-dashboard" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg active">Dashboard</button><button data-target="seller-cash" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">Caja</button><button data-target="seller-sales" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">Ventas</button><button data-target="seller-clients" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">Clientes</button><button data-target="seller-credit-accounts" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">Cuentas por Cobrar</button><button data-target="seller-collections" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">Ingresos Adicionales</button><button data-target="seller-expenses" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">Gastos</button><button data-target="seller-cash-closure" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">Cierre de Caja</button><button data-target="seller-reports" class="sidebar-button w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg">Reportes</button></nav>
            <div class="p-4 border-t border-slate-200 dark:border-slate-700 space-y-2"><button class="logout-btn w-full text-left flex items-center gap-3 px-4 py-2 rounded-lg text-red-500 hover:bg-red-500/10 dark:hover:bg-red-500/20 transition">Salir</button></div>
        </aside>

        <main id="seller-main-content" class="flex-1 transition-all duration-300 ease-in-out">
            <div class="p-2 sm:p-4 md:p-6">
                <header class="flex justify-between items-center mb-6">
                     <div class="flex items-center gap-4">
                         <button id="sidebar-toggle" class="p-2 rounded-md bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200"><svg id="menu-open-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg><svg id="menu-close-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                         <h1 class="text-2xl md:text-4xl font-extrabold text-slate-900 dark:text-white tracking-tight">Módulo de Vendedor</h1>
                     </div>
                     <button id="theme-toggle" class="p-2 rounded-md bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200"><svg id="theme-icon-light" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg><svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg></button>
                </header>
                <div id="seller-content">
                    <div id="seller-dashboard">
                        <!-- Nombre del Vendedor -->
                        <div class="bg-gradient-to-r from-slate-700 to-slate-900 p-4 rounded-xl shadow-lg text-white mb-4">
                            <div class="flex items-center gap-3">
                                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                <div>
                                    <div class="text-sm opacity-75">Vendedor</div>
                                    <div id="seller-name-display" class="text-xl font-bold">CARGANDO...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Meta del Día Destacada -->
                        <div id="daily-goal-card" class="mb-6">
                            <!-- Se llenará dinámicamente -->
                        </div>

                        <!-- Resumen Principal: Total Ventas y Total Gastos -->
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-gradient-to-br from-green-500 to-green-700 p-6 rounded-2xl shadow-xl text-white">
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <div class="text-sm opacity-90 font-medium">TOTAL VENTAS</div>
                                </div>
                                <div id="dashboard-total-sales" class="text-3xl font-bold mb-1">$0.00</div>
                                <div id="dashboard-sales-count" class="text-xs opacity-80">0 ventas</div>
                            </div>

                            <div class="bg-gradient-to-br from-red-500 to-red-700 p-6 rounded-2xl shadow-xl text-white">
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 0a3 3 0 110 6H9l3 3m-3-6h6m6 1a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <div class="text-sm opacity-90 font-medium">TOTAL GASTOS</div>
                                </div>
                                <div id="dashboard-total-expenses" class="text-3xl font-bold mb-1">$0.00</div>
                                <div id="dashboard-expenses-count" class="text-xs opacity-80">0 gastos</div>
                            </div>
                        </div>

                        <!-- Meta de Ventas -->
                        <div id="seller-goal-container" class="mb-6">
                            <!-- Se llenará dinámicamente con JavaScript -->
                        </div>

                        <!-- Productos Más Vendidos -->
                        <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-lg">
                            <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                PRODUCTOS VENDIDOS
                            </h3>
                            <div id="dashboard-top-products" class="space-y-3">
                                <p class="text-center py-8 text-slate-500 dark:text-slate-400 text-sm">No hay productos vendidos</p>
                            </div>
                        </div>
                    </div>
                    <div id="seller-cash" class="hidden"><div id="open-cash-view" class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-2xl shadow-md text-center"><h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Abrir Caja</h2><form id="open-cash-form" class="flex flex-col items-center gap-4"><input type="number" id="opening-balance" placeholder="Monto Inicial" min="0" step="0.01" class="p-2 border rounded-lg w-full max-w-xs focus:ring-2 focus:ring-green-500 dark:bg-slate-700 dark:border-slate-600" required><button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Abrir Caja</button></form></div><div id="cash-opened-view" class="hidden bg-white dark:bg-slate-800 p-4 md:p-6 rounded-2xl shadow-md"><h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Caja Abierta</h2><p class="mb-4">Monto Inicial: <span id="display-opening-balance" class="font-bold text-green-500 dark:text-green-400"></span></p><p>Utilice el módulo "Cierre de Caja" para finalizar la sesión.</p></div></div>
                    <div id="seller-sales" class="hidden">
                        <div class="space-y-4">
                            <!-- Formulario de Venta Optimizado para Móvil -->
                            <div class="bg-white dark:bg-slate-800 p-3 sm:p-6 rounded-xl shadow-md">
                                <form id="sale-form">
                                    <h2 class="text-xl sm:text-2xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                        <svg class="w-6 h-6 sm:w-8 sm:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                        Nueva Venta
                                    </h2>

                                    <!-- Información del Cliente con Búsqueda Inteligente -->
                                    <div class="bg-slate-50 dark:bg-slate-700/50 p-3 sm:p-4 rounded-lg mb-4">
                                        <h3 class="font-semibold mb-3 text-sm sm:text-base text-slate-700 dark:text-slate-300">Cliente</h3>
                                        <div class="space-y-3">
                                            <div class="relative">
                                                <label class="text-xs sm:text-sm font-medium text-slate-600 dark:text-slate-400">Buscar Cliente</label>
                                                <div class="relative mt-1">
                                                    <input
                                                        type="text"
                                                        id="client-name"
                                                        placeholder="�� Buscar o crear cliente..."
                                                        autocomplete="off"
                                                        class="w-full p-3 sm:p-4 pr-12 text-base border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                                    <button
                                                        type="button"
                                                        id="toggle-clients-btn"
                                                        class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-slate-500 hover:text-blue-600 active:scale-95 transition">
                                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <!-- Dropdown de clientes -->
                                                <div id="clients-dropdown" class="hidden absolute z-10 w-full mt-1 bg-white dark:bg-slate-700 border-2 border-blue-500 rounded-lg shadow-xl max-h-64 overflow-y-auto">
                                                    <div id="clients-list" class="divide-y divide-slate-200 dark:divide-slate-600">
                                                        <!-- Los clientes se cargan dinámicamente -->
                                                    </div>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="text-xs sm:text-sm font-medium text-slate-600 dark:text-slate-400 block mb-2">Tipo</label>
                                                <div id="client-type-selector" class="grid grid-cols-2 gap-2">
                                                    <label class="flex items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                                        <input type="radio" name="client-type" value="consumidor-final" checked class="w-5 h-5 text-blue-600">
                                                        <span class="text-sm font-medium">Consumidor</span>
                                                    </label>
                                                    <label class="flex items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                                        <input type="radio" name="client-type" value="negocio" class="w-5 h-5 text-blue-600">
                                                        <span class="text-sm font-medium">Negocio</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Búsqueda y Selección de Productos Unificado -->
                                    <div class="bg-slate-50 dark:bg-slate-700/50 p-3 sm:p-4 rounded-lg mb-4">
                                        <h3 class="font-semibold mb-3 text-sm sm:text-base text-slate-700 dark:text-slate-300">Agregar Productos</h3>
                                        <div class="space-y-3">
                                            <div class="relative">
                                                <label class="text-xs sm:text-sm font-medium text-slate-600 dark:text-slate-400">Buscar Producto</label>
                                                <div class="relative mt-1">
                                                    <input
                                                        type="text"
                                                        id="product-search-input"
                                                        placeholder="🔍 Buscar o seleccionar producto..."
                                                        autocomplete="off"
                                                        class="w-full p-3 sm:p-4 pr-12 text-base border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                                    <button
                                                        type="button"
                                                        id="toggle-products-btn"
                                                        class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-slate-500 hover:text-blue-600 active:scale-95 transition">
                                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <!-- Dropdown de productos -->
                                                <div id="products-dropdown" class="hidden absolute z-10 w-full mt-1 bg-white dark:bg-slate-700 border-2 border-blue-500 rounded-lg shadow-xl max-h-64 overflow-y-auto">
                                                    <div id="products-list" class="divide-y divide-slate-200 dark:divide-slate-600">
                                                        <!-- Los productos se cargan dinámicamente -->
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex gap-2">
                                                <div class="w-24 sm:w-32">
                                                    <label class="text-xs sm:text-sm font-medium text-slate-600 dark:text-slate-400">Cantidad</label>
                                                    <input type="number" id="sale-quantity" value="1" min="1" class="w-full p-3 sm:p-4 text-base text-center font-bold border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                                </div>
                                                <div class="flex-1">
                                                    <label class="text-xs sm:text-sm font-medium text-slate-600 dark:text-slate-400 opacity-0">.</label>
                                                    <button type="button" id="add-to-cart-btn" class="w-full bg-blue-600 active:bg-blue-700 text-white p-3 sm:p-4 mt-1 rounded-lg font-bold text-base shadow-lg active:shadow-inner transition flex items-center justify-center gap-2">
                                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                                        <span class="hidden sm:inline">Añadir</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Carrito Compacto -->
                                    <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg mb-3 overflow-hidden">
                                        <div class="bg-slate-100 dark:bg-slate-700 px-3 py-2 border-b border-slate-200 dark:border-slate-600 flex items-center justify-between">
                                            <h3 class="font-semibold text-xs sm:text-sm text-slate-700 dark:text-slate-300">🛒 Carrito</h3>
                                            <span id="cart-count" class="bg-blue-500 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span>
                                        </div>
                                        <div id="current-sale-table" class="divide-y divide-slate-200 dark:divide-slate-700 max-h-48 overflow-y-auto">
                                            <div class="text-center py-6 px-3 text-slate-500 dark:text-slate-400">
                                                <svg class="w-10 h-10 mx-auto mb-1 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                                                <p class="text-xs">Vacío</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Total Compacto -->
                                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/30 p-3 sm:p-4 rounded-lg mb-3 border-2 border-green-300 dark:border-green-700">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm sm:text-base font-bold text-slate-700 dark:text-slate-200">TOTAL:</span>
                                            <span id="current-sale-total" class="text-2xl sm:text-3xl font-extrabold text-green-600 dark:text-green-400">$0.00</span>
                                        </div>
                                    </div>

                                    <!-- Forma de Pago (Botones grandes para móvil) -->
                                    <div class="bg-slate-50 dark:bg-slate-700/50 p-3 sm:p-4 rounded-lg mb-4">
                                        <h3 class="font-semibold mb-3 text-sm sm:text-base text-slate-700 dark:text-slate-300">Forma de Pago</h3>
                                        <div class="grid grid-cols-3 gap-2 mb-3" id="sale-payment-method">
                                            <label class="flex flex-col items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 sm:p-4 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-green-500 has-[:checked]:bg-green-50 dark:has-[:checked]:bg-green-900/30 transition active:scale-95">
                                                <input type="radio" name="sale-payment" value="efectivo" checked class="sr-only">
                                                <span class="text-2xl sm:text-3xl">💵</span>
                                                <span class="text-xs sm:text-sm font-bold">Efectivo</span>
                                            </label>
                                            <label class="flex flex-col items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 sm:p-4 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition active:scale-95">
                                                <input type="radio" name="sale-payment" value="transferencia" class="sr-only">
                                                <span class="text-2xl sm:text-3xl">🏦</span>
                                                <span class="text-xs sm:text-sm font-bold">Transfer.</span>
                                            </label>
                                            <label class="flex flex-col items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 sm:p-4 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-orange-500 has-[:checked]:bg-orange-50 dark:has-[:checked]:bg-orange-900/30 transition active:scale-95">
                                                <input type="radio" name="sale-payment" value="credito" class="sr-only">
                                                <span class="text-2xl sm:text-3xl">📋</span>
                                                <span class="text-xs sm:text-sm font-bold">Crédito</span>
                                            </label>
                                        </div>
                                        <textarea id="sale-transfer-note" placeholder="Nota de transferencia / referencia" class="w-full p-3 text-base border-2 rounded-lg mt-2 hidden focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600" rows="2"></textarea>
                                    </div>

                                    <!-- Botones de Acción (Extra grandes para móvil) -->
                                    <div class="grid grid-cols-3 gap-2">
                                        <button type="button" onclick="clearSaleCart()" class="bg-slate-200 active:bg-slate-300 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-bold py-4 px-2 rounded-lg shadow-md active:shadow-inner transition text-sm">
                                            🗑️
                                            <span class="hidden sm:inline">Limpiar</span>
                                        </button>
                                        <button type="submit" class="col-span-2 bg-gradient-to-r from-green-600 to-green-700 active:from-green-700 active:to-green-800 text-white font-bold py-4 px-4 rounded-lg shadow-lg active:shadow-inner transition text-base sm:text-lg">
                                            💳 Finalizar Venta
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Módulo de Clientes -->
                    <div id="seller-clients" class="hidden">
                        <!-- Pestañas -->
                        <div class="bg-white dark:bg-slate-800 p-2 rounded-xl shadow-md mb-4">
                            <div class="flex gap-2" id="clients-tabs">
                                <button data-tab="create-client" class="tab-button flex-1 py-3 px-4 rounded-lg font-semibold text-sm sm:text-base transition bg-blue-600 text-white">
                                    ➕ Crear Cliente
                                </button>
                                <button data-tab="list-clients" class="tab-button flex-1 py-3 px-4 rounded-lg font-semibold text-sm sm:text-base transition bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300">
                                    📋 Listado
                                </button>
                            </div>
                        </div>

                        <!-- Crear Cliente -->
                        <div id="create-client" class="tab-content">
                            <div class="bg-white dark:bg-slate-800 p-3 sm:p-6 rounded-xl shadow-md">
                                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                    Nuevo Cliente
                                </h2>

                                <form id="add-client-form" class="space-y-4">
                                    <!-- Tipo de Cliente -->
                                    <div>
                                        <label class="text-sm font-semibold text-slate-700 dark:text-slate-300 block mb-2">Tipo de Cliente</label>
                                        <div id="client-form-type-selector" class="grid grid-cols-2 gap-2">
                                            <label class="flex items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                                <input type="radio" name="client-form-type" value="consumidor-final" checked class="w-5 h-5 text-blue-600">
                                                <span class="text-sm font-medium">👤 Consumidor Final</span>
                                            </label>
                                            <label class="flex items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                                                <input type="radio" name="client-form-type" value="negocio" class="w-5 h-5 text-blue-600">
                                                <span class="text-sm font-medium">🏢 Negocio</span>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Nombre del Cliente -->
                                    <div>
                                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Nombre del Cliente *</label>
                                        <input type="text" id="client-name-input" placeholder="Ej: Juan Pérez" required class="w-full p-3 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                    </div>

                                    <!-- Nombre del Negocio (solo para negocios) -->
                                    <div id="business-name-field" class="hidden">
                                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Nombre del Negocio</label>
                                        <input type="text" id="client-business-name" placeholder="Ej: Tienda La Esperanza" class="w-full p-3 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                    </div>

                                    <!-- Teléfono -->
                                    <div>
                                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Teléfono</label>
                                        <input type="tel" id="client-phone" placeholder="Ej: +505 8888-8888" class="w-full p-3 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                    </div>

                                    <!-- Dirección -->
                                    <div>
                                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Dirección</label>
                                        <textarea id="client-address" placeholder="Dirección del cliente" rows="2" class="w-full p-3 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600"></textarea>
                                    </div>

                                    <!-- Ubicación GPS -->
                                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border-2 border-blue-200 dark:border-blue-800">
                                        <label class="text-sm font-semibold text-slate-700 dark:text-slate-300 block mb-2 flex items-center gap-2">
                                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                            Ubicación GPS
                                        </label>
                                        <div class="flex gap-2 mb-2">
                                            <input type="text" id="client-latitude" placeholder="Latitud" readonly class="flex-1 p-2 border rounded-lg bg-slate-100 dark:bg-slate-700 dark:border-slate-600 text-sm">
                                            <input type="text" id="client-longitude" placeholder="Longitud" readonly class="flex-1 p-2 border rounded-lg bg-slate-100 dark:bg-slate-700 dark:border-slate-600 text-sm">
                                        </div>
                                        <button type="button" onclick="getClientLocation()" class="w-full bg-blue-600 active:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md active:shadow-inner transition flex items-center justify-center gap-2">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                            Capturar Ubicación Actual
                                        </button>
                                        <p class="text-xs text-slate-600 dark:text-slate-400 mt-2">Presiona el botón para obtener la ubicación GPS actual del cliente</p>
                                    </div>

                                    <!-- Botones -->
                                    <div class="flex gap-2">
                                        <button type="reset" class="flex-1 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-bold py-3 px-4 rounded-lg active:bg-slate-300 dark:active:bg-slate-600 transition">
                                            Limpiar
                                        </button>
                                        <button type="submit" class="flex-[2] bg-gradient-to-r from-green-600 to-green-700 active:from-green-700 active:to-green-800 text-white font-bold py-3 px-4 rounded-lg shadow-lg active:shadow-inner transition">
                                            💾 Guardar Cliente
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Listado de Clientes -->
                        <div id="list-clients" class="tab-content hidden">
                            <div class="bg-white dark:bg-slate-800 p-3 sm:p-6 rounded-xl shadow-md">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-xl sm:text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                        <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                        Clientes
                                    </h2>
                                    <span id="clients-count" class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-3 py-1 rounded-full text-sm font-bold">0</span>
                                </div>

                                <!-- Búsqueda -->
                                <div class="mb-4">
                                    <input type="text" id="search-clients" placeholder="🔍 Buscar por nombre, negocio o teléfono..." class="w-full p-3 sm:p-4 text-base border-2 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                </div>

                                <!-- Lista de Clientes -->
                                <div id="clients-list-container" class="space-y-2">
                                    <p class="text-center py-8 text-slate-500 dark:text-slate-400">No hay clientes registrados</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="seller-credit-accounts" class="hidden">
                        <!-- Resumen de Cuentas por Cobrar -->
                        <div class="bg-gradient-to-r from-orange-600 to-red-700 p-4 sm:p-6 rounded-xl shadow-lg text-white mb-6">
                            <h2 class="text-xl sm:text-2xl font-bold mb-4 flex items-center gap-2">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                Cuentas por Cobrar
                            </h2>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Total Por Cobrar</div>
                                    <div id="credit-total-pending" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                    <div id="credit-accounts-count" class="text-xs opacity-75">0 cuentas</div>
                                </div>
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Ventas a Crédito</div>
                                    <div id="credit-total-sales" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                </div>
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Abonos Recibidos</div>
                                    <div id="credit-total-payments" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                </div>
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Cuentas Saldadas</div>
                                    <div id="credit-paid-count" class="text-2xl sm:text-3xl font-bold">0</div>
                                </div>
                            </div>
                        </div>

                        <!-- Búsqueda y Filtros -->
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-md mb-4">
                            <div class="flex flex-col sm:flex-row gap-3">
                                <div class="flex-1">
                                    <input type="text" id="credit-client-search" placeholder="🔍 Buscar por cliente..." class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                </div>
                                <select id="credit-status-filter" class="p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                                    <option value="all">Todas las cuentas</option>
                                    <option value="pending">Solo pendientes</option>
                                    <option value="paid">Solo saldadas</option>
                                </select>
                            </div>
                        </div>

                        <!-- Lista de Cuentas -->
                        <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-md">
                            <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Detalle de Cuentas</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead class="bg-slate-50 dark:bg-slate-700">
                                        <tr>
                                            <th class="py-3 px-4 text-left text-xs font-semibold">Fecha</th>
                                            <th class="py-3 px-4 text-left text-xs font-semibold">Cliente</th>
                                            <th class="py-3 px-4 text-left text-xs font-semibold">Total Venta</th>
                                            <th class="py-3 px-4 text-left text-xs font-semibold">Abonado</th>
                                            <th class="py-3 px-4 text-left text-xs font-semibold">Saldo</th>
                                            <th class="py-3 px-4 text-left text-xs font-semibold">Estado</th>
                                            <th class="py-3 px-4 text-left text-xs font-semibold">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="credit-sales-list" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="seller-collections" class="hidden">
                        <!-- Resumen de Ingresos Adicionales -->
                        <div class="bg-gradient-to-r from-cyan-600 to-blue-700 p-4 sm:p-6 rounded-xl shadow-lg text-white mb-6">
                            <h2 class="text-xl sm:text-2xl font-bold mb-4 flex items-center gap-2">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Ingresos Adicionales
                            </h2>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 sm:gap-4">
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Total del Día</div>
                                    <div id="collections-today-total" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                    <div id="collections-today-count" class="text-xs opacity-75">0 ingresos</div>
                                </div>
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Total del Mes</div>
                                    <div id="collections-month-total" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                </div>
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Mayor Ingreso</div>
                                    <div id="collections-max" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Formulario de Registro -->
                            <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-md">
                                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                    Registrar Nuevo Ingreso
                                </h3>
                                <form id="add-collection-form" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Origen del Ingreso</label>
                                        <input type="text" id="collection-client-name" placeholder="Ej: Devolución, Bonificación, etc." class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Monto</label>
                                        <input type="number" id="collection-amount" placeholder="0.00" min="0" step="0.01" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Descripción / Razón</label>
                                        <textarea id="collection-reason" placeholder="Describe el motivo del ingreso..." class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" rows="3" required></textarea>
                                    </div>
                                    <button type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg transition flex items-center justify-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                        Registrar Ingreso
                                    </button>
                                </form>
                            </div>

                            <!-- Historial de Ingresos del Día -->
                            <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-md">
                                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                                    Historial del Día
                                </h3>
                                <div id="collections-today-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>
                    <div id="seller-expenses" class="hidden">
                        <!-- Resumen de Gastos -->
                        <div class="bg-gradient-to-r from-red-600 to-pink-700 p-4 sm:p-6 rounded-xl shadow-lg text-white mb-6">
                            <h2 class="text-xl sm:text-2xl font-bold mb-4 flex items-center gap-2">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 0a3 3 0 110 6H9l3 3m-3-6h6m6 1a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Gastos
                            </h2>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Total del Día</div>
                                    <div id="expenses-today-total" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                    <div id="expenses-today-count" class="text-xs opacity-75">0 gastos</div>
                                </div>
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Efectivo</div>
                                    <div id="expenses-cash-total" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                </div>
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Transfer./Créd.</div>
                                    <div id="expenses-other-total" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                </div>
                                <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                    <div class="text-xs sm:text-sm opacity-90">Mayor Gasto</div>
                                    <div id="expenses-max" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Formulario de Registro -->
                            <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-md">
                                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                    Registrar Nuevo Gasto
                                </h3>
                                <form id="add-expense-form" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Tipo de Gasto</label>
                                        <select id="expense-category-selector" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                                            <option value="">Seleccione un tipo de gasto</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Monto</label>
                                        <input type="number" id="expense-amount" placeholder="0.00" min="0" step="0.01" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Observaciones (opcional)</label>
                                        <textarea id="expense-observations" placeholder="Detalles adicionales..." class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" rows="3"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Forma de Pago</label>
                                        <div class="flex flex-col sm:flex-row gap-3">
                                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                                                <input type="radio" name="expense-payment" value="efectivo" checked class="text-blue-600">
                                                <span>💵 Efectivo</span>
                                            </label>
                                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                                                <input type="radio" name="expense-payment" value="transferencia" class="text-blue-600">
                                                <span>💳 Transferencia</span>
                                            </label>
                                            <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700">
                                                <input type="radio" name="expense-payment" value="credito" class="text-blue-600">
                                                <span>🏦 Crédito</span>
                                            </label>
                                        </div>
                                    </div>
                                    <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition flex items-center justify-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                        Registrar Gasto
                                    </button>
                                </form>
                            </div>

                            <!-- Historial de Gastos del Día -->
                            <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-md">
                                <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                                    Gastos del Día
                                </h3>
                                <div id="expenses-today-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
                            </div>
                        </div>

                        <!-- Resumen por Categoría -->
                        <div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-xl shadow-md mt-6">
                            <h3 class="text-lg font-bold mb-4 text-slate-900 dark:text-white">Gastos por Categoría (Hoy)</h3>
                            <div id="expenses-by-category" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                        </div>
                    </div>
                    <div id="seller-cash-closure" class="hidden">
                        <div class="space-y-4 sm:space-y-6">
                            <!-- Resumen Visual del Día -->
                            <div class="bg-gradient-to-r from-green-600 to-emerald-700 p-4 sm:p-6 rounded-xl shadow-lg text-white">
                                <h2 class="text-xl sm:text-2xl font-bold mb-4 flex items-center gap-2">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                    Resumen del Día
                                </h2>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
                                    <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                        <div class="text-xs sm:text-sm opacity-90">Total Ventas</div>
                                        <div id="closure-summary-total-sales" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                        <div id="closure-summary-sales-count" class="text-xs opacity-75">0 ventas</div>
                                    </div>
                                    <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                        <div class="text-xs sm:text-sm opacity-90">Efectivo</div>
                                        <div id="closure-summary-cash" class="text-xl sm:text-2xl font-bold">$0.00</div>
                                    </div>
                                    <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                        <div class="text-xs sm:text-sm opacity-90">Transfer./Créd.</div>
                                        <div id="closure-summary-other" class="text-xl sm:text-2xl font-bold">$0.00</div>
                                    </div>
                                    <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                        <div class="text-xs sm:text-sm opacity-90">Balance</div>
                                        <div id="closure-summary-balance" class="text-xl sm:text-2xl font-bold">$0.00</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Cumplimiento de Meta -->
                            <div id="closure-goal-container" class="hidden">
                                <!-- Se llenará dinámicamente con JavaScript -->
                            </div>

                            <!-- Top Productos del Día -->
                            <div class="bg-white dark:bg-slate-800 p-3 sm:p-6 rounded-xl shadow-md">
                                <h3 class="text-lg sm:text-xl font-bold mb-3 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                    Productos Más Vendidos
                                </h3>
                                <div id="closure-top-products" class="space-y-2">
                                    <p class="text-center text-slate-500 dark:text-slate-400 py-4 text-sm">No hay datos disponibles</p>
                                </div>
                            </div>

                            <!-- Cierre de Caja -->
                            <div class="bg-white dark:bg-slate-800 p-3 sm:p-6 rounded-xl shadow-md">
                                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Cierre de Caja
                                </h2>

                                <!-- Movimientos de Efectivo -->
                                <div class="space-y-2 mb-4">
                                    <h3 class="font-semibold text-sm text-slate-600 dark:text-slate-400 mb-2">💰 Movimientos de Efectivo</h3>
                                    <div class="flex justify-between items-center p-2 sm:p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                                        <span class="text-sm sm:text-base font-medium">Apertura:</span>
                                        <span id="closure-opening-balance" class="font-bold text-blue-600 dark:text-blue-400">$0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center p-2 sm:p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                                        <span class="text-sm sm:text-base font-medium">+ Ventas Efectivo:</span>
                                        <span id="closure-cash-sales" class="font-bold text-green-600 dark:text-green-400">$0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center p-2 sm:p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                                        <span class="text-sm sm:text-base font-medium">+ Cobros:</span>
                                        <span id="closure-collections" class="font-bold text-green-600 dark:text-green-400">$0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center p-2 sm:p-3 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800">
                                        <span class="text-sm sm:text-base font-medium">- Gastos Efectivo:</span>
                                        <span id="closure-cash-expenses" class="font-bold text-red-600 dark:text-red-400">$0.00</span>
                                    </div>
                                </div>

                                <!-- Conteo Físico -->
                                <div class="mb-4">
                                    <label class="font-semibold text-sm sm:text-base text-slate-700 dark:text-slate-300 mb-2 block">🔢 Efectivo Físico Contado:</label>
                                    <input type="number" id="closure-physical-cash" placeholder="0.00" min="0" step="0.01" class="w-full p-3 sm:p-4 text-lg border-2 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-slate-700 dark:border-slate-600 font-bold text-center">
                                </div>

                                <!-- Efectivo Esperado (Oculto hasta el cierre) -->
                                <div id="closure-expected-section" class="hidden bg-gradient-to-r from-purple-50 to-indigo-50 dark:from-purple-900/30 dark:to-indigo-900/30 p-4 rounded-xl border-2 border-purple-300 dark:border-purple-700 mb-4">
                                    <div class="flex justify-between items-center">
                                        <span class="font-bold text-base sm:text-lg text-slate-700 dark:text-slate-200">💵 Efectivo Esperado:</span>
                                        <span id="closure-expected-cash" class="font-extrabold text-xl sm:text-2xl text-purple-600 dark:text-purple-400">$0.00</span>
                                    </div>
                                </div>

                                <!-- Diferencia (Oculta hasta el cierre) -->
                                <div id="closure-difference-section" class="hidden flex justify-between items-center p-3 sm:p-4 rounded-xl bg-yellow-50 dark:bg-yellow-900/30 border-2 border-yellow-300 dark:border-yellow-700 mb-4">
                                    <span class="font-bold text-base sm:text-lg text-yellow-800 dark:text-yellow-300">⚖️ Diferencia:</span>
                                    <span id="closure-difference" class="font-bold text-xl sm:text-2xl text-yellow-800 dark:text-yellow-300">$0.00</span>
                                </div>

                                <!-- Valores Informativos -->
                                <div class="bg-slate-50 dark:bg-slate-700/50 p-3 sm:p-4 rounded-lg border border-slate-200 dark:border-slate-600">
                                    <p class="font-semibold text-xs sm:text-sm text-slate-600 dark:text-slate-400 mb-2">📊 Valores Informativos (no afectan efectivo):</p>
                                    <div class="space-y-1.5 text-sm">
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-600 dark:text-slate-400">Ventas a Crédito:</span>
                                            <span id="closure-credit-sales" class="font-semibold text-orange-600 dark:text-orange-400">$0.00</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-slate-600 dark:text-slate-400">Ventas por Transferencia:</span>
                                            <span id="closure-transfer-sales" class="font-semibold text-blue-600 dark:text-blue-400">$0.00</span>
                                        </div>
                                        <div class="flex justify-between items-center pt-2 border-t border-slate-300 dark:border-slate-600">
                                            <span class="text-slate-600 dark:text-slate-400 font-semibold">Total General del Día:</span>
                                            <span id="closure-total-day" class="font-bold text-lg text-slate-800 dark:text-slate-200">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Estadísticas del Día -->
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3">
                                <div class="bg-white dark:bg-slate-800 p-3 rounded-lg shadow-md text-center border border-slate-200 dark:border-slate-700">
                                    <div class="text-2xl mb-1">📦</div>
                                    <div class="text-xs text-slate-600 dark:text-slate-400">Total Ventas</div>
                                    <div id="stats-total-sales" class="text-lg font-bold text-slate-800 dark:text-slate-200">0</div>
                                </div>
                                <div class="bg-white dark:bg-slate-800 p-3 rounded-lg shadow-md text-center border border-slate-200 dark:border-slate-700">
                                    <div class="text-2xl mb-1">📋</div>
                                    <div class="text-xs text-slate-600 dark:text-slate-400">Productos</div>
                                    <div id="stats-total-items" class="text-lg font-bold text-slate-800 dark:text-slate-200">0</div>
                                </div>
                                <div class="bg-white dark:bg-slate-800 p-3 rounded-lg shadow-md text-center border border-slate-200 dark:border-slate-700">
                                    <div class="text-2xl mb-1">💸</div>
                                    <div class="text-xs text-slate-600 dark:text-slate-400">Gastos</div>
                                    <div id="stats-total-expenses" class="text-lg font-bold text-red-600 dark:text-red-400">0</div>
                                </div>
                                <div class="bg-white dark:bg-slate-800 p-3 rounded-lg shadow-md text-center border border-slate-200 dark:border-slate-700">
                                    <div class="text-2xl mb-1">💰</div>
                                    <div class="text-xs text-slate-600 dark:text-slate-400">Cobros</div>
                                    <div id="stats-total-collections" class="text-lg font-bold text-green-600 dark:text-green-400">0</div>
                                </div>
                            </div>

                            <!-- Botón de Cierre -->
                            <button onclick="closeCashRegister()" id="btn-close-cash" class="w-full bg-gradient-to-r from-red-600 to-red-700 active:from-red-700 active:to-red-800 text-white font-bold py-4 px-6 rounded-xl shadow-lg active:shadow-inner transition text-base sm:text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                🔒 Cerrar Caja y Generar Reporte
                            </button>
                        </div>
                    </div>
                    <div id="seller-reports" class="hidden">
                        <div class="space-y-4 sm:space-y-6">
                            <!-- Resumen de Ventas de Hoy -->
                            <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-4 sm:p-6 rounded-xl shadow-lg text-white">
                                <h2 class="text-xl sm:text-2xl font-bold mb-4 flex items-center gap-2">
                                    <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                                    Resumen del Día
                                </h2>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
                                    <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                        <div class="text-xs sm:text-sm opacity-90">Total Ventas</div>
                                        <div id="today-total-sales" class="text-2xl sm:text-3xl font-bold">$0.00</div>
                                        <div id="today-sales-count" class="text-xs opacity-75">0 ventas</div>
                                    </div>
                                    <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                        <div class="text-xs sm:text-sm opacity-90">💵 Efectivo</div>
                                        <div id="today-cash-sales" class="text-xl sm:text-2xl font-bold">$0.00</div>
                                    </div>
                                    <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                        <div class="text-xs sm:text-sm opacity-90">🏦 Transfer.</div>
                                        <div id="today-transfer-sales" class="text-xl sm:text-2xl font-bold">$0.00</div>
                                    </div>
                                    <div class="bg-white/20 backdrop-blur-sm p-3 sm:p-4 rounded-lg">
                                        <div class="text-xs sm:text-sm opacity-90">📋 Crédito</div>
                                        <div id="today-credit-sales" class="text-xl sm:text-2xl font-bold">$0.00</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Ventas de Hoy - Lista Detallada -->
                            <div class="bg-white dark:bg-slate-800 p-3 sm:p-6 rounded-xl shadow-md">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg sm:text-xl font-bold text-slate-900 dark:text-white">Ventas de Hoy</h3>
                                    <select id="today-payment-filter" class="p-2 border-2 rounded-lg text-sm dark:bg-slate-700 dark:border-slate-600">
                                        <option value="">Todos los métodos</option>
                                        <option value="efectivo">💵 Efectivo</option>
                                        <option value="transferencia">🏦 Transferencia</option>
                                        <option value="credito">📋 Crédito</option>
                                    </select>
                                </div>
                                <div id="today-sales-list" class="space-y-2 max-h-96 overflow-y-auto">
                                    <p class="text-center text-slate-500 dark:text-slate-400 py-6 sm:py-8 text-sm">No hay ventas registradas hoy</p>
                                </div>
                            </div>

                            <!-- Top Productos Vendidos Hoy -->
                            <div class="bg-white dark:bg-slate-800 p-3 sm:p-6 rounded-xl shadow-md">
                                <h3 class="text-lg sm:text-xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                    Productos Más Vendidos
                                </h3>
                                <div id="top-products-today" class="space-y-2">
                                    <p class="text-center text-slate-500 dark:text-slate-400 py-4 text-sm">No hay datos disponibles</p>
                                </div>
                            </div>

                            <!-- Reportes Históricos -->
                            <div class="bg-white dark:bg-slate-800 p-3 sm:p-6 rounded-xl shadow-md">
                                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-slate-900 dark:text-white">📊 Reportes Históricos</h2>

                                <!-- Filtros -->
                                <div class="bg-slate-50 dark:bg-slate-700/50 p-3 sm:p-4 rounded-lg mb-4">
                                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                                        <div>
                                            <label class="text-xs font-medium text-slate-600 dark:text-slate-400">Fecha Inicio</label>
                                            <input type="date" id="seller-start-date" class="w-full p-2 sm:p-3 text-sm border-2 rounded-lg mt-1 dark:bg-slate-700 dark:border-slate-600">
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-slate-600 dark:text-slate-400">Fecha Fin</label>
                                            <input type="date" id="seller-end-date" class="w-full p-2 sm:p-3 text-sm border-2 rounded-lg mt-1 dark:bg-slate-700 dark:border-slate-600">
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-slate-600 dark:text-slate-400">Método de Pago</label>
                                            <select id="report-payment-filter" class="w-full p-2 sm:p-3 text-sm border-2 rounded-lg mt-1 dark:bg-slate-700 dark:border-slate-600">
                                                <option value="">Todos</option>
                                                <option value="efectivo">Efectivo</option>
                                                <option value="transferencia">Transferencia</option>
                                                <option value="credito">Crédito</option>
                                            </select>
                                        </div>
                                        <div class="flex items-end gap-2">
                                            <button onclick="filterSellerReports()" class="flex-1 bg-green-600 active:bg-green-700 text-white font-bold py-2 sm:py-3 px-3 rounded-lg shadow-md active:shadow-inner transition text-sm">
                                                📊 Consultar
                                            </button>
                                            <button onclick="generateSellerReportPDF()" class="bg-red-600 active:bg-red-700 text-white font-bold py-2 sm:py-3 px-3 rounded-lg shadow-md active:shadow-inner transition text-sm">
                                                📄 PDF
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Resumen del Período -->
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                                    <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-lg border-2 border-green-200 dark:border-green-800">
                                        <div class="text-xs text-slate-600 dark:text-slate-400">Total Ventas</div>
                                        <div id="report-total-sales" class="text-xl sm:text-2xl font-bold text-green-600 dark:text-green-400">$0.00</div>
                                        <div id="report-sales-count" class="text-xs text-slate-500 dark:text-slate-400">0 ventas</div>
                                    </div>
                                    <div class="bg-red-50 dark:bg-red-900/20 p-3 rounded-lg border-2 border-red-200 dark:border-red-800">
                                        <div class="text-xs text-slate-600 dark:text-slate-400">Total Gastos</div>
                                        <div id="report-total-expenses" class="text-xl sm:text-2xl font-bold text-red-600 dark:text-red-400">$0.00</div>
                                        <div id="report-expenses-count" class="text-xs text-slate-500 dark:text-slate-400">0 gastos</div>
                                    </div>
                                    <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border-2 border-blue-200 dark:border-blue-800">
                                        <div class="text-xs text-slate-600 dark:text-slate-400">Balance</div>
                                        <div id="report-balance" class="text-xl sm:text-2xl font-bold text-blue-600 dark:text-blue-400">$0.00</div>
                                    </div>
                                    <div class="bg-purple-50 dark:bg-purple-900/20 p-3 rounded-lg border-2 border-purple-200 dark:border-purple-800">
                                        <div class="text-xs text-slate-600 dark:text-slate-400">Productos</div>
                                        <div id="report-products-count" class="text-xl sm:text-2xl font-bold text-purple-600 dark:text-purple-400">0</div>
                                        <div class="text-xs text-slate-500 dark:text-slate-400">vendidos</div>
                                    </div>
                                </div>

                                <!-- Tablas de Ventas y Gastos -->
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                    <div>
                                        <h3 class="text-lg font-bold mb-2 text-slate-900 dark:text-white">Detalle de Ventas</h3>
                                        <div class="overflow-x-auto max-h-96">
                                            <table class="min-w-full bg-white dark:bg-slate-800 text-sm">
                                                <thead class="bg-slate-50 dark:bg-slate-700 sticky top-0">
                                                    <tr>
                                                        <th class="py-2 px-2 text-left text-xs">Fecha</th>
                                                        <th class="py-2 px-2 text-left text-xs">Cliente</th>
                                                        <th class="py-2 px-2 text-left text-xs">Método</th>
                                                        <th class="py-2 px-2 text-right text-xs">Monto</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="seller-sales-report" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold mb-2 text-slate-900 dark:text-white">Detalle de Gastos</h3>
                                        <div class="overflow-x-auto max-h-96">
                                            <table class="min-w-full bg-white dark:bg-slate-800 text-sm">
                                                <thead class="bg-slate-50 dark:bg-slate-700 sticky top-0">
                                                    <tr>
                                                        <th class="py-2 px-2 text-left text-xs">Fecha</th>
                                                        <th class="py-2 px-2 text-left text-xs">Descripción</th>
                                                        <th class="py-2 px-2 text-right text-xs">Monto</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="seller-expenses-report" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Historial de Cierres de Caja -->
                            <div class="bg-white dark:bg-slate-800 p-3 sm:p-6 rounded-xl shadow-md">
                                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    Historial de Cierres de Caja
                                </h2>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full bg-white dark:bg-slate-800">
                                        <thead class="bg-slate-50 dark:bg-slate-700">
                                            <tr>
                                                <th class="py-3 px-4 text-left text-sm">Fecha</th>
                                                <th class="py-3 px-4 text-left text-sm">Monto Inicial</th>
                                                <th class="py-3 px-4 text-left text-sm">Esperado</th>
                                                <th class="py-3 px-4 text-left text-sm">Físico</th>
                                                <th class="py-3 px-4 text-left text-sm">Diferencia</th>
                                                <th class="py-3 px-4 text-left text-sm">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="seller-closures-list" class="divide-y divide-slate-200 dark:divide-slate-700">
                                            <tr>
                                                <td colspan="6" class="text-center py-4 text-slate-500">Cargando...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para Editar Producto -->
    <div id="edit-product-modal" class="modal-overlay hidden"><div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg w-full max-w-md"><h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Editar Producto</h2><form id="edit-product-form" class="space-y-4"><input type="text" id="edit-product-name" placeholder="Nombre del Producto" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required><input type="number" id="edit-product-price-normal" placeholder="Precio Normal" min="0" step="0.01" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required><input type="number" id="edit-product-price-business" placeholder="Precio Negocio" min="0" step="0.01" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required><div class="flex justify-end gap-4 mt-6"><button type="button" onclick="closeEditModal()" class="bg-slate-200 dark:bg-slate-600 font-semibold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button></div></form></div></div>

    <!-- Modal para Confirmar Anulación -->
    <div id="delete-confirm-modal" class="modal-overlay hidden"><div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg w-full max-w-sm text-center"><h2 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Confirmar Anulación</h2><p class="mb-6">¿Está seguro? Esta acción no se puede deshacer.</p><div class="flex justify-center gap-4"><button type="button" onclick="cancelDelete()" class="bg-slate-200 dark:bg-slate-600 font-semibold py-2 px-6 rounded-lg">Cancelar</button><button type="button" id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Anular</button></div></div></div>
    
    <!-- Modal para Registrar Abono -->
    <div id="payment-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold mb-2 text-slate-900 dark:text-white">Registrar Abono</h2>
            <p class="mb-4">Saldo pendiente: <span id="payment-modal-balance" class="font-bold"></span></p>
            <form id="add-payment-form" class="space-y-4">
                <input type="number" id="payment-amount" placeholder="Monto del abono" min="0.01" step="0.01" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closePaymentModal()" class="bg-slate-200 dark:bg-slate-600 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Guardar Abono</button>
                </div>
            </form>
        </div>
    </div>

    <div id="cash-close-report-modal" class="modal-overlay hidden"><div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg w-full max-w-lg"><h2 class="text-2xl font-bold mb-4 text-center text-slate-900 dark:text-white">Reporte de Cierre de Caja</h2><div id="report-content" class="space-y-3 text-lg"><p><strong>Fecha de Cierre:</strong> <span id="report-date"></span></p><hr class="border-slate-200 dark:border-slate-600"><p><strong>(+) Monto Inicial:</strong> <span id="report-initial"></span></p><p><strong>(+) Ventas Efectivo:</strong> <span id="report-cash-sales"></span></p><p><strong>(+) Cobros:</strong> <span id="report-collections"></span></p><p><strong>(-) Gastos Efectivo:</strong> <span id="report-cash-expenses"></span></p><hr class="border-slate-200 dark:border-slate-600"><p><strong>(=) Total Esperado:</strong> <span id="report-total"></span></p><p><strong>Físico Contado:</strong> <span id="report-physical-cash"></span></p><hr class="border-slate-200 dark:border-slate-600"><p class="font-bold text-xl"><strong>Diferencia:</strong> <span id="report-difference"></span></p></div><div class="mt-6 flex justify-end space-x-4"><button onclick="document.getElementById('cash-close-report-modal').classList.add('hidden')" class="bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500">Cerrar</button><button onclick="generateCloseCashPDF()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Descargar PDF</button></div></div></div>

    <!-- Modal de Crear Cliente desde Ventas -->
    <div id="create-client-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white flex items-center gap-2">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                Crear Nuevo Cliente
            </h2>

            <form id="modal-client-form" class="space-y-4">
                <!-- Tipo de Cliente -->
                <div>
                    <label class="text-sm font-semibold text-slate-700 dark:text-slate-300 block mb-2">Tipo de Cliente</label>
                    <div id="modal-client-type-selector" class="grid grid-cols-2 gap-2">
                        <label class="flex items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                            <input type="radio" name="modal-client-type" value="consumidor-final" checked class="w-5 h-5 text-blue-600">
                            <span class="text-sm font-medium">👤 Consumidor Final</span>
                        </label>
                        <label class="flex items-center justify-center gap-2 cursor-pointer bg-white dark:bg-slate-600 p-3 rounded-lg border-2 border-slate-300 dark:border-slate-500 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/30 transition">
                            <input type="radio" name="modal-client-type" value="negocio" class="w-5 h-5 text-blue-600">
                            <span class="text-sm font-medium">🏢 Negocio</span>
                        </label>
                    </div>
                </div>

                <!-- Nombre del Cliente -->
                <div>
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Nombre del Cliente *</label>
                    <input type="text" id="modal-client-name" placeholder="Ej: Juan Pérez" required class="w-full p-3 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                </div>

                <!-- Nombre del Negocio (solo para negocios) -->
                <div id="modal-business-name-field" class="hidden">
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Nombre del Negocio</label>
                    <input type="text" id="modal-client-business-name" placeholder="Ej: Tienda La Esperanza" class="w-full p-3 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                </div>

                <!-- Teléfono -->
                <div>
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Teléfono</label>
                    <input type="tel" id="modal-client-phone" placeholder="Ej: +505 8888-8888" class="w-full p-3 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600">
                </div>

                <!-- Dirección -->
                <div>
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Dirección</label>
                    <textarea id="modal-client-address" placeholder="Dirección del cliente" rows="2" class="w-full p-3 border-2 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600"></textarea>
                </div>

                <!-- Ubicación GPS -->
                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border-2 border-blue-200 dark:border-blue-800">
                    <label class="text-sm font-semibold text-slate-700 dark:text-slate-300 block mb-2 flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Ubicación GPS (Opcional)
                    </label>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="modal-client-latitude" placeholder="Latitud" readonly class="flex-1 p-2 border rounded-lg bg-slate-100 dark:bg-slate-700 dark:border-slate-600 text-sm">
                        <input type="text" id="modal-client-longitude" placeholder="Longitud" readonly class="flex-1 p-2 border rounded-lg bg-slate-100 dark:bg-slate-700 dark:border-slate-600 text-sm">
                    </div>
                    <button type="button" onclick="captureModalClientLocation()" class="w-full bg-blue-600 active:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md active:shadow-inner transition flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Capturar Ubicación
                    </button>
                </div>

                <!-- Botones -->
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="closeClientModal()" class="flex-1 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-bold py-3 px-4 rounded-lg active:bg-slate-300 dark:active:bg-slate-600 transition">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-[2] bg-gradient-to-r from-green-600 to-green-700 active:from-green-700 active:to-green-800 text-white font-bold py-3 px-4 rounded-lg shadow-lg active:shadow-inner transition">
                        💾 Guardar y Seleccionar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Editar Venta -->
    <div id="edit-sale-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Editar Venta</h2>
            <form id="edit-sale-form" class="space-y-4">
                <input type="hidden" id="edit-sale-id">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Fecha</label>
                        <input type="date" id="edit-sale-date" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Cliente</label>
                        <input type="text" id="edit-sale-client" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                    </div>
                </div>

                <div>
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Método de Pago</label>
                    <select id="edit-sale-payment" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                        <option value="efectivo">Efectivo</option>
                        <option value="transferencia">Transferencia</option>
                        <option value="credito">Crédito</option>
                    </select>
                </div>

                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Productos</label>
                        <button type="button" onclick="addEditSaleProduct()" class="bg-green-600 text-white text-sm py-1 px-3 rounded-lg hover:bg-green-700">+ Agregar Producto</button>
                    </div>
                    <div id="edit-sale-products-container" class="space-y-2"></div>
                </div>

                <div class="border-t pt-4">
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-bold text-slate-900 dark:text-white">Total:</span>
                        <span id="edit-sale-total-display" class="text-2xl font-bold text-green-600">$0.00</span>
                    </div>
                </div>

                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeEditSaleModal()" class="bg-slate-200 dark:bg-slate-600 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Editar Gasto -->
    <div id="edit-expense-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Editar Gasto</h2>
            <form id="edit-expense-form" class="space-y-4">
                <input type="hidden" id="edit-expense-id">

                <div>
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Fecha</label>
                    <input type="date" id="edit-expense-date" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                </div>

                <div>
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Categoría</label>
                    <select id="edit-expense-category" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                    </select>
                </div>

                <div>
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Monto</label>
                    <input type="number" id="edit-expense-amount" step="0.01" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                </div>

                <div>
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Método de Pago</label>
                    <select id="edit-expense-payment" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                        <option value="efectivo">Efectivo</option>
                        <option value="transferencia">Transferencia</option>
                    </select>
                </div>

                <div>
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Descripción (opcional)</label>
                    <textarea id="edit-expense-description" rows="3" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600"></textarea>
                </div>

                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeEditExpenseModal()" class="bg-slate-200 dark:bg-slate-600 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Editar Tipo de Gasto -->
    <div id="edit-expense-type-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Editar Tipo de Gasto</h2>
            <form id="edit-expense-type-form" class="space-y-4">
                <input type="hidden" id="edit-expense-type-id">

                <div>
                    <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Nombre del Tipo de Gasto</label>
                    <input type="text" id="edit-expense-type-name" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                </div>

                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeEditExpenseTypeModal()" class="bg-slate-200 dark:bg-slate-600 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Editar Cierre de Caja -->
    <div id="edit-closure-modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Editar Cierre de Caja</h2>
            <form id="edit-closure-form" class="space-y-4">
                <input type="hidden" id="edit-closure-id">

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Monto Inicial</label>
                        <input type="number" id="edit-closure-opening" step="0.01" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Ventas Efectivo</label>
                        <input type="number" id="edit-closure-cash-sales" step="0.01" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Gastos Efectivo</label>
                        <input type="number" id="edit-closure-cash-expenses" step="0.01" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Cobros/Ingresos</label>
                        <input type="number" id="edit-closure-collections" step="0.01" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Efectivo Físico Contado</label>
                        <input type="number" id="edit-closure-physical" step="0.01" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600" required>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Ventas a Crédito</label>
                        <input type="number" id="edit-closure-credit-sales" step="0.01" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                    </div>

                    <div class="col-span-2">
                        <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Ventas por Transferencia</label>
                        <input type="number" id="edit-closure-transfer-sales" step="0.01" min="0" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600">
                    </div>
                </div>

                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                    <p class="text-sm text-slate-600 dark:text-slate-400"><strong>Cálculo automático:</strong></p>
                    <p class="text-sm text-slate-600 dark:text-slate-400">Efectivo Esperado = Monto Inicial + Ventas Efectivo + Cobros - Gastos Efectivo</p>
                    <p class="text-sm text-slate-600 dark:text-slate-400">Diferencia = Efectivo Físico - Efectivo Esperado</p>
                </div>

                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" onclick="closeEditClosureModal()" class="bg-slate-200 dark:bg-slate-600 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

<script>
    const { jsPDF } = window.jspdf;
    const firebaseConfig = { apiKey: "AIzaSyC08Np1t5rx2MiQmSfQrRKObSFEy0bZnHw", authDomain: "distribuidor-autorizado-f08bf.firebaseapp.com", projectId: "distribuidor-autorizado-f08bf", storageBucket: "distribuidor-autorizado-f08bf.appspot.com", messagingSenderId: "770396065529", appId: "1:770396065529:web:ef07592ce4b23076da5c28", measurementId: "G-EHMP32VLVT" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db_firestore = firebase.firestore();
    
    // Habilitar persistencia offline
    db_firestore.enablePersistence().catch((err) => {
        if (err.code == 'failed-precondition') {
            console.warn("La persistencia de Firestore falló, probablemente porque ya está activa en otra pestaña.");
        } else if (err.code == 'unimplemented') {
            console.warn("El navegador actual no soporta la persistencia de datos offline.");
        }
    });

    let db = { products: [], sales: [], expenses: [], collections: [], expenseTypes: [], clients: [], cashRegister: { isOpen: false, openingBalance: 0, transactions: [] }, usersMap: {} };
    let currentSaleItems = [];
    let filteredAdminReportsData = {};
    
    function getCurrentDate() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function formatDateDisplay(dateStr) {
        // Convierte YYYY-MM-DD a DD-MM-YYYY
        if (!dateStr) return '';
        const [year, month, day] = dateStr.split('-');
        return `${day}-${month}-${year}`;
    }

    const views = ['auth-view', 'admin-view', 'seller-view'];
    
    function showView(viewId) { views.forEach(id => { const el = document.getElementById(id); if (el) el.classList.add('hidden'); }); const targetViewEl = document.getElementById(`${viewId}-view`); if (targetViewEl) targetViewEl.classList.remove('hidden'); const sellerViewEl = document.getElementById('seller-view'); if (sellerViewEl) { viewId === 'seller' ? sellerViewEl.classList.add('flex') : sellerViewEl.classList.remove('flex'); } if (viewId === 'admin') { updateAdminDashboard(); } if (viewId === 'seller') { checkCashRegisterStatus(); updateSellerDashboard(); if(viewId === 'seller-credit-accounts') renderCreditAccounts(); } }
    const loginForm = document.getElementById('login-form');
    const authError = document.getElementById('auth-error');
    
    loginForm.addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('login-email').value, password = document.getElementById('login-password').value; auth.signInWithEmailAndPassword(email, password).catch(error => { authError.textContent = "Error: " + error.message; }); });

    function handleLogout() { auth.signOut(); }

    window.onload = function() {
        auth.onAuthStateChanged(user => {
            if (user) {
                console.log('Usuario autenticado:', user.email, 'UID:', user.uid);
                loadCashRegisterFromStorage(); // Cargar estado de la caja DESPUÉS de que el usuario inicie sesión
                db_firestore.collection('users').doc(user.uid).get().then((doc) => {
                    console.log('Documento de usuario existe:', doc.exists);
                    if (doc.exists) {
                        console.log('Datos del usuario:', doc.data());
                        console.log('Rol del usuario:', doc.data().role);
                    }
                    const userRole = (doc.exists && doc.data().role) ? doc.data().role : 'seller';
                    console.log('Rol asignado:', userRole);
                    listenForData(userRole === 'admin'); // Iniciar listeners con el rol correcto
                    if (userRole === 'admin') {
                        console.log('Mostrando vista de administrador');
                        showView('admin');
                    } else {
                        console.log('Mostrando vista de vendedor');
                        showView('seller');
                    }
                }).catch(error => { console.error("Error al obtener rol de usuario:", error); showView('seller'); });
            } else {
                showView('auth');
            }
        });
        document.querySelectorAll('.logout-btn').forEach(btn => btn.addEventListener('click', handleLogout));
        initializeTheme(); setupTabNavigation('admin-tabs', 'admin-content'); setupClientsTabNavigation(); setupSidebarNavigation(); setupSaleFormListeners(); setupAdminProductListeners(); 
        document.getElementById('add-collection-form').addEventListener('submit', finalizeCollection); 
        
        document.getElementById('filter-closures-btn').addEventListener('click', filterClosures);
        // Sistema unificado de búsqueda y selección de productos
        setupUnifiedProductSearch();
        // Sistema inteligente de búsqueda de clientes
        setupIntelligentClientSearch();
        document.getElementById('credit-client-search').addEventListener('input', (e) => {
            const statusFilter = document.getElementById('credit-status-filter')?.value || 'all';
            renderCreditAccounts(e.target.value, statusFilter);
        });
        document.getElementById('credit-status-filter')?.addEventListener('change', (e) => {
            const searchTerm = document.getElementById('credit-client-search').value;
            renderCreditAccounts(searchTerm, e.target.value);
        });
        
        document.getElementById('query-admin-reports-btn').addEventListener('click', queryAndDisplayAdminReports);
        
        document.getElementById('expense-category-selector').addEventListener('change', handleExpenseCategoryChange);
        document.getElementById('filter-dashboard-btn').addEventListener('click', updateAdminDashboard);
        document.getElementById('reset-dashboard-btn').addEventListener('click', () => {
            document.getElementById('dashboard-start-date').value = '';
            document.getElementById('dashboard-end-date').value = '';
            updateAdminDashboard();
        });

        // Online/Offline Status
        updateOnlineStatus();
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // Convertir automáticamente a MAYÚSCULAS todos los inputs de texto y textareas
        setupUppercaseInputs();
    };

    function setupUppercaseInputs() {
        // Función para convertir a mayúsculas
        function convertToUppercase(e) {
            const target = e.target;
            const start = target.selectionStart;
            const end = target.selectionEnd;
            target.value = target.value.toUpperCase();
            target.setSelectionRange(start, end);
        }

        // Aplicar a todos los inputs de tipo text y textareas existentes
        const textInputs = document.querySelectorAll('input[type="text"], textarea');
        textInputs.forEach(input => {
            // Excluir campos de fecha, número, email, password y búsqueda de productos
            if (!input.id.includes('date') &&
                !input.id.includes('latitude') &&
                !input.id.includes('longitude') &&
                !input.type.includes('number') &&
                !input.type.includes('email') &&
                !input.type.includes('password')) {
                input.addEventListener('input', convertToUppercase);
            }
        });

        // Observer para detectar nuevos inputs agregados dinámicamente
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) { // Element node
                        const inputs = node.querySelectorAll ? node.querySelectorAll('input[type="text"], textarea') : [];
                        inputs.forEach(input => {
                            if (!input.id.includes('date') &&
                                !input.id.includes('latitude') &&
                                !input.id.includes('longitude') &&
                                !input.type.includes('number') &&
                                !input.type.includes('email') &&
                                !input.type.includes('password')) {
                                input.addEventListener('input', convertToUppercase);
                            }
                        });
                    }
                });
            });
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }

    function updateOnlineStatus() {
        const indicator = document.getElementById('status-indicator');
        if (navigator.onLine) {
            indicator.classList.remove('offline');
            indicator.classList.add('online');
            indicator.title = "En línea";

            // Cuando se recupera la conexión, sincronizar operaciones pendientes
            syncPendingOperations();
        } else {
            indicator.classList.remove('online');
            indicator.classList.add('offline');
            indicator.title = "Fuera de línea";
        }
    }

    // Sistema de cola offline
    function savePendingOperation(type, data) {
        const pendingOps = JSON.parse(localStorage.getItem('pendingOperations') || '[]');
        pendingOps.push({ type, data, timestamp: Date.now() });
        localStorage.setItem('pendingOperations', JSON.stringify(pendingOps));
    }

    async function syncPendingOperations() {
        const pendingOps = JSON.parse(localStorage.getItem('pendingOperations') || '[]');

        if (pendingOps.length === 0) return;

        console.log(`Sincronizando ${pendingOps.length} operaciones pendientes...`);

        for (let i = 0; i < pendingOps.length; i++) {
            const op = pendingOps[i];

            try {
                if (op.type === 'sale') {
                    const saleData = { ...op.data };
                    delete saleData.id; // Eliminar el ID temporal

                    await db_firestore.collection('sales').add(saleData);
                    console.log('✅ Venta sincronizada:', saleData);
                } else if (op.type === 'expense') {
                    const expenseData = { ...op.data };
                    delete expenseData.id;

                    await db_firestore.collection('expenses').add(expenseData);
                    console.log('✅ Gasto sincronizado:', expenseData);
                } else if (op.type === 'collection') {
                    const collectionData = { ...op.data };
                    delete collectionData.id;

                    await db_firestore.collection('collections').add(collectionData);
                    console.log('✅ Ingreso sincronizado:', collectionData);
                }

                // Eliminar la operación sincronizada de la cola
                pendingOps.splice(i, 1);
                i--; // Ajustar el índice después de eliminar
            } catch (error) {
                console.error('Error sincronizando operación:', error);
                // Si falla, dejar en la cola para reintentar después
            }
        }

        // Actualizar la lista de operaciones pendientes
        localStorage.setItem('pendingOperations', JSON.stringify(pendingOps));

        if (pendingOps.length === 0) {
            console.log('✅ Todas las operaciones offline sincronizadas');
            alert('✅ Datos sincronizados con el servidor');
        }
    }

    function handleExpenseCategoryChange() { const selector = document.getElementById('expense-category-selector'); const observationsTextarea = document.getElementById('expense-observations'); if (!selector || !observationsTextarea) return; const selectedOption = selector.options[selector.selectedIndex]; const selectedText = selectedOption ? selectedOption.text.toLowerCase().trim() : ''; if (selectedText === 'compra de producto' || selectedText === 'otros') { observationsTextarea.placeholder = "Observaciones (requerido)"; observationsTextarea.required = true; } else { observationsTextarea.placeholder = "Observaciones (opcional)"; observationsTextarea.required = false; } }

    function listenForData(isAdmin = false) {
        db_firestore.collection('products').onSnapshot((snapshot) => { db.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.name.localeCompare(b.name)); renderProductList(); });
        db_firestore.collection('expense_types').onSnapshot((snapshot) => { db.expenseTypes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.name.localeCompare(b.name)); renderExpenseTypeList(); updateExpenseTypeDropdown(); }, error => console.error("Error en listener de expense_types:", error));
        if (isAdmin) {
            db_firestore.collection('users').onSnapshot(snapshot => {
                snapshot.forEach(doc => {
                    db.usersMap[doc.id] = doc.data().name || doc.data().email;
                });
                loadSellersDropdown(snapshot.docs);
            }, error => console.error("Error en listener de users:", error));
        }
        db_firestore.collection('sales').onSnapshot(snapshot => {
            db.sales = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            renderCreditAccounts();
            renderTodaySales();
        }, error => console.error("Error en listener de sales:", error));
        db_firestore.collection('expenses').onSnapshot(snapshot => db.expenses = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})));
        db_firestore.collection('collections').onSnapshot(snapshot => db.collections = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})));
        db_firestore.collection('clients').onSnapshot(snapshot => {
            db.clients = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})).sort((a,b) => a.name.localeCompare(b.name));
            renderClientsList();
            updateClientDropdown();
        }, error => console.error("Error en listener de clients:", error));
    }

    // ===== GESTIÓN DE CLIENTES =====
    function getClientLocation() {
        if (!navigator.geolocation) {
            alert('La geolocalización no está soportada en este navegador');
            return;
        }

        const latInput = document.getElementById('client-latitude');
        const lonInput = document.getElementById('client-longitude');

        latInput.value = 'Obteniendo...';
        lonInput.value = 'Obteniendo...';

        navigator.geolocation.getCurrentPosition(
            (position) => {
                latInput.value = position.coords.latitude.toFixed(6);
                lonInput.value = position.coords.longitude.toFixed(6);
                alert('✅ Ubicación capturada correctamente');
            },
            (error) => {
                latInput.value = '';
                lonInput.value = '';
                let errorMsg = 'Error al obtener ubicación';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg = 'Por favor, permite el acceso a la ubicación en tu navegador';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg = 'Información de ubicación no disponible';
                        break;
                    case error.TIMEOUT:
                        errorMsg = 'Tiempo de espera agotado';
                        break;
                }
                alert(errorMsg);
            }
        );
    }

    document.getElementById('add-client-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const type = document.querySelector('input[name="client-form-type"]:checked').value;
        const name = document.getElementById('client-name-input').value.trim();
        const businessName = document.getElementById('client-business-name').value.trim();
        const phone = document.getElementById('client-phone').value.trim();
        const address = document.getElementById('client-address').value.trim();
        const latitude = document.getElementById('client-latitude').value;
        const longitude = document.getElementById('client-longitude').value;

        if (!name) {
            alert('El nombre del cliente es obligatorio');
            return;
        }

        // Verificar si el cliente ya existe (por nombre y teléfono)
        const existingClient = db.clients.find(c =>
            c.name.toLowerCase() === name.toLowerCase() ||
            (phone && c.phone === phone)
        );

        if (existingClient) {
            alert(`⚠️ Ya existe un cliente con ese nombre o teléfono.\n\nNombre: ${existingClient.name}\nTeléfono: ${existingClient.phone || 'Sin teléfono'}`);
            return;
        }

        const clientData = {
            // NO incluimos sellerId - los clientes son compartidos entre todos los vendedores
            type,
            name,
            businessName: type === 'negocio' ? businessName : '',
            phone,
            address,
            location: latitude && longitude ? {
                latitude: parseFloat(latitude),
                longitude: parseFloat(longitude)
            } : null,
            createdBy: auth.currentUser.uid, // Solo para referencia de quién lo creó
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            const docRef = await db_firestore.collection('clients').add(clientData);

            // Agregar el cliente al array local inmediatamente
            db.clients.push({
                id: docRef.id,
                ...clientData,
                createdAt: new Date()
            });
            db.clients.sort((a,b) => a.name.localeCompare(b.name));

            // Actualizar la lista visual
            renderClientsList();
            updateClientDropdown();

            alert('✅ Cliente guardado exitosamente');
            e.target.reset();
            document.getElementById('client-latitude').value = '';
            document.getElementById('client-longitude').value = '';
            document.getElementById('business-name-field').classList.add('hidden');

            // Cambiar a la pestaña de lista de clientes
            document.querySelectorAll('[data-tab]').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[data-tab="clients-list"]').classList.add('active');
            document.getElementById('add-client-tab').classList.add('hidden');
            document.getElementById('clients-list-tab').classList.remove('hidden');
        } catch (error) {
            console.error('Error al guardar cliente:', error);
            alert('Error al guardar cliente: ' + error.message);
        }
    });

    // Mostrar/ocultar campo de nombre de negocio
    document.querySelectorAll('input[name="client-form-type"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const businessField = document.getElementById('business-name-field');
            if (e.target.value === 'negocio') {
                businessField.classList.remove('hidden');
            } else {
                businessField.classList.add('hidden');
            }
        });
    });

    function renderClientsList(searchTerm = '') {
        const container = document.getElementById('clients-list-container');
        const countEl = document.getElementById('clients-count');

        if (!container) return;

        const lowerSearch = searchTerm.toLowerCase();
        const filteredClients = db.clients.filter(c =>
            c.name.toLowerCase().includes(lowerSearch) ||
            (c.businessName && c.businessName.toLowerCase().includes(lowerSearch)) ||
            (c.phone && c.phone.includes(searchTerm))
        );

        countEl.textContent = filteredClients.length;

        if (filteredClients.length === 0) {
            container.innerHTML = '<p class="text-center py-8 text-slate-500 dark:text-slate-400">No hay clientes registrados</p>';
            return;
        }

        container.innerHTML = filteredClients.map(client => {
            const displayName = client.type === 'negocio' && client.businessName
                ? `${client.businessName} (${client.name})`
                : client.name;

            const locationUrl = client.location
                ? `https://www.google.com/maps?q=${client.location.latitude},${client.location.longitude}`
                : null;

            return `
                <div class="bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg border border-slate-200 dark:border-slate-600">
                    <div class="flex items-start justify-between gap-3">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-lg">${client.type === 'negocio' ? '🏢' : '👤'}</span>
                                <h4 class="font-semibold text-slate-800 dark:text-slate-200 truncate">${displayName}</h4>
                            </div>
                            ${client.phone ? `<p class="text-sm text-slate-600 dark:text-slate-400">📞 ${client.phone}</p>` : ''}
                            ${client.address ? `<p class="text-sm text-slate-600 dark:text-slate-400">📍 ${client.address}</p>` : ''}
                            ${locationUrl ? `<a href="${locationUrl}" target="_blank" class="text-xs text-blue-600 dark:text-blue-400 hover:underline flex items-center gap-1 mt-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                Ver en Mapa
                            </a>` : ''}
                        </div>
                        <button onclick="deleteClient('${client.id}')" class="bg-red-100 active:bg-red-200 dark:bg-red-900 dark:active:bg-red-800 text-red-600 dark:text-red-400 px-3 py-2 rounded-lg transition text-sm font-semibold">
                            Eliminar
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    document.getElementById('search-clients').addEventListener('input', (e) => {
        renderClientsList(e.target.value);
    });

    async function deleteClient(clientId) {
        if (!confirm('¿Está seguro de eliminar este cliente?')) return;

        try {
            await db_firestore.collection('clients').doc(clientId).delete();
            alert('Cliente eliminado');
        } catch (error) {
            alert('Error al eliminar: ' + error.message);
        }
    }

    function updateClientDropdown() {
        const select = document.getElementById('sale-client-selector');
        if (!select) return;

        select.innerHTML = '<option value="">Seleccione un cliente (opcional)</option>';
        db.clients.forEach(client => {
            const displayName = client.type === 'negocio' && client.businessName
                ? `${client.businessName} - ${client.name}`
                : client.name;
            select.innerHTML += `<option value="${client.id}">${displayName}</option>`;
        });
    }

    function setupTabNavigation(tabsContainerId, contentContainerId) { const tabsContainer = document.getElementById(tabsContainerId); if (!tabsContainer) return; tabsContainer.querySelectorAll('.tab-button').forEach(tab => { tab.addEventListener('click', () => { tabsContainer.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active')); tab.classList.add('active'); const targetId = tab.dataset.target; Array.from(document.getElementById(contentContainerId).children).forEach(content => { content.classList.toggle('hidden', content.id !== targetId); }); }); }); }

    function setupClientsTabNavigation() {
        const tabsContainer = document.getElementById('clients-tabs');
        if (!tabsContainer) return;

        tabsContainer.querySelectorAll('[data-tab]').forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;

                // Actualizar estilos de los botones
                tabsContainer.querySelectorAll('[data-tab]').forEach(btn => {
                    if (btn.dataset.tab === targetTab) {
                        btn.classList.remove('bg-slate-200', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-300');
                        btn.classList.add('bg-blue-600', 'text-white');
                    } else {
                        btn.classList.remove('bg-blue-600', 'text-white');
                        btn.classList.add('bg-slate-200', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-300');
                    }
                });

                // Mostrar/ocultar contenido
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('hidden', content.id !== targetTab);
                });
            });
        });
    }
    const themeToggle = document.getElementById('theme-toggle'), themeIconLight = document.getElementById('theme-icon-light'), themeIconDark = document.getElementById('theme-icon-dark'); function updateThemeIcon(isDark) { themeIconLight.classList.toggle('hidden', !isDark); themeIconDark.classList.toggle('hidden', isDark); } function toggleTheme() { const isDark = document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); updateThemeIcon(isDark); } themeToggle.addEventListener('click', toggleTheme); function initializeTheme() { const isDark = localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches); if (isDark) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); updateThemeIcon(isDark); }
    const sidebar = document.getElementById('seller-sidebar'), sidebarToggle = document.getElementById('sidebar-toggle'), mainContent = document.getElementById('seller-main-content'); function toggleSidebar() { sidebar.classList.toggle('-translate-x-full'); mainContent.classList.toggle('md:ml-64'); document.getElementById('menu-open-icon').classList.toggle('hidden'); document.getElementById('menu-close-icon').classList.toggle('hidden'); } if (sidebarToggle) { sidebarToggle.addEventListener('click', toggleSidebar); }
    function setupSidebarNavigation() {
        const menu = document.getElementById('seller-menu');
        if (!menu) return;
        const contentContainer = document.getElementById('seller-content');
        menu.querySelectorAll('.sidebar-button').forEach(button => {
            if(button.dataset.target) {
                button.addEventListener('click', () => {
                    menu.querySelectorAll('.sidebar-button').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    const targetId = button.dataset.target;
                    Array.from(contentContainer.children).forEach(content => content.classList.toggle('hidden', content.id !== targetId));
                    if(targetId === 'seller-credit-accounts') renderCreditAccounts();
                    if(targetId === 'seller-collections') updateCollectionsModule();
                    if(targetId === 'seller-expenses') updateExpensesModule();
                    if(targetId === 'seller-reports') {
                        renderTodaySales();
                        loadSellerClosures();
                    }
                    // Ocultar sidebar automáticamente al hacer clic en cualquier módulo
                    if (!sidebar.classList.contains('-translate-x-full')) {
                        toggleSidebar();
                    }
                });
            }
        });
        const firstButton = menu.querySelector('.sidebar-button[data-target]');
        if (firstButton) firstButton.click();
    }
    
    function updateSellerDashboard() {
        const dashboardSalesEl = document.getElementById('dashboard-total-sales');
        if (!dashboardSalesEl) return;

        // Actualizar nombre del vendedor
        db_firestore.collection('users').doc(auth.currentUser.uid).get().then((doc) => {
            if (doc.exists) {
                const userName = doc.data().name || doc.data().email || 'VENDEDOR';
                document.getElementById('seller-name-display').textContent = userName.toUpperCase();
            }
        }).catch(error => {
            console.error("Error al obtener nombre del vendedor:", error);
        });

        if (!db.cashRegister.isOpen) {
            // Resumen principal
            dashboardSalesEl.textContent = '$0.00';
            document.getElementById('dashboard-sales-count').textContent = '0 ventas';
            document.getElementById('dashboard-total-expenses').textContent = '$0.00';
            document.getElementById('dashboard-expenses-count').textContent = '0 gastos';

            // Top productos
            document.getElementById('dashboard-top-products').innerHTML = '<div class="text-center text-slate-500 py-4">La caja está cerrada.</div>';

            // Mostrar meta incluso si la caja está cerrada
            loadSellerGoal();

            return;
        }

        // Obtener TODAS las ventas del día
        const todaySales = db.sales.filter(s => s.date === getCurrentDate() && s.sellerId === auth.currentUser.uid);
        const expensesInSession = db.cashRegister.transactions.filter(t => t.type === 'expense');

        // Calcular totales
        const totalSales = todaySales.reduce((sum, s) => sum + s.total, 0);
        const totalExpenses = expensesInSession.reduce((sum, e) => sum + e.amount, 0);
        const balance = totalSales - totalExpenses;

        // Calcular items vendidos
        let totalItems = 0;
        todaySales.forEach(sale => {
            sale.items.forEach(item => {
                totalItems += item.quantity;
            });
        });

        // RESUMEN PRINCIPAL: Total Ventas y Total Gastos
        dashboardSalesEl.textContent = `$${totalSales.toFixed(2)}`;
        document.getElementById('dashboard-sales-count').textContent = `${todaySales.length} venta${todaySales.length !== 1 ? 's' : ''}`;
        document.getElementById('dashboard-total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
        document.getElementById('dashboard-expenses-count').textContent = `${expensesInSession.length} gasto${expensesInSession.length !== 1 ? 's' : ''}`;

        // PRODUCTOS VENDIDOS
        const soldProducts = {};
        todaySales.forEach(sale => {
            sale.items.forEach(item => {
                if (!soldProducts[item.productId]) {
                    soldProducts[item.productId] = { name: item.name, quantity: 0, total: 0 };
                }
                soldProducts[item.productId].quantity += item.quantity;
                soldProducts[item.productId].total += (item.price * item.quantity);
            });
        });

        const sortedProducts = Object.entries(soldProducts)
            .sort(([, a], [, b]) => b.quantity - a.quantity)
            .slice(0, 10); // Mostrar top 10

        const topProductsContainer = document.getElementById('dashboard-top-products');
        if (sortedProducts.length === 0) {
            topProductsContainer.innerHTML = '<div class="text-center text-slate-500 py-4">No se han vendido productos.</div>';
        } else {
            const maxQuantity = sortedProducts[0][1].quantity;
            topProductsContainer.innerHTML = sortedProducts.map(([id, p], index) => {
                const percentage = (p.quantity / maxQuantity) * 100;
                const medals = ['🥇', '🥈', '🥉'];
                const medal = index < 3 ? medals[index] : `<span class="text-slate-500 text-xs">${index + 1}</span>`;

                return `
                    <div class="p-3 bg-slate-50 dark:bg-slate-700 rounded-lg mb-2">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-2 flex-1">
                                <span class="text-xl">${medal}</span>
                                <span class="font-medium text-sm text-slate-900 dark:text-white">${p.name}</span>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-blue-600 dark:text-blue-400">${p.quantity}</div>
                                <div class="text-xs text-slate-500">unidades</div>
                            </div>
                        </div>
                        <div class="w-full bg-slate-200 dark:bg-slate-600 rounded-full h-2">
                            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 h-2 rounded-full transition-all" style="width: ${percentage}%"></div>
                        </div>
                        <div class="text-xs text-slate-600 dark:text-slate-400 mt-1">Total vendido: $${p.total.toFixed(2)}</div>
                    </div>
                `;
            }).join('');
        }

        // Mostrar meta de ventas del mes actual
        loadSellerGoal();
    }

    async function loadSellerGoal() {
        const goalContainer = document.getElementById('seller-goal-container');
        const dailyGoalCard = document.getElementById('daily-goal-card');
        if (!goalContainer) return;

        try {
            const currentDate = new Date();
            const currentMonth = currentDate.toISOString().slice(0, 7); // YYYY-MM
            const today = getCurrentDate(); // YYYY-MM-DD

            // Buscar meta del vendedor para el mes actual
            const goalSnapshot = await db_firestore.collection('sales_goals')
                .where('sellerId', '==', auth.currentUser.uid)
                .where('month', '==', currentMonth)
                .get();

            if (goalSnapshot.empty) {
                goalContainer.innerHTML = '';
                if (dailyGoalCard) dailyGoalCard.innerHTML = '';
                return;
            }

            const goalDoc = goalSnapshot.docs[0];
            const goal = goalDoc.data();

            // Calcular ventas del mes actual
            const year = currentMonth.split('-')[0];
            const month = currentMonth.split('-')[1];
            const startDate = `${year}-${month}-01`;
            const lastDay = new Date(year, month, 0).getDate();
            const endDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;

            // Obtener todas las ventas del mes
            const salesSnapshot = await db_firestore.collection('sales')
                .where('sellerId', '==', auth.currentUser.uid)
                .where('date', '>=', startDate)
                .where('date', '<=', endDate)
                .get();

            const totalSold = salesSnapshot.docs.reduce((sum, doc) => sum + doc.data().total, 0);

            // Calcular ventas de HOY
            const todaySales = salesSnapshot.docs
                .filter(doc => doc.data().date === today)
                .reduce((sum, doc) => sum + doc.data().total, 0);

            // CÁLCULOS DE META DIARIA
            const daysInMonth = lastDay;
            const dailyGoal = goal.goalAmount / daysInMonth;
            const currentDay = parseInt(today.split('-')[2]);
            const daysElapsed = currentDay;
            const expectedSales = dailyGoal * daysElapsed;
            const difference = totalSold - expectedSales;
            const differencePercentage = (difference / expectedSales) * 100;

            // Progreso mensual
            const percentage = (totalSold / goal.goalAmount) * 100;
            const remaining = goal.goalAmount - totalSold;

            // Progreso diario de hoy
            const todayPercentage = (todaySales / dailyGoal) * 100;

            // Determinar color según progreso general
            let bgColor, icon;
            if (percentage >= 100) {
                bgColor = 'from-green-500 to-emerald-600';
                icon = '🎯';
            } else if (percentage >= 75) {
                bgColor = 'from-yellow-500 to-amber-600';
                icon = '⚡';
            } else if (percentage >= 50) {
                bgColor = 'from-blue-500 to-indigo-600';
                icon = '📈';
            } else {
                bgColor = 'from-red-500 to-rose-600';
                icon = '🎯';
            }

            // Determinar estado de comparación
            let comparisonIcon, comparisonColor, comparisonText, adviceText;
            if (difference >= 0) {
                comparisonIcon = '✅';
                comparisonColor = 'bg-green-500';
                const percentAhead = Math.abs(differencePercentage);
                comparisonText = `¡Vas ${percentAhead.toFixed(0)}% adelantado del ritmo necesario!`;
                const projection = (totalSold / daysElapsed) * daysInMonth;
                adviceText = `Si continúas así, terminarás en $${projection.toFixed(2)}`;
            } else {
                comparisonIcon = '⚠️';
                comparisonColor = 'bg-orange-500';
                const percentBehind = Math.abs(differencePercentage);
                comparisonText = `Vas ${percentBehind.toFixed(0)}% por debajo del ritmo necesario`;
                const daysRemaining = daysInMonth - currentDay;
                const neededDaily = remaining / daysRemaining;
                adviceText = `¡Acelera! Necesitas vender $${neededDaily.toFixed(2)}/día los próximos ${daysRemaining} días`;
            }

            // Llenar tarjeta destacada de meta diaria
            const todayRemaining = dailyGoal - todaySales;
            const todayBgColor = todayPercentage >= 100 ? 'from-green-600 to-emerald-700' : todayPercentage >= 50 ? 'from-blue-600 to-indigo-700' : 'from-orange-500 to-red-600';

            if (dailyGoalCard) {
                dailyGoalCard.innerHTML = `
                    <div class="bg-gradient-to-r ${todayBgColor} p-6 rounded-2xl shadow-2xl text-white">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <span class="text-4xl">🎯</span>
                                <div>
                                    <h3 class="text-xl font-bold">Meta del Día</h3>
                                    <p class="text-sm opacity-90">Hoy ${today.split('-')[2]} ${formatMonth(currentMonth).split(' ')[0]}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-black">${todayPercentage.toFixed(0)}%</div>
                                <div class="text-xs opacity-90">Cumplimiento</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-white/20 backdrop-blur-sm p-4 rounded-xl">
                                <div class="text-xs opacity-90 mb-1">Meta del Día</div>
                                <div class="text-2xl font-bold">$${dailyGoal.toFixed(2)}</div>
                            </div>
                            <div class="bg-white/20 backdrop-blur-sm p-4 rounded-xl">
                                <div class="text-xs opacity-90 mb-1">Vendido Hoy</div>
                                <div class="text-2xl font-bold text-green-200">$${todaySales.toFixed(2)}</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="w-full bg-white/30 rounded-full h-4 mb-2">
                                <div class="bg-white h-4 rounded-full transition-all duration-500 flex items-center justify-center text-xs font-bold" style="width: ${Math.min(todayPercentage, 100)}%">
                                    ${todayPercentage >= 30 ? todayPercentage.toFixed(0) + '%' : ''}
                                </div>
                            </div>
                        </div>

                        ${todayRemaining > 0
                            ? `<div class="bg-white/10 p-3 rounded-lg text-center">
                                <div class="text-sm font-semibold">Te faltan <span class="text-yellow-300 text-lg">$${todayRemaining.toFixed(2)}</span> para completar la meta diaria</div>
                               </div>`
                            : `<div class="bg-white/10 p-3 rounded-lg text-center">
                                <div class="text-sm font-semibold">🎉 ¡Felicidades! Superaste la meta diaria por <span class="text-yellow-300 text-lg">$${Math.abs(todayRemaining).toFixed(2)}</span></div>
                               </div>`
                        }
                    </div>
                `;
            }

            goalContainer.innerHTML = `
                <div class="bg-gradient-to-r ${bgColor} p-6 rounded-2xl shadow-xl text-white">
                    <!-- Encabezado -->
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-4xl">${icon}</span>
                        <div>
                            <h3 class="text-xl font-bold">Meta de Ventas</h3>
                            <p class="text-sm opacity-90">${formatMonth(currentMonth)}</p>
                        </div>
                    </div>

                    <!-- Resumen General -->
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-white/20 backdrop-blur-sm p-3 rounded-lg">
                            <div class="text-xs opacity-90">Meta Mensual</div>
                            <div class="text-lg font-bold">$${goal.goalAmount.toFixed(2)}</div>
                        </div>
                        <div class="bg-white/20 backdrop-blur-sm p-3 rounded-lg">
                            <div class="text-xs opacity-90">Total Vendido</div>
                            <div class="text-lg font-bold">$${totalSold.toFixed(2)}</div>
                        </div>
                        <div class="bg-white/20 backdrop-blur-sm p-3 rounded-lg">
                            <div class="text-xs opacity-90">Restante</div>
                            <div class="text-lg font-bold">$${remaining.toFixed(2)}</div>
                        </div>
                    </div>

                    <!-- Progreso General -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span>Progreso General</span>
                            <span class="font-bold">${percentage.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-white/30 rounded-full h-3">
                            <div class="bg-white h-3 rounded-full transition-all duration-500" style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                    </div>

                    <!-- Divisor -->
                    <div class="border-t border-white/30 my-4"></div>

                    <!-- ANÁLISIS DIARIO -->
                    <div class="mb-4">
                        <h4 class="text-sm font-bold mb-2 opacity-90">📅 ANÁLISIS DIARIO</h4>
                        <p class="text-xs opacity-80 mb-3">Hoy es el día ${currentDay} de ${daysInMonth} (${((currentDay/daysInMonth)*100).toFixed(0)}% del mes)</p>

                        <div class="bg-white/20 backdrop-blur-sm p-3 rounded-lg mb-3">
                            <div class="text-xs opacity-90 mb-1">Meta Diaria Promedio</div>
                            <div class="text-2xl font-bold">$${dailyGoal.toFixed(2)}/día</div>
                            <div class="text-xs opacity-75">(Meta mensual ÷ ${daysInMonth} días)</div>
                        </div>

                        <!-- Ventas de Hoy -->
                        <div class="bg-white/10 p-4 rounded-lg mb-3">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xl">🌟</span>
                                <span class="font-bold text-sm">Ventas de Hoy (${today.split('-')[2]} ${formatMonth(currentMonth).split(' ')[0]})</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <div class="text-xs opacity-80">Meta del Día</div>
                                    <div class="text-lg font-bold">$${dailyGoal.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div class="text-xs opacity-80">Vendido Hoy</div>
                                    <div class="text-lg font-bold">$${todaySales.toFixed(2)}</div>
                                </div>
                            </div>
                            <div class="w-full bg-white/30 rounded-full h-2 mb-1">
                                <div class="bg-white h-2 rounded-full transition-all" style="width: ${Math.min(todayPercentage, 100)}%"></div>
                            </div>
                            <div class="text-xs text-center font-semibold">
                                ${todayPercentage >= 100
                                    ? `✨ ¡Excelente! ${todayPercentage.toFixed(0)}% - Superaste la meta diaria`
                                    : todayPercentage >= 50
                                        ? `📊 ${todayPercentage.toFixed(0)}% - Buen avance`
                                        : `💪 ${todayPercentage.toFixed(0)}% - Sigue adelante`
                                }
                            </div>
                        </div>

                        <!-- Comparación con Ritmo Esperado -->
                        <div class="bg-white/10 p-4 rounded-lg">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="text-xl">📊</span>
                                <span class="font-bold text-sm">Comparación con el Ritmo Esperado</span>
                            </div>
                            <div class="space-y-2 mb-3">
                                <div class="flex justify-between text-xs">
                                    <span class="opacity-80">A esta altura del mes (día ${currentDay}) deberías llevar:</span>
                                    <span class="font-bold">$${expectedSales.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between text-xs">
                                    <span class="opacity-80">Tú llevas vendido:</span>
                                    <span class="font-bold">$${totalSold.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between text-sm font-bold border-t border-white/30 pt-2">
                                    <span>Diferencia:</span>
                                    <span class="${difference >= 0 ? 'text-green-200' : 'text-orange-200'}">
                                        ${difference >= 0 ? '+' : ''}$${difference.toFixed(2)} ${difference >= 0 ? '⬆️' : '⬇️'}
                                    </span>
                                </div>
                            </div>
                            <div class="bg-white/20 p-3 rounded-lg text-center">
                                <div class="text-sm font-bold mb-1">${comparisonIcon} ${comparisonText}</div>
                                <div class="text-xs opacity-90">${adviceText}</div>
                            </div>
                        </div>
                    </div>

                    ${percentage >= 100
                        ? `<div class="text-center mt-4 p-3 bg-white/20 rounded-lg">
                            <p class="font-bold">🎉 ¡Felicidades! Meta alcanzada</p>
                           </div>`
                        : ''
                    }
                </div>
            `;
        } catch (error) {
            console.error('Error al cargar meta del vendedor:', error);
            goalContainer.innerHTML = '';
        }
    }

    function setupAdminProductListeners() { document.getElementById('add-product-form').addEventListener('submit', (e) => { e.preventDefault(); const name = document.getElementById('product-name').value; const priceNormal = parseFloat(document.getElementById('product-price-normal').value); const priceBusiness = parseFloat(document.getElementById('product-price-business').value); if (name && !isNaN(priceNormal) && !isNaN(priceBusiness)) { db_firestore.collection('products').add({ name, priceNormal, priceBusiness }).then(() => e.target.reset()).catch(error => alert('Error: ' + error.message)); } }); document.getElementById('edit-product-form').addEventListener('submit', (e) => { e.preventDefault(); const productId = e.target.dataset.editingId; const updatedData = { name: document.getElementById('edit-product-name').value, priceNormal: parseFloat(document.getElementById('edit-product-price-normal').value), priceBusiness: parseFloat(document.getElementById('edit-product-price-business').value) }; db_firestore.collection('products').doc(productId).update(updatedData).then(closeEditModal).catch(error => alert('Error: ' + error.message)); }); document.getElementById('confirm-delete-btn').addEventListener('click', confirmDelete); document.getElementById('add-expense-type-form').addEventListener('submit', (e) => { e.preventDefault(); const name = document.getElementById('expense-type-name').value; if(name) db_firestore.collection('expense_types').add({ name }).then(() => e.target.reset()).catch(error => alert('Error: ' + error.message)); });}
    function renderProductList() { const list = document.getElementById('product-list'); if(!list) return; list.innerHTML = ''; db.products.forEach(p => { list.innerHTML += `<tr><td class="py-3 px-4">${p.name}</td><td class="py-3 px-4">$${p.priceNormal.toFixed(2)}</td><td class="py-3 px-4">$${p.priceBusiness.toFixed(2)}</td><td class="py-3 px-4 space-x-2"><button onclick="openEditModal('${p.id}')" class="text-blue-500 hover:underline">Editar</button><button onclick="promptDeleteProduct('${p.id}')" class="text-red-500 hover:underline">Anular</button></td></tr>`; }); }
    function openEditModal(productId) { const product = db.products.find(p => p.id === productId); if (product) { const form = document.getElementById('edit-product-form'); form.dataset.editingId = productId; document.getElementById('edit-product-name').value = product.name; document.getElementById('edit-product-price-normal').value = product.priceNormal; document.getElementById('edit-product-price-business').value = product.priceBusiness; document.getElementById('edit-product-modal').classList.remove('hidden'); } }
    function closeEditModal() { document.getElementById('edit-product-modal').classList.add('hidden'); }
    function promptDeleteProduct(productId) { document.getElementById('confirm-delete-btn').dataset.deleteId = productId; document.getElementById('delete-confirm-modal').classList.remove('hidden'); document.getElementById('delete-confirm-modal').dataset.deleteType = 'product'; }
    function cancelDelete() { document.getElementById('delete-confirm-modal').classList.add('hidden'); }
    async function confirmDelete() {
        const modal = document.getElementById('delete-confirm-modal');
        const confirmBtn = document.getElementById('confirm-delete-btn');

        // Leer del botón donde se guarda el ID
        const id = confirmBtn.dataset.deleteId;
        const type = modal.dataset.deleteType;
        let collectionName = '';

        console.log('confirmDelete - ID:', id, 'Type:', type);
        console.log('Leyendo de confirmBtn.dataset.deleteId:', confirmBtn.dataset.deleteId);
        console.log('Leyendo de modal.dataset.deleteType:', modal.dataset.deleteType);

        if(type === 'product') {
            collectionName = 'products';
        } else if(type === 'expense_type') {
            // Verificar si hay gastos registrados con este tipo
            const expenseType = db.expenseTypes.find(et => et.id === id);
            console.log('Tipo de gasto encontrado:', expenseType);

            if (expenseType) {
                const expensesWithType = db.expenses.filter(e => e.category === expenseType.name);
                console.log('Gastos encontrados con esta categoría:', expensesWithType.length);

                if (expensesWithType.length > 0) {
                    alert(`No se puede eliminar este tipo de gasto porque existen ${expensesWithType.length} gasto(s) registrado(s) con esta categoría.\n\nPrimero debe eliminar o reasignar los gastos asociados.`);
                    cancelDelete();
                    return;
                }
            }
            collectionName = 'expense_types';
        }

        console.log('Intentando eliminar de colección:', collectionName);

        if(collectionName) {
            try {
                await db_firestore.collection(collectionName).doc(id).delete();
                console.log('Eliminación exitosa de Firestore');
                cancelDelete();
                alert('Eliminado correctamente.');
            } catch(error) {
                console.error('Error al eliminar:', error);
                alert('Error: ' + error.message);
            }
        } else {
            console.error('No se determinó la colección para eliminar');
        }
    }
    function renderExpenseTypeList() {
        const list = document.getElementById('expense-type-list');
        if(!list) return;
        list.innerHTML = '';
        db.expenseTypes.forEach(et => {
            list.innerHTML += `<tr><td class="py-3 px-4">${et.name}</td><td class="py-3 px-4 space-x-2"><button onclick="openEditExpenseTypeModal('${et.id}')" class="text-blue-500 hover:underline">Editar</button><button onclick="promptDeleteExpenseType('${et.id}')" class="text-red-500 hover:underline">Eliminar</button></td></tr>`;
        });
    }
    function promptDeleteExpenseType(id) {
        console.log('promptDeleteExpenseType llamado con ID:', id);
        const modal = document.getElementById('delete-confirm-modal');
        const confirmBtn = document.getElementById('confirm-delete-btn');

        console.log('Modal encontrado:', modal);
        console.log('Botón confirmar encontrado:', confirmBtn);

        confirmBtn.dataset.deleteId = id;
        modal.dataset.deleteType = 'expense_type';

        console.log('Dataset del botón después de asignar:', confirmBtn.dataset.deleteId);
        console.log('Dataset del modal después de asignar:', modal.dataset.deleteType);

        modal.classList.remove('hidden');
    }
    
    async function updateAdminDashboard() {
        const startDateInput = document.getElementById('dashboard-start-date');
        const endDateInput = document.getElementById('dashboard-end-date');

        let startDate = startDateInput.value;
        let endDate = endDateInput.value;

        if (!startDate && !endDate) {
            const today = getCurrentDate();
            startDate = today;
            endDate = today;
        }

        let salesQuery = db_firestore.collection('sales');
        if (startDate) salesQuery = salesQuery.where('date', '>=', startDate);
        if (endDate) salesQuery = salesQuery.where('date', '<=', endDate);

        let expensesQuery = db_firestore.collection('expenses');
        if (startDate) expensesQuery = expensesQuery.where('date', '>=', startDate);
        if (endDate) expensesQuery = expensesQuery.where('date', '<=', endDate);

        try {
            const [salesSnapshot, expensesSnapshot] = await Promise.all([
                salesQuery.get(),
                expensesQuery.get()
            ]);

            const salesData = salesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            const expensesData = expensesSnapshot.docs.map(doc => doc.data());

            // Estadísticas Principales
            const totalSales = salesData.reduce((sum, s) => sum + s.total, 0);
            const totalExpenses = expensesData.reduce((sum, e) => sum + e.amount, 0);
            const balance = totalSales - totalExpenses;
            const creditSales = salesData.filter(s => s.paymentMethod === 'credito');
            const totalCredits = creditSales.reduce((sum, s) => sum + s.total, 0);

            document.getElementById('admin-total-sales').textContent = `$${totalSales.toFixed(2)}`;
            document.getElementById('admin-sales-count').textContent = `${salesData.length} venta${salesData.length !== 1 ? 's' : ''}`;
            document.getElementById('admin-total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
            document.getElementById('admin-expenses-count').textContent = `${expensesData.length} gasto${expensesData.length !== 1 ? 's' : ''}`;
            document.getElementById('admin-balance').textContent = `$${balance.toFixed(2)}`;
            document.getElementById('admin-credits-pending').textContent = `$${totalCredits.toFixed(2)}`;
            document.getElementById('admin-credits-count').textContent = `${creditSales.length} pendiente${creditSales.length !== 1 ? 's' : ''}`;

            // Calcular Producto Más Vendido
            const productStats = {};
            salesData.forEach(sale => {
                if (sale.items && Array.isArray(sale.items)) {
                    sale.items.forEach(item => {
                        if (!productStats[item.name]) {
                            productStats[item.name] = { quantity: 0, total: 0 };
                        }
                        productStats[item.name].quantity += item.quantity;
                        productStats[item.name].total += item.total;
                    });
                }
            });

            // Producto más vendido (por cantidad)
            const topProduct = Object.entries(productStats)
                .sort((a, b) => b[1].quantity - a[1].quantity)[0];

            const topProductContainer = document.getElementById('top-product-container');
            if (topProduct) {
                topProductContainer.innerHTML = `
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-slate-700 dark:to-slate-700 p-4 rounded-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-2xl font-bold text-slate-900 dark:text-white">${topProduct[0]}</p>
                                <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">Cantidad vendida: ${topProduct[1].quantity} unidades</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold text-indigo-600 dark:text-indigo-400">$${topProduct[1].total.toFixed(2)}</p>
                                <p class="text-xs text-slate-500">Total generado</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                topProductContainer.innerHTML = '<p class="text-slate-500 text-center py-4">No hay datos de productos</p>';
            }

            // Top 5 Productos
            const top5Products = Object.entries(productStats)
                .sort((a, b) => b[1].quantity - a[1].quantity)
                .slice(0, 5);

            const top5Container = document.getElementById('top5-products-container');
            if (top5Products.length > 0) {
                top5Container.innerHTML = `
                    <table class="min-w-full">
                        <thead class="bg-slate-50 dark:bg-slate-700">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-bold">#</th>
                                <th class="py-3 px-4 text-left text-sm font-bold">Producto</th>
                                <th class="py-3 px-4 text-left text-sm font-bold">Cantidad</th>
                                <th class="py-3 px-4 text-left text-sm font-bold">Total</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                            ${top5Products.map((product, index) => `
                                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700">
                                    <td class="py-3 px-4">
                                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${
                                            index === 0 ? 'bg-yellow-100 text-yellow-800' :
                                            index === 1 ? 'bg-gray-100 text-gray-800' :
                                            index === 2 ? 'bg-orange-100 text-orange-800' :
                                            'bg-blue-100 text-blue-800'
                                        } font-bold text-sm">${index + 1}</span>
                                    </td>
                                    <td class="py-3 px-4 font-medium text-slate-900 dark:text-white">${product[0]}</td>
                                    <td class="py-3 px-4 text-slate-600 dark:text-slate-400">${product[1].quantity} unidades</td>
                                    <td class="py-3 px-4 font-bold text-teal-600 dark:text-teal-400">$${product[1].total.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                top5Container.innerHTML = '<p class="text-slate-500 text-center py-4">No hay datos de productos</p>';
            }

            // Vendedor con Más Ventas
            const sellerStats = {};
            salesData.forEach(sale => {
                const sellerId = sale.sellerId;
                if (!sellerStats[sellerId]) {
                    sellerStats[sellerId] = { total: 0, count: 0 };
                }
                sellerStats[sellerId].total += sale.total;
                sellerStats[sellerId].count += 1;
            });

            const topSeller = Object.entries(sellerStats)
                .sort((a, b) => b[1].total - a[1].total)[0];

            const topSellerContainer = document.getElementById('top-seller-container');
            if (topSeller) {
                const sellerName = db.usersMap[topSeller[0]] || 'Usuario';
                topSellerContainer.innerHTML = `
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-slate-700 dark:to-slate-700 p-4 rounded-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-2xl font-bold text-slate-900 dark:text-white">${sellerName}</p>
                                <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">${topSeller[1].count} venta${topSeller[1].count !== 1 ? 's' : ''} realizada${topSeller[1].count !== 1 ? 's' : ''}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold text-purple-600 dark:text-purple-400">$${topSeller[1].total.toFixed(2)}</p>
                                <p class="text-xs text-slate-500">Total vendido</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                topSellerContainer.innerHTML = '<p class="text-slate-500 text-center py-4">No hay datos de vendedores</p>';
            }

        } catch (error) {
            console.error("Error filtering dashboard data: ", error);
            alert("Error al cargar los datos del dashboard.");
        }
    } 

    // Sistema unificado de búsqueda y selección de productos
    let selectedProductId = null;

    function setupUnifiedProductSearch() {
        const searchInput = document.getElementById('product-search-input');
        const dropdown = document.getElementById('products-dropdown');
        const toggleBtn = document.getElementById('toggle-products-btn');

        if (!searchInput || !dropdown || !toggleBtn) return;

        // Evento de escritura en el input
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value;
            renderProductsDropdown(searchTerm);
            if (searchTerm.length > 0) {
                dropdown.classList.remove('hidden');
            }
        });

        // Evento de click en el input (mostrar todos)
        searchInput.addEventListener('focus', () => {
            renderProductsDropdown(searchInput.value);
            dropdown.classList.remove('hidden');
        });

        // Botón de toggle (flecha)
        toggleBtn.addEventListener('click', () => {
            if (dropdown.classList.contains('hidden')) {
                searchInput.focus();
                renderProductsDropdown(searchInput.value);
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        });

        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !dropdown.contains(e.target) && !toggleBtn.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Renderizar productos inicialmente
        renderProductsDropdown('');
    }

    function renderProductsDropdown(searchTerm = '') {
        const container = document.getElementById('products-list');
        const dropdown = document.getElementById('products-dropdown');
        if (!container) return;

        const lowerSearch = searchTerm.toLowerCase();
        const filteredProducts = db.products.filter(p =>
            p.name.toLowerCase().includes(lowerSearch)
        );

        if (filteredProducts.length === 0) {
            container.innerHTML = `
                <div class="p-4 text-center text-slate-500 dark:text-slate-400">
                    <p class="text-sm">No se encontraron productos</p>
                </div>`;
            return;
        }

        container.innerHTML = filteredProducts.map(product => {
            const clientType = document.querySelector('input[name="client-type"]:checked')?.value || 'consumidor-final';
            const price = (clientType === 'negocio') ? product.priceBusiness : product.priceNormal;

            return `
                <button
                    type="button"
                    onclick="selectProductFromDropdown('${product.id}', '${product.name.replace(/'/g, "\\'")}', ${price})"
                    class="w-full p-3 sm:p-4 text-left hover:bg-blue-50 dark:hover:bg-slate-600 active:bg-blue-100 dark:active:bg-slate-500 transition flex justify-between items-center">
                    <div class="flex-1">
                        <div class="font-medium text-slate-900 dark:text-white">${product.name}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">Stock: ${product.stock}</div>
                    </div>
                    <div class="font-bold text-blue-600 dark:text-blue-400">$${price.toFixed(2)}</div>
                </button>`;
        }).join('');
    }

    function selectProductFromDropdown(productId, productName, price) {
        const searchInput = document.getElementById('product-search-input');
        const dropdown = document.getElementById('products-dropdown');

        // Guardar el producto seleccionado
        selectedProductId = productId;

        // Actualizar el input con el nombre del producto
        searchInput.value = productName;

        // Cerrar el dropdown
        dropdown.classList.add('hidden');

        // Enfocar en la cantidad para facilitar la entrada rápida
        document.getElementById('sale-quantity').focus();
        document.getElementById('sale-quantity').select();
    }

    // Sistema inteligente de búsqueda de clientes en ventas
    let selectedClientData = null;

    function setupIntelligentClientSearch() {
        const clientInput = document.getElementById('client-name');
        const dropdown = document.getElementById('clients-dropdown');
        const toggleBtn = document.getElementById('toggle-clients-btn');

        if (!clientInput || !dropdown || !toggleBtn) return;

        // Evento de escritura en el input
        clientInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value;
            renderClientsDropdown(searchTerm);
            dropdown.classList.remove('hidden');
            // Limpiar cliente seleccionado si se modifica el texto
            selectedClientData = null;
        });

        // Evento de focus en el input
        clientInput.addEventListener('focus', () => {
            renderClientsDropdown(clientInput.value);
            dropdown.classList.remove('hidden');
        });

        // Botón de toggle (flecha)
        toggleBtn.addEventListener('click', () => {
            if (dropdown.classList.contains('hidden')) {
                clientInput.focus();
                renderClientsDropdown(clientInput.value);
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        });

        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', (e) => {
            if (!clientInput.contains(e.target) && !dropdown.contains(e.target) && !toggleBtn.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Renderizar clientes inicialmente
        renderClientsDropdown('');
    }

    function renderClientsDropdown(searchTerm = '') {
        const container = document.getElementById('clients-list');
        const dropdown = document.getElementById('clients-dropdown');
        if (!container) return;

        const lowerSearch = searchTerm.toLowerCase().trim();

        // Filtrar TODOS los clientes (compartidos entre vendedores)
        const allClients = db.clients.filter(c =>
            (c.name.toLowerCase().includes(lowerSearch) ||
             (c.businessName && c.businessName.toLowerCase().includes(lowerSearch)) ||
             (c.phone && c.phone.includes(searchTerm)))
        );

        let html = '';

        // Mostrar clientes encontrados
        if (allClients.length > 0) {
            html += allClients.map(client => {
                const displayName = client.type === 'negocio' && client.businessName
                    ? `${client.businessName} (${client.name})`
                    : client.name;
                const icon = client.type === 'negocio' ? '🏢' : '👤';

                return `
                    <button
                        type="button"
                        onclick="selectClientFromDropdown('${client.id}')"
                        class="w-full p-3 sm:p-4 text-left hover:bg-blue-50 dark:hover:bg-slate-600 active:bg-blue-100 dark:active:bg-slate-500 transition">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">${icon}</span>
                            <div class="flex-1">
                                <div class="font-medium text-slate-900 dark:text-white">${displayName}</div>
                                ${client.phone ? `<div class="text-xs text-slate-500 dark:text-slate-400">📱 ${client.phone}</div>` : ''}
                            </div>
                        </div>
                    </button>`;
            }).join('');
        }

        // Opción para crear nuevo cliente si hay texto de búsqueda
        if (lowerSearch.length > 0) {
            const exactMatch = allClients.some(c =>
                c.name.toLowerCase() === lowerSearch
            );

            if (!exactMatch) {
                html += `
                    <button
                        type="button"
                        onclick="createNewClientFromSearch('${searchTerm.replace(/'/g, "\\'")}')"
                        class="w-full p-3 sm:p-4 text-left bg-green-50 dark:bg-green-900/30 hover:bg-green-100 dark:hover:bg-green-900/50 active:bg-green-200 dark:active:bg-green-900/70 transition border-t-2 border-green-300 dark:border-green-700">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">➕</span>
                            <div class="flex-1">
                                <div class="font-bold text-green-700 dark:text-green-400">Crear nuevo cliente</div>
                                <div class="text-sm text-green-600 dark:text-green-500">"${searchTerm}"</div>
                            </div>
                        </div>
                    </button>`;
            }
        }

        // Si no hay resultados ni opción de crear
        if (html === '') {
            html = `
                <div class="p-4 text-center text-slate-500 dark:text-slate-400">
                    <p class="text-sm">Escribe un nombre para buscar o crear un cliente</p>
                </div>`;
        }

        container.innerHTML = html;
    }

    function selectClientFromDropdown(clientId) {
        const client = db.clients.find(c => c.id === clientId);
        if (!client) return;

        const clientInput = document.getElementById('client-name');
        const dropdown = document.getElementById('clients-dropdown');

        // Guardar datos del cliente seleccionado
        selectedClientData = client;

        // Mostrar el nombre en el input
        const displayName = client.type === 'negocio' && client.businessName
            ? client.businessName
            : client.name;
        clientInput.value = displayName;

        // Actualizar el tipo de cliente automáticamente
        const typeRadio = client.type === 'negocio'
            ? document.querySelector('input[name="client-type"][value="negocio"]')
            : document.querySelector('input[name="client-type"][value="consumidor-final"]');
        if (typeRadio) typeRadio.checked = true;

        // Actualizar precios de productos si ya hay tipo seleccionado
        const searchInput = document.getElementById('product-search-input');
        if (searchInput) renderProductsDropdown(searchInput.value);

        // Cerrar dropdown
        dropdown.classList.add('hidden');
    }

    function createNewClientFromSearch(clientName) {
        const dropdown = document.getElementById('clients-dropdown');
        dropdown.classList.add('hidden');

        // Abrir el modal con el nombre pre-llenado
        openClientModal(clientName);
    }

    function openClientModal(clientName = '') {
        const modal = document.getElementById('create-client-modal');
        const nameInput = document.getElementById('modal-client-name');

        // Pre-llenar el nombre si se proporciona
        if (clientName) {
            nameInput.value = clientName;
        }

        // Mostrar el modal
        modal.classList.remove('hidden');
    }

    function closeClientModal() {
        const modal = document.getElementById('create-client-modal');
        const form = document.getElementById('modal-client-form');

        // Limpiar el formulario
        form.reset();
        document.getElementById('modal-client-latitude').value = '';
        document.getElementById('modal-client-longitude').value = '';
        document.getElementById('modal-business-name-field').classList.add('hidden');

        // Cerrar el modal
        modal.classList.add('hidden');
    }

    function captureModalClientLocation() {
        if (!navigator.geolocation) {
            alert('La geolocalización no está soportada en este navegador');
            return;
        }

        const latInput = document.getElementById('modal-client-latitude');
        const lonInput = document.getElementById('modal-client-longitude');

        navigator.geolocation.getCurrentPosition(
            (position) => {
                latInput.value = position.coords.latitude.toFixed(6);
                lonInput.value = position.coords.longitude.toFixed(6);
                alert('✅ Ubicación capturada correctamente');
            },
            (error) => {
                let errorMessage = 'Error al obtener la ubicación';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'Permiso de ubicación denegado. Por favor, habilita la ubicación en tu navegador.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'Ubicación no disponible';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'Tiempo de espera agotado';
                        break;
                }
                alert(errorMessage);
            }
        );
    }

    // Listener para mostrar/ocultar campo de nombre de negocio en el modal
    document.addEventListener('DOMContentLoaded', () => {
        const modalTypeSelector = document.getElementById('modal-client-type-selector');
        if (modalTypeSelector) {
            modalTypeSelector.addEventListener('change', (e) => {
                const businessField = document.getElementById('modal-business-name-field');
                if (e.target.value === 'negocio') {
                    businessField.classList.remove('hidden');
                } else {
                    businessField.classList.add('hidden');
                }
            });
        }

        // Listener para el formulario del modal
        const modalForm = document.getElementById('modal-client-form');
        if (modalForm) {
            modalForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const type = document.querySelector('input[name="modal-client-type"]:checked').value;
                const name = document.getElementById('modal-client-name').value.trim();
                const businessName = document.getElementById('modal-client-business-name').value.trim();
                const phone = document.getElementById('modal-client-phone').value.trim();
                const address = document.getElementById('modal-client-address').value.trim();
                const latitude = document.getElementById('modal-client-latitude').value;
                const longitude = document.getElementById('modal-client-longitude').value;

                try {
                    // Verificar si el cliente ya existe
                    const existingClient = db.clients.find(c =>
                        c.name.toLowerCase() === name.toLowerCase() ||
                        (phone && c.phone === phone)
                    );

                    if (existingClient) {
                        alert(`⚠️ Ya existe un cliente con ese nombre o teléfono.\n\nNombre: ${existingClient.name}\nTeléfono: ${existingClient.phone || 'Sin teléfono'}\n\nSe seleccionará el cliente existente.`);

                        // Usar el cliente existente
                        selectedClientData = existingClient;
                        const clientInput = document.getElementById('client-name');
                        const displayName = existingClient.type === 'negocio' && existingClient.businessName ? existingClient.businessName : existingClient.name;
                        clientInput.value = displayName;

                        // Cerrar modal
                        document.getElementById('create-client-modal').classList.add('hidden');
                        modalForm.reset();
                        return;
                    }

                    const newClient = {
                        // NO incluimos sellerId - los clientes son compartidos entre todos los vendedores
                        type,
                        name,
                        businessName: type === 'negocio' ? businessName : '',
                        phone,
                        address,
                        location: latitude && longitude ? {
                            latitude: parseFloat(latitude),
                            longitude: parseFloat(longitude)
                        } : null,
                        createdBy: auth.currentUser.uid, // Solo para referencia de quién lo creó
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    const docRef = await db_firestore.collection('clients').add(newClient);

                    // Guardar referencia al cliente recién creado
                    selectedClientData = { id: docRef.id, ...newClient };

                    // Actualizar el input del módulo de ventas
                    const clientInput = document.getElementById('client-name');
                    const displayName = type === 'negocio' && businessName ? businessName : name;
                    clientInput.value = displayName;

                    // Actualizar el tipo de cliente en ventas
                    const typeRadio = type === 'negocio'
                        ? document.querySelector('input[name="client-type"][value="negocio"]')
                        : document.querySelector('input[name="client-type"][value="consumidor-final"]');
                    if (typeRadio) typeRadio.checked = true;

                    // Actualizar precios si es necesario
                    const searchInput = document.getElementById('product-search-input');
                    if (searchInput) renderProductsDropdown(searchInput.value);

                    alert(`✅ Cliente "${name}" creado exitosamente`);
                    closeClientModal();
                } catch (error) {
                    console.error('Error creating client:', error);
                    alert('❌ Error al crear el cliente. Intenta nuevamente.');
                }
            });
        }
    });

    function updateExpenseTypeDropdown() { const select = document.getElementById('expense-category-selector'); if(!select) return; select.innerHTML = '<option value="">Seleccione tipo</option>'; db.expenseTypes.forEach(et => { select.innerHTML += `<option value="${et.id}">${et.name}</option>`; }); }
    document.getElementById('open-cash-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const balance = parseFloat(document.getElementById('opening-balance').value);
        if (!isNaN(balance)) {
            try {
                // Crear sesión de caja en Firestore
                const sessionData = {
                    sellerId: auth.currentUser.uid,
                    isOpen: true,
                    openingBalance: balance,
                    openedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    date: getCurrentDate()
                };

                const sessionRef = await db_firestore.collection('cash_sessions').add(sessionData);

                db.cashRegister = {
                    sessionId: sessionRef.id,
                    isOpen: true,
                    openingBalance: balance,
                    transactions: []
                };

                saveCashRegisterToStorage();
                await loadCashRegisterFromStorage(); // Recargar desde Firestore para confirmar

                alert('✅ Caja abierta exitosamente');
            } catch (error) {
                console.error('Error al abrir caja:', error);
                alert('Error al abrir caja: ' + error.message);
            }
        }
    });

    // --- Funciones de persistencia de caja ---
    function saveCashRegisterToStorage() {
        // Ya no se usa localStorage para las transacciones, solo para el ID de sesión si es necesario.
        // Las transacciones se guardan directamente en Firestore.
    }

    async function loadCashRegisterFromStorage() {
        if (!auth.currentUser) return;

        try {
            // Primero verificar si hay una sesión activa en Firestore
            const sessionsSnapshot = await db_firestore.collection('cash_sessions')
                .where('sellerId', '==', auth.currentUser.uid)
                .where('isOpen', '==', true)
                .where('date', '==', getCurrentDate())
                .limit(1)
                .get();

            if (!sessionsSnapshot.empty) {
                // Hay una sesión activa en Firestore, cargarla
                const sessionDoc = sessionsSnapshot.docs[0];
                const sessionData = sessionDoc.data();

                // Cargar las transacciones de la subcolección
                const transactionsSnapshot = await sessionDoc.ref.collection('transactions').get();
                const transactions = transactionsSnapshot.docs.map(doc => doc.data());

                db.cashRegister = {
                    sessionId: sessionDoc.id,
                    isOpen: true,
                    openingBalance: sessionData.openingBalance,
                    transactions: transactions
                };

                console.log('✅ Sesión de caja cargada desde Firestore.');
            } else {
                // No hay sesión activa en Firestore para hoy
                db.cashRegister = { isOpen: false, openingBalance: 0, transactions: [] };
            }
        } catch (error) {
            console.error('Error al cargar estado de caja:', error);
            // En caso de error (ej. offline), se mantiene el estado por defecto (caja cerrada)
            db.cashRegister = { isOpen: false, openingBalance: 0, transactions: [] };
        }
        checkCashRegisterStatus();
    }

    function updateCashClosureSummary() {
        const el = document.getElementById('closure-opening-balance');
        if (!el) return;

        if (!db.cashRegister.isOpen) {
            el.textContent = '$0.00';
            return;
        }

        const { openingBalance, transactions } = db.cashRegister;

        // Estadísticas del día - OBTENER PRIMERO las ventas del día
        const todaySales = db.sales.filter(s => s.date === getCurrentDate() && s.sellerId === auth.currentUser.uid);
        const todayExpenses = db.expenses.filter(e => e.date === getCurrentDate() && e.sellerId === auth.currentUser.uid);
        const todayCollections = db.collections.filter(c => c.date === getCurrentDate() && c.sellerId === auth.currentUser.uid);

        // Calcular totales por método de pago desde db.sales (TODAS las ventas del día)
        const cashSales = todaySales.filter(s => s.paymentMethod === 'efectivo').reduce((sum, s) => sum + s.total, 0);
        const creditSales = todaySales.filter(s => s.paymentMethod === 'credito').reduce((sum, s) => sum + s.total, 0);
        const transferSales = todaySales.filter(s => s.paymentMethod === 'transferencia').reduce((sum, s) => sum + s.total, 0);

        // CORRECCIÓN: Gastos y cobros deben calcularse desde los datos del día, no de 'transactions'
        const cashExpenses = todayExpenses.filter(e => e.paymentMethod === 'efectivo').reduce((sum, e) => sum + e.amount, 0);
        const collections = todayCollections.reduce((sum, c) => sum + c.amount, 0);

        const expected = openingBalance + cashSales + collections - cashExpenses;
        const totalDay = cashSales + creditSales + transferSales;

        const totalItems = todaySales.reduce((sum, sale) => {
            return sum + sale.items.reduce((itemSum, item) => itemSum + item.quantity, 0);
        }, 0);

        const totalExpensesAmount = todayExpenses.reduce((sum, e) => sum + e.amount, 0);
        const balance = totalDay - totalExpensesAmount;

        // Actualizar Resumen Visual del Día
        const summaryTotalSales = document.getElementById('closure-summary-total-sales');
        if (summaryTotalSales) summaryTotalSales.textContent = `$${totalDay.toFixed(2)}`;

        const summarySalesCount = document.getElementById('closure-summary-sales-count');
        if (summarySalesCount) summarySalesCount.textContent = `${todaySales.length} ${todaySales.length === 1 ? 'venta' : 'ventas'}`;

        const summaryCash = document.getElementById('closure-summary-cash');
        if (summaryCash) summaryCash.textContent = `$${cashSales.toFixed(2)}`;

        const summaryOther = document.getElementById('closure-summary-other');
        if (summaryOther) summaryOther.textContent = `$${(transferSales + creditSales).toFixed(2)}`;

        const summaryBalance = document.getElementById('closure-summary-balance');
        if (summaryBalance) summaryBalance.textContent = `$${balance.toFixed(2)}`;

        // Renderizar Top Productos
        renderClosureTopProducts(todaySales);

        // Actualizar UI de Cierre
        el.textContent = `$${openingBalance.toFixed(2)}`;
        document.getElementById('closure-cash-sales').textContent = `$${cashSales.toFixed(2)}`;
        document.getElementById('closure-collections').textContent = `$${collections.toFixed(2)}`;
        document.getElementById('closure-cash-expenses').textContent = `$${cashExpenses.toFixed(2)}`;
        document.getElementById('closure-expected-cash').textContent = `$${expected.toFixed(2)}`;
        document.getElementById('closure-credit-sales').textContent = `$${creditSales.toFixed(2)}`;
        document.getElementById('closure-transfer-sales').textContent = `$${transferSales.toFixed(2)}`;

        // Total general del día
        const totalDayEl = document.getElementById('closure-total-day');
        if (totalDayEl) totalDayEl.textContent = `$${totalDay.toFixed(2)}`;

        // Estadísticas
        const statsSales = document.getElementById('stats-total-sales');
        if (statsSales) statsSales.textContent = todaySales.length;

        const statsItems = document.getElementById('stats-total-items');
        if (statsItems) statsItems.textContent = totalItems;

        const statsExpenses = document.getElementById('stats-total-expenses');
        if (statsExpenses) statsExpenses.textContent = todayExpenses.length;

        const statsCollections = document.getElementById('stats-total-collections');
        if (statsCollections) statsCollections.textContent = todayCollections.length;

        // Mostrar cumplimiento de meta del mes
        loadClosureGoal(todaySales);
    }

    async function loadClosureGoal(todaySales) {
        const goalContainer = document.getElementById('closure-goal-container');
        if (!goalContainer) return;

        try {
            const currentDate = new Date();
            const currentMonth = currentDate.toISOString().slice(0, 7); // YYYY-MM

            // Buscar meta del vendedor para el mes actual
            const goalSnapshot = await db_firestore.collection('sales_goals')
                .where('sellerId', '==', auth.currentUser.uid)
                .where('month', '==', currentMonth)
                .get();

            if (goalSnapshot.empty) {
                goalContainer.classList.add('hidden');
                return;
            }

            const goalDoc = goalSnapshot.docs[0];
            const goal = goalDoc.data();

            // Calcular ventas del mes actual
            const year = currentMonth.split('-')[0];
            const month = currentMonth.split('-')[1];
            const startDate = `${year}-${month}-01`;
            const lastDay = new Date(year, month, 0).getDate();
            const endDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;

            const salesSnapshot = await db_firestore.collection('sales')
                .where('sellerId', '==', auth.currentUser.uid)
                .where('date', '>=', startDate)
                .where('date', '<=', endDate)
                .get();

            const totalSold = salesSnapshot.docs.reduce((sum, doc) => sum + doc.data().total, 0);
            const percentage = (totalSold / goal.goalAmount) * 100;

            // Determinar color según progreso
            let bgColor, progressColor, statusText;
            if (percentage >= 100) {
                bgColor = 'from-green-500 to-emerald-600';
                progressColor = 'bg-green-500';
                statusText = '¡Meta Alcanzada! 🎉';
            } else if (percentage >= 75) {
                bgColor = 'from-yellow-500 to-amber-600';
                progressColor = 'bg-yellow-500';
                statusText = '¡Muy Cerca de la Meta! ⚡';
            } else if (percentage >= 50) {
                bgColor = 'from-blue-500 to-indigo-600';
                progressColor = 'bg-blue-500';
                statusText = 'En Progreso 📈';
            } else {
                bgColor = 'from-orange-500 to-red-600';
                progressColor = 'bg-red-500';
                statusText = 'Necesita Impulso 🎯';
            }

            goalContainer.classList.remove('hidden');
            goalContainer.innerHTML = `
                <div class="bg-gradient-to-r ${bgColor} p-4 sm:p-6 rounded-xl shadow-lg text-white">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg sm:text-xl font-bold">Cumplimiento de Meta - ${formatMonth(currentMonth)}</h3>
                        <span class="text-2xl sm:text-3xl font-extrabold">${percentage.toFixed(1)}%</span>
                    </div>
                    <div class="w-full bg-white/30 rounded-full h-3 sm:h-4 mb-3">
                        <div class="bg-white h-3 sm:h-4 rounded-full transition-all duration-500" style="width: ${Math.min(percentage, 100)}%"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="bg-white/20 backdrop-blur-sm p-3 rounded-lg">
                            <div class="text-xs opacity-90">Meta del Mes</div>
                            <div class="text-lg sm:text-xl font-bold">$${goal.goalAmount.toFixed(2)}</div>
                        </div>
                        <div class="bg-white/20 backdrop-blur-sm p-3 rounded-lg">
                            <div class="text-xs opacity-90">Total Vendido</div>
                            <div class="text-lg sm:text-xl font-bold">$${totalSold.toFixed(2)}</div>
                        </div>
                    </div>
                    <p class="text-center font-bold text-sm sm:text-base">${statusText}</p>
                </div>
            `;
        } catch (error) {
            console.error('Error al cargar meta en cierre de caja:', error);
            goalContainer.classList.add('hidden');
        }
    }

    function renderClosureTopProducts(todaySales) {
        const container = document.getElementById('closure-top-products');
        if (!container) return;

        // Agrupar productos y contar cantidades
        const productStats = {};
        todaySales.forEach(sale => {
            sale.items.forEach(item => {
                if (!productStats[item.productId]) {
                    productStats[item.productId] = {
                        name: item.name,
                        quantity: 0,
                        revenue: 0
                    };
                }
                productStats[item.productId].quantity += item.quantity;
                productStats[item.productId].revenue += item.total;
            });
        });

        // Convertir a array y ordenar por cantidad
        const topProducts = Object.values(productStats)
            .sort((a, b) => b.quantity - a.quantity)
            .slice(0, 3);

        if (topProducts.length === 0) {
            container.innerHTML = '<p class="text-center text-slate-500 dark:text-slate-400 py-4 text-sm">No hay productos vendidos</p>';
            return;
        }

        const maxQuantity = topProducts[0].quantity;

        container.innerHTML = topProducts.map((product, index) => {
            const percentage = (product.quantity / maxQuantity) * 100;
            const medals = ['🥇', '🥈', '🥉'];
            const medal = medals[index];

            return `<div class="flex items-center gap-3 p-2 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                <span class="text-2xl">${medal}</span>
                <div class="flex-1">
                    <div class="font-semibold text-sm text-slate-700 dark:text-slate-300">${product.name}</div>
                    <div class="flex items-center gap-2">
                        <div class="flex-1 bg-slate-200 dark:bg-slate-600 rounded-full h-1.5">
                            <div class="bg-green-600 h-1.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <span class="text-xs text-slate-600 dark:text-slate-400">${product.quantity} uds</span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="font-bold text-green-600 dark:text-green-400 text-sm">$${product.revenue.toFixed(2)}</div>
                </div>
            </div>`;
        }).join('');
    }
    
    function checkCashRegisterStatus() { const openView = document.getElementById('open-cash-view'); if (!openView) return; const openedView = document.getElementById('cash-opened-view'), menuButtons = document.querySelectorAll('#seller-menu button:not([data-target="seller-cash"]):not([data-target="seller-reports"])'), closeCashButton = document.getElementById('btn-close-cash'); if (db.cashRegister.isOpen) { openView.classList.add('hidden'); openedView.classList.remove('hidden'); document.getElementById('display-opening-balance').textContent = `$${db.cashRegister.openingBalance.toFixed(2)}`; menuButtons.forEach(btn => btn.disabled = false); closeCashButton.disabled = false; } else { openView.classList.remove('hidden'); openedView.classList.add('hidden'); menuButtons.forEach(btn => btn.disabled = true); closeCashButton.disabled = true; } updateCashClosureSummary(); updateSellerDashboard(); saveCashRegisterToStorage(); }
    function setupSaleFormListeners() {
        document.getElementById('add-to-cart-btn').addEventListener('click', addProductToSale);
        document.getElementById('sale-form').addEventListener('submit', finalizeSale);
        document.getElementById('sale-payment-method').addEventListener('change', (e) => {
            document.getElementById('sale-transfer-note').classList.toggle('hidden', e.target.value !== 'transferencia');
        });
        document.getElementById('client-type-selector').addEventListener('change', () => {
            if (currentSaleItems.length > 0) {
                alert('Cambiar el tipo de cliente vaciará el carrito actual para recalcular precios.');
                currentSaleItems = [];
                renderCurrentSaleTable();
            }
            // Actualizar los precios en el dropdown
            const searchInput = document.getElementById('product-search-input');
            renderProductsDropdown(searchInput.value);
        });
        document.getElementById('add-payment-form').addEventListener('submit', finalizePayment);
    }
    function addProductToSale() {
        const productId = selectedProductId;
        const quantity = parseInt(document.getElementById('sale-quantity').value);
        const product = db.products.find(p => p.id === productId);

        if(product && quantity > 0) {
            const clientType = document.querySelector('input[name="client-type"]:checked').value;
            const price = (clientType === 'negocio') ? product.priceBusiness : product.priceNormal;
            currentSaleItems.push({
                productId: product.id,
                name: product.name,
                quantity,
                price,
                basePrice: price,
                total: price * quantity
            });
            renderCurrentSaleTable();

            // Limpiar el input y resetear selección
            document.getElementById('product-search-input').value = '';
            selectedProductId = null;
            document.getElementById('sale-quantity').value = '1';
            document.getElementById('product-search-input').focus();
        } else {
            alert('Seleccione un producto y cantidad válida.');
        }
    }
    function renderCurrentSaleTable() {
        const container = document.getElementById('current-sale-table');
        const totalEl = document.getElementById('current-sale-total');
        const cartCount = document.getElementById('cart-count');
        container.innerHTML = '';
        let total = 0;

        if (currentSaleItems.length === 0) {
            container.innerHTML = `<div class="text-center py-6 px-3 text-slate-500 dark:text-slate-400">
                <svg class="w-10 h-10 mx-auto mb-1 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                </svg>
                <p class="text-xs">Vacío</p>
            </div>`;
            totalEl.textContent = '$0.00';
            cartCount.classList.add('hidden');
            return;
        }

        // Mostrar contador de items
        cartCount.textContent = currentSaleItems.length;
        cartCount.classList.remove('hidden');

        currentSaleItems.forEach((item, index) => {
            total += item.total;
            container.innerHTML += `
                <div class="p-2 hover:bg-slate-50 dark:hover:bg-slate-700/30 transition">
                    <div class="flex items-center justify-between gap-2">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-200 px-1.5 py-0.5 rounded text-xs font-bold">${item.quantity}x</span>
                                <h4 class="font-medium text-xs sm:text-sm text-slate-800 dark:text-slate-200 truncate">${item.name}</h4>
                            </div>
                            <div class="flex items-center gap-1 mt-0.5 text-xs text-slate-600 dark:text-slate-400">
                                <span>$</span>
                                <input type="number" class="price-input w-12 text-right bg-transparent border-0 border-b border-slate-300 dark:border-slate-600 focus:border-blue-500 p-0 text-xs" value="${item.price.toFixed(2)}" step="0.01" onchange="updateSaleItemPrice(${index}, this.value)">
                                <span class="text-slate-400">c/u</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="font-bold text-sm text-green-600 dark:text-green-400 whitespace-nowrap">$${item.total.toFixed(2)}</span>
                            <button type="button" onclick="removeSaleItem(${index})" class="bg-red-100 active:bg-red-200 dark:bg-red-900 dark:active:bg-red-800 text-red-600 dark:text-red-400 w-6 h-6 rounded-full transition font-bold text-xs flex-shrink-0">✕</button>
                        </div>
                    </div>
                </div>`;
        });
        totalEl.textContent = `$${total.toFixed(2)}`;
    }

    function clearSaleCart() {
        if (currentSaleItems.length === 0) return;
        if (confirm('¿Está seguro de que desea limpiar el carrito?')) {
            currentSaleItems = [];
            renderCurrentSaleTable();
        }
    }

    function renderTodaySales() {
        const todaySales = db.sales.filter(s => s.date === getCurrentDate() && s.sellerId === auth.currentUser.uid);

        // Actualizar resumen del día
        updateTodaySummary(todaySales);

        // Renderizar lista de ventas
        renderTodaySalesList(todaySales);

        // Renderizar productos más vendidos
        renderTopProducts(todaySales);
    }

    function updateTodaySummary(todaySales) {
        const totalSales = todaySales.reduce((sum, s) => sum + s.total, 0);
        const cashSales = todaySales.filter(s => s.paymentMethod === 'efectivo').reduce((sum, s) => sum + s.total, 0);
        const transferSales = todaySales.filter(s => s.paymentMethod === 'transferencia').reduce((sum, s) => sum + s.total, 0);
        const creditSales = todaySales.filter(s => s.paymentMethod === 'credito').reduce((sum, s) => sum + s.total, 0);

        document.getElementById('today-total-sales').textContent = `$${totalSales.toFixed(2)}`;
        document.getElementById('today-sales-count').textContent = `${todaySales.length} ${todaySales.length === 1 ? 'venta' : 'ventas'}`;
        document.getElementById('today-cash-sales').textContent = `$${cashSales.toFixed(2)}`;
        document.getElementById('today-transfer-sales').textContent = `$${transferSales.toFixed(2)}`;
        document.getElementById('today-credit-sales').textContent = `$${creditSales.toFixed(2)}`;
    }

    function renderTodaySalesList(allSales = null) {
        const container = document.getElementById('today-sales-list');
        if (!container) return;

        const filter = document.getElementById('today-payment-filter')?.value || '';
        const todaySales = allSales || db.sales.filter(s => s.date === getCurrentDate() && s.sellerId === auth.currentUser.uid);
        const filteredSales = filter ? todaySales.filter(s => s.paymentMethod === filter) : todaySales;

        if (filteredSales.length === 0) {
            container.innerHTML = '<p class="text-center text-slate-500 dark:text-slate-400 py-6 text-sm">No hay ventas registradas</p>';
            return;
        }

        const paymentIcons = {
            'efectivo': '💵',
            'transferencia': '🏦',
            'credito': '📋'
        };
        const paymentColors = {
            'efectivo': 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300',
            'transferencia': 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300',
            'credito': 'bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300'
        };

        container.innerHTML = filteredSales.slice(-10).reverse().map(sale => {
            return `<div class="bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg border border-slate-200 dark:border-slate-600">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <div class="font-semibold text-sm text-slate-700 dark:text-slate-300">${sale.clientName || 'Cliente General'}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400">${sale.items.length} producto(s)</div>
                    </div>
                    <span class="text-lg font-bold text-green-600 dark:text-green-400">$${sale.total.toFixed(2)}</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs ${paymentColors[sale.paymentMethod]} px-2 py-1 rounded-full font-medium">${paymentIcons[sale.paymentMethod]} ${sale.paymentMethod}</span>
                    <span class="text-xs text-slate-500 dark:text-slate-400">${new Date(sale.timestamp?.toDate ? sale.timestamp.toDate() : sale.timestamp).toLocaleTimeString()}</span>
                </div>
            </div>`;
        }).join('');
    }

    function renderTopProducts(todaySales) {
        const container = document.getElementById('top-products-today');
        if (!container) return;

        // Agrupar productos y contar cantidades
        const productStats = {};
        todaySales.forEach(sale => {
            sale.items.forEach(item => {
                if (!productStats[item.productId]) {
                    productStats[item.productId] = {
                        name: item.name,
                        quantity: 0,
                        revenue: 0
                    };
                }
                productStats[item.productId].quantity += item.quantity;
                productStats[item.productId].revenue += item.total;
            });
        });

        // Convertir a array y ordenar por cantidad
        const topProducts = Object.values(productStats)
            .sort((a, b) => b.quantity - a.quantity)
            .slice(0, 5);

        if (topProducts.length === 0) {
            container.innerHTML = '<p class="text-center text-slate-500 dark:text-slate-400 py-4 text-sm">No hay datos disponibles</p>';
            return;
        }

        const maxQuantity = topProducts[0].quantity;

        container.innerHTML = topProducts.map((product, index) => {
            const percentage = (product.quantity / maxQuantity) * 100;
            const medals = ['🥇', '🥈', '🥉'];
            const medal = medals[index] || '📦';

            return `<div class="bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg border border-slate-200 dark:border-slate-600">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">${medal}</span>
                        <div>
                            <div class="font-semibold text-sm text-slate-700 dark:text-slate-300">${product.name}</div>
                            <div class="text-xs text-slate-500 dark:text-slate-400">${product.quantity} unidades vendidas</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-green-600 dark:text-green-400">$${product.revenue.toFixed(2)}</div>
                    </div>
                </div>
                <div class="w-full bg-slate-200 dark:bg-slate-600 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                </div>
            </div>`;
        }).join('');
    }

    // Listener para el filtro de pagos de hoy
    document.addEventListener('DOMContentLoaded', () => {
        const filterElement = document.getElementById('today-payment-filter');
        if (filterElement) {
            filterElement.addEventListener('change', () => {
                renderTodaySalesList();
            });
        }
    });

    function updateSaleItemPrice(index, newPriceStr) { const item = currentSaleItems[index]; const newPrice = parseFloat(newPriceStr); if (isNaN(newPrice) || newPrice < item.basePrice) { alert(`El precio no puede ser menor a $${item.basePrice.toFixed(2)}`); renderCurrentSaleTable(); return; } item.price = newPrice; item.total = newPrice * item.quantity; renderCurrentSaleTable(); }
    function removeSaleItem(index) { currentSaleItems.splice(index, 1); renderCurrentSaleTable(); }
    async function finalizeSale(e) {
        e.preventDefault();
        if (!db.cashRegister.isOpen) {
            alert("Abra la caja primero.");
            return;
        }
        if (currentSaleItems.length === 0) {
            alert("Añada productos a la venta.");
            return;
        }
        const clientName = document.getElementById('client-name').value;
        const clientType = document.querySelector('input[name="client-type"]:checked').value;
        const paymentMethod = document.querySelector('input[name="sale-payment"]:checked').value;
        const paymentNote = document.getElementById('sale-transfer-note').value;
        const total = currentSaleItems.reduce((sum, item) => sum + item.total, 0);
        const saleDoc = {
            sellerId: auth.currentUser.uid,
            date: getCurrentDate(),
            clientName,
            clientType,
            paymentMethod,
            paymentNote,
            items: currentSaleItems,
            total,
            status: (paymentMethod === 'credito' ? 'pendiente' : 'pagado'),
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Actualizar UI inmediatamente
        currentSaleItems = [];
        renderCurrentSaleTable();
        document.getElementById('sale-form').reset();
        document.getElementById('sale-transfer-note').classList.add('hidden');
        document.getElementById('sale-quantity').value = 1;
        updateCashClosureSummary();
        updateSellerDashboard();
        renderTodaySales();

        // Intentar guardar en Firestore
        try {
            const docRef = await db_firestore.collection('sales').add(saleDoc);
            db.sales.push({ id: docRef.id, ...saleDoc }); // Añadir a la lista local con el ID real

            alert(navigator.onLine
                ? '✅ Venta finalizada con éxito!'
                : '✅ Venta guardada localmente. Se sincronizará al recuperar conexión.');
        } catch (error) {
            console.error("Error al sincronizar con Firestore:", error);
            alert('✅ Venta guardada localmente. Se sincronizará automáticamente cuando haya conexión.');
        }
    }
    async function finalizeCollection(e) {
        e.preventDefault();
        if (!db.cashRegister.isOpen) {
            alert("Abra la caja primero.");
            return;
        }
        const clientName = document.getElementById('collection-client-name').value;
        const amount = parseFloat(document.getElementById('collection-amount').value);
        const reason = document.getElementById('collection-reason').value;

        if(clientName && reason && !isNaN(amount) && amount > 0) {
            const collection = {
                sellerId: auth.currentUser.uid,
                type: 'collection',
                date: getCurrentDate(),
                clientName,
                amount,
                reason
            };

            // Actualizar transacciones de caja
            if (db.cashRegister.sessionId) {
                await db_firestore.collection('cash_sessions').doc(db.cashRegister.sessionId).collection('transactions').add(collection);
            }

            // Actualizar UI inmediatamente
            e.target.reset();
            updateCollectionsModule();

            // Intentar guardar en Firestore
            try {
                const docRef = await db_firestore.collection('collections').add(collection);
                db.collections.push({ id: docRef.id, ...collection });

                alert(navigator.onLine ? '✅ Ingreso registrado con éxito!' : '✅ Ingreso guardado localmente. Se sincronizará al recuperar la conexión.');
            } catch (error) {
                console.error("Error al sincronizar ingreso:", error);
                alert('✅ Ingreso guardado localmente. Se sincronizará automáticamente cuando haya conexión.');
            }
        } else {
            alert('Por favor, complete todos los campos del ingreso.');
        }
    }
    document.getElementById('add-expense-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!db.cashRegister.isOpen) {
            alert("Abra la caja primero.");
            return;
        }
        const categoryId = document.getElementById('expense-category-selector').value;
        const category = db.expenseTypes.find(et => et.id === categoryId);
        const amount = parseFloat(document.getElementById('expense-amount').value);
        const observations = document.getElementById('expense-observations').value;
        const paymentMethod = document.querySelector('input[name="expense-payment"]:checked').value;

        if (category && !isNaN(amount)) {
            if (observations.trim() === '' && (category.name.toLowerCase() === 'compra de producto' || category.name.toLowerCase() === 'otros')) {
                alert('Se requiere una observación para este tipo de gasto.');
                return;
            }

            const expense = {
                sellerId: auth.currentUser.uid,
                type: 'expense',
                date: getCurrentDate(),
                categoryId,
                categoryName: category.name,
                amount,
                observations,
                paymentMethod
            };

            // Actualizar transacciones de caja
            if(paymentMethod === 'efectivo') {
                if (db.cashRegister.sessionId) {
                    await db_firestore.collection('cash_sessions').doc(db.cashRegister.sessionId).collection('transactions').add(expense);
                }
            }

            // Actualizar UI inmediatamente
            updateExpensesModule();
            this.reset();

            // Intentar guardar en Firestore
            try {
                const docRef = await db_firestore.collection('expenses').add(expense);
                db.expenses.push({ id: docRef.id, ...expense });

                alert(navigator.onLine ? '✅ Gasto registrado!' : '✅ Gasto guardado localmente. Se sincronizará al recuperar la conexión.');
            } catch (error) {
                console.error("Error al sincronizar gasto:", error);
                alert('✅ Gasto guardado localmente. Se sincronizará automáticamente cuando haya conexión.');
            }
        } else {
            alert('Complete los campos obligatorios.');
        }
    });
    
    async function closeCashRegister() {
        const physicalCash = parseFloat(document.getElementById('closure-physical-cash').value) || 0;

        if (physicalCash === 0) {
            alert('Por favor, ingrese el efectivo físico contado antes de cerrar la caja.');
            return;
        }

        const { openingBalance, transactions } = db.cashRegister;

        // Obtener las ventas del día del vendedor actual
        const todaySales = db.sales.filter(s => s.date === getCurrentDate() && s.sellerId === auth.currentUser.uid);
        const todayExpenses = db.expenses.filter(e => e.date === getCurrentDate() && e.sellerId === auth.currentUser.uid);
        const todayCollections = db.collections.filter(c => c.date === getCurrentDate() && c.sellerId === auth.currentUser.uid);

        // Calcular totales por método de pago desde db.sales (TODAS las ventas del día)
        const cashSales = todaySales.filter(s => s.paymentMethod === 'efectivo').reduce((sum, s) => sum + s.total, 0);
        const creditSales = todaySales.filter(s => s.paymentMethod === 'credito').reduce((sum, s) => sum + s.total, 0);
        const transferSales = todaySales.filter(s => s.paymentMethod === 'transferencia').reduce((sum, s) => sum + s.total, 0);

        // Gastos en efectivo del día
        const cashExpenses = todayExpenses.filter(e => e.paymentMethod === 'efectivo').reduce((sum, e) => sum + e.amount, 0);

        // Cobros/ingresos adicionales del día
        const collections = todayCollections.reduce((sum, c) => sum + c.amount, 0);

        const expectedCash = openingBalance + cashSales + collections - cashExpenses;
        const difference = physicalCash - expectedCash;

        // Mostrar efectivo esperado y diferencia
        document.getElementById('closure-expected-section').classList.remove('hidden');
        document.getElementById('closure-difference-section').classList.remove('hidden');
        document.getElementById('closure-expected-cash').textContent = `$${expectedCash.toFixed(2)}`;
        document.getElementById('closure-difference').textContent = `$${difference.toFixed(2)}`;

        // Actualizar color de la diferencia
        const diffSection = document.getElementById('closure-difference-section');
        if (difference < 0) {
            diffSection.classList.remove('bg-yellow-50', 'dark:bg-yellow-900/30', 'border-yellow-300', 'dark:border-yellow-700');
            diffSection.classList.add('bg-red-50', 'dark:bg-red-900/30', 'border-red-300', 'dark:border-red-700');
            document.getElementById('closure-difference').classList.add('text-red-800', 'dark:text-red-300');
        } else if (difference > 0) {
            diffSection.classList.remove('bg-yellow-50', 'dark:bg-yellow-900/30', 'border-yellow-300', 'dark:border-yellow-700');
            diffSection.classList.add('bg-green-50', 'dark:bg-green-900/30', 'border-green-300', 'dark:border-green-700');
            document.getElementById('closure-difference').classList.add('text-green-800', 'dark:text-green-300');
        }

        // Confirmar el cierre
        const confirmMsg = `¿Confirmar cierre de caja?\n\nEfectivo Esperado: $${expectedCash.toFixed(2)}\nEfectivo Contado: $${physicalCash.toFixed(2)}\nDiferencia: $${difference.toFixed(2)}`;

        if (!confirm(confirmMsg)) {
            return;
        }

        const closureData = {
            sellerId: auth.currentUser.uid,
            closeTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
            openingBalance, cashSales, cashExpenses, collections, expectedCash, physicalCash, difference,
            creditSales, transferSales, transactions
        };

        try {
            await db_firestore.collection('cash_closures').add(closureData);

            // Cerrar la sesión de caja en Firestore
            if (db.cashRegister.sessionId) {
                await db_firestore.collection('cash_sessions').doc(db.cashRegister.sessionId).update({
                    isOpen: false,
                    closedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    physicalCash,
                    difference
                });
            }

            // Mostrar reporte en modal
            const closureDate = getCurrentDate(); // Guardar la fecha del cierre
            document.getElementById('report-date').textContent = new Date().toLocaleString();
            document.getElementById('report-date').setAttribute('data-closure-date', closureDate); // Guardar fecha en formato YYYY-MM-DD
            document.getElementById('report-initial').textContent = `$${openingBalance.toFixed(2)}`;
            document.getElementById('report-cash-sales').textContent = `$${cashSales.toFixed(2)}`;
            document.getElementById('report-collections').textContent = `$${collections.toFixed(2)}`;
            document.getElementById('report-cash-expenses').textContent = `-$${cashExpenses.toFixed(2)}`;
            document.getElementById('report-total').textContent = `$${expectedCash.toFixed(2)}`;
            document.getElementById('report-physical-cash').textContent = `$${physicalCash.toFixed(2)}`;
            const diffEl = document.getElementById('report-difference');
            diffEl.textContent = `${difference < 0 ? 'Faltante: ' : 'Sobrante: '}$${Math.abs(difference).toFixed(2)}`;
            diffEl.className = `font-bold text-xl ${difference < 0 ? 'text-red-500' : 'text-green-500'}`;

            document.getElementById('cash-close-report-modal').classList.remove('hidden');

            // Resetear caja y ocultar secciones de nuevo
            db.cashRegister = { isOpen: false, openingBalance: 0, transactions: [] };
            document.getElementById('closure-physical-cash').value = '';
            document.getElementById('closure-expected-section').classList.add('hidden');
            document.getElementById('closure-difference-section').classList.add('hidden');

            checkCashRegisterStatus();
        } catch(error) {
            console.error('Error al guardar el cierre:', error);
            alert("Error al guardar el cierre: " + error.message);
        }
    }
    
    async function renderCreditAccounts(searchTerm = '', statusFilter = 'all') {
        const list = document.getElementById('credit-sales-list');
        if (!list) return;

        list.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-slate-500">Cargando...</td></tr>';

        const lowerCaseSearchTerm = searchTerm.toLowerCase();
        const creditSales = db.sales.filter(s => s.paymentMethod === 'credito' && (s.clientName || '').toLowerCase().includes(lowerCaseSearchTerm));

        let totalPending = 0;
        let totalSales = 0;
        let totalPayments = 0;
        let paidCount = 0;
        let pendingAccounts = [];

        list.innerHTML = '';

        if (creditSales.length === 0) {
            list.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-slate-500">No hay cuentas por cobrar${searchTerm ? ' que coincidan.' : '.'}</td></tr>`;
            updateCreditSummary(0, 0, 0, 0, 0);
            return;
        }

        for (const sale of creditSales) {
            const paymentsSnapshot = await db_firestore.collection('sales').doc(sale.id).collection('payments').get();
            const totalPaid = paymentsSnapshot.docs.reduce((sum, doc) => sum + doc.data().amount, 0);
            const balance = sale.total - totalPaid;
            const isPaid = balance <= 0;

            totalSales += sale.total;
            totalPayments += totalPaid;

            if (isPaid) {
                paidCount++;
            } else {
                totalPending += balance;
            }

            // Aplicar filtro de estado
            if (statusFilter === 'pending' && isPaid) continue;
            if (statusFilter === 'paid' && !isPaid) continue;

            const statusBadge = isPaid
                ? '<span class="px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs rounded-full">Saldada</span>'
                : '<span class="px-2 py-1 bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200 text-xs rounded-full">Pendiente</span>';

            list.innerHTML += `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
                    <td class="py-3 px-4 text-xs">${sale.date}</td>
                    <td class="py-3 px-4 text-xs font-medium">${sale.clientName}</td>
                    <td class="py-3 px-4 text-xs">$${sale.total.toFixed(2)}</td>
                    <td class="py-3 px-4 text-xs text-blue-600 dark:text-blue-400">$${totalPaid.toFixed(2)}</td>
                    <td class="py-3 px-4 text-xs font-bold ${isPaid ? 'text-green-600' : 'text-red-600'}">$${balance.toFixed(2)}</td>
                    <td class="py-3 px-4">${statusBadge}</td>
                    <td class="py-3 px-4">
                        ${!isPaid ? `<button onclick="openPaymentModal('${sale.id}', ${balance})" class="text-blue-500 hover:text-blue-700 text-xs font-medium hover:underline">💰 Abonar</button>` : '<span class="text-xs text-slate-400">-</span>'}
                    </td>
                </tr>`;
        }

        updateCreditSummary(totalPending, totalSales, totalPayments, paidCount, creditSales.length - paidCount);
    }

    function updateCreditSummary(totalPending, totalSales, totalPayments, paidCount, pendingCount) {
        document.getElementById('credit-total-pending').textContent = `$${totalPending.toFixed(2)}`;
        document.getElementById('credit-accounts-count').textContent = `${pendingCount} cuenta${pendingCount !== 1 ? 's' : ''}`;
        document.getElementById('credit-total-sales').textContent = `$${totalSales.toFixed(2)}`;
        document.getElementById('credit-total-payments').textContent = `$${totalPayments.toFixed(2)}`;
        document.getElementById('credit-paid-count').textContent = paidCount.toString();
    }
    function openPaymentModal(saleId, balance) { const modal = document.getElementById('payment-modal'); const form = document.getElementById('add-payment-form'); const amountInput = document.getElementById('payment-amount'); form.dataset.saleId = saleId; document.getElementById('payment-modal-balance').textContent = `$${balance.toFixed(2)}`; amountInput.max = balance; modal.classList.remove('hidden'); }
    function closePaymentModal() { document.getElementById('payment-modal').classList.add('hidden'); }
    async function finalizePayment(e) { e.preventDefault(); if (!db.cashRegister.isOpen) { alert("Abra la caja primero para registrar un cobro."); return; } const form = e.target; const saleId = form.dataset.saleId; const amount = parseFloat(document.getElementById('payment-amount').value); const balance = parseFloat(document.getElementById('payment-modal-balance').textContent.replace('$', '')); if (isNaN(amount) || amount <= 0 || amount > balance) { alert('Monto inválido.'); return; } const paymentData = { amount, date: getCurrentDate(), sellerId: auth.currentUser.uid }; const sale = db.sales.find(s => s.id === saleId); db.cashRegister.transactions.push({ type: 'collection', amount, reason: `Abono a venta para ${sale.clientName}` }); updateCashClosureSummary(); updateSellerDashboard(); renderCreditAccounts(); closePaymentModal(); alert(navigator.onLine ? 'Abono registrado con éxito.' : 'Abono guardado localmente. Se sincronizará al recuperar la conexión.'); db_firestore.collection('sales').doc(saleId).collection('payments').add(paymentData).catch(error => console.error("Error al sincronizar abono con Firestore: ", error)); }

    // ===== INGRESOS ADICIONALES =====
    function updateCollectionsModule() {
        const todayCollections = db.collections.filter(c => c.date === getCurrentDate() && c.sellerId === auth.currentUser.uid);
        const currentMonth = getCurrentDate().substring(0, 7); // YYYY-MM
        const monthCollections = db.collections.filter(c => c.date.startsWith(currentMonth) && c.sellerId === auth.currentUser.uid);

        const todayTotal = todayCollections.reduce((sum, c) => sum + c.amount, 0);
        const monthTotal = monthCollections.reduce((sum, c) => sum + c.amount, 0);
        const maxAmount = Math.max(...todayCollections.map(c => c.amount), 0);

        document.getElementById('collections-today-total').textContent = `$${todayTotal.toFixed(2)}`;
        document.getElementById('collections-today-count').textContent = `${todayCollections.length} ingreso${todayCollections.length !== 1 ? 's' : ''}`;
        document.getElementById('collections-month-total').textContent = `$${monthTotal.toFixed(2)}`;
        document.getElementById('collections-max').textContent = `$${maxAmount.toFixed(2)}`;

        // Renderizar historial del día
        const listContainer = document.getElementById('collections-today-list');
        if (todayCollections.length === 0) {
            listContainer.innerHTML = '<div class="text-center text-slate-500 py-4">No hay ingresos registrados hoy.</div>';
        } else {
            listContainer.innerHTML = todayCollections.sort((a, b) => b.amount - a.amount).map(c => `
                <div class="p-3 bg-slate-50 dark:bg-slate-700 rounded-lg">
                    <div class="flex justify-between items-start mb-1">
                        <div class="font-medium text-sm">${c.clientName}</div>
                        <div class="font-bold text-green-600 dark:text-green-400">$${c.amount.toFixed(2)}</div>
                    </div>
                    <div class="text-xs text-slate-600 dark:text-slate-400">${c.reason}</div>
                </div>
            `).join('');
        }
    }

    // ===== GASTOS =====
    function updateExpensesModule() {
        const todayExpenses = db.expenses.filter(e => e.date === getCurrentDate() && e.sellerId === auth.currentUser.uid);

        const todayTotal = todayExpenses.reduce((sum, e) => sum + e.amount, 0);
        const cashExpenses = todayExpenses.filter(e => e.paymentMethod === 'efectivo').reduce((sum, e) => sum + e.amount, 0);
        const otherExpenses = todayExpenses.filter(e => e.paymentMethod !== 'efectivo').reduce((sum, e) => sum + e.amount, 0);
        const maxAmount = Math.max(...todayExpenses.map(e => e.amount), 0);

        document.getElementById('expenses-today-total').textContent = `$${todayTotal.toFixed(2)}`;
        document.getElementById('expenses-today-count').textContent = `${todayExpenses.length} gasto${todayExpenses.length !== 1 ? 's' : ''}`;
        document.getElementById('expenses-cash-total').textContent = `$${cashExpenses.toFixed(2)}`;
        document.getElementById('expenses-other-total').textContent = `$${otherExpenses.toFixed(2)}`;
        document.getElementById('expenses-max').textContent = `$${maxAmount.toFixed(2)}`;

        // Renderizar historial del día
        const listContainer = document.getElementById('expenses-today-list');
        if (todayExpenses.length === 0) {
            listContainer.innerHTML = '<div class="text-center text-slate-500 py-4">No hay gastos registrados hoy.</div>';
        } else {
            listContainer.innerHTML = todayExpenses.sort((a, b) => b.amount - a.amount).map(e => {
                const paymentIcons = { 'efectivo': '💵', 'transferencia': '💳', 'credito': '🏦' };
                const icon = paymentIcons[e.paymentMethod] || '💰';
                return `
                    <div class="p-3 bg-slate-50 dark:bg-slate-700 rounded-lg">
                        <div class="flex justify-between items-start mb-1">
                            <div class="font-medium text-sm">${e.categoryName}</div>
                            <div class="font-bold text-red-600 dark:text-red-400">$${e.amount.toFixed(2)}</div>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-xs text-slate-600 dark:text-slate-400">${e.observations || 'Sin observaciones'}</div>
                            <div class="text-xs">${icon}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Gastos por categoría
        const expensesByCategory = {};
        todayExpenses.forEach(e => {
            if (!expensesByCategory[e.categoryId]) {
                expensesByCategory[e.categoryId] = { name: e.categoryName, total: 0, count: 0 };
            }
            expensesByCategory[e.categoryId].total += e.amount;
            expensesByCategory[e.categoryId].count++;
        });

        const categoryContainer = document.getElementById('expenses-by-category');
        const categories = Object.values(expensesByCategory).sort((a, b) => b.total - a.total);

        if (categories.length === 0) {
            categoryContainer.innerHTML = '<div class="col-span-full text-center text-slate-500 py-4">No hay gastos por categoría hoy.</div>';
        } else {
            const maxCategoryTotal = categories[0].total;
            categoryContainer.innerHTML = categories.map(cat => {
                const percentage = (cat.total / maxCategoryTotal) * 100;
                return `
                    <div class="p-4 bg-slate-50 dark:bg-slate-700 rounded-lg">
                        <div class="font-medium text-sm mb-2">${cat.name}</div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-slate-600 dark:text-slate-400">${cat.count} gasto${cat.count !== 1 ? 's' : ''}</span>
                            <span class="font-bold text-red-600 dark:text-red-400">$${cat.total.toFixed(2)}</span>
                        </div>
                        <div class="w-full bg-slate-200 dark:bg-slate-600 rounded-full h-2 mt-2">
                            <div class="bg-gradient-to-r from-red-500 to-pink-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    }

    function filterClosures() { let query = db_firestore.collection('cash_closures'); const startDate = document.getElementById('closure-start-date').value; const endDate = document.getElementById('closure-end-date').value; if(startDate) query = query.where('closeTimestamp', '>=', new Date(startDate)); if(endDate) query = query.where('closeTimestamp', '<=', new Date(endDate + 'T23:59:59')); query.get().then(snapshot => { const closures = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})); renderClosuresList(closures); }); }
    function renderClosuresList(closures) {
        const list = document.getElementById('closures-list');
        list.innerHTML = '';
        closures.forEach(c => {
            const diff = c.difference;
            const diffText = `${diff < 0 ? 'Faltante' : 'Sobrante'}: $${Math.abs(diff).toFixed(2)}`;
            list.innerHTML += `
                <tr>
                    <td class="py-3 px-4">${c.closeTimestamp.toDate().toLocaleString()}</td>
                    <td class="py-3 px-4">${db.usersMap[c.sellerId] || c.sellerId}</td>
                    <td class="py-3 px-4 ${diff < 0 ? 'text-red-500' : 'text-green-500'}">${diffText}</td>
                    <td class="py-3 px-4 space-x-2">
                        <button onclick="openEditClosureModal('${c.id}')" class="text-blue-500 hover:underline">Editar</button>
                        <button onclick="generateAdminClosurePdf('${c.id}')" class="text-green-500 hover:underline">PDF</button>
                        <button onclick="deleteClosureAdmin('${c.id}')" class="text-red-500 hover:underline">Eliminar</button>
                    </td>
                </tr>
            `;
        });
    }
    
    async function generateDetailedReport(type, creditOnly = false) {
        const data = creditOnly ? filteredAdminReportsData.creditSales : filteredAdminReportsData[type];
        if (!data) {
            alert("Por favor, primero consulte la información.");
            return;
        }

        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;
        const doc = new jsPDF();
        let title = '', head = [], body = [];
        const dateRange = `${startDate || 'Inicio'} al ${endDate || 'Fin'}`;

        switch(type) {
            case 'sales':
                title = creditOnly ? `Reporte de Cuentas por Cobrar` : `Reporte Detallado de Ventas`;
                head = [['Fecha', 'Vendedor', 'Cliente', 'Producto', 'Cant.', 'Total', 'Método']];
                body = data.flatMap(s => s.items.map(i => [s.date, db.usersMap[s.sellerId] || s.sellerId, s.clientName, i.name, i.quantity, `$${i.total.toFixed(2)}`, s.paymentMethod]));
                break;
            case 'expenses':
                title = 'Reporte Detallado de Gastos';
                head = [['Fecha', 'Vendedor', 'Categoría', 'Monto', 'Método']];
                body = data.map(e => [e.date, db.usersMap[e.sellerId], e.categoryName, `$${e.amount.toFixed(2)}`, e.paymentMethod]);
                break;
            case 'collections':
                title = 'Reporte de Ingresos Adicionales';
                head = [['Fecha', 'Vendedor', 'Origen', 'Monto', 'Razón']];
                body = data.map(c => [c.date, db.usersMap[c.sellerId], c.clientName, `$${c.amount.toFixed(2)}`, c.reason]);
                break;
        }
        doc.setFontSize(18); doc.text(title, 14, 22); doc.setFontSize(10); doc.text(`Periodo: ${dateRange}`, 14, 28); doc.autoTable({ startY: 35, head, body });
        doc.save(`${type}_report_${getCurrentDate()}.pdf`);
    }

    async function generateAdminClosurePdf(closureId) {
        try {
            const docSnap = await db_firestore.collection('cash_closures').doc(closureId).get();
            if (!docSnap.exists) {
                alert('No se encontró el cierre.');
                return;
            }

            const closure = docSnap.data();

            // Obtener las ventas del día del cierre usando fecha local
            const closureDateTime = closure.closeTimestamp.toDate();
            const year = closureDateTime.getFullYear();
            const month = String(closureDateTime.getMonth() + 1).padStart(2, '0');
            const day = String(closureDateTime.getDate()).padStart(2, '0');
            const closureDate = `${year}-${month}-${day}`;
            console.log('Admin PDF - Fecha del cierre:', closureDate);
            console.log('Admin PDF - Seller ID:', closure.sellerId);

            const salesSnapshot = await db_firestore.collection('sales')
                .where('sellerId', '==', closure.sellerId)
                .where('date', '==', closureDate)
                .get();

            const todaySales = salesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            console.log('Admin PDF - Ventas encontradas:', todaySales.length);
            console.log('Admin PDF - Ventas:', todaySales);

            // Calcular totales por método de pago
            const totalCashSales = todaySales.filter(s => s.paymentMethod === 'efectivo').reduce((sum, s) => sum + s.total, 0);
            const totalTransferSales = todaySales.filter(s => s.paymentMethod === 'transferencia').reduce((sum, s) => sum + s.total, 0);
            const totalCreditSales = todaySales.filter(s => s.paymentMethod === 'credito').reduce((sum, s) => sum + s.total, 0);
            const totalAllSales = totalCashSales + totalTransferSales + totalCreditSales;

            const doc = new jsPDF();

            // Encabezado
            doc.setFontSize(18);
            doc.setTextColor(22, 160, 133);
            doc.text('Reporte de Cierre de Caja', 14, 20);

            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text(`Fecha: ${closure.closeTimestamp.toDate().toLocaleString()}`, 14, 28);
            // Obtener nombre del vendedor
            const sellerDoc = await db_firestore.collection('users').doc(closure.sellerId).get();
            const sellerName = sellerDoc.exists ? (sellerDoc.data().name || sellerDoc.data().email) : 'Usuario';
            doc.text(`Vendedor: ${sellerName}`, 14, 34);

            // Resumen de Efectivo
            doc.setFontSize(14);
            doc.setTextColor(22, 160, 133);
            doc.text('Resumen de Efectivo', 14, 45);

            doc.autoTable({
                startY: 50,
                theme: 'grid',
                body: [
                    ['(+) Monto Inicial', `$${closure.openingBalance.toFixed(2)}`],
                    ['(+) Ventas Efectivo', `$${closure.cashSales.toFixed(2)}`],
                    ['(+) Cobros', `$${closure.collections.toFixed(2)}`],
                    ['(-) Gastos Efectivo', `-$${closure.cashExpenses.toFixed(2)}`],
                    ['(=) Total Esperado', `$${closure.expectedCash.toFixed(2)}`],
                    ['Fisico Contado', `$${closure.physicalCash.toFixed(2)}`],
                    ['Diferencia', `${closure.difference < 0 ? 'Faltante' : 'Sobrante'}: $${Math.abs(closure.difference).toFixed(2)}`]
                ],
                styles: { fontSize: 10 },
                headStyles: { fillColor: [22, 160, 133] },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 90 },
                    1: { halign: 'right', cellWidth: 50 }
                }
            });

            let currentY = doc.lastAutoTable.finalY + 10;

            // Resumen de Ventas por Método de Pago
            doc.setFontSize(14);
            doc.setTextColor(22, 160, 133);
            doc.text('Resumen de Ventas', 14, currentY);

            doc.autoTable({
                startY: currentY + 5,
                theme: 'grid',
                head: [['Metodo de Pago', 'Cantidad', 'Total']],
                body: [
                    ['Efectivo', todaySales.filter(s => s.paymentMethod === 'efectivo').length.toString(), `$${totalCashSales.toFixed(2)}`],
                    ['Transferencia', todaySales.filter(s => s.paymentMethod === 'transferencia').length.toString(), `$${totalTransferSales.toFixed(2)}`],
                    ['Credito', todaySales.filter(s => s.paymentMethod === 'credito').length.toString(), `$${totalCreditSales.toFixed(2)}`],
                    ['TOTAL GENERAL', todaySales.length.toString(), `$${totalAllSales.toFixed(2)}`]
                ],
                styles: { fontSize: 10 },
                headStyles: { fillColor: [22, 160, 133] },
                columnStyles: {
                    0: { cellWidth: 70 },
                    1: { halign: 'center', cellWidth: 30 },
                    2: { halign: 'right', cellWidth: 40, fontStyle: 'bold' }
                },
                bodyStyles: {
                    3: { fillColor: [220, 220, 220], fontStyle: 'bold' }
                }
            });

            currentY = doc.lastAutoTable.finalY + 10;

            // Detalle de Ventas
            if (todaySales.length > 0) {
                doc.setFontSize(14);
                doc.setTextColor(22, 160, 133);
                doc.text('Detalle de Ventas', 14, currentY);

                // Preparar datos para la tabla con detalle de productos
                const salesData = [];
                todaySales.forEach((sale, index) => {
                    const items = sale.items || [];
                    const itemsText = items.length > 0
                        ? items.map(i => `${i.name} (${i.quantity}x$${i.price.toFixed(2)})`).join(', ')
                        : 'Sin productos';

                    salesData.push([
                        (index + 1).toString(),
                        sale.clientName || 'Cliente General',
                        sale.paymentMethod,
                        itemsText,
                        `$${sale.total.toFixed(2)}`
                    ]);
                });

                doc.autoTable({
                    startY: currentY + 5,
                    theme: 'striped',
                    head: [['#', 'Cliente', 'Metodo', 'Productos', 'Total']],
                    body: salesData,
                    styles: { fontSize: 7, cellPadding: 2 },
                    headStyles: { fillColor: [22, 160, 133], fontSize: 8 },
                    columnStyles: {
                        0: { cellWidth: 10, halign: 'center' },
                        1: { cellWidth: 35 },
                        2: { cellWidth: 23 },
                        3: { cellWidth: 95 },
                        4: { cellWidth: 25, halign: 'right', fontStyle: 'bold' }
                    },
                    margin: { left: 10, right: 10 }
                });

                currentY = doc.lastAutoTable.finalY + 10;

                // Productos más vendidos
                const productStats = {};
                todaySales.forEach(sale => {
                    sale.items.forEach(item => {
                        if (!productStats[item.name]) {
                            productStats[item.name] = 0;
                        }
                        productStats[item.name] += item.quantity;
                    });
                });

                const topProducts = Object.entries(productStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                if (topProducts.length > 0) {
                    if (currentY > 250) {
                        doc.addPage();
                        currentY = 20;
                    }

                    doc.setFontSize(14);
                    doc.setTextColor(22, 160, 133);
                    doc.text('Productos Mas Vendidos', 14, currentY);

                    const productsData = topProducts.map(([name, qty], index) => {
                        return [
                            (index + 1).toString(),
                            name,
                            qty.toString()
                        ];
                    });

                    doc.autoTable({
                        startY: currentY + 5,
                        theme: 'grid',
                        head: [['Pos', 'Producto', 'Cantidad']],
                        body: productsData,
                        styles: { fontSize: 10 },
                        headStyles: { fillColor: [22, 160, 133] },
                        columnStyles: {
                            0: { cellWidth: 20, halign: 'center' },
                            1: { cellWidth: 90 },
                            2: { cellWidth: 30, halign: 'center', fontStyle: 'bold' }
                        }
                    });
                }
            } else {
                doc.setFontSize(11);
                doc.setTextColor(100, 100, 100);
                doc.text('No se registraron ventas en este periodo', 14, currentY);
            }

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Pagina ${i} de ${pageCount}`, 14, 285);
                doc.text(`Generado el ${new Date().toLocaleString()}`, 120, 285);
            }

            doc.save(`cierre_caja_${closureDate}.pdf`);
        } catch (error) {
            console.error('Error al generar PDF:', error);
            alert('Error al generar el PDF: ' + error.message);
        }
    }
    
    async function queryAndDisplayAdminReports() {
        const displayArea = document.getElementById('admin-reports-display');
        displayArea.classList.remove('hidden');

        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;

        try {
            // Fetch Sales
            let salesQuery = db_firestore.collection('sales');
            if (startDate) salesQuery = salesQuery.where('date', '>=', startDate);
            if (endDate) salesQuery = salesQuery.where('date', '<=', endDate);
            const salesSnapshot = await salesQuery.get();
            const salesData = salesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            filteredAdminReportsData.sales = salesData;

            const creditSalesData = salesData.filter(s => s.paymentMethod === 'credito');
            filteredAdminReportsData.creditSales = creditSalesData;

            // Fetch Expenses
            let expensesQuery = db_firestore.collection('expenses');
            if (startDate) expensesQuery = expensesQuery.where('date', '>=', startDate);
            if (endDate) expensesQuery = expensesQuery.where('date', '<=', endDate);
            const expensesSnapshot = await expensesQuery.get();
            const expensesData = expensesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            filteredAdminReportsData.expenses = expensesData;

            // Fetch Collections
            let collectionsQuery = db_firestore.collection('collections');
            if (startDate) collectionsQuery = collectionsQuery.where('date', '>=', startDate);
            if (endDate) collectionsQuery = collectionsQuery.where('date', '<=', endDate);
            const collectionsSnapshot = await collectionsQuery.get();
            const collectionsData = collectionsSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
            filteredAdminReportsData.collections = collectionsData;

            renderAllAdminReportTables();
        } catch (error) {
            console.error("Error querying reports:", error);
            alert("Error al consultar los reportes.");
        }
    }

    function renderAllAdminReportTables() {
        // Render Sales
        const salesHead = document.getElementById('admin-sales-report-head');
        const salesBody = document.getElementById('admin-sales-report-body');
        salesHead.innerHTML = `<th>Fecha</th><th>Vendedor</th><th>Cliente</th><th>Items</th><th>Total</th><th>Método</th>`;
        salesBody.innerHTML = filteredAdminReportsData.sales.map(s => `<tr>
            <td class="p-2">${s.date}</td>
            <td class="p-2">${db.usersMap[s.sellerId] || ''}</td>
            <td class="p-2">${s.clientName}</td>
            <td class="p-2">${s.items.map(i => i.name).join(', ')}</td>
            <td class="p-2">$${s.total.toFixed(2)}</td>
            <td class="p-2">${s.paymentMethod}</td>
        </tr>`).join('') || `<tr><td colspan="6" class="text-center p-4">No hay datos.</td></tr>`;

        // Render Credit Sales
        const creditHead = document.getElementById('admin-credit-report-head');
        const creditBody = document.getElementById('admin-credit-report-body');
        creditHead.innerHTML = `<th>Fecha</th><th>Vendedor</th><th>Cliente</th><th>Total</th>`;
        creditBody.innerHTML = filteredAdminReportsData.creditSales.map(s => `<tr>
            <td class="p-2">${s.date}</td>
            <td class="p-2">${db.usersMap[s.sellerId] || ''}</td>
            <td class="p-2">${s.clientName}</td>
            <td class="p-2">$${s.total.toFixed(2)}</td>
        </tr>`).join('') || `<tr><td colspan="4" class="text-center p-4">No hay datos.</td></tr>`;

        // Render Expenses
        const expensesHead = document.getElementById('admin-expenses-report-head');
        const expensesBody = document.getElementById('admin-expenses-report-body');
        expensesHead.innerHTML = `<th>Fecha</th><th>Vendedor</th><th>Categoría</th><th>Monto</th><th>Método</th>`;
        expensesBody.innerHTML = filteredAdminReportsData.expenses.map(e => `<tr>
            <td class="p-2">${e.date}</td>
            <td class="p-2">${db.usersMap[e.sellerId] || ''}</td>
            <td class="p-2">${e.categoryName}</td>
            <td class="p-2">$${e.amount.toFixed(2)}</td>
            <td class="p-2">${e.paymentMethod}</td>
        </tr>`).join('') || `<tr><td colspan="5" class="text-center p-4">No hay datos.</td></tr>`;

        // Render Collections
        const collectionsHead = document.getElementById('admin-collections-report-head');
        const collectionsBody = document.getElementById('admin-collections-report-body');
        collectionsHead.innerHTML = `<th>Fecha</th><th>Vendedor</th><th>Origen</th><th>Monto</th><th>Razón</th>`;
        collectionsBody.innerHTML = filteredAdminReportsData.collections.map(c => `<tr>
            <td class="p-2">${c.date}</td>
            <td class="p-2">${db.usersMap[c.sellerId] || ''}</td>
            <td class="p-2">${c.clientName}</td>
            <td class="p-2">$${c.amount.toFixed(2)}</td>
            <td class="p-2">${c.reason}</td>
        </tr>`).join('') || `<tr><td colspan="5" class="text-center p-4">No hay datos.</td></tr>`;
    }

    function filterSellerReports() {
        const startDate = document.getElementById('seller-start-date').value;
        const endDate = document.getElementById('seller-end-date').value;
        const paymentFilter = document.getElementById('report-payment-filter')?.value || '';

        if (!startDate || !endDate) {
            alert('Por favor seleccione las fechas de inicio y fin');
            return;
        }

        // Filtrar ventas
        let sales = db.sales.filter(s => s.sellerId === auth.currentUser.uid && s.date >= startDate && s.date <= endDate);
        if (paymentFilter) {
            sales = sales.filter(s => s.paymentMethod === paymentFilter);
        }

        // Filtrar gastos
        const expenses = db.expenses.filter(e => e.sellerId === auth.currentUser.uid && e.date >= startDate && e.date <= endDate);

        // Calcular totales
        const totalSales = sales.reduce((sum, s) => sum + s.total, 0);
        const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
        const balance = totalSales - totalExpenses;
        const totalProducts = sales.reduce((sum, s) => sum + s.items.reduce((itemSum, item) => itemSum + item.quantity, 0), 0);

        // Actualizar resumen
        document.getElementById('report-total-sales').textContent = `$${totalSales.toFixed(2)}`;
        document.getElementById('report-sales-count').textContent = `${sales.length} ${sales.length === 1 ? 'venta' : 'ventas'}`;
        document.getElementById('report-total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
        document.getElementById('report-expenses-count').textContent = `${expenses.length} ${expenses.length === 1 ? 'gasto' : 'gastos'}`;
        document.getElementById('report-balance').textContent = `$${balance.toFixed(2)}`;
        document.getElementById('report-products-count').textContent = totalProducts;

        // Renderizar tablas
        renderSalesReport(sales);
        renderExpensesReport(expenses);
    }

    function renderSalesReport(sales) {
        const container = document.getElementById('seller-sales-report');
        if (!container) return;

        if (sales.length === 0) {
            container.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-slate-500 dark:text-slate-400 text-sm">No hay ventas en el período seleccionado</td></tr>';
            return;
        }

        const paymentIcons = { 'efectivo': '💵', 'transferencia': '🏦', 'credito': '📋' };

        container.innerHTML = sales.map(sale => {
            return `<tr>
                <td class="py-2 px-2 text-xs">${sale.date}</td>
                <td class="py-2 px-2 text-xs">${sale.clientName || 'General'}</td>
                <td class="py-2 px-2 text-xs">${paymentIcons[sale.paymentMethod]} ${sale.paymentMethod}</td>
                <td class="py-2 px-2 text-xs text-right font-bold text-green-600 dark:text-green-400">$${sale.total.toFixed(2)}</td>
            </tr>`;
        }).join('');
    }

    function renderExpensesReport(expenses) {
        const container = document.getElementById('seller-expenses-report');
        if (!container) return;

        if (expenses.length === 0) {
            container.innerHTML = '<tr><td colspan="3" class="py-4 text-center text-slate-500 dark:text-slate-400 text-sm">No hay gastos en el período seleccionado</td></tr>';
            return;
        }

        container.innerHTML = expenses.map(expense => {
            const expenseType = db.expenseTypes.find(et => et.id === expense.typeId);
            return `<tr>
                <td class="py-2 px-2 text-xs">${expense.date}</td>
                <td class="py-2 px-2 text-xs">${expenseType ? expenseType.name : expense.description}</td>
                <td class="py-2 px-2 text-xs text-right font-bold text-red-600 dark:text-red-400">$${expense.amount.toFixed(2)}</td>
            </tr>`;
        }).join('');
    }

    async function generateSellerReportPDF() {
        const startDate = document.getElementById('seller-start-date').value;
        const endDate = document.getElementById('seller-end-date').value;

        if (!startDate || !endDate) {
            alert('Por favor genere el reporte primero');
            return;
        }

        const doc = new jsPDF();
        const totalSales = document.getElementById('report-total-sales').textContent;
        const totalExpenses = document.getElementById('report-total-expenses').textContent;
        const balance = document.getElementById('report-balance').textContent;
        const salesCount = document.getElementById('report-sales-count').textContent;
        const expensesCount = document.getElementById('report-expenses-count').textContent;

        doc.setFontSize(18);
        doc.text('Reporte de Ventas y Gastos', 14, 22);
        doc.setFontSize(12);
        doc.text(`Período: ${startDate} al ${endDate}`, 14, 30);
        // Obtener nombre del vendedor
        const currentUserDoc = await db_firestore.collection('users').doc(auth.currentUser.uid).get();
        const currentUserName = currentUserDoc.exists ? (currentUserDoc.data().name || auth.currentUser.email) : auth.currentUser.email;
        doc.text(`Vendedor: ${currentUserName}`, 14, 36);

        doc.autoTable({
            startY: 45,
            theme: 'grid',
            head: [['Concepto', 'Valor']],
            body: [
                ['Total Ventas', totalSales + ' (' + salesCount + ')'],
                ['Total Gastos', totalExpenses + ' (' + expensesCount + ')'],
                ['Balance', balance]
            ],
            styles: { fontSize: 12 },
            headStyles: { fillColor: [22, 160, 133] }
        });

        doc.save(`reporte_${startDate}_${endDate}.pdf`);
    }
    async function generateCloseCashPDF() {
        const doc = new jsPDF();
        const date = document.getElementById('report-date').textContent;
        const closureDate = document.getElementById('report-date').getAttribute('data-closure-date') || getCurrentDate();
        const initial = document.getElementById('report-initial').textContent;
        const cashSales = document.getElementById('report-cash-sales').textContent;
        const collections = document.getElementById('report-collections').textContent;
        const cashExpenses = document.getElementById('report-cash-expenses').textContent;
        const total = document.getElementById('report-total').textContent;
        const physical = document.getElementById('report-physical-cash').textContent;
        const difference = document.getElementById('report-difference').textContent;

        console.log('Generando PDF para fecha:', closureDate);
        console.log('Fecha mostrada:', date);

        // Obtener ventas del día del cierre desde Firestore
        const salesSnapshot = await db_firestore.collection('sales')
            .where('sellerId', '==', auth.currentUser.uid)
            .where('date', '==', closureDate)
            .get();

        const todaySales = salesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        console.log('Ventas encontradas:', todaySales.length);
        console.log('Ventas:', todaySales);

        // Calcular totales por método de pago
        const totalCashSales = todaySales.filter(s => s.paymentMethod === 'efectivo').reduce((sum, s) => sum + s.total, 0);
        const totalTransferSales = todaySales.filter(s => s.paymentMethod === 'transferencia').reduce((sum, s) => sum + s.total, 0);
        const totalCreditSales = todaySales.filter(s => s.paymentMethod === 'credito').reduce((sum, s) => sum + s.total, 0);
        const totalAllSales = totalCashSales + totalTransferSales + totalCreditSales;

        // Encabezado
        doc.setFontSize(18);
        doc.setTextColor(22, 160, 133);
        doc.text('Reporte de Cierre de Caja', 14, 20);

        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        doc.text(`Fecha: ${date}`, 14, 28);
        // Obtener nombre del vendedor
        const userDoc = await db_firestore.collection('users').doc(auth.currentUser.uid).get();
        const userName = userDoc.exists ? (userDoc.data().name || auth.currentUser.email) : auth.currentUser.email;
        doc.text(`Vendedor: ${userName}`, 14, 34);

        // Resumen de Efectivo
        doc.setFontSize(14);
        doc.setTextColor(22, 160, 133);
        doc.text('Resumen de Efectivo', 14, 45);

        doc.autoTable({
            startY: 50,
            theme: 'grid',
            body: [
                ['(+) Monto Inicial', initial],
                ['(+) Ventas Efectivo', cashSales],
                ['(+) Cobros', collections],
                ['(-) Gastos Efectivo', cashExpenses],
                ['(=) Total Esperado', total],
                ['Fisico Contado', physical],
                ['Diferencia', difference]
            ],
            styles: { fontSize: 10 },
            headStyles: { fillColor: [22, 160, 133] },
            columnStyles: {
                0: { fontStyle: 'bold', cellWidth: 90 },
                1: { halign: 'right', cellWidth: 50 }
            }
        });

        let currentY = doc.lastAutoTable.finalY + 10;

        // Resumen de Ventas por Método de Pago
        doc.setFontSize(14);
        doc.setTextColor(22, 160, 133);
        doc.text('Resumen de Ventas', 14, currentY);

        doc.autoTable({
            startY: currentY + 5,
            theme: 'grid',
            head: [['Metodo de Pago', 'Cantidad', 'Total']],
            body: [
                ['Efectivo', todaySales.filter(s => s.paymentMethod === 'efectivo').length.toString(), `$${totalCashSales.toFixed(2)}`],
                ['Transferencia', todaySales.filter(s => s.paymentMethod === 'transferencia').length.toString(), `$${totalTransferSales.toFixed(2)}`],
                ['Credito', todaySales.filter(s => s.paymentMethod === 'credito').length.toString(), `$${totalCreditSales.toFixed(2)}`],
                ['TOTAL GENERAL', todaySales.length.toString(), `$${totalAllSales.toFixed(2)}`]
            ],
            styles: { fontSize: 10 },
            headStyles: { fillColor: [22, 160, 133] },
            columnStyles: {
                0: { cellWidth: 70 },
                1: { halign: 'center', cellWidth: 30 },
                2: { halign: 'right', cellWidth: 40, fontStyle: 'bold' }
            },
            bodyStyles: {
                3: { fillColor: [220, 220, 220], fontStyle: 'bold' }
            }
        });

        currentY = doc.lastAutoTable.finalY + 10;

        // Detalle de Ventas
        if (todaySales.length > 0) {
            doc.setFontSize(14);
            doc.setTextColor(22, 160, 133);
            doc.text('Detalle de Ventas', 14, currentY);

            // Preparar datos para la tabla con detalle de productos
            const salesData = [];
            todaySales.forEach((sale, index) => {
                const items = sale.items || [];
                const itemsText = items.length > 0
                    ? items.map(i => `${i.name} (${i.quantity}x$${i.price.toFixed(2)})`).join(', ')
                    : 'Sin productos';

                salesData.push([
                    (index + 1).toString(),
                    sale.clientName || 'Cliente General',
                    sale.paymentMethod,
                    itemsText,
                    `$${sale.total.toFixed(2)}`
                ]);
            });

            doc.autoTable({
                startY: currentY + 5,
                theme: 'striped',
                head: [['#', 'Cliente', 'Metodo', 'Productos', 'Total']],
                body: salesData,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [22, 160, 133] },
                columnStyles: {
                    0: { cellWidth: 8, halign: 'center' },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 80 },
                    4: { cellWidth: 25, halign: 'right', fontStyle: 'bold' }
                },
                margin: { left: 14, right: 14 }
            });

            currentY = doc.lastAutoTable.finalY + 10;

            // Productos más vendidos
            const productStats = {};
            todaySales.forEach(sale => {
                sale.items.forEach(item => {
                    if (!productStats[item.name]) {
                        productStats[item.name] = 0;
                    }
                    productStats[item.name] += item.quantity;
                });
            });

            const topProducts = Object.entries(productStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            if (topProducts.length > 0) {
                // Verificar si necesitamos una nueva página
                if (currentY > 250) {
                    doc.addPage();
                    currentY = 20;
                }

                doc.setFontSize(14);
                doc.setTextColor(22, 160, 133);
                doc.text('Productos Mas Vendidos', 14, currentY);

                const productsData = topProducts.map(([name, qty], index) => {
                    return [
                        (index + 1).toString(),
                        name,
                        qty.toString()
                    ];
                });

                doc.autoTable({
                    startY: currentY + 5,
                    theme: 'grid',
                    head: [['Pos', 'Producto', 'Cantidad']],
                    body: productsData,
                    styles: { fontSize: 10 },
                    headStyles: { fillColor: [22, 160, 133] },
                    columnStyles: {
                        0: { cellWidth: 20, halign: 'center' },
                        1: { cellWidth: 90 },
                        2: { cellWidth: 30, halign: 'center', fontStyle: 'bold' }
                    }
                });
            }
        } else {
            doc.setFontSize(11);
            doc.setTextColor(100, 100, 100);
            doc.text('No se registraron ventas en este periodo', 14, currentY);
        }

        // Footer
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`Pagina ${i} de ${pageCount}`, 14, 285);
            doc.text(`Generado el ${new Date().toLocaleString()}`, 120, 285);
        }

        doc.save(`cierre_caja_${getCurrentDate()}.pdf`);
    }

    // ========== FUNCIONES PARA GESTIÓN DE VENTAS Y GASTOS ==========

    let managementSalesData = [];
    let managementExpensesData = [];

    async function queryManagement() {
        const startDate = document.getElementById('management-start-date').value;
        const endDate = document.getElementById('management-end-date').value;
        const sellerFilter = document.getElementById('management-seller-filter').value;

        if (!startDate || !endDate) {
            alert('Por favor, seleccione un rango de fechas.');
            return;
        }

        // Consultar ventas
        let salesQuery = db_firestore.collection('sales')
            .where('date', '>=', startDate)
            .where('date', '<=', endDate);

        if (sellerFilter) {
            salesQuery = salesQuery.where('sellerId', '==', sellerFilter);
        }

        const salesSnapshot = await salesQuery.orderBy('date', 'desc').get();
        managementSalesData = salesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

        // Consultar gastos
        let expensesQuery = db_firestore.collection('expenses')
            .where('date', '>=', startDate)
            .where('date', '<=', endDate);

        if (sellerFilter) {
            expensesQuery = expensesQuery.where('sellerId', '==', sellerFilter);
        }

        const expensesSnapshot = await expensesQuery.orderBy('date', 'desc').get();
        managementExpensesData = expensesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

        // Calcular estadísticas
        const totalSales = managementSalesData.reduce((sum, s) => sum + s.total, 0);
        const totalExpenses = managementExpensesData.reduce((sum, e) => sum + e.amount, 0);
        const totalCredits = managementSalesData.filter(s => s.paymentMethod === 'credito').reduce((sum, s) => sum + s.total, 0);
        const creditsCount = managementSalesData.filter(s => s.paymentMethod === 'credito').length;

        document.getElementById('management-total-sales').textContent = '$' + totalSales.toFixed(2);
        document.getElementById('management-count-sales').textContent = managementSalesData.length + ' registro' + (managementSalesData.length !== 1 ? 's' : '');
        document.getElementById('management-total-expenses').textContent = '$' + totalExpenses.toFixed(2);
        document.getElementById('management-count-expenses').textContent = managementExpensesData.length + ' registro' + (managementExpensesData.length !== 1 ? 's' : '');
        document.getElementById('management-balance').textContent = '$' + (totalSales - totalExpenses).toFixed(2);
        document.getElementById('management-total-credits').textContent = '$' + totalCredits.toFixed(2);
        document.getElementById('management-count-credits').textContent = creditsCount + ' pendiente' + (creditsCount !== 1 ? 's' : '');

        document.getElementById('management-stats').classList.remove('hidden');

        // Renderizar tablas
        renderManagementSales();
        renderManagementExpenses();
    }

    function loadSellersDropdown(users) {
        // Dropdown de filtro de gestión
        const dropdown = document.getElementById('management-seller-filter');
        const currentValue = dropdown.value;
        dropdown.innerHTML = '<option value="">Todos los vendedores</option>';

        users.forEach(doc => {
            const userData = doc.data();
            const name = userData.name || userData.email;
            dropdown.innerHTML += `<option value="${doc.id}">${name}</option>`;
        });

        dropdown.value = currentValue;

        // Dropdown de metas
        const goalDropdown = document.getElementById('goal-seller');
        if (goalDropdown) {
            const currentGoalValue = goalDropdown.value;
            goalDropdown.innerHTML = '<option value="">Seleccionar vendedor</option>';

            users.forEach(doc => {
                const userData = doc.data();
                const name = userData.name || userData.email;
                goalDropdown.innerHTML += `<option value="${doc.id}">${name}</option>`;
            });

            goalDropdown.value = currentGoalValue;
        }
    }

    // ========== FUNCIONES PARA METAS DE VENTAS ==========

    // Listener para guardar nueva meta
    document.getElementById('add-sales-goal-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const sellerId = document.getElementById('goal-seller').value;
        const month = document.getElementById('goal-month').value;
        const goalAmount = parseFloat(document.getElementById('goal-amount').value);

        if (!sellerId || !month || !goalAmount) {
            alert('Por favor complete todos los campos.');
            return;
        }

        try {
            // Verificar si ya existe una meta para este vendedor en este mes
            const existingGoal = await db_firestore.collection('sales_goals')
                .where('sellerId', '==', sellerId)
                .where('month', '==', month)
                .get();

            if (!existingGoal.empty) {
                alert('Ya existe una meta para este vendedor en este mes. Por favor elimine la meta existente primero.');
                return;
            }

            await db_firestore.collection('sales_goals').add({
                sellerId,
                month,
                goalAmount,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            alert('Meta creada exitosamente');
            document.getElementById('add-sales-goal-form').reset();
            // No llamar loadSalesGoals() aquí porque el onSnapshot lo hará automáticamente
        } catch (error) {
            console.error('Error creating sales goal:', error);
            alert('Error al crear la meta: ' + error.message);
        }
    });

    async function loadSalesGoals() {
        try {
            const snapshot = await db_firestore.collection('sales_goals')
                .orderBy('month', 'desc')
                .get();

            const goalsList = document.getElementById('sales-goals-list');
            goalsList.innerHTML = '';

            if (snapshot.empty) {
                goalsList.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">No hay metas registradas</td></tr>';
                return;
            }

            for (const doc of snapshot.docs) {
                const goal = doc.data();
                const goalId = doc.id;

                // Calcular ventas del mes
                const [year, month] = goal.month.split('-');
                const startDate = `${year}-${month}-01`;
                const lastDay = new Date(year, month, 0).getDate();
                const endDate = `${year}-${month}-${lastDay}`;

                const salesSnapshot = await db_firestore.collection('sales')
                    .where('sellerId', '==', goal.sellerId)
                    .where('date', '>=', startDate)
                    .where('date', '<=', endDate)
                    .get();

                const totalSold = salesSnapshot.docs.reduce((sum, doc) => sum + doc.data().total, 0);
                const percentage = (totalSold / goal.goalAmount) * 100;

                const sellerName = db.usersMap[goal.sellerId] || 'Usuario';

                const row = `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                        <td class="py-3 px-6">${sellerName}</td>
                        <td class="py-3 px-6">${formatMonth(goal.month)}</td>
                        <td class="py-3 px-6 font-semibold text-orange-600 dark:text-orange-400">$${goal.goalAmount.toFixed(2)}</td>
                        <td class="py-3 px-6 font-semibold text-green-600 dark:text-green-400">$${totalSold.toFixed(2)}</td>
                        <td class="py-3 px-6">
                            <div class="flex items-center gap-2">
                                <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                    <div class="h-2 rounded-full ${percentage >= 100 ? 'bg-green-500' : percentage >= 75 ? 'bg-yellow-500' : 'bg-red-500'}"
                                         style="width: ${Math.min(percentage, 100)}%"></div>
                                </div>
                                <span class="text-sm font-bold ${percentage >= 100 ? 'text-green-600' : percentage >= 75 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${percentage.toFixed(1)}%
                                </span>
                            </div>
                        </td>
                        <td class="py-3 px-6">
                            <button onclick="downloadGoalPDF('${goalId}', '${goal.sellerId}', '${goal.month}', ${goal.goalAmount}, ${totalSold}, ${percentage})" class="text-blue-600 hover:text-blue-800 font-medium mr-3">
                                <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                PDF
                            </button>
                            <button onclick="deleteSalesGoal('${goalId}')" class="text-red-600 hover:text-red-800 font-medium">Eliminar</button>
                        </td>
                    </tr>
                `;
                goalsList.innerHTML += row;
            }

        } catch (error) {
            console.error('Error loading sales goals:', error);
        }
    }

    async function deleteSalesGoal(goalId) {
        if (!confirm('¿Está seguro de eliminar esta meta?')) return;

        try {
            await db_firestore.collection('sales_goals').doc(goalId).delete();
            alert('Meta eliminada correctamente');
            loadSalesGoals();
        } catch (error) {
            console.error('Error deleting sales goal:', error);
            alert('Error al eliminar la meta: ' + error.message);
        }
    }

    async function downloadGoalPDF(goalId, sellerId, month, goalAmount, totalSold, overallPercentage) {
        try {
            const doc = new jsPDF();

            // Header
            doc.setFontSize(20);
            doc.setTextColor(22, 160, 133);
            doc.text('Reporte de Meta de Ventas', 14, 20);

            // Información básica
            const sellerName = db.usersMap[sellerId] || 'Usuario';
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text(`Vendedor: ${sellerName}`, 14, 28);
            doc.text(`Período: ${formatMonth(month)}`, 14, 34);
            doc.text(`Fecha de reporte: ${new Date().toLocaleDateString()}`, 14, 40);

            // Resumen de Meta Mensual
            doc.setFontSize(14);
            doc.setTextColor(22, 160, 133);
            doc.text('Resumen del Mes', 14, 50);

            const [year, monthNum] = month.split('-');
            const daysInMonth = new Date(year, monthNum, 0).getDate();
            const remainingMonth = goalAmount - totalSold;

            doc.autoTable({
                startY: 55,
                theme: 'grid',
                head: [['Concepto', 'Valor']],
                body: [
                    ['Meta del Mes', `$${goalAmount.toFixed(2)}`],
                    ['Total Vendido', `$${totalSold.toFixed(2)}`],
                    ['Porcentaje Cumplido', `${overallPercentage.toFixed(1)}%`],
                    [remainingMonth > 0 ? 'Falta para Cumplir' : 'Excedente', `$${Math.abs(remainingMonth).toFixed(2)}`],
                    ['Meta Diaria Promedio', `$${(goalAmount / daysInMonth).toFixed(2)}/día`],
                    ['Días en el Mes', `${daysInMonth} días`]
                ],
                styles: { fontSize: 10 },
                headStyles: { fillColor: [22, 160, 133] },
                columnStyles: {
                    0: { cellWidth: 90, fontStyle: 'bold' },
                    1: { halign: 'right', cellWidth: 50, fontStyle: 'bold' }
                },
                bodyStyles: (data) => {
                    if (data.row.index === 2) {
                        return { fillColor: [255, 255, 200] };
                    }
                }
            });

            let currentY = doc.lastAutoTable.finalY + 10;

            // Obtener ventas detalladas por día
            const startDate = `${year}-${monthNum}-01`;
            const lastDay = daysInMonth;
            const endDate = `${year}-${monthNum}-${String(lastDay).padStart(2, '0')}`;

            const salesSnapshot = await db_firestore.collection('sales')
                .where('sellerId', '==', sellerId)
                .where('date', '>=', startDate)
                .where('date', '<=', endDate)
                .orderBy('date', 'asc')
                .get();

            // Agrupar ventas por día
            const dailySales = {};
            salesSnapshot.docs.forEach(doc => {
                const sale = doc.data();
                if (!dailySales[sale.date]) {
                    dailySales[sale.date] = 0;
                }
                dailySales[sale.date] += sale.total;
            });

            // Crear tabla de progreso diario
            doc.setFontSize(14);
            doc.setTextColor(22, 160, 133);
            doc.text('Progreso Diario', 14, currentY);

            const dailyGoal = goalAmount / daysInMonth;
            const today = getCurrentDate();
            const currentDay = today.slice(0, 7) === month ? parseInt(today.split('-')[2]) : daysInMonth;

            const dailyData = [];
            let accumulatedSales = 0;
            let accumulatedGoal = 0;

            for (let day = 1; day <= currentDay; day++) {
                const dateStr = `${year}-${monthNum}-${String(day).padStart(2, '0')}`;
                const daySales = dailySales[dateStr] || 0;
                accumulatedSales += daySales;
                accumulatedGoal += dailyGoal;

                const dayPercentage = (daySales / dailyGoal) * 100;
                const difference = daySales - dailyGoal;

                dailyData.push([
                    `${day}/${monthNum}`,
                    `$${daySales.toFixed(2)}`,
                    `$${dailyGoal.toFixed(2)}`,
                    `${dayPercentage.toFixed(1)}%`,
                    `${difference >= 0 ? '+' : ''}$${difference.toFixed(2)}`,
                    `$${accumulatedSales.toFixed(2)}`
                ]);
            }

            doc.autoTable({
                startY: currentY + 5,
                theme: 'striped',
                head: [['Día', 'Vendido', 'Meta Día', '%', 'Dif.', 'Acumulado']],
                body: dailyData,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [22, 160, 133] },
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { halign: 'right', cellWidth: 28 },
                    2: { halign: 'right', cellWidth: 28 },
                    3: { halign: 'center', cellWidth: 20 },
                    4: { halign: 'right', cellWidth: 28 },
                    5: { halign: 'right', cellWidth: 30, fontStyle: 'bold' }
                },
                bodyStyles: (data) => {
                    const difference = parseFloat(data.row.raw[4].replace('$', '').replace('+', ''));
                    if (difference >= 0) {
                        return { 4: { textColor: [0, 128, 0] } };
                    } else {
                        return { 4: { textColor: [255, 0, 0] } };
                    }
                }
            });

            currentY = doc.lastAutoTable.finalY + 10;

            // Análisis de cumplimiento
            doc.setFontSize(14);
            doc.setTextColor(22, 160, 133);
            doc.text('Análisis de Cumplimiento', 14, currentY);

            const expectedSales = dailyGoal * currentDay;
            const differenceVsExpected = totalSold - expectedSales;
            const performanceRate = (totalSold / expectedSales) * 100;

            doc.autoTable({
                startY: currentY + 5,
                theme: 'grid',
                head: [['Concepto', 'Valor']],
                body: [
                    ['Días Transcurridos', `${currentDay} de ${daysInMonth} días`],
                    ['Ventas Esperadas a la Fecha', `$${expectedSales.toFixed(2)}`],
                    ['Ventas Reales a la Fecha', `$${totalSold.toFixed(2)}`],
                    ['Diferencia vs Esperado', `${differenceVsExpected >= 0 ? '+' : ''}$${differenceVsExpected.toFixed(2)}`],
                    ['Ritmo de Cumplimiento', `${performanceRate.toFixed(1)}%`],
                    ['Proyección de Cierre', `$${((totalSold / currentDay) * daysInMonth).toFixed(2)}`]
                ],
                styles: { fontSize: 10 },
                headStyles: { fillColor: [22, 160, 133] },
                columnStyles: {
                    0: { cellWidth: 90, fontStyle: 'bold' },
                    1: { halign: 'right', cellWidth: 50, fontStyle: 'bold' }
                },
                bodyStyles: (data) => {
                    if (data.row.index === 3) {
                        const diff = differenceVsExpected;
                        return { 1: { textColor: diff >= 0 ? [0, 128, 0] : [255, 0, 0] } };
                    }
                    if (data.row.index === 4) {
                        return { fillColor: [255, 255, 200] };
                    }
                }
            });

            // Footer
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('Generado con Sistema de Ventas - Distribuidor Autorizado', 14, 285);

            // Guardar PDF
            doc.save(`Meta_${sellerName}_${formatMonth(month).replace(' ', '_')}.pdf`);

        } catch (error) {
            console.error('Error generating goal PDF:', error);
            alert('Error al generar el PDF: ' + error.message);
        }
    }

    function formatMonth(monthStr) {
        const [year, month] = monthStr.split('-');
        const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                       'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        return `${months[parseInt(month) - 1]} ${year}`;
    }

    // Cargar metas cuando se abre la pestaña (solo para administradores)
    auth.onAuthStateChanged(user => {
        if (user) {
            db_firestore.collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists && doc.data().role === 'admin') {
                    db_firestore.collection('sales_goals').onSnapshot(() => {
                        loadSalesGoals();
                    });
                }
            });
        }
    });

    function renderManagementSales() {
        const searchTerm = document.getElementById('search-sales').value.toLowerCase();
        const paymentFilter = document.getElementById('filter-sales-payment').value;

        let filtered = managementSalesData.filter(sale => {
            const matchSearch = sale.clientName.toLowerCase().includes(searchTerm);
            const matchPayment = !paymentFilter || sale.paymentMethod === paymentFilter;
            return matchSearch && matchPayment;
        });

        const salesList = document.getElementById('management-sales-list');
        salesList.innerHTML = '';

        filtered.forEach(sale => {
            const row = `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                    <td class="py-3 px-6">${formatDateDisplay(sale.date)}</td>
                    <td class="py-3 px-6">${db.usersMap[sale.sellerId] || sale.sellerId}</td>
                    <td class="py-3 px-6">${sale.clientName}</td>
                    <td class="py-3 px-6 font-semibold text-green-600 dark:text-green-400">$${sale.total.toFixed(2)}</td>
                    <td class="py-3 px-6"><span class="px-2 py-1 text-xs rounded-full ${
                        sale.paymentMethod === 'efectivo' ? 'bg-green-100 text-green-800' :
                        sale.paymentMethod === 'transferencia' ? 'bg-blue-100 text-blue-800' :
                        'bg-yellow-100 text-yellow-800'
                    }">${sale.paymentMethod}</span></td>
                    <td class="py-3 px-6">
                        <button onclick="openEditSaleModal('${sale.id}')" class="text-blue-600 hover:text-blue-800 mr-3 font-medium">Editar</button>
                        <button onclick="deleteSale('${sale.id}')" class="text-red-600 hover:text-red-800 font-medium">Eliminar</button>
                    </td>
                </tr>
            `;
            salesList.innerHTML += row;
        });

        if (filtered.length === 0) {
            salesList.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">No se encontraron ventas</td></tr>';
        }
    }

    function renderManagementExpenses() {
        const searchTerm = document.getElementById('search-expenses').value.toLowerCase();
        const paymentFilter = document.getElementById('filter-expenses-payment').value;

        let filtered = managementExpensesData.filter(expense => {
            const category = expense.category || '';
            const matchSearch = category.toLowerCase().includes(searchTerm);
            const matchPayment = !paymentFilter || expense.paymentMethod === paymentFilter;
            return matchSearch && matchPayment;
        });

        const expensesList = document.getElementById('management-expenses-list');
        expensesList.innerHTML = '';

        filtered.forEach(expense => {
            const row = `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                    <td class="py-3 px-6">${formatDateDisplay(expense.date)}</td>
                    <td class="py-3 px-6">${db.usersMap[expense.sellerId] || expense.sellerId}</td>
                    <td class="py-3 px-6">${expense.category || 'Sin categoría'}</td>
                    <td class="py-3 px-6 font-semibold text-red-600 dark:text-red-400">$${expense.amount.toFixed(2)}</td>
                    <td class="py-3 px-6"><span class="px-2 py-1 text-xs rounded-full ${
                        expense.paymentMethod === 'efectivo' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'
                    }">${expense.paymentMethod}</span></td>
                    <td class="py-3 px-6">
                        <button onclick="openEditExpenseModal('${expense.id}')" class="text-blue-600 hover:text-blue-800 mr-3 font-medium">Editar</button>
                        <button onclick="deleteExpense('${expense.id}')" class="text-red-600 hover:text-red-800 font-medium">Eliminar</button>
                    </td>
                </tr>
            `;
            expensesList.innerHTML += row;
        });

        if (filtered.length === 0) {
            expensesList.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500">No se encontraron gastos</td></tr>';
        }
    }

    // Event listeners para filtros
    document.getElementById('search-sales').addEventListener('input', renderManagementSales);
    document.getElementById('filter-sales-payment').addEventListener('change', renderManagementSales);
    document.getElementById('search-expenses').addEventListener('input', renderManagementExpenses);
    document.getElementById('filter-expenses-payment').addEventListener('change', renderManagementExpenses);

    // Funciones de exportación a Excel
    function exportSalesToExcel() {
        const searchTerm = document.getElementById('search-sales').value.toLowerCase();
        const paymentFilter = document.getElementById('filter-sales-payment').value;

        let filtered = managementSalesData.filter(sale => {
            const matchSearch = sale.clientName.toLowerCase().includes(searchTerm);
            const matchPayment = !paymentFilter || sale.paymentMethod === paymentFilter;
            return matchSearch && matchPayment;
        });

        if (filtered.length === 0) {
            alert('No hay datos para exportar');
            return;
        }

        let csv = 'Fecha,Vendedor,Cliente,Total,Método de Pago,Productos\n';
        filtered.forEach(sale => {
            const productos = sale.items ? sale.items.map(i => `${i.name} (${i.quantity})`).join('; ') : '';
            const vendedor = db.usersMap[sale.sellerId] || sale.sellerId;
            csv += `${sale.date},"${vendedor}","${sale.clientName}",${sale.total},${sale.paymentMethod},"${productos}"\n`;
        });

        downloadCSV(csv, 'ventas_' + new Date().toISOString().split('T')[0] + '.csv');
    }

    function exportExpensesToExcel() {
        const searchTerm = document.getElementById('search-expenses').value.toLowerCase();
        const paymentFilter = document.getElementById('filter-expenses-payment').value;

        let filtered = managementExpensesData.filter(expense => {
            const category = expense.category || '';
            const matchSearch = category.toLowerCase().includes(searchTerm);
            const matchPayment = !paymentFilter || expense.paymentMethod === paymentFilter;
            return matchSearch && matchPayment;
        });

        if (filtered.length === 0) {
            alert('No hay datos para exportar');
            return;
        }

        let csv = 'Fecha,Vendedor,Categoría,Monto,Método de Pago,Descripción\n';
        filtered.forEach(expense => {
            const vendedor = db.usersMap[expense.sellerId] || expense.sellerId;
            const desc = expense.description || '';
            csv += `${expense.date},"${vendedor}","${expense.category}",${expense.amount},${expense.paymentMethod},"${desc}"\n`;
        });

        downloadCSV(csv, 'gastos_' + new Date().toISOString().split('T')[0] + '.csv');
    }

    function downloadCSV(csv, filename) {
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    let editSaleProducts = [];

    async function openEditSaleModal(saleId) {
        const docSnap = await db_firestore.collection('sales').doc(saleId).get();
        if (!docSnap.exists) {
            alert('Venta no encontrada.');
            return;
        }

        const sale = docSnap.data();
        document.getElementById('edit-sale-id').value = saleId;
        document.getElementById('edit-sale-date').value = sale.date;
        document.getElementById('edit-sale-client').value = sale.clientName;
        document.getElementById('edit-sale-payment').value = sale.paymentMethod;

        // Cargar productos
        editSaleProducts = sale.items ? JSON.parse(JSON.stringify(sale.items)) : [];
        renderEditSaleProducts();

        document.getElementById('edit-sale-modal').classList.remove('hidden');
    }

    function renderEditSaleProducts() {
        const container = document.getElementById('edit-sale-products-container');
        container.innerHTML = '';

        if (editSaleProducts.length === 0) {
            container.innerHTML = '<p class="text-slate-500 text-sm text-center py-4">No hay productos. Haga clic en "+ Agregar Producto"</p>';
            updateEditSaleTotal();
            return;
        }

        editSaleProducts.forEach((item, index) => {
            const productRow = document.createElement('div');
            productRow.className = 'grid grid-cols-12 gap-2 items-center bg-slate-50 dark:bg-slate-700 p-2 rounded-lg';
            productRow.innerHTML = `
                <div class="col-span-5">
                    <select class="w-full p-2 text-sm border rounded-lg dark:bg-slate-600 dark:border-slate-500" onchange="updateEditSaleProductName(${index}, this.value)">
                        <option value="">Seleccionar producto</option>
                        ${db.products.map(p => `<option value="${p.name}" ${p.name === item.name ? 'selected' : ''}>${p.name}</option>`).join('')}
                    </select>
                </div>
                <div class="col-span-2">
                    <input type="number" value="${item.quantity}" min="1" step="1" placeholder="Cant."
                        class="w-full p-2 text-sm border rounded-lg dark:bg-slate-600 dark:border-slate-500"
                        onchange="updateEditSaleProductQuantity(${index}, this.value)">
                </div>
                <div class="col-span-2">
                    <input type="number" value="${item.price}" min="0" step="0.01" placeholder="Precio"
                        class="w-full p-2 text-sm border rounded-lg dark:bg-slate-600 dark:border-slate-500"
                        onchange="updateEditSaleProductPrice(${index}, this.value)">
                </div>
                <div class="col-span-2">
                    <span class="text-sm font-semibold text-slate-900 dark:text-white">$${item.total.toFixed(2)}</span>
                </div>
                <div class="col-span-1 text-right">
                    <button type="button" onclick="removeEditSaleProduct(${index})" class="text-red-500 hover:text-red-700">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            `;
            container.appendChild(productRow);
        });

        updateEditSaleTotal();
    }

    function addEditSaleProduct() {
        editSaleProducts.push({
            name: '',
            quantity: 1,
            price: 0,
            total: 0
        });
        renderEditSaleProducts();
    }

    function removeEditSaleProduct(index) {
        editSaleProducts.splice(index, 1);
        renderEditSaleProducts();
    }

    function updateEditSaleProductName(index, name) {
        editSaleProducts[index].name = name;
        const product = db.products.find(p => p.name === name);
        if (product) {
            editSaleProducts[index].price = product.price;
            editSaleProducts[index].total = editSaleProducts[index].quantity * product.price;
        }
        renderEditSaleProducts();
    }

    function updateEditSaleProductQuantity(index, quantity) {
        const qty = parseInt(quantity) || 1;
        editSaleProducts[index].quantity = qty;
        editSaleProducts[index].total = qty * editSaleProducts[index].price;
        renderEditSaleProducts();
    }

    function updateEditSaleProductPrice(index, price) {
        const p = parseFloat(price) || 0;
        editSaleProducts[index].price = p;
        editSaleProducts[index].total = editSaleProducts[index].quantity * p;
        renderEditSaleProducts();
    }

    function updateEditSaleTotal() {
        const total = editSaleProducts.reduce((sum, item) => sum + item.total, 0);
        document.getElementById('edit-sale-total-display').textContent = '$' + total.toFixed(2);
    }

    function closeEditSaleModal() {
        document.getElementById('edit-sale-modal').classList.add('hidden');
        document.getElementById('edit-sale-form').reset();
    }

    async function openEditExpenseModal(expenseId) {
        const docSnap = await db_firestore.collection('expenses').doc(expenseId).get();
        if (!docSnap.exists) {
            alert('Gasto no encontrado.');
            return;
        }

        const expense = docSnap.data();
        document.getElementById('edit-expense-id').value = expenseId;

        // Cargar fecha
        document.getElementById('edit-expense-date').value = expense.date || getCurrentDate();

        // Poblar categorías
        const categorySelect = document.getElementById('edit-expense-category');
        categorySelect.innerHTML = '';
        db.expenseTypes.forEach(type => {
            categorySelect.innerHTML += `<option value="${type.name}">${type.name}</option>`;
        });

        categorySelect.value = expense.category;
        document.getElementById('edit-expense-amount').value = expense.amount;
        document.getElementById('edit-expense-payment').value = expense.paymentMethod;
        document.getElementById('edit-expense-description').value = expense.description || '';

        document.getElementById('edit-expense-modal').classList.remove('hidden');
    }

    function closeEditExpenseModal() {
        document.getElementById('edit-expense-modal').classList.add('hidden');
        document.getElementById('edit-expense-form').reset();
    }

    async function deleteSale(saleId) {
        if (!confirm('¿Está seguro de eliminar esta venta? Esta acción no se puede deshacer.')) {
            return;
        }

        try {
            await db_firestore.collection('sales').doc(saleId).delete();

            // Actualizar db local
            const index = db.sales.findIndex(s => s.id === saleId);
            if (index !== -1) {
                db.sales.splice(index, 1);
            }

            alert('Venta eliminada correctamente.');
            queryManagement();
        } catch (error) {
            alert('Error al eliminar la venta: ' + error.message);
        }
    }

    async function deleteExpense(expenseId) {
        if (!confirm('¿Está seguro de eliminar este gasto? Esta acción no se puede deshacer.')) {
            return;
        }

        try {
            console.log('Eliminando gasto con ID:', expenseId);

            // Eliminar de Firestore
            await db_firestore.collection('expenses').doc(expenseId).delete();

            console.log('Gasto eliminado de Firestore');

            // Actualizar db local
            const index = db.expenses.findIndex(e => e.id === expenseId);
            if (index !== -1) {
                db.expenses.splice(index, 1);
                console.log('Gasto eliminado del array local');
            }

            alert('Gasto eliminado correctamente.');

            // Refrescar la lista
            await queryManagement();
        } catch (error) {
            console.error('Error al eliminar gasto:', error);
            alert('Error al eliminar el gasto: ' + error.message);
        }
    }

    // Listener para el formulario de edición de ventas
    document.getElementById('edit-sale-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const saleId = document.getElementById('edit-sale-id').value;
        const date = document.getElementById('edit-sale-date').value;
        const clientName = document.getElementById('edit-sale-client').value;
        const paymentMethod = document.getElementById('edit-sale-payment').value;

        // Validar que haya al menos un producto
        if (editSaleProducts.length === 0) {
            alert('Debe agregar al menos un producto a la venta.');
            return;
        }

        // Validar que todos los productos tengan nombre
        const invalidProducts = editSaleProducts.filter(p => !p.name || p.name === '');
        if (invalidProducts.length > 0) {
            alert('Todos los productos deben tener un nombre seleccionado.');
            return;
        }

        // Calcular el total
        const total = editSaleProducts.reduce((sum, item) => sum + item.total, 0);

        if (total <= 0) {
            alert('El total de la venta debe ser mayor a 0.');
            return;
        }

        try {
            await db_firestore.collection('sales').doc(saleId).update({
                date,
                clientName,
                items: editSaleProducts,
                total,
                paymentMethod,
                status: (paymentMethod === 'credito' ? 'pendiente' : 'pagado')
            });

            // Actualizar db local
            const index = db.sales.findIndex(s => s.id === saleId);
            if (index !== -1) {
                db.sales[index].date = date;
                db.sales[index].clientName = clientName;
                db.sales[index].items = JSON.parse(JSON.stringify(editSaleProducts));
                db.sales[index].total = total;
                db.sales[index].paymentMethod = paymentMethod;
                db.sales[index].status = (paymentMethod === 'credito' ? 'pendiente' : 'pagado');
            }

            alert('Venta actualizada correctamente.');
            closeEditSaleModal();
            queryManagement();
        } catch (error) {
            alert('Error al actualizar la venta: ' + error.message);
        }
    });

    // Listener para el formulario de edición de gastos
    document.getElementById('edit-expense-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const expenseId = document.getElementById('edit-expense-id').value;
        const date = document.getElementById('edit-expense-date').value;
        const category = document.getElementById('edit-expense-category').value;
        const amount = parseFloat(document.getElementById('edit-expense-amount').value);
        const paymentMethod = document.getElementById('edit-expense-payment').value;
        const description = document.getElementById('edit-expense-description').value;

        try {
            await db_firestore.collection('expenses').doc(expenseId).update({
                date,
                category,
                amount,
                paymentMethod,
                description
            });

            // Actualizar db local
            const index = db.expenses.findIndex(e => e.id === expenseId);
            if (index !== -1) {
                db.expenses[index].date = date;
                db.expenses[index].category = category;
                db.expenses[index].amount = amount;
                db.expenses[index].paymentMethod = paymentMethod;
                db.expenses[index].description = description;
            }

            alert('Gasto actualizado correctamente.');
            closeEditExpenseModal();
            queryManagement();
        } catch (error) {
            alert('Error al actualizar el gasto: ' + error.message);
        }
    });

    // Listener para el botón de consultar en gestión
    document.getElementById('query-management-btn').addEventListener('click', queryManagement);

    // ========== FUNCIONES PARA EDITAR TIPOS DE GASTO ==========

    function openEditExpenseTypeModal(expenseTypeId) {
        const expenseType = db.expenseTypes.find(et => et.id === expenseTypeId);
        if (!expenseType) {
            alert('Tipo de gasto no encontrado.');
            return;
        }

        document.getElementById('edit-expense-type-id').value = expenseTypeId;
        document.getElementById('edit-expense-type-name').value = expenseType.name;
        document.getElementById('edit-expense-type-modal').classList.remove('hidden');
    }

    function closeEditExpenseTypeModal() {
        document.getElementById('edit-expense-type-modal').classList.add('hidden');
        document.getElementById('edit-expense-type-form').reset();
    }

    // Listener para el formulario de edición de tipos de gasto
    document.getElementById('edit-expense-type-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const expenseTypeId = document.getElementById('edit-expense-type-id').value;
        const newName = document.getElementById('edit-expense-type-name').value.trim();

        if (!newName) {
            alert('El nombre del tipo de gasto no puede estar vacío.');
            return;
        }

        // Verificar si ya existe otro tipo de gasto con el mismo nombre
        const existingType = db.expenseTypes.find(et => et.name.toLowerCase() === newName.toLowerCase() && et.id !== expenseTypeId);
        if (existingType) {
            alert('Ya existe un tipo de gasto con ese nombre.');
            return;
        }

        try {
            const oldExpenseType = db.expenseTypes.find(et => et.id === expenseTypeId);
            const oldName = oldExpenseType.name;

            // Actualizar el tipo de gasto en Firestore
            await db_firestore.collection('expense_types').doc(expenseTypeId).update({
                name: newName
            });

            // Si el nombre cambió, actualizar todos los gastos que usen este tipo
            if (oldName !== newName) {
                const expensesToUpdate = db.expenses.filter(e => e.category === oldName);

                if (expensesToUpdate.length > 0) {
                    const batch = db_firestore.batch();
                    expensesToUpdate.forEach(expense => {
                        const expenseRef = db_firestore.collection('expenses').doc(expense.id);
                        batch.update(expenseRef, { category: newName });
                    });
                    await batch.commit();

                    alert(`Tipo de gasto actualizado correctamente.\nSe actualizaron ${expensesToUpdate.length} gasto(s) asociado(s).`);
                } else {
                    alert('Tipo de gasto actualizado correctamente.');
                }
            } else {
                alert('Tipo de gasto actualizado correctamente.');
            }

            closeEditExpenseTypeModal();
        } catch (error) {
            alert('Error al actualizar el tipo de gasto: ' + error.message);
        }
    });

    // ========== FUNCIONES PARA EDITAR CIERRES DE CAJA (ADMINISTRADOR) ==========

    async function openEditClosureModal(closureId) {
        try {
            const docSnap = await db_firestore.collection('cash_closures').doc(closureId).get();
            if (!docSnap.exists) {
                alert('Cierre de caja no encontrado.');
                return;
            }

            const closure = docSnap.data();
            document.getElementById('edit-closure-id').value = closureId;
            document.getElementById('edit-closure-opening').value = closure.openingBalance || 0;
            document.getElementById('edit-closure-cash-sales').value = closure.cashSales || 0;
            document.getElementById('edit-closure-cash-expenses').value = closure.cashExpenses || 0;
            document.getElementById('edit-closure-collections').value = closure.collections || 0;
            document.getElementById('edit-closure-physical').value = closure.physicalCash || 0;
            document.getElementById('edit-closure-credit-sales').value = closure.creditSales || 0;
            document.getElementById('edit-closure-transfer-sales').value = closure.transferSales || 0;

            document.getElementById('edit-closure-modal').classList.remove('hidden');
        } catch (error) {
            console.error('Error al abrir modal de edición:', error);
            alert('Error al cargar el cierre de caja: ' + error.message);
        }
    }

    function closeEditClosureModal() {
        document.getElementById('edit-closure-modal').classList.add('hidden');
        document.getElementById('edit-closure-form').reset();
    }

    async function deleteClosureAdmin(closureId) {
        if (!confirm('¿Está seguro de eliminar este cierre de caja? Esta acción no se puede deshacer.')) {
            return;
        }

        try {
            await db_firestore.collection('cash_closures').doc(closureId).delete();
            alert('Cierre de caja eliminado correctamente.');
            filterClosures(); // Recargar la lista
        } catch (error) {
            console.error('Error al eliminar cierre:', error);
            alert('Error al eliminar el cierre: ' + error.message);
        }
    }

    // Listener para el formulario de edición de cierres
    document.getElementById('edit-closure-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const closureId = document.getElementById('edit-closure-id').value;
        const openingBalance = parseFloat(document.getElementById('edit-closure-opening').value);
        const cashSales = parseFloat(document.getElementById('edit-closure-cash-sales').value);
        const cashExpenses = parseFloat(document.getElementById('edit-closure-cash-expenses').value);
        const collections = parseFloat(document.getElementById('edit-closure-collections').value);
        const physicalCash = parseFloat(document.getElementById('edit-closure-physical').value);
        const creditSales = parseFloat(document.getElementById('edit-closure-credit-sales').value) || 0;
        const transferSales = parseFloat(document.getElementById('edit-closure-transfer-sales').value) || 0;

        // Calcular el efectivo esperado y la diferencia
        const expectedCash = openingBalance + cashSales + collections - cashExpenses;
        const difference = physicalCash - expectedCash;

        try {
            await db_firestore.collection('cash_closures').doc(closureId).update({
                openingBalance,
                cashSales,
                cashExpenses,
                collections,
                physicalCash,
                creditSales,
                transferSales,
                expectedCash,
                difference
            });

            alert('Cierre de caja actualizado correctamente.');
            closeEditClosureModal();
            filterClosures(); // Recargar la lista
        } catch (error) {
            console.error('Error al actualizar cierre:', error);
            alert('Error al actualizar el cierre: ' + error.message);
        }
    });

    // ========== FUNCIONES PARA HISTORIAL DE CIERRES DEL VENDEDOR ==========

    async function loadSellerClosures() {
        const list = document.getElementById('seller-closures-list');
        if (!list) return;

        list.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-500">Cargando...</td></tr>';

        try {
            const snapshot = await db_firestore.collection('cash_closures')
                .where('sellerId', '==', auth.currentUser.uid)
                .orderBy('closeTimestamp', 'desc')
                .limit(20)
                .get();

            if (snapshot.empty) {
                list.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-500">No se encontraron cierres de caja</td></tr>';
                return;
            }

            list.innerHTML = '';
            snapshot.forEach(doc => {
                const closure = doc.data();
                const diff = closure.difference;
                const diffClass = diff < 0 ? 'text-red-500' : (diff > 0 ? 'text-green-500' : 'text-slate-500');
                const diffText = diff < 0 ? `Faltante: $${Math.abs(diff).toFixed(2)}` : (diff > 0 ? `Sobrante: $${diff.toFixed(2)}` : '$0.00');

                const row = `
                    <tr>
                        <td class="py-3 px-4">${closure.closeTimestamp.toDate().toLocaleString()}</td>
                        <td class="py-3 px-4">$${closure.openingBalance.toFixed(2)}</td>
                        <td class="py-3 px-4">$${closure.expectedCash.toFixed(2)}</td>
                        <td class="py-3 px-4">$${closure.physicalCash.toFixed(2)}</td>
                        <td class="py-3 px-4 ${diffClass} font-semibold">${diffText}</td>
                        <td class="py-3 px-4">
                            <button onclick="generateSellerClosurePdf('${doc.id}')" class="text-blue-500 hover:underline">Descargar PDF</button>
                        </td>
                    </tr>
                `;
                list.innerHTML += row;
            });
        } catch (error) {
            console.error('Error al cargar cierres:', error);
            list.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Error al cargar los cierres</td></tr>';
        }
    }

    async function generateSellerClosurePdf(closureId) {
        try {
            const docSnap = await db_firestore.collection('cash_closures').doc(closureId).get();
            if (!docSnap.exists) {
                alert('No se encontró el cierre.');
                return;
            }

            const closure = docSnap.data();

            // Obtener las ventas del día del cierre usando fecha local
            const closureDateTime = closure.closeTimestamp.toDate();
            const year = closureDateTime.getFullYear();
            const month = String(closureDateTime.getMonth() + 1).padStart(2, '0');
            const day = String(closureDateTime.getDate()).padStart(2, '0');
            const closureDate = `${year}-${month}-${day}`;

            const salesSnapshot = await db_firestore.collection('sales')
                .where('sellerId', '==', closure.sellerId)
                .where('date', '==', closureDate)
                .get();

            const todaySales = salesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

            // Calcular totales por método de pago
            const totalCashSales = todaySales.filter(s => s.paymentMethod === 'efectivo').reduce((sum, s) => sum + s.total, 0);
            const totalTransferSales = todaySales.filter(s => s.paymentMethod === 'transferencia').reduce((sum, s) => sum + s.total, 0);
            const totalCreditSales = todaySales.filter(s => s.paymentMethod === 'credito').reduce((sum, s) => sum + s.total, 0);
            const totalAllSales = totalCashSales + totalTransferSales + totalCreditSales;

            const doc = new jsPDF();

            // Encabezado
            doc.setFontSize(18);
            doc.setTextColor(22, 160, 133);
            doc.text('Reporte de Cierre de Caja', 14, 20);

            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text(`Fecha: ${closure.closeTimestamp.toDate().toLocaleString()}`, 14, 28);
            // Obtener nombre del vendedor
            const sellerDoc = await db_firestore.collection('users').doc(closure.sellerId).get();
            const sellerName = sellerDoc.exists ? (sellerDoc.data().name || sellerDoc.data().email) : 'Usuario';
            doc.text(`Vendedor: ${sellerName}`, 14, 34);

            // Resumen de Efectivo
            doc.setFontSize(14);
            doc.setTextColor(22, 160, 133);
            doc.text('Resumen de Efectivo', 14, 45);

            doc.autoTable({
                startY: 50,
                theme: 'grid',
                body: [
                    ['(+) Monto Inicial', `$${closure.openingBalance.toFixed(2)}`],
                    ['(+) Ventas Efectivo', `$${closure.cashSales.toFixed(2)}`],
                    ['(+) Cobros', `$${closure.collections.toFixed(2)}`],
                    ['(-) Gastos Efectivo', `-$${closure.cashExpenses.toFixed(2)}`],
                    ['(=) Total Esperado', `$${closure.expectedCash.toFixed(2)}`],
                    ['Fisico Contado', `$${closure.physicalCash.toFixed(2)}`],
                    ['Diferencia', `${closure.difference < 0 ? 'Faltante' : 'Sobrante'}: $${Math.abs(closure.difference).toFixed(2)}`]
                ],
                styles: { fontSize: 10 },
                headStyles: { fillColor: [22, 160, 133] },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 90 },
                    1: { halign: 'right', cellWidth: 50 }
                }
            });

            let currentY = doc.lastAutoTable.finalY + 10;

            // Resumen de Ventas por Método de Pago
            doc.setFontSize(14);
            doc.setTextColor(22, 160, 133);
            doc.text('Resumen de Ventas', 14, currentY);

            doc.autoTable({
                startY: currentY + 5,
                theme: 'grid',
                head: [['Metodo de Pago', 'Cantidad', 'Total']],
                body: [
                    ['Efectivo', todaySales.filter(s => s.paymentMethod === 'efectivo').length.toString(), `$${totalCashSales.toFixed(2)}`],
                    ['Transferencia', todaySales.filter(s => s.paymentMethod === 'transferencia').length.toString(), `$${totalTransferSales.toFixed(2)}`],
                    ['Credito', todaySales.filter(s => s.paymentMethod === 'credito').length.toString(), `$${totalCreditSales.toFixed(2)}`],
                    ['TOTAL GENERAL', todaySales.length.toString(), `$${totalAllSales.toFixed(2)}`]
                ],
                styles: { fontSize: 10 },
                headStyles: { fillColor: [22, 160, 133] },
                columnStyles: {
                    0: { cellWidth: 70 },
                    1: { halign: 'center', cellWidth: 30 },
                    2: { halign: 'right', cellWidth: 40, fontStyle: 'bold' }
                },
                bodyStyles: {
                    3: { fillColor: [220, 220, 220], fontStyle: 'bold' }
                }
            });

            currentY = doc.lastAutoTable.finalY + 10;

            // Detalle de Ventas
            if (todaySales.length > 0) {
                doc.setFontSize(14);
                doc.setTextColor(22, 160, 133);
                doc.text('Detalle de Ventas', 14, currentY);

                // Preparar datos para la tabla con detalle de productos
                const salesData = [];
                todaySales.forEach((sale, index) => {
                    const items = sale.items || [];
                    const itemsText = items.length > 0
                        ? items.map(i => `${i.name} (${i.quantity}x$${i.price.toFixed(2)})`).join(', ')
                        : 'Sin productos';

                    salesData.push([
                        (index + 1).toString(),
                        sale.clientName || 'Cliente General',
                        sale.paymentMethod,
                        itemsText,
                        `$${sale.total.toFixed(2)}`
                    ]);
                });

                doc.autoTable({
                    startY: currentY + 5,
                    theme: 'striped',
                    head: [['#', 'Cliente', 'Metodo', 'Productos', 'Total']],
                    body: salesData,
                    styles: { fontSize: 7, cellPadding: 2 },
                    headStyles: { fillColor: [22, 160, 133], fontSize: 8 },
                    columnStyles: {
                        0: { cellWidth: 10, halign: 'center' },
                        1: { cellWidth: 35 },
                        2: { cellWidth: 23 },
                        3: { cellWidth: 95 },
                        4: { cellWidth: 25, halign: 'right', fontStyle: 'bold' }
                    },
                    margin: { left: 10, right: 10 }
                });

                currentY = doc.lastAutoTable.finalY + 10;

                // Productos más vendidos
                const productStats = {};
                todaySales.forEach(sale => {
                    sale.items.forEach(item => {
                        if (!productStats[item.name]) {
                            productStats[item.name] = 0;
                        }
                        productStats[item.name] += item.quantity;
                    });
                });

                const topProducts = Object.entries(productStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                if (topProducts.length > 0) {
                    if (currentY > 250) {
                        doc.addPage();
                        currentY = 20;
                    }

                    doc.setFontSize(14);
                    doc.setTextColor(22, 160, 133);
                    doc.text('Productos Mas Vendidos', 14, currentY);

                    const productsData = topProducts.map(([name, qty], index) => {
                        return [
                            (index + 1).toString(),
                            name,
                            qty.toString()
                        ];
                    });

                    doc.autoTable({
                        startY: currentY + 5,
                        theme: 'grid',
                        head: [['Pos', 'Producto', 'Cantidad']],
                        body: productsData,
                        styles: { fontSize: 10 },
                        headStyles: { fillColor: [22, 160, 133] },
                        columnStyles: {
                            0: { cellWidth: 20, halign: 'center' },
                            1: { cellWidth: 90 },
                            2: { cellWidth: 30, halign: 'center', fontStyle: 'bold' }
                        }
                    });
                }
            } else {
                doc.setFontSize(11);
                doc.setTextColor(100, 100, 100);
                doc.text('No se registraron ventas en este periodo', 14, currentY);
            }

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Pagina ${i} de ${pageCount}`, 14, 285);
                doc.text(`Generado el ${new Date().toLocaleString()}`, 120, 285);
            }

            doc.save(`cierre_caja_${closureDate}.pdf`);
        } catch (error) {
            console.error('Error al generar PDF:', error);
            alert('Error al generar el PDF: ' + error.message);
        }
    }

</script>
</body>
</html>
